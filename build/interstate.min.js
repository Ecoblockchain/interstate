/*! InterState - v0.1.0 - 2014-07-30 12:26:21 PM */
var RedSet=function(){"use strict";var a=Array.prototype,b=Object.prototype,c=(Function.prototype,a.slice,b.toString),d=(a.forEach,a.map,function(a,b){return a===b}),e=Array.isArray||function(a){return"[object Array]"===c.call(a)},f=function(a){return"[object String]"===c.call(a)},g=function(a){var b,c,d=arguments.length;for(b=1;d>b;b+=1){var e=arguments[b];for(c in e)e.hasOwnProperty(c)&&(a[c]=e[c])}return a},h=function(a){return a.toString()},i=function(a){return function(b){return b[a]()}},j=function(a){a=g({hash:h,equals:d,value:[]},a),this._equality_check=a.equals,this._hash=f(a.hash)?i(a.hash):a.hash,this._hashed_values={},this.value=[],this.add.apply(this,a.value)};return function(a){var b=a.prototype;b.add=function(){var a,b,c=arguments.length,d=this.value.length;for(b=0;c>b;b+=1){var e=arguments[b];a=this.add_to_hash(e,d),a&&(this.value[d]=a,d+=1)}return this},b.add_at=function(a){var b,c,d,e=arguments.length;for(d=1;e>d;d+=1){var f=arguments[d];b=this.add_to_hash(f,a),b&&(this.value.splice(a,0,b),a+=1)}var g=this.value.length;for(c=a;g>c;c+=1)this.value[c].index=c;return this},b.remove=function(){var a,b,c,d=arguments.length;for(a=0;d>a;a+=1){var e=arguments[a],f=this._hash(e),g=this._hashed_values[f];if(g){var h=g.length;for(b=0;h>b;b+=1){var i=g[b];if(this._equality_check(i.item,e)){1===h?delete this._hashed_values[f]:g.splice(b,1);var j=i.index;this.value.splice(j,1);var k=this.value.length;for(c=j;k>c;c+=1)this.value[c].index=c;break}}}}return this},b.contains=function(a){var b=this._hash(a),c=this._hashed_values[b];if(e(c)){var d,f=c.length,g=this._equality_check;for(d=0;f>d;d+=1)if(g(c[d].item,a))return!0;return!1}return!1},b.add_to_hash=function(a,b){var c=this._hash(a),d=this._hashed_values[c],f={item:a,index:b};if(e(d)){var g,h=d.length,i=this._equality_check;for(g=0;h>g;g+=1)if(i(d[g].item,a))return!1;d[g]=f}else this._hashed_values[c]=[f];return f},b.each=function(a,b){b=b||window;var c;for(c=0;c<this.value.length&&a.call(b,this.value[c].item,c)!==!1;c+=1);return this},b.len=function(){return this.value.length},b.item=function(a){return this.value[a]?this.value[a].item:void 0},b.toArray=function(){var a,b=this.value.length,c=[];for(a=0;b>a;a+=1)c[a]=this.value[a].item;return c}}(j),j}(this),RedMap=function(){"use strict";var a=Array.prototype,b=Object.prototype,c=(Function.prototype,a.slice),d=b.toString,e=a.forEach,f=(a.map,{}),g=(function(){var a=0;return function(){return a+=1}}(),Array.isArray||function(a){return"[object Array]"===d.call(a)},function(a){return"[object String]"===d.call(a)}),h=Object.prototype.hasOwnProperty,i=function(a,b){return h.call(a,b)},j=function(a,b,c){var d,g,h;if(a)if(e&&a.forEach===e)a.forEach(b,c);else if(a.length===+a.length){for(d=0,h=a.length;h>d;d+=1)if(i(a,d)&&b.call(c,a[d],d,a)===f)return}else for(g in a)if(a.hasOwnProperty(g)&&b.call(c,a[g],g,a)===f)return},k=function(a){var b,c=arguments.length,d=function(b,c){a[c]=b};for(b=1;c>b;b+=1)j(arguments[b],d);return a},l=function(a,b){return a===b},m=function(a){return a.toString()},n=function(a){return function(b){return b[a]()}},o=function(a){a=k({hash:m,equals:l,value:{},values:[],keys:[]},a),j(a.value,function(b,c){a.keys.push(c),a.values.push(b)},this),this._equality_check=a.equals,this._hash=g(a.hash)?n(a.hash):a.hash,this._khash={},this._ordered_values=[];var b=0;j(a.keys,function(c,d){var e=a.values[d],f=this._hash(c),g=this._khash[f],h={key:c,value:e};g?g.push(h):this._khash[f]=[h],this._ordered_values[b]=h,b+=1},this)};return function(a){var b=a.prototype;b.put=function(a,b){var c,d=this._hash(a),e=this._khash[d],f={key:a,value:b};if(e){var g=e.length;for(c=0;g>c;c+=1){var h=e[c];if(this._equality_check(h.key,a))return h.value=b,this}return e.push(f),this._ordered_values.push(f),this}return this._khash[d]=[f],this._ordered_values.push(f),this},b.remove=function(a){var b,c,d,e,f=this._hash(a),g=this._khash[f];if(g)for(d=g.length,b=0;d>b;b+=1)if(c=g[b],this._equality_check(c.key,a)){for(g.splice(b,1),1===d&&delete this._khash[f],d=this._ordered_values.length,b=0;d>b;b+=1)c=this._ordered_values[b],this._equality_check(c.key,a)&&(this._ordered_values.splice(b,1),b--,d--,e=c.value);return e}return e},b.clear=function(){this._ordered_values.splice(0,this._ordered_values.length),j(this._khash,function(a,b){delete this._khash[b]},this)},b.get=function(a){var b,c=this._hash(a),d=this._khash[c];if(d){var e=d.length;for(b=0;e>b;b+=1){var f=d[b];if(this._equality_check(f.key,a))return f.value}}return void 0},b.has=function(a){var b,c=this._hash(a),d=this._khash[c];if(d){var e=d.length;for(b=0;e>b;b+=1){var f=d[b];if(this._equality_check(f.key,a))return!0}}return!1},b.get_or_put=function(a,b,c){var d,e,f,g=this._hash(a),h=this._khash[g],i=c||this;if(h){var j=h.length;for(e=0;j>e;e+=1){var k=h[e];if(this._equality_check(k.key,a))return k.value}return d=b.call(i,a),f={key:a,value:d},h.push(f),this._ordered_values.push(f),d}return d=b.call(i,a),f={key:a,value:d},this._khash[g]=[f],this._ordered_values.push(f),d},b.keys=function(){var a,b=new Array(this._ordered_values.length);for(a=this._ordered_values.length-1;a>=0;a-=1)b[a]=this._ordered_values[a].key;return b},b.values=function(){var a,b=new Array(this._ordered_values.length);for(a=this._ordered_values.length-1;a>=0;a-=1)b[a]=this._ordered_values[a].value;return b},b.each=b.forEach=function(a,b){b=b||window;var d=c.call(this._ordered_values);return j(d,function(c){a.call(b,c.value,c.key,c.index)}),this},b.destroy=function(){}}(o),o}(this);!function(){"use strict";var a,b=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],c=((new Date).getTime(),6),d=b.length,e="";for(a=0;c-2>a;a+=1){var f=Math.floor(Math.random()*d);e+=b[f]}var g="$"+e+"_",h=0;window.uid=function(){return h+=1,g+h},window.uid.strip_prefix=function(a){return parseInt(a.slice(c))},window.uid.get_prefix=function(){return e}}();var cjs=function(a){"use strict";var b,c,d=Array.prototype,e=Object.prototype,f=(Function.prototype,String.prototype),g=d.slice,h=e.toString,i=d.concat,j=d.push,k=d.some,l=d.indexOf,m=(d.lastIndexOf,d.every),n=d.forEach,o=Object.keys,p=d.filter,q=d.reduce,r=d.map,s=f.trim,t=function(a,b){return function(){return a.apply(b,arguments)}},u=function(a){var b=P(arguments,1);return function(){return a.apply(this,b)}},v=function(a){return s?s.call(a):String(a).replace(/^\s+|\s+$/g,"")},w=a.document,x=function(b,c){return a.setTimeout(b,c)},y=function(b,c){return a.clearTimeout(b,c)},z={"+":function(a){return+a},"-":function(a){return-a},"~":function(a){return~a},"!":function(a){return!a}},A={"===":function(a,b){return a===b},"!==":function(a,b){return a!==b},"==":function(a,b){return a==b},"!=":function(a,b){return a!=b},">":function(a,b){return a>b},">=":function(a,b){return a>=b},"<":function(a,b){return b>a},"<=":function(a,b){return b>=a},"+":function(a,b){return a+b},"-":function(a,b){return a-b},"*":function(a,b){return a*b},"/":function(a,b){return a/b},"%":function(a,b){return a%b},"^":function(a,b){return a^b},"&&":function(a,b){return a&&b},"||":function(a,b){return a||b},"&":function(a,b){return a&b},"|":function(a,b){return a|b},"<<":function(a,b){return a<<b},">>":function(a,b){return a>>b},">>>":function(a,b){return a>>>b}};!w||"textContent"in w.createElement("div")?(b=function(a){return a.textContent},c=function(a,b){a.textContent=b}):(b=function(a){return a&&3===a.nodeType?a.nodeValue:a.innerText},c=function(a,b){a&&3===a.nodeType?a.nodeValue=b:a.innerText=b});var B,C,D,E,F,G,H=function(a,b,c){a.addEventListener?a.addEventListener(b,c):a.attachEvent("on"+b,c)},I=function(a,b,c){a.removeEventListener?a.removeEventListener(b,c):a.detachEvent("on"+b,c)},J={},K=function(){var a=0;return function(){return a++}}(),L=function(a){return X(a)?U(a)?a.slice():gb({},a):a},M=o||function(a){if(a!==Object(a))throw new TypeError("Invalid object");var b,c=[],d=0;for(b in a)bb.call(a,b)&&(c[d++]=b);return c},N=function(a,b){return a?void 0===b?a[a.length-1]:g.call(a,Math.max(a.length-b,0)):void 0},O=function(a,b,c){var d=!1;return a?k&&a.some===k?a.some(b,c):(db(a,function(a,e,f){return d||(d=b.call(c,a,e,f))?J:void 0}),!!d):d},P=function(a,b){return g.call(a,void 0===b?1:b)},Q=function(a,b,c){b=b||_;var d=!0;return a?m&&a.every===m?a.every(b,c):(db(a,function(a,e,f){return(d=d&&b.call(c,a,e,f))?void 0:J}),!!d):d},R=function(a,b,c){return b&&Q(a,U)?i.apply(c,a):(db(a,function(a){U(a)||$(a)?b?j.apply(c,a):R(a,b,c):c.push(a)}),c)},S=function(a,b){return R(a,b,[])},T=function(a){return"[object Number]"===h.call(a)},U=Array.isArray||function(a){return"[object Array]"===h.call(a)},V=function(a){return"[object Function]"===h.call(a)},W=function(a){return"[object String]"===h.call(a)},X=function(a){return a===Object(a)},Y=function(a){return!(!a||1!==a.nodeType)},Z=function(a){return!!(a&&a.nodeType>0)},$=function(a){return"[object Arguments]"===h.call(a)},_=function(a){return a},ab=function(a){return a?U(a)?g.call(a):$(a)?g.call(a):a.toArray&&V(a.toArray)?a.toArray():eb(a,_):[]},bb=e.hasOwnProperty,cb=function(a,b){return bb.call(a,b)},db=function(a,b,c){var d,e;if(a){if(n&&a.forEach===n)a.forEach(b,c);else if(a.length===+a.length){for(d=0,e=a.length;e>d;d++)if(b.call(c,a[d],d,a)===J)return}else{var f=M(a);for(d=0,e=f.length;e>d;d++)if(b.call(c,a[f[d]],f[d],a)===J)return}return a}},eb=function(a,b,c){var d=[];return a?r&&a.map===r?a.map(b,c):(db(a,function(a,e,f){d[d.length]=b.call(c,a,e,f)}),a.length===+a.length&&(d.length=a.length),d):d},fb=function(a,b,c){var d=[];return a?p&&a.filter===p?a.filter(b,c):(db(a,function(a,e,f){b.call(c,a,e,f)&&d.push(a)}),d):d},gb=function(a){return db(g.call(arguments,1),function(b){if(b)for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])}),a},hb=function(a,b,c){var d,e=a.length;for(d=c||0;e>d;d++)if(b(a[d],d))return d;return-1},ib=function(a,b){return a===b},jb=function(a,b,c,d){return d||c||!l||a.indexOf!==l?(d=d||ib,hb(a,function(a){return d(b,a)},c)):a.indexOf(b)},kb=function(a,b){return lb(a,jb(a,b))},lb=function(a,b){return b>=0?a.splice(b,1)[0]:b},mb=function(a,b,c){var d=arguments.length>2;return a||(a=[]),q&&a.reduce===q?d?a.reduce(b,c):a.reduce(b):(db(a,function(a,d,e){c=b(c,a,d,e)}),c)},nb=function(a,b,c,d){for(var e=c,f=a.length;f>e;){if(d(a[e],b))return e;e++}return-1},ob=function(a,b,c,d,e,f,g){var h=b[a],i=d[h]+1;return i=nb(c,h,i>e?i:e,g||ib),0>i&&(i=f),d[h]=i,i},pb=function(a,b,c){var d,e,f,g={},h=0,i=0,j=0,k=a.length,l=b.length,m=new Array(l>k?l:k);if(0===l||0===k)return[];for(d=ob(0,a,b,g,h,l,c),f=0;k>f;f++)i=h===i?d:ob(f,a,b,g,h,l,c),d=ob(f+1,a,b,g,h,l,c),i>d?(f++,e=d):e=i,e===l||f===k?i=ob(f,a,b,g,h,l,c):(h=e,m[j]={item:a[f],indicies:[f,e]},j++);return m.slice(0,j)},qb=function(a,b,c){var d,e,f,g=L(b),h=a.length,i=b.length,j=[],k=0;if(0===i||0===h)return a;for(d=0;h>d;d+=1)if(f=a[d],e=jb(g,f,0,c),e>=0){if(lb(g,e),0===--i){j.push.apply(j,P(a,d+1));break}}else j[k]=f,k++;return j},rb=function(a,b,c){var d,e,f,g=L(b),h=a.length,i=b.length,j=[];for(d=0;h>d&&i>0;d++)f=a[d],e=jb(g,f,0,c),e>=0&&(j.push([f,lb(g,e)]),i--);return j},sb=function(a){var b=a[1].item;return{item:b,from:a[0].index,to:a[1].index,from_item:a[0].item,to_item:b}},tb=function(a){for(var b=0,c=a.length,d=[];c>b;)d[b]={item:a[b],index:b},b++;return d},ub=function(a){return{item:a.item,from:a.indicies[0],to:a.indicies[1]}},vb=function(a){return a.index},wb=function(a){return a.to},xb=function(a){return{from:a.index,from_item:a.item}},yb=function(a,b,c){var d=c||ib,e=function(a,b){return d(a?a.item:a,b?b.item:b)},f=tb(a),g=tb(b),h=eb(pb(a,b),ub),i=qb(f,h,e),j=qb(g,h,e),k=eb(rb(i,j,e),sb);j=qb(j,k,e),i=qb(i,k,e);for(var l,m,n,o=eb(j,vb),p=eb(k,wb),q=eb(h,wb),r=[],s=0,t=b.length;t>s;)n=b[s],(m=jb(o,s))>=0?(l=j[m],r[s]={to:s,to_item:n,item:n}):(m=jb(p,s))>=0?(l=k[m],r[s]={to:s,to_item:n,item:n,from:l.from,from_item:l.from_item}):(m=jb(q,s))>=0&&(l=h[m],r[s]={to:s,to_item:n,item:n,from:l.from,from_item:a[l.from]}),s++;return r.concat(eb(i,xb))},zb=function(a){return a.hasOwnProperty("from")},Ab=function(a){return!zb(a)},Bb=function(a){return a.hasOwnProperty("to")},Cb=function(a){return!Bb(a)},Db=function(a){return zb(a)&&Bb(a)},Eb=function(a){return Db(a)&&a.from!==a.to},Fb=function(a,b){var c=zb(a),d=zb(b);return c&&d?a.from-b.from:d-c},Gb=function(a,b,c){var d=yb(a,b,c),e=L(d).sort(Fb),f=fb(d,Ab),g=fb(e,Cb).reverse(),h=fb(d,Eb),i=[];return db(g,function(a){lb(e,a.from)}),db(f,function(a){e.splice(a.to,0,a)}),db(d,function(a,b){if(Db(a)&&e[b]!==a){var c=jb(e,a,b);e.splice(b,0,lb(e,c)),i.push({move_from:c,insert_at:b,item:a.item,from:a.from,to:a.to})}}),e=null,{added:f,removed:g,moved:i,index_changed:h,mapping:d}},Hb=/-([a-z]|[0-9])/gi,Ib=/^-ms-/,Jb=function(a,b){return String(b).toUpperCase()},Kb=function(a){return a.replace(Ib,"ms-").replace(Hb,Jb)},Lb=a.cjs,Mb=function(a,b){return U(a)?new C(gb({value:a},b)):Ld(a)?Mb.inputValue(a):E(a)?new B(a,b):X(a)&&!V(a)?new D(gb({value:a},b)):new B(a,b)},Nb=function(a){return E(a)?a.get():a},Ob={stack:[],getValue:function(a,b){var c,d,e,f=this,g=Ob.stack,h=g.length;if(h>0&&(c=g[h-1],d=f._outEdges[c._id],e=c._tstamp+1,d?d.tstamp=e:f._options.auto_add_outgoing_dependencies!==!1&&c._options.auto_add_incoming_dependencies!==!1&&a!==!1&&(f._outEdges[c._id]=c._inEdges[f._id]={from:f,to:c,tstamp:e})),f._paused_info)return f._paused_info.temporaryValue;if(!f._valid){if(f._tstamp++,g[h]=f,f._valid=!0,f._options.cache_value!==!1){if(f._cached_value=f._options.literal?f._value:V(f._value)?f._value.call(f._options.context||f,f,b):Nb(f._value),f._sync_value)f._cached_value=f._sync_value.value,delete f._sync_value;else if(Ob._paused_node&&Ob._paused_node.node===f)return f._paused_info=Ob._paused_node,delete Ob._paused_node,g.length=h,f._paused_info.temporaryValue}else V(f._value)&&f._value.call(f._options.context);g.length=h}return f._cached_value},pauseNodeGetter:function(a){Ob._paused_node={temporaryValue:a,node:this}},resumeNodeGetter:function(a){var b,c=this;Ob._paused_node&&Ob._paused_node.node===c?(delete Ob._paused_node,c._sync_value={value:a}):(b=Ob.stack,delete c._paused_info,c._tstamp++,c._valid=!0,Ob.stack=[c],c._options.cache_value!==!1?c._cached_value=c._options.literal?a:V(a)?a.call(c._options.context||c,c):Mb.get(a):V(c._value)&&a.call(c._options.context),Ob.nullify.apply(Ob,eb(c._outEdges,function(a){return a.to})),Ob.stack=b)},add_in_call_stack:function(a){var b=a.priority;if(a.in_call_stack++,a.node._num_listeners_in_call_stack++,T(b))for(var c,d,e=0,f=this.nullified_call_stack.length;f>e;){if(c=this.nullified_call_stack[e],c&&(d=c.priority,d===!1||b>d))return void this.nullified_call_stack.splice(e,0,a);e++}this.nullified_call_stack.push(a)},nullify:function(){var a,b,c,d,e,f,h,i,j,k,l=g.call(arguments),m=l.length,n=!this._is_nullifying;for(n&&(this._is_nullifying=!0),a=0;m>a;a+=1)if(e=l[a],l[a]=!1,e._valid&&(e._valid=!1,d=!0,e._options.cache_value!==!1&&e._options.check_on_nullify===!0&&(f=e._options.equals||ib,h=e._cached_value,i=e.get(void 0,!0),f(h,i)&&(d=!1)),d)){j=e._changeListeners,db(j,this.add_in_call_stack,this),b=e._outEdges,k=e._id;for(c in b)if(cb(b,c)){var o=b[c],p=o.to;o.tstamp<p._tstamp?(delete e._outEdges[c],delete p._inEdges[k]):(l[m]=p,m+=1)}}n&&(this.semaphore>=0&&this.nullified_call_stack.length>0&&this.run_nullified_listeners(),delete this._is_nullifying)},removeDependency:function(a,b){delete a._outEdges[b._id],delete b._inEdges[a._id]},semaphore:0,wait:function(){this.semaphore-=1},signal:function(){this.semaphore+=1,this.semaphore>=0&&this.nullified_call_stack.length>0&&this.run_nullified_listeners()},nullified_call_stack:[],running_listeners:!1,clearEdges:function(a,b){var c,d=b!==!0,e=a._id,f=a._inEdges,g=a._outEdges;d&&this.wait();for(c in f)cb(f,c)&&(delete f[c].from._outEdges[e],delete f[c]);for(c in g)if(cb(g,c)){var h=g[c].to;d&&Ob.nullify(h),delete h._inEdges[e],delete g[c]}d&&this.signal()},run_nullified_listeners:function(){var b,c,d;if(!this.running_listeners){for(this.running_listeners=!0;this.nullified_call_stack.length>0;)if(b=this.nullified_call_stack.shift(),c=b.callback,d=b.context||a,b.in_call_stack--,b.node._num_listeners_in_call_stack--,Mb.__debug)c.apply(d,b.args);else try{c.apply(d,b.args)}catch(e){cb(a,"console")&&a.console.error(e)}this.running_listeners=!1}},remove_from_call_stack:function(a){for(;a.in_call_stack>0;)kb(this.nullified_call_stack,a),a.in_call_stack--,a.node._num_listeners_in_call_stack--}};B=function(b,c){this._options=gb({context:a},c),this._value=b,this._id=K(),this._outEdges={},this._inEdges={},this._changeListeners=[],this._tstamp=0,this._num_listeners_in_call_stack=0,this._options.literal||!V(this._value)&&!E(this._value)?(this._valid=!0,this._cached_value=this._value):(this._valid=!1,this._cached_value=void 0)},function(a){var b=a.prototype;b.get=Ob.getValue,b.set=function(a){var b=this._value;if(this._value=a,this._options.literal||!V(a)&&!E(a)){var c=this._options.equal||ib;c(b,a)||Ob.nullify(this)}else b!==a&&Ob.nullify(this);return this};var c=["context","literal"];b.setOption=function(a,b){var d;if(W(a))this._options[a]=b,d=jb(c,a)>=0;else{var e=e(a);gb(this._options,a),d=O(c,function(a){return e.indexOf(a)>=0})}return d?this.invalidate():this},b.invalidate=function(){return Ob.nullify(this),this},b.isValid=function(){return this._valid},b.remove=function(a){return Ob.clearEdges(this,a),this._valid=!1,this._cached_value=void 0,this},b.destroy=function(a){return this._num_listeners_in_call_stack>0&&db(this._changeListeners,function(a){return a.in_call_stack>0&&(Ob.remove_from_call_stack(a),0===this._num_listeners_in_call_stack)?J:void 0},this),this.remove(a),this._changeListeners=[],this},b.pauseGetter=function(){return Ob.pauseNodeGetter.apply(this,arguments),this},b.resumeGetter=function(){return Ob.resumeNodeGetter.apply(this,arguments),this},b.onChange=function(){return this.onChangeWithPriority.apply(this,[!1].concat(ab(arguments)))},b.onChangeWithPriority=function(a,b,c){var d=g.call(arguments,3);return T(a)||(a=!1),this._changeListeners.push({callback:b,context:c,args:d,in_call_stack:0,node:this,priority:a}),this._options.run_on_add_listener!==!1&&this.get(!1),this},b.offChange=function(a,b){var c,d;for(d=this._changeListeners.length-1;d>=0;d-=1)if(c=this._changeListeners[d],c.callback===a&&(!b||c.context===b)){lb(this._changeListeners,d),c.in_call_stack>0&&Ob.remove_from_call_stack(c),delete c.node;break}return this},b.inFSM=function(a,b){return db(b,function(b,c){a.on(c,function(){this.set(b)},this),a.is(c)&&this.set(b)},this),this},b.and=function(){var b=[this].concat(ab(arguments)),c=b.length;return new a(function(){for(var a,d=0;c>d;d++)if(!(a=Mb.get(b[d])))return!1;return a})},b.iif=function(b,c){var d=this;return new a(function(){return Mb.get(d.get()?b:c)})},b.or=function(){var b=[this].concat(ab(arguments)),c=b.length;return new a(function(){for(var a,d=0;c>d;d++)if(a=Mb.get(b[d]))return a;return!1})};var d=function(b){return function(){var c=[this].concat(ab(arguments));return new a(function(){return b.apply(this,eb(c,Mb.get))})}},e=function(a,b){return a?a[b]:void 0};b.prop=d(function(a){return mb(P(arguments),e,a)}),b.toInt=d(function(){return parseInt.apply(this,arguments)}),b.toFloat=d(function(){return parseFloat.apply(this,arguments)}),b.add=d(function(){return mb(arguments,A["+"],0)}),b.sub=d(function(a){return mb(P(arguments),A["-"],a)}),b.mul=d(function(a){return mb(P(arguments),A["*"],a)}),b.div=d(function(a){return mb(P(arguments),A["/"],a)}),db(["abs","acos","asin","atan","atan2","cos","max","min","sin","tan","pow","round","floor","ceil","sqrt","log","exp"],function(a){b[a]=d(t(Math[a],Math))}),db({u:{pos:"+",neg:"-",not:"!",bitwiseNot:"~"},bi:{eqStrict:"===",neqStrict:"!==",eq:"==",neq:"!=",gt:">",ge:">=",lt:"<",le:"<=",xor:"^",bitwiseAnd:"&",bitwiseOr:"|",mod:"%",rightShift:">>",leftShift:"<<",unsignedRightShift:">>>"}},function(a,c){var e="u"===c?z:A;db(a,function(a,c){b[c]=d(e[a])})}),b.typeOf=d(function(a){return typeof a}),b.instanceOf=d(function(a,b){return a instanceof b})}(B),E=function(a){return a instanceof B},gb(Mb,{constraint:function(a,b){return new B(a,b)},Constraint:B,isConstraint:E,inFSM:function(a,b){return(new B).inFSM(a,b)},get:function(a,b){return E(a)?a.get(b):F(a)?a.toArray():G(a)?a.toObject():a},wait:t(Ob.wait,Ob),signal:t(Ob.signal,Ob),removeDependency:Ob.removeDependency,arrayDiff:Gb,version:"0.9.7-beta",toString:function(){return"ConstraintJS v"+Mb.version},__debug:!0,noConflict:cb(a,"cjs")?function(){return a.cjs===Mb&&(a.cjs=Lb),Mb}:function(){return delete a.cjs,Mb}});var Pb=function(a){return T(a)&&Math.round(a)===a&&a>=0};C=function(a){a=gb({equals:ib,value:[]},a),this._value=eb(a.value,function(a){return new B(a,{literal:!0})}),this._unsubstantiated_items=[],this.$len=new B(this._value.length),this.$equality_check=new B(a.equals,{literal:!0})},function(b){var c=b.prototype;b.BREAK={};var d=function(a,b){var c=a._value[b];return void 0===c&&(c=new B(void 0,{literal:!0}),a._unsubstantiated_items[b]=c),c.get()},e=function(a,b,c){Mb.wait();var d=a._value[b];if(void 0===d&&a._unsubstantiated_items[b]&&(d=a._value[b]=a._unsubstantiated_items[b],delete a._unsubstantiated_items[b]),E(d)){{d.get()}d.set(c)}else a._value[b]=new B(c,{literal:!0});return h(a),Mb.signal(),c},f=function(a,b){var c;for(Mb.wait();a._value.length>0;){c=a._value.pop();{a._value.length}E(c)&&c.destroy(b)}return h(a),Mb.signal(),this},h=function(a){a.$len.set(a._value.length)};c.setEqualityCheck=function(a){return this.$equality_check.set(a),this},c.forEach=function(c,e){var f,g=this.length();for(e=e||a,f=0;g>f;f+=1)if(c.call(e,d(this,f),f)===b.BREAK)return this;return this},c.map=function(b,c){var d=[];return c=c||a,this.forEach(function(a,e){d[e]=b.call(c,a,e)}),d},c.setValue=function(a){return Mb.wait(),f(this),this.push.apply(this,a),Mb.signal(),this},c.item=function(a,b){return 0===arguments.length?this.toArray():1===arguments.length?d(this,a):arguments.length>1?e(this,a,b):void 0},c.destroy=function(a){f(this,a),this.$len.destroy(a)},c.length=function(){return this.$len.get()},c.push=function(){var a,b=arguments.length,c=this._value.length;for(Mb.wait(),a=0;b>a;a++)e(this,c+a,arguments[a]);return Mb.signal(),this.length()},c.pop=function(){var a,b=this._value.pop();return Mb.wait(),E(b)&&(a=b.get(),b.destroy()),h(this),Mb.signal(),a},c.toArray=function(){return this.map(_)},c.indexWhere=function(a,b){var c,d,e=this.length();for(b=b||this,c=0;e>c;c+=1)if(d=this._value[c],a.call(b,d.get(),c))return c;return-1},c.lastIndexWhere=function(a,b){var c,d,e=this.length();for(b=b||this,c=e-1;c>=0;c-=1)if(d=this._value[c],a.call(b,d.get(),c))return c;return-1},c.indexOf=function(a,b){b=b||this.$equality_check.get();var c=function(c){return b(c,a)};return this.indexWhere(c)},c.lastIndexOf=function(a,b){b=b||this.$equality_check.get();var c=function(c){return b(c,a)};return this.lastIndexWhere(c)},c.some=function(a,b){return this.indexWhere(a,b)>=0},c.every=function(a,c){var d=!0;return this.forEach(function(){return a.apply(c,arguments)?void 0:(d=!1,b.BREAK)}),d},c.splice=function(a,b){var c;if(T(b)||(b=0),!Pb(a)||!Pb(b))throw new Error("index and howmany must be positive integers");var f=g.call(arguments,2),i=f.length;Mb.wait();var j=i-b,k=eb(this._value.slice(a,a+b),function(a){return a?a.get():void 0});if(0>j){var l=this._value.length,m=a+i,n=l+j;for(c=a;m>c;c+=1)e(this,c,f[c-a]);for(;n>c;c+=1)e(this,c,d(this,c-j));for(;l>c;c+=1){var o=this._value.pop();E(o)&&o.destroy()}}else for(c=this._value.length+j-1;c>=a;c-=1)a+i>c?e(this,c,f[c-a]):e(this,c,d(this,c-j));return 0!==j&&h(this),Mb.signal(),k},c.shift=function(){var a=this.splice(0,1);return a[0]},c.unshift=function(){return this.splice.apply(this,[0,0].concat(ab(arguments))),this.length()},c.concat=function(){var a=eb(arguments,function(a){return F(a)?a.toArray():a}),b=this.toArray();return b.concat.apply(b,a)},c.slice=function(){var a=this._value.slice.apply(this._value,arguments);return eb(a,function(a){return a?a.get():void 0})},c.itemConstraint=function(a){return new B(function(){return this.item(Mb.get(a))},{context:this})},db(["filter","join","sort","reverse","toString"],function(a){c[a]=function(){var b=this.toArray();return b[a].apply(b,arguments)}})}(C),F=function(a){return a instanceof C},gb(Mb,{array:function(a){return new C(a)},ArrayConstraint:C,isArrayConstraint:F});var Qb=function(a){return a+""},Rb=function(a){return function(b){return b[a]()}};D=function(a){a=gb({hash:Qb,valuehash:!1,equals:ib,valueequals:ib,value:{},keys:[],values:[],literal_values:!1,create_unsubstantiated:!0},a),a.keys=L(a.keys),a.values=L(a.values);var b={};db(a.keys,function(a){b[a]=!0}),db(a.value,function(c,d){b[d]||(a.keys.push(d),a.values.push(c))},this),b=!1,this._default_literal_values=!!a.literal_values,this.$equality_check=new B(a.equals,{literal:!0}),this.$vequality_check=new B(a.valueequals,{literal:!0}),this._hash=W(a.hash)?Rb(a.hash):a.hash,this._create_unsubstantiated=a.create_unsubstantiated,this._khash={},a.valuehash?(this._vhash={},this._valuehash=V(a.valuehash)?a.valuehash:W(a.valuehash)?Rb(a.valuehash):Qb):this._vhash=!1;var c=this._default_literal_values;this._ordered_values=eb(a.keys,function(b,d){var e=a.values[d],f={key:new B(b,{literal:!0}),value:new B(e,{literal:c}),index:new B(d,{literal:!0})},g=this._hash(b),h=this._khash[g];if(h?h.push(f):this._khash[g]=[f],this._vhash){var i=this._valuehash(e),j=this._vhash[i];j?j.push(f):this._vhash[i]=[f]}return f},this),this._unsubstantiated_values={},this.$keys=new B(function(){var a=[];return this.forEach(function(b,c,d){a[d]=c}),a},{context:this}),this.$values=new B(function(){var a=[];return this.forEach(function(b,c,d){a[d]=b}),a},{context:this}),this.$entries=new B(function(){var a=[];return this.forEach(function(b,c,d){a[d]={key:c,value:b}}),a},{context:this}),this.$size=new B(function(){return this._ordered_values.length},{context:this})},function(a){a.BREAK=C.BREAK;var b=a.prototype,c=function(a,b,c,d){var e=this._hash(a),f={h:e,hv:!1,i:-1,ui:-1,uhv:!1},g=this.$equality_check.get(),h=function(b){return g(b.key.get(),a)},i=this._khash[e];if(i){var j=hb(i,h);if(f.hv=i,j>=0)return f.i=j,f}if(b!==!1){var k=this._unsubstantiated_values[e],l=-1;if(k&&(f.uhv=k,l=hb(k,h),l>=0))return f.ui=l,f;if(c===!0){var m=(this._default_literal_values,{key:new B(a,{literal:!0}),value:new B(void 0,{literal:void 0===d?this._default_literal_values:!!d}),index:new B(-1,{literal:!0})});k?(l=k.length,k[l]=m):(l=0,this._unsubstantiated_values[e]=k=[m])}f.uhv=k||!1,f.ui=l}return f},d=function(a,b,c,d,f){var g,h,i,j,k=a.i,l=a.hv,m=a.h;if(k>=0){if(j=l[k],this._vhash){var n=j.value.get(),o=this._valuehash(n),p=this._vhash[o];if(h=this._valuehash(c),p){var q=p.length;for(g=0;q>g;g+=1)if(p[g]===j){p.splice(g,1),0===p.length&&delete this._vhash[o];break}}i=this._vhash[h],i?i.push(j):this._vhash[h]=[j]}if(j.value.set(c),Pb(d)){var r=j.index.get();if(r!==d){this._ordered_values.splice(r,1),this._ordered_values.splice(d,0,j);var s=Math.min(r,d),t=Math.max(r,d);for(g=s;t>=g;g+=1)e(this._ordered_values[g],g);this.$keys.invalidate()}}}else{Pb(d)||(d=this._ordered_values.length);var u=a.ui;if(u>=0){var v=a.uhv,w=v[u];v.splice(u,1),0===v.length&&delete this._unsubstantiated_values[m],j=w}else j={key:new B(b,{literal:!0}),value:new B(c,{literal:void 0===f?this._default_literal_values:!!f}),index:new B(d,{literal:!0})};for(l?l.push(j):l=this._khash[m]=[j],this._vhash&&(h=this._valuehash(c),i=this._vhash[h],i?i.push(j):this._vhash[h]=[j]),this._ordered_values.splice(d,0,j),u>=0&&(j.value.set(c),j.index.set(d)),g=d+1;g<this._ordered_values.length;g+=1)e(this._ordered_values[g],g);this.$size.invalidate(),this.$keys.invalidate()}this.$values.invalidate(),this.$entries.invalidate()},e=function(a,b){a.index.set(b)},f=function(a,b){db(a,function(a){a.key.destroy(b),a.value.destroy(b),a.index.destroy(b)})},g=function(a,b){this._ordered_values[a];f(this._ordered_values.splice(a,1),b),b!==!0&&this.$size.invalidate()};b.keys=function(){return this.$keys.get()},b.values=function(){return this.$values.get()},b.entries=function(){return this.$entries.get()},b.size=function(){return this.$size.get()},b.isEmpty=function(){return 0===this.size()},b.put=function(a,b,e,f){Mb.wait();var g=c.call(this,a,!0,!1,f);return d.call(this,g,a,b,e,f),Mb.signal(),this},b.remove=function(a,b){var d,f,h,i,j,k=c.call(this,a,!1,!1),l=k.i,m=k.hv;if(l>=0){if(Mb.wait(),f=m[l],h=f.index.get(),m.splice(l,1),0===m.length&&delete this._khash[k.h],this._vhash&&(i=this._valuehash(f.value.get()),j=this._vhash[i])){var n=j.length;for(d=0;n>d;d+=1)if(j[d]===f){j.splice(d,1),0===j.length&&delete this._vhash[i];break}}for(g.call(this,h,b),d=h;d<this._ordered_values.length;d+=1)e(this._ordered_values[d],d);b||(this.$size.invalidate(),this.$keys.invalidate(),this.$values.invalidate(),this.$entries.invalidate()),Mb.signal()}return this},b.get=function(a){var b=c.call(this,a,!0,this._create_unsubstantiated),d=b.i,e=b.hv;if(d>=0){var f=e[d];return f.value.get()}if(this._create_unsubstantiated){var g=b.uhv[b.ui];return g.value.get()}return void 0},b.item=function(a,b,c){return 0===arguments.length?this.toObject():1===arguments.length?this.get(a):this.put(a,b,c)},b.itemConstraint=function(a){return new B(function(){return this.get(Mb.get(a))},{context:this})},b.clear=function(a){if(this.size()>0){for(Mb.wait();this._ordered_values.length>0;)g.call(this,0,a);db(this._khash,function(a,b){delete this._khash[b]},this),this._vhash&&db(this._vhash,function(a,b){delete this._vhash[b]},this),a||(this.$keys.invalidate(),this.$values.invalidate(),this.$entries.invalidate(),this.$size.invalidate()),Mb.signal()}return this},b.forEach=function(b,c){var d,e,f=this.size(),g=this._ordered_values.slice();for(c=c||this,d=0;f>d&&(e=g[d],!e||b.call(c,e.value.get(),e.key.get(),e.index.get())!==a.BREAK);d+=1);return this},b.setEqualityCheck=function(a){return this.$equality_check.set(a),this},b.setValueEqualityCheck=function(a){return this.$vequality_check.set(a),this},b.setHash=function(a){Mb.wait(),this._hash=W(a)?Rb(a):a,this._khash={},db(this._ordered_values,function(a){var b=a.key.get(),c=this._hash(b),d=this._khash[c];d?d.push(a):this._khash[c]=[a]},this);var b={};return db(this._unsubstantiated_values,function(a){db(a,function(a){var c=a.key.get(),d=this._hash(c),e=this.new_unsubstatiated_values[d];e?e.push(a):b[d]=[a]},this)},this),this._unsubstantiated_values=b,Mb.signal(),this},b.setValueHash=function(a){return this._valuehash=W(a)?Rb(a):a,this._vhash={},this._valuehash&&db(this._ordered_values,function(a){var b=a.value.get(),c=this._valuehash(b),d=this._vhash[c];d?d.push(a):this._vhash[c]=[a]},this),this},b.indexOf=function(a){var b=c.call(this,a,!0,this._create_unsubstantiated),d=b.i,e=b.hv;if(d>=0){var f=e[d];return f.index.get()}if(b.ui>=0){var g=b.uhv[b.ui];return g.index.get()}return-1},b.getOrPut=function(a,b,e,f,g){{var h,i,j,k=c.call(this,a,!0,!1,g),l=k.i,m=k.hv;k.h}return l>=0?(j=m[l],j.value.get()):(Mb.wait(),h=e||this,i=b.call(h,a),d.call(this,k,a,i,f,g),Mb.signal(),i)},b.has=function(a){var b=c.call(this,a,!0,this._create_unsubstantiated),d=b.i;if(d>=0)return!0;if(this._create_unsubstantiated){var e=b.uhv[b.ui];return e.index.get(),!1}return!1},b.moveIndex=function(a,b){var c;Mb.wait();var d=this._ordered_values[a];this._ordered_values.splice(a,1),this._ordered_values.splice(b,0,d);var f=Math.min(a,b),g=Math.max(a,b);for(c=f;g>=c;c+=1)e(this._ordered_values[c],c);return this.$keys.invalidate(),this.$values.invalidate(),this.$entries.invalidate(),Mb.signal(),this},b.move=function(a,b){var d=c.call(this,a,!1,!1),e=d.i;if(e>=0){var f=d.hv[e];this.moveIndex(f.index.get(),b)}return this},b.keyForValue=function(b,c){c=c||this.$vequality_check.get();var d;if(this._vhash){var e=this._valuehash(b),f=this._vhash[e];if(f){var g=f.length;for(d=0;g>d;d+=1){var h=f[d];if(c(h.value.get(),b))return h.key.get()}}return void 0
}var i;return this.forEach(function(d,e){return c(b,d)?(i=e,a.BREAK):void 0}),i},b.destroy=function(a){Mb.wait(),this.clear(a),this.$equality_check.destroy(a),this.$vequality_check.destroy(a),this.$keys.destroy(a),this.$values.destroy(a),this.$entries.destroy(a),this.$size.destroy(a),Mb.signal()},b.toObject=function(a){var b={};return a=a||_,this.forEach(function(c,d){b[a(d)]=c}),b}}(D),G=function(a){return a instanceof D},gb(Mb,{map:function(a,b){return new D(a,b)},MapConstraint:D,isMapConstraint:G}),gb(Mb,{liven:function(b,c){c=gb({context:a,run_on_create:!0,pause_while_running:!1,priority:!1,on_destroy:!1},c);var d,e=new B(b,{context:c.context,cache_value:!1,auto_add_outgoing_dependencies:!1,run_on_add_listener:!1}),f=!1,g=function(){e.invalidate()},h=function(a){c.on_destroy&&c.on_destroy.call(c.context,a),e.destroy(a)},i=function(){return f===!1?(f=!0,e.offChange(d),!0):!1},j=function(){return f===!0?(f=!1,e.onChangeWithPriority(c.priority,d),c.run_on_create!==!1&&(Ob.semaphore>=0?e.get(!1):db(e._changeListeners,Ob.add_in_call_stack,Ob)),!0):!1};d=function(){c.pause_while_running&&i(),e.get(),c.pause_while_running&&j()},e.onChangeWithPriority(c.priority,d);var k={destroy:h,pause:i,resume:j,run:function(a){return d(a),this},invalidate:g,_constraint:e};return c.run_on_create!==!1&&(Ob.semaphore>=0?e.get(!1):db(e._changeListeners,Ob.add_in_call_stack,Ob)),k}});var Sb=function(){var a,b=arguments.length,c="";for(a=0;b>a;a+=1)c+=arguments[a];return c},Tb=function(a,b){var c,d=a.length;if(d===b.length){for(c=0;d>c;c+=1){var e=a[c],f=b[c];if(e!==f)return!1}return!0}return!1};gb(Mb,{memoize:function(b,c){c=gb({hash:Sb,equals:Tb,context:a,literal_values:!0},c),c.args_map=new D({hash:c.hash,equals:c.equals,literal_values:c.literal_values});var d=function(){var a=g.call(arguments),d=c.args_map.getOrPut(a,function(){return new B(function(){return b.apply(c.context,a)})});return d.get()};return d.destroy=function(a){c.args_map.forEach(function(b){b.destroy(a)}),c.args_map.destroy(a)},d.each=function(a){c.args_map.forEach(a)},d.options=c,d}});var Ub=function(a){if(Z(a))return a;var b=w.createTextNode(a);return b},Vb=function(a,b,c){var d=b.childNodes;if(d.length<=c)b.appendChild(a);else{var e=d[c];b.insertBefore(a,e)}},Wb=function(a,b){var c,d=a.childNodes;return d.length>b?(c=d[b],a.removeChild(c),c):void 0},Xb=function(a,b,c){var d=a.childNodes;if(d.length>c){var e=d[c];return a&&(b>c&&b++,Vb(e,a,b)),e}},Yb=function(b){return cb(a,"jQuery")?b instanceof a.jQuery:!1},Zb=a.NodeList||!1,$b=Zb?function(a){return a instanceof Zb}:function(){return!1},_b=function(b){return U(b)?b:E(b)?_b(b.get()):F(b)?b.toArray():G(b)?b.values():Yb(b)?a.jQuery.makeArray(b):$b(b)?ab(b):[b]},ac=function(a){this.options=a,this.targets=a.targets;var b,c,d=a.setter,e=a.getter,f=a.init_val,g=function(){this._timeout_id=!1;var e=fb(_b(this.targets),Z);cb(a,"onChange")&&a.onChange.call(this,b,c),db(e,function(a){d.call(this,a,b,c)},this),c=b};this._throttle_delay=!1,this._timeout_id=!1,c=V(f)?f(_b(this.targets[0])):f,this.$live_fn=Mb.liven(function(){b=e(),this._throttle_delay?this._timeout_id||(this._timeout_id=x(t(g,this),this._throttle_delay)):g.call(this)},{context:this})};!function(a){var b=a.prototype;b.pause=function(){return this.$live_fn.pause(),this},b.resume=function(){return this.$live_fn.resume(),this},b.throttle=function(a){return this._throttle_delay=a>0?a:!1,this._timeout_id&&!this._throttle_delay&&(y(this._timeout_id),this._timeout_id=!1),this.$live_fn.run(),this},b.destroy=function(){this.$live_fn.destroy(),this.options.onDestroy&&this.options.onDestroy(),this.options.coreDestroy&&this.options.coreDestroy()}}(ac);var bc=function(a,b,c){return function(d){var e=g.call(arguments,1),f=Mb(function(){return a(e)}),h=new ac({targets:d,getter:t(f.get,f),setter:b,init_val:c,coreDestroy:function(){f.destroy()}});return h}},cc=function(a){return bc(function(a){return eb(a,Mb.get).join("")},function(b,c){a(b,c)})},dc=function(a){return function(b){var c,d=g.call(arguments,1);if(0!==d.length){1===d.length?c=d[0]:d.length>1&&(c={},c[d[0]]=d[1]);var e=new ac({targets:b,setter:function(b,c){db(c,function(c,d){a(b,d,c)})},getter:function(){if(G(c))return c.toObject();var a={};return db(c,function(b,c){a[c]=Mb.get(b)}),a}});return e}}},ec=cc(function(a,b){c(a,b)}),fc=cc(function(a,b){a.innerHTML=b}),gc=cc(function(a,b){a.val=b}),hc=bc(function(a){return S(eb(a,Mb.get),!0)},function(a,b,c){var d=Gb(c,b),e=" "+a.className+" ";db(d.removed,function(a){e=e.replace(" "+a.from_item+" "," ")}),e+=eb(d.added,function(a){return a.item}).join(" "),e=v(e),a.className=e},[]),ic=bc(function(a){var b=eb(a,Mb.get);return eb(S(b,!0),Ub)},function(a,b,c){var d=Gb(c,b);db(d.removed,function(b){var c=Wb(a,b.from);this.options.onRemove&&this.options.onRemove.call(this,c,b.from)},this),db(d.added,function(b){var c=b.item;Vb(c,a,b.to),this.options.onAdd&&this.options.onAdd.call(this,c,b.to)},this),db(d.moved,function(b){var c=Xb(a,b.to_index,b.from_index);this.options.onMove&&this.options.onMove.call(this,c,b.to_index,b.from_index)},this),this.options.onIndexChange&&db(d.index_changed,function(a){this.options.onIndexChange.call(this,a.item,a.to,a.from)},this)},function(a){return ab(a.childNodes)}),jc=dc(function(a,b,c){a.style[Kb(b)]=c}),kc=dc(function(a,b,c){Qc[b]&&!c?a.removeAttribute(b):a.setAttribute(b,c)}),lc=["keyup","input","paste","propertychange","change"],mc=function(a){var b;Y(a)?(a=[a],b=!1):b=!0;var c=Mb(function(){return b?eb(a,function(a){return a.value}):a[0].value}),d=(a.length,t(c.invalidate,c)),e=function(){db(lc,function(b){db(a,function(a){H(a,b,d)})})},f=function(){db(lc,function(b){db(a,function(a){I(a,b,d)})})},g=c.destroy;return c.destroy=function(){f(),g.call(c)},e(),c};gb(Mb,{bindText:ec,bindHTML:fc,bindValue:gc,bindChildren:ic,bindAttr:kc,bindCSS:jc,bindClass:hc,inputValue:mc,Binding:ac});var nc=function(a,b){this._fsm=a,this._name=b,this._id=K()};!function(a){var b=a.prototype;b.getName=function(){return this._name},b.id=function(){return this._id}}(nc);var oc=function(a,b,c,d){this._fsm=a,this._from=b,this._to=c,this._name=d,this._id=K(),this._event=!1};!function(a){var b=a.prototype;b.getFrom=function(){return this._from},b.getTo=function(){return this._to},b.getName=function(){return this._name},b.getFSM=function(){return this._fsm},b.id=function(){return this._id},b.destroy=function(){var a=this._event;a&&a._removeTransition(this),delete this._event,delete this._fsm,delete this._from,delete this._to},b.setEvent=function(a){this._event=a},b.run=function(){var a=this.getFSM();if(a&&a.is(this.getFrom())){var b=ab(arguments);b.unshift(this.getTo(),this),a._setState.apply(a,b)}}}(oc);var pc=function(a){this._state_name=a};!function(a){var b=a.prototype;b.matches=function(a){return this._state_name===a||a instanceof nc&&this._state_name===a.getName()}}(pc);var qc=function(){};!function(a){var b=a.prototype;b.matches=function(a){return!(a instanceof oc)}}(qc);var rc=function(a,b,c){this.is_pre=a,this.from_state_selector=b,this.to_state_selector=c};!function(a){var b=a.prototype;b.matches=function(a,b){if(a instanceof oc&&this.is_pre===b){var c=a.getFrom(),d=a.getTo();return this.from_state_selector.matches(c)&&this.to_state_selector.matches(d)}return!1}}(rc);var sc=function(){this.selectors=ab(arguments)};!function(a){var b=a.prototype;b.matches=function(){var a=arguments;return O(this.selectors,function(b){return b.matches.apply(b,a)})}}(sc);var tc=function(a){return"*"===a?new qc:new pc(a)},uc=function(a){var b=eb(a.split(","),function(a){return v(a)});if(1===b.length)return tc(b[0]);var c=eb(b,tc);return new sc(c)},vc=function(a,b,c){var d,e,f=uc(a),g=uc(c);return"<->"===b?(d=new rc(!1,f,g),e=new rc(!1,g,f),new sc(d,e)):">-<"===b?(d=new rc(!0,f,g),e=new rc(!0,g,f),new sc(d,e)):"->"===b?new rc(!1,f,g):">-"===b?new rc(!0,f,g):"<-"===b?new rc(!1,g,f):"-<"===b?new rc(!0,g,f):null},wc=/^([\sa-zA-Z0-9,\-_*]+)((<->|>-<|->|>-|<-|-<)([\sa-zA-Z0-9,\-_*]+))?$/,xc=function(a){var b=a.match(wc);if(null===b)return null;if(b[2]){var c=b[1],d=b[3],e=b[4];return vc(c,d,e)}var f=b[1];return uc(f)},yc=0,zc=function(b,c,d){this._context=d||a,this._selector=b,this._callback=c,this._id=yc++};!function(a){var b=a.prototype;b.interested_in=function(){return this._selector.matches.apply(this._selector,arguments)},b.run=function(){this._callback.apply(this._context,arguments)}}(zc);var Ac=function(){this._states={},this._transitions=[],this._curr_state=null,this._listeners=[],this._chain_state=null,this._did_transition=!1,this.state=Mb(function(){return this._curr_state?this._curr_state._name:null},{context:this}),this.addState.apply(this,S(arguments,!0))};!function(a){var b=a.prototype,c=function(a,b){return a._states[b]};b.addState=function(){var a;return db(arguments,function(b){a=c(this,b),a||(a=this._states[b]=new nc(this,b),null===this._curr_state&&(this._curr_state=a))},this),a&&(this._chain_state=a),this},b.getState=function(){return this.state.get()},b.addTransition=function(a,b,c){var d,e,f,g,h=!1;if(0===arguments.length)throw new Error("addTransition expects at least one argument");return 1===arguments.length?(h=!0,d=this._chain_state,e=a):2===arguments.length?V(b)||b instanceof Bc?(d=this._chain_state,e=a,g=b):(d=a,e=b,h=!0):(d=a,e=b,g=c),W(d)&&!cb(this._states,d)&&(this._states[d]=new nc(this,d)),W(e)&&!cb(this._states,e)&&(this._states[e]=new nc(this,e)),f=new oc(this,d,e),this._transitions.push(f),h?t(f.run,f):(g instanceof Bc?(g._addTransition(f),f.setEvent(g)):g.call(this,t(f.run,f),this),this)},b._setState=function(a,b,d){var e=this.getState(),f=W(a)?c(this,a):a,g=this._listeners.length>0?[d,b,f,e].concat(P(arguments,3)):!1;if(!f)throw new Error("Could not find state '"+a+"'");this.did_transition=!0,db(this._listeners,function(a){a.interested_in(b,!0)&&a.run.apply(a,g)}),this._curr_state=f,this.state.invalidate(),db(this._listeners,function(a){(a.interested_in(b,!1)||a.interested_in(f))&&a.run.apply(a,g)})},b.destroy=function(){this.state.destroy(),this._states={},db(this._transitions,function(a){a.destroy()}),this._transitions=[],this._curr_state=null},b.startsAt=function(a){var b=c(this,a);return b||(b=this._states[a]=new nc(this,a)),this.did_transition||(this._curr_state=b,this.state.invalidate()),this._chain_state=b,this},b.is=function(a){var b=this.getState();return null===b?!1:b===(W(a)?a:a.getName())},b.on=b.addEventListener=function(a,b,c){var d;if(W(a)){if(d=xc(a),null===d)throw new Error("Unrecognized format for state/transition spec.")}else d=a;var e=new zc(d,b,c);return this._listeners.push(e),this},b.off=b.removeEventListener=function(a){return this._listeners=fb(this._listeners,function(b){return b.callback!==a}),this}}(Ac),gb(Mb,{FSM:Ac,fsm:function(){return new Ac(arguments)},isFSM:function(a){return a instanceof Ac}});var Bc=function(a,b,c,d){this._listeners=[],this._transitions=[],this._on_add_transition=c,this._on_remove_transition=d,this._live_fns={},this._parent=a,this._parent&&this._parent._listeners.push({event:this,filter:b})};!function(b){var c=b.prototype;c.guard=function(a,b){if(!V(a)){var c=a;a=function(a){return a&&a[c]===b}}return new Bc(this,a)},c._addTransition=function(a){this._transitions.push(a),this._on_add_transition&&(this._live_fns[a.id()]=this._on_add_transition(a)),this._parent&&this._parent._on_add_transition&&this._parent._on_add_transition(a)},c._removeTransition=function(a){if(kb(this._transitions,a)&&this._on_remove_transition){this._on_remove_transition(a);var b=a.id();this._live_fns[b].destroy(),delete this._live_fns[b]}this._parent&&this._parent._on_remove_transition&&this._parent._on_remove_transition(a)},c._fire=function(){var b=arguments;db(this._transitions,function(a){a.run.apply(a,b)}),db(this._listeners,function(c){var d=c.event,e=c.filter;(!e||e.apply(a,b))&&d._fire.apply(d,b)})}}(Bc);var Cc=function(b){return b===a||Ld(b)},Dc=function(a){return eb(a.split(" "),v)},Ec="timeout";gb(Mb,{CJSEvent:Bc,on:function(b){var c=arguments.length>1?P(arguments):a,d=new Bc(!1,!1,function(a){var d=[],e=!1,f=[],g=t(this._fire,this),h=a.getFSM(),i=a.getFrom(),j=new pc(i),k=new rc(!0,j,new qc),l=function(){db(f,function(a){if(a===Ec){e&&(y(e),e=!1);var b=Mb.get(c[0]);(!T(b)||0>b)&&(b=0),e=x(g,b)}else db(d,function(b){H(b,a,g)})})},m=function(){db(f,function(a){db(d,function(b){a===Ec?e&&(y(e),e=!1):I(b,a,g)})})},n=Mb.liven(function(){m(),f=Dc(Mb.get(b)),d=S(eb(fb(_b(c),Cc),Nd,!0)),h.on(j,l).on(k,m),h.is(i)&&l()});return n});return d}});var Fc=function(a){var b={};return db(a.split(","),function(a){b[a]=!0}),b},Gc=/^<([\-A-Za-z0-9_]+)((?:\s+[a-zA-Z0-9_\-]+(?:\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^>\s]+)))?)*)\s*(\/?)>/,Hc=/^<\/([\-A-Za-z0-9_]+)[^>]*>/,Ic=/^\{\{([#=!>|{\/])?\s*((?:(?:"[^"]*")|(?:'[^']*')|[^\}])*)\s*(\/?)\}?\}\}/,Jc=/([\-A-Za-z0-9_]+)(?:\s*=\s*(?:(?:"((?:\\.|[^"])*)")|(?:'((?:\\.|[^'])*)')|([^\/>\s]+)))?/g,Kc="hb",Lc="html",Mc=Fc("area,base,basefont,br,col,frame,hr,img,input,isindex,link,meta,param,embed"),Nc=Fc("address,applet,blockquote,button,center,dd,del,dir,div,dl,dt,fieldset,form,frameset,hr,iframe,ins,isindex,li,map,menu,noframes,noscript,object,ol,p,pre,script,table,tbody,td,tfoot,th,thead,tr,ul"),Oc=Fc("a,abbr,acronym,applet,b,basefont,bdo,big,br,button,cite,code,del,dfn,em,font,i,iframe,img,input,ins,kbd,label,map,object,q,s,samp,script,select,small,span,strike,strong,sub,sup,textarea,tt,u,var"),Pc=Fc("colgroup,dd,dt,li,options,p,td,tfoot,th,thead,tr"),Qc=Fc("checked,compact,declare,defer,disabled,ismap,multiple,nohref,noresize,noshade,nowrap,readonly,selected"),Rc=Fc("script,style"),Sc="if",Tc="elif",Uc="else",Vc="state",Wc="each",Xc="with",Yc="fsm",Zc="unless",$c={};$c[Vc]={parent:[Yc]},$c[Tc]={parent:[Sc]},$c[Uc]={parent:[Sc,Wc]};var _c={};_c[Tc]={when_open_sibling:[Tc,Uc]},_c[Uc]={when_close_parent:[Sc,Wc],when_open_sibling:[]},_c[Vc]={when_open_sibling:[Vc]};var ad={};ad[Tc]={follows:[Tc],or_parent:[Sc]},ad[Uc]={follows:[Tc],or_parent:[Sc,Wc]},ad[Vc]={follows:[Vc],or_parent:[Yc]};var bd=function(a,b){function c(a,c,e,f){if(c=c.toLowerCase(),Nc[c])for(;n.last()&&Oc[n.last()];)d("",n.last());if(Pc[c]&&n.last()==c&&d("",c),f=Mc[c]||!!f,f||n.push({type:Lc,tag:c}),b.startHTML){var g=[];e.replace(Jc,function(a,b){var c=arguments[2]?arguments[2]:arguments[3]?arguments[3]:arguments[4]?arguments[4]:Qc[b]?b:"";g.push({name:b,value:c,escaped:c.replace(/(^|[^\\])"/g,'$1\\"')})}),b.startHTML(c,g,f)}}function d(a,b){g(b,Lc)}function e(){var a,b;for(a=n.length-1;a>=0;a--)if(b=n[a],b.type===Kc)return b;return void 0}function f(a,c,d){var f,h,i=re(d);switch(i.type===Ud?i.body.length>0&&i.body[0].type===Vd&&(h=i.body[0].name):i.type===Vd&&(h=i.name),c){case"{":b.startHB(h,i,!0,!0);break;case">":b.partialHB(h,i);break;case"#":if(f=e(),f&&cb(_c,f.tag)){var k=_c[f.tag];jb(k.when_open_sibling,h)>=0&&(g(f.tag,Kc),f=e())}if(cb($c,h)){var l=$c[h];if(!f||jb(l.parent,f.tag)<0)throw new Error("'"+h+"' must be inside of a '"+l.parent+"' block")}if(cb(ad,h)){var m=ad[h];if(jb(m.follows,j)<0&&(!m.or_parent||jb(m.or_parent,f.tag)<0)){var o="'"+h+"' must follow a '"+m.follows[0]+"'";throw m.or_parent&&(o+=" or be inside of a '"+m.or_parent[0]+"' tag"),new Error(o)}}n.push({type:Kc,tag:h}),b.startHB(h,i,!1);break;case"/":g(h,Kc);break;case"!":break;default:b.startHB(h,i,!0,!1)}}function g(a,c){var d,e,f;for(e=n.length-1;e>=0&&(n[e].type!==c||n[e].tag!==a);e-=1);if(e>=0){for(d=n.length-1;d>=e;d--)f=n[d],f.type===Kc?b.endHB&&b.endHB(f.tag):b.endHTML&&b.endHTML(f.tag);n.length=e}c===Kc&&(j=a)}var h,i,j,k,l,m,n=[],o=a;n.last=function(){return this[this.length-1]};for(var p=function(a,c){return c=c.replace(/<!--(.*?)-->/g,"$1").replace(/<!\[CDATA\[(.*?)\]\]>/g,"$1"),b.chars&&b.chars(c),""};a;){if(l=!0,n.last()&&Rc[n.last()])a=a.replace(new RegExp("(.*)</"+n.last()+"[^>]*>"),p),d("",n.last());else if(0===a.indexOf("<!--")?(k=a.indexOf("-->"),k>=0&&(b.HTMLcomment&&b.HTMLcomment(a.substring(4,k)),a=a.substring(k+3),l=!1)):0===a.indexOf("</")?(m=a.match(Hc),m&&(a=a.substring(m[0].length),m[0].replace(Hc,d),l=!1)):0===a.indexOf("<")?(m=a.match(Gc),m&&(a=a.substring(m[0].length),m[0].replace(Gc,c),l=!1)):0===a.indexOf("{{")&&(m=a.match(Ic),m&&(a=a.substring(m[0].length),m[0].replace(Ic,f),l=!1)),l){h=a.indexOf("<"),i=a.indexOf("{{"),k=0>h?i:0>i?h:Math.min(h,i);var q=0>k?a:a.substring(0,k);a=0>k?"":a.substring(k),b.chars(q)}if(a==o)throw new Error("Parse Error: "+a);o=a}d()},cd=function(a){var b={children:[],type:id},c=[b],d=!1,e=[],f=[];return bd(a,{startHTML:function(a,b,e){d={type:Lc,tag:a,attributes:b,unary:e,children:[]},N(c).children.push(d),e||c.push(d)},endHTML:function(){d=c.pop()},HTMLcomment:function(a){d={type:jd,str:a},N(c).children.push(d)},chars:function(a){d={type:hd,str:a},N(c).children.push(d)},startHB:function(a,b,g,h){if(g)d={type:gd,obj:pd(b),literal:h,tag:a},N(c).children.push(d);else{var i=!0;switch(d={type:Kc,tag:a,children:[]},a){case Wc:d.parsed_content=qd(b),d.else_child=!1;break;case Zc:case Sc:d.reverse=a===Zc,d.sub_conditions=[],d.condition=qd(b),f.push(d);break;case Tc:case Uc:var j=N(c);j.type===Kc&&j.tag===Wc?j.else_child=d:N(f).sub_conditions.push(d),d.condition=a===Uc?od:qd(b),i=!1;break;case Wc:case Yc:d.fsm_target=qd(b),d.sub_states={},e.push(d);break;case Vc:var k=b.body[1].name;N(e).sub_states[k]=d,i=!1;break;case Xc:d.content=qd(b)}i&&N(c).children.push(d),c.push(d)}},endHB:function(a){switch(a){case Sc:case Zc:f.pop();break;case Yc:e.pop()}c.pop()},partialHB:function(a,b){d={type:fd,tag:a,content:qd(b)},N(c).children.push(d)}}),b},dd=function(a){return a.type===gd&&a.literal},ed=function(a){return O(a,dd)},fd="partial_hb",gd="unary_hb",hd="chars",id="root",jd="comment",kd="data-cjs-template-instance",ld=function(a){return a.outerHTML||function(a){var b,c=document.createElement("div");return c.appendChild(a.cloneNode(!0)),b=c.innerHTML,c=null,b}(a)},md=function(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")},nd=function(a,b,c,d){return a?a[b.computed?sd(b,c,d):b.name]:void 0},od={},pd=function(a){return a.type===Ud?a.body[0]:a},qd=function(a){return{type:Ud,body:a.type===Ud?P(a.body):[]}},rd=function(a){return a.node||a.getNodes()},sd=function(b,c,d){var e,f,g,h,i,j,k;if(b)switch(b.type){case Yd:return Mb.get(N(d).this_exp);case Xd:return b.value;case $d:return e=z[b.operator],e?e(sd(b.argument,c,d)):void 0;case _d:case ae:return e=A[b.operator],e?e(sd(b.left,c,d),sd(b.right,c,d)):void 0;case Vd:if("@"===b.name.charAt(0)){for(j=b.name.slice(1),k=d.length-1;k>=0;k--)if(f=d[k].at,f&&cb(f,j)){i=f[j];break}}else i=c[b.name];return E(i)?i.get():i;case Wd:return f=sd(b.object,c,d),nd(f,b.property,c,d);case Ud:return sd(b.body[0],c,d);case ee:return f=N(d).this_exp,nd(f,b.argument,c,d);case de:return f=d&&d.length>1?d[d.length-2].this_exp:void 0,nd(f,b.argument,c,d);case be:return sd(b.test,c,d)?sd(b.consequent,c,d):sd(b.alternate,c,d);case Zd:if(b.callee.type===Wd?(g=sd(b.callee.object,c,d),f=nd(g,b.callee.property,c,d)):(g=a,f=sd(b.callee,c,d)),f&&V(f))return h=eb(b.arguments,function(a){return sd(a,c,d)}),f.apply(g,h)}},td=function(a){return md(3===a.nodeType?b(a):ld(a))},ud=function(a,b,c){return Mb(function(){return eb(a,function(a){if(a.type===gd)return a.literal?sd(a.val,b,c):md(sd(a.val,b,c)+"");var d=rd(a);return U(d)?eb(d,td).join(""):td(d)}).join("")})},vd=function(a){return Mb(function(){var b=[];return db(a,function(a){var c=rd(a);U(c)?b.push.apply(b,c):b.push(c)}),b})},wd=/^\{\{([^\}]+)\}\}/,xd=function(a,b,c){for(var d,e,f,g=!1,h=!1,i=[],j=0,k=!1;a.length>0;){if(d=a.indexOf("{"),0===d){if(e=a.match(wd)){i[j++]=Mb(u(sd,re(e[1]),b,c)),a=a.substr(e[0].length),k=!1,g=!0;continue}d++}0>d&&(d=a.length),f=a.substr(0,d),a=a.substr(d),k?i[j-1]=i[j-1]+f:i[j++]=f,h=k=!0}return g?h||1!==i.length?Mb(function(){return eb(i,function(a){return E(a)?a.get():F(a)?a.join(" "):""+a}).join("")}):i[0]:i.join("")},yd={},zd=function(a,b){return a===b||a&&a.is_obj===yd&&a.key===b.key&&a.value===b.value},Ad=/^(data-)?cjs-out$/,Bd=/^(data-)?cjs-on-(\w+)$/,Cd=function(a,b){var c=P(arguments,2);db(a,function(a){cb(a,b)&&a[b].apply(a,c)})},Dd=function(a){Cd.apply(this,[a,"pause"].concat(P(arguments)))},Ed=function(a){Cd.apply(this,[a,"resume"].concat(P(arguments)))},Fd=function(a){Cd.apply(this,[a,"destroy"].concat(P(arguments)))},Gd=function(a){Cd.apply(this,[a,"onAdd"].concat(P(arguments)))},Hd=function(a){Cd.apply(this,[a,"onRemove"].concat(P(arguments)))},Id=function(b,c,d,e){var f,g,h,i=b.type;if(i===hd)return{type:i,node:w.createTextNode(b.str)};if(i===id||i===Lc){var j,k,l=arguments,m=[];if(f=eb(b.children,function(a){return Id(a,c,d)}),i===id)if(e)g=e;else{if(1===f.length&&b.children[0].type===Lc)return f[0];g=w.createElement("span")}else g=w.createElement(b.tag);if(db(b.attributes,function(a){var b=a.name,e=a.value;if(b.match(Ad))m.push(c[e]=mc(g));else if(j=b.match(Bd)){var f=j[2];H(g,f,t(c[e],Mb.get(N(d).this_exp)))}else{var h=xd(e,c,d);if(E(h))if("class"===a.name){var i=Mb(function(){var a=h.get();return a.split(" ")});m.push(h,i,hc(g,i))}else m.push(h,kc(g,b,h));else g.setAttribute(a.name,h)}}),ed(b.children)){var n=ud(f,c,d);k=fc(g,n),m.push(n,k)}else{var o=vd(f,l);k=ic(g,o),m.push(o,k)}return{node:g,type:i,onAdd:function(){Ed(m),Gd(f)},onRemove:function(){Dd(m),Hd(f)},pause:function(){Dd(f.concat(m))},resume:function(){Ed(f.concat(m))},destroy:function(){Fd(f.concat(m))}}}if(i===gd){var p,q,r=b.obj,s=Mb(function(){return sd(r,c,d)});if(!b.literal){var u=Mb.get(s);Ld(u)?p=Md(u):(p=w.createTextNode(""+u),q=ec(p,s))}return{type:i,literal:b.literal,val:r,node:p,destroy:function(){q&&q.destroy(!0),s.destroy(!0)},pause:function(){q&&q.pause()},resume:function(){q&&q.resume()},onRemove:function(){this.pause()},onAdd:function(){this.resume()}}}if(i===Kc){var v=b.tag;if(v===Wc){var x,y=[],z=[];return h=[],{type:i,onRemove:function(){db(h,Hd)},onAdd:function(){db(h,Gd)},pause:function(){db(h,Dd)},resume:function(){db(h,Ed)},destroy:function(){db(h,Fd),h=[]},getNodes:function(){x=sd(b.parsed_content,c,d),F(x)&&(x=x.toArray()),U(x)?0===x.length&&b.else_child&&(x=[od]):G(x)?(x=x.entries(),db(x,function(a){a.is_obj=yd})):(E(x)&&(x=x.get()),x=eb(x,function(a,b){return{key:b,value:a,is_obj:yd}}));var a=Gb(y,x,zd),e=[],f=[];y=x,db(a.index_changed,function(a){var b=z[a.from];b&&b.at&&b.at.index&&b.at.index.set(a.to)}),db(a.removed,function(a){var b=a.from,c=z[b];f.push.apply(f,h[b]),lb(h,b),c&&c.at&&db(c.at,function(a){a.destroy(!0)})}),db(a.added,function(a){var f=a.item,g=a.to,i=f===od,j=i?!1:f&&f.is_obj===yd?{this_exp:f.value,at:{key:Mb.constraint(f.key)}}:{this_exp:f,at:{index:Mb.constraint(g)}},k=i?d:d.concat(j),l=i?b.else_child.children:b.children,m=eb(l,function(a){return Id(a,c,k)});h.splice(g,0,m),z.splice(g,0,j),e.push.apply(e,m)},this),db(a.moved,function(a){var b=a.from_index,c=a.to_index,d=(mdom[b],h[b]),e=z[b];lb(h,b),h.splice(c,0,d),lb(z,b),z.splice(c,0,e)}),Hd(f),Fd(f),Gd(e);var g=eb(h,function(a){var b=S(eb(a,function(a){return rd(a)}),!0);return b});return S(g,!0)}}}if(v===Sc||v===Zc){f=[],h=[];var A=-1;return{type:i,onRemove:function(){Hd(h)},onAdd:function(){Gd(h)},pause:function(){Dd(h)},resume:function(){Ed(h)},destroy:function(){A>=0&&(h=[],A=-1),db(f,Fd)},getNodes:function(){var a,e,g=b.sub_conditions.length,i=!!Mb.get(sd(b.condition,c,d)),j=!1;if(b.reverse&&(i=!i),i)a=0,j=b.children;else if(g>0)for(a=0;g>a;a++)if(i=b.sub_conditions[a],i.condition===od||sd(i.condition,c,d)){j=i.children,a++;break}return A!==a&&Hd(h),j?(f[a]?h=f[a]:(j=0===a?b.children:b.sub_conditions[a-1].children,h=f[a]=eb(j,function(a){return Id(a,c,d)})),e=S(eb(h,rd),!0)):e=h=[],A!==a&&Gd(h),A=a,e}}}if(v===Yc){var B={},C=!1;return h=[],{pause:function(){Dd(h)},resume:function(){Ed(h)},destroy:function(){C&&(Fd(h),h=[],C=!1)},onRemove:function(){this.pause()},onAdd:function(){this.resume()},type:i,getNodes:function(){var a,e=sd(b.fsm_target,c,d),f=e.getState(),g=function(a){return Id(a,c,d)},i=[];C!==f&&Hd(h);for(a in b.sub_states)if(b.sub_states.hasOwnProperty(a)&&f===a){cb(B,a)||(B[a]=eb(b.sub_states[a].children,g)),h=B[a],i=S(eb(h,rd),!0);break}return C!==f&&Gd(h),C=f,i}}}if(v===Xc){var D=sd(b.content,c,d),I=d.concat({this_exp:D});return f=S(eb(b.children,function(a){return Id(a,D,I)})),{pause:function(){Dd(f)},resume:function(){Ed(f)},onRemove:function(){Hd(f)},onAdd:function(){Gd(f)},destroy:function(){Fd(f)},node:S(eb(f,rd),!0)}}}else{if(i===fd){var J,K,L,M=b.content,O=function(){return M.type===Ud?eb(M.body,function(a){return sd(a,c,d)}):[sd(b.content,c,d)]},P=!1;if(cb(Jd,b.tag))J=Jd[b.tag],K=J.apply(a,O()),L=Td(K);else{if(!cb(Kd,b.tag))throw new Error("Could not find partial with name '"+b.tag+"'");J=Kd[b.tag],L=J.apply(a,O()),K=L.node,P=!0}return{node:K,pause:function(){L&&L.pause(K)},destroy:function(){P?L.destroy(K):Mb.destroyTemplate(K)},onAdd:function(){L&&L.onAdd.apply(L,[K].concat(O()))},onRemove:function(){L&&L.onRemove(K)},resume:function(){L&&L.resume(K)}}}if(i===jd)return{node:w.createComment(b.str)}}return{node:[]}},Jd={},Kd={},Ld=function(a){return Yb(a)||$b(a)||Z(a)},Md=function(a){return Yb(a)||$b(a)?a[0]:Z(a)?a:!1},Nd=function(a){return Yb(a)||$b(a)?ab(a):a},Od=[],Pd=[],Qd=1,Rd=function(a,b){var c=this,d=Id(c,a,[{this_exp:a}],Md(b)),e=d.node,f=d.id=Qd++;return Pd[f]=d,Od[f]=e,e.setAttribute(kd,f),e},Sd=function(a){var b=a.getAttribute(kd);return b||(b=jb(Od,a)),b},Td=function(a){var b=Sd(a);return b>=0?Pd[b]:!1};gb(Mb,{createTemplate:function(a){W(a)||(a=Yb(a)||$b(a)?a.length>0?v(b(a[0])):"":Y(a)?v(b(a)):""+a);var c=cd(a);return arguments.length>=2?Rd.apply(c,P(arguments)):t(Rd,c)},registerCustomPartial:function(a,b){return Kd[a]=function(){var a=Md(b.createNode.apply(this,arguments));return{node:a,onAdd:function(){b.onAdd&&b.onAdd.apply(this,arguments)},onRemove:function(){b.onRemove&&b.onRemove.apply(this,arguments)},destroy:function(){b.destroyNode&&b.destroyNode.apply(this,arguments)},pause:function(){b.pause&&b.pause.apply(this,arguments)},resume:function(){b.resume&&b.resume.apply(this,arguments)}}},this},registerPartial:function(a,b){return Jd[a]=b,this},unregisterPartial:function(a){return delete Jd[a],delete Kd[a],this},destroyTemplate:function(a){var b=Sd(Md(a)),c=b>=0?Pd[b]:!1;return c&&(delete Pd[b],c.destroy()),this},pauseTemplate:function(a){var b=Td(a);return b&&b.pause(),this},resumeTemplate:function(a){var b=Td(a);return b&&b.resume(),this},createParsedConstraint:function(a,b){var c=re(a);return c.type===Xd?c.value:Mb(function(){return sd(c,b,[b])})}});var Ud="Compound",Vd="Identifier",Wd="MemberExpression",Xd="Literal",Yd="ThisExpression",Zd="CallExpression",$d="UnaryExpression",_d="BinaryExpression",ae="LogicalExpression",be="ConditionalExpression",ce="Array",de="ParentExpression",ee="CurrLevelExpression",fe=46,ge=44,he=39,ie=34,je=40,ke=41,le=91,me=93,ne=63,oe=59,pe=58,qe=function(a,b){var c=new Error(a+" at character "+b);throw c.index=b,c.dedscription=a,c},re=function(){var a=!0,b={"-":a,"!":a,"~":a,"+":a},c={"||":1,"&&":2,"|":3,"^":4,"&":5,"==":6,"!=":6,"===":6,"!==":6,"<":7,">":7,"<=":7,">=":7,"<<":8,">>":8,">>>":8,"+":9,"-":9,"*":10,"/":10,"%":10},d=function(a){var b,c=0;for(var d in a)(b=d.length)>c&&a.hasOwnProperty(d)&&(c=b);return c},e=d(b),f=d(c),g={"true":!0,"false":!1,"null":null},h="this",i=function(a){return c[a]||0},j=function(a,b,c){var d="||"===a||"&&"===a?ae:_d;return{type:d,operator:a,left:b,right:c}},k=function(a){return a>=48&&57>=a},l=function(a){return 36===a||95===a||a>=65&&90>=a||64===a||a>=97&&122>=a},m=function(a){return 36===a||95===a||a>=65&&90>=a||a>=97&&122>=a||a>=48&&57>=a},n=function(a){for(var d,n,o=0,p=a.charAt,q=a.charCodeAt,r=function(b){return p.call(a,b)},s=function(b){return q.call(a,b)},t=a.length,u=function(){for(var a=s(o);32===a||9===a;)a=s(++o)},v=function(){var a,b,c=x();return u(),s(o)!==ne?c:(o++,a=v(),a||qe("Expected expression",o),u(),s(o)===pe?(o++,b=v(),b||qe("Expected expression",o),{type:be,test:c,consequent:a,alternate:b}):void qe("Expected :",o))},w=function(){u();for(var b=a.substr(o,f),d=b.length;d>0;){if(c.hasOwnProperty(b))return o+=d,b;b=b.substr(0,--d)}return!1},x=function(){var a,b,c,d,e,f,g,h;if(f=y(),b=w(),!b)return f;for(e={value:b,prec:i(b)},g=y(),g||qe("Expected expression after "+b,o),d=[f,e,g];(b=w())&&(c=i(b),0!==c);){for(e={value:b,prec:c};d.length>2&&c<=d[d.length-2].prec;)g=d.pop(),b=d.pop().value,f=d.pop(),a=j(b,f,g),d.push(a);a=y(),a||qe("Expected expression after "+b,o),d.push(e,a)}for(h=d.length-1,a=d[h];h>1;)a=j(d[h-1].value,d[h-2],a),h-=2;return a},y=function(){var c,d,f;if(u(),c=s(o),c===fe&&47===a.charCodeAt(o+1))return o+=2,{type:ee,argument:y()};if(c===fe&&a.charCodeAt(o+1)===fe&&47===a.charCodeAt(o+2))return o+=3,{type:de,argument:y()};if(k(c)||c===fe)return z();if(c===he||c===ie)return A();if(l(c)||c===je)return D();for(d=a.substr(o,e),f=d.length;f>0;){if(b.hasOwnProperty(d))return o+=f,{type:$d,operator:d,argument:y(),prefix:!0};d=d.substr(0,--f)}return!1},z=function(){for(var a,b="";k(s(o));)b+=r(o++);if(s(o)===fe)for(b+=r(o++);k(s(o));)b+=r(o++);if(a=r(o),"e"===a||"E"===a){for(b+=r(o++),a=r(o),("+"===a||"-"===a)&&(b+=r(o++));k(s(o));)b+=r(o++);k(s(o-1))||qe("Expected exponent ("+b+r(o)+")",o)}return l(s(o))&&qe("Variable names cannot start with a number ("+b+r(o)+")",o),{type:Xd,value:parseFloat(b),raw:b}},A=function(){for(var a,b="",c=r(o++),d=!1;t>o;){if(a=r(o++),a===c){d=!0;break}if("\\"===a)switch(a=r(o++)){case"n":b+="\n";break;case"r":b+="\r";break;case"t":b+="	";break;case"b":b+="\b";break;case"f":b+="\f";break;case"v":b+=""}else b+=a}return d||qe('Unclosed quote after "'+b+'"',o),{type:Xd,value:b,raw:c+b+c}},B=function(){var b,c=s(o),d=o;for(l(c)?o++:qe("Unexpected "+r(o),o);t>o&&(c=s(o),m(c));)o++;return b=a.slice(d,o),g.hasOwnProperty(b)?{type:Xd,value:g[b],raw:b}:b===h?{type:Yd}:{type:Vd,name:b}},C=function(a){for(var b,c,d=[];t>o;){if(u(),b=s(o),b===a){o++;break}b===ge?o++:(c=v(),c&&c.type!==Ud||qe("Expected comma",o),d.push(c))}return d},D=function(){var a,b;for(a=s(o),b=a===je?E():B(),u(),a=s(o);a===fe||a===le||a===je;)o++,a===fe?(u(),b={type:Wd,computed:!1,object:b,property:B()}):a===le?(b={type:Wd,computed:!0,object:b,property:v()},u(),a=s(o),a!==me&&qe("Unclosed [",o),o++):a===je&&(b={type:Zd,arguments:C(ke),callee:b}),u(),a=s(o);return b},E=function(){o++;var a=v();return u(),s(o)===ke?(o++,a):void qe("Unclosed (",o)},F=function(){return o++,{type:ce,body:C(me)}},G=[];t>o;)d=s(o),d===oe||d===ge?o++:d===le&&(n=F())?G.push(n):(n=v())?G.push(n):t>o&&qe('Unexpected "'+r(o)+'"',o);return 1===G.length?G[0]:{type:Ud,body:G}};return n}();return Mb}(this);"undefined"!=typeof module&&module.exports&&(module.exports=cjs);var able=function(a){"use strict";var b=Array.prototype,c=Object.prototype,d=(Function.prototype,b.slice),e=c.toString,f=b.forEach,g=b.map,h=Array.isArray||function(a){return"[object Array]"===e.call(a)},i=function(a){return"[object Function]"===e.call(a)},j=function(a){return"[object String]"===e.call(a)},k=function(a){return"[object Arguments]"===e.call(a)},l={},m=function(a){var b,c,e=d.call(arguments,1),f=e.length;for(b=0;f>b;b+=1){var g=e[b];for(c in g)g.hasOwnProperty(c)&&(a[c]=g[c])}return a},n=function(a,b,c){var d,e,g;if(a)if(f&&a.forEach===f)a.forEach(b,c);else if(a.length===+a.length){for(e=a.length,d=0;e>d;d+=1)if(a.hasOwnProperty(d)&&b.call(c,a[d],d,a)===l)return}else for(g in a)if(a.hasOwnProperty(g)&&b.call(c,a[g],g,a)===l)return},o=function(a,b,c){var d=[];return a?g&&a.map===g?a.map(b,c):(n(a,function(a,e,f){d[d.length]=b.call(c,a,e,f)}),a.length===+a.length&&(d.length=a.length),d):d},p=(Array.prototype.filter,function(a,b,c){return d.call(a,null==b||c?1:b)}),q=function(a){return a},r=function(a){return o(a,q)},s=function(a){return a?h(a)?d.call(a):k(a)?d.call(a):a.toArray&&i(a.toArray)?a.toArray():r(a):[]},t=(Object.prototype.hasOwnProperty,a.able,function(){});return t.version="<%= version %>",t.noConflict=function(){return a.able=t,t},function(){var a="__listeners",b="_emit";t.make_this_listenable=function(b){b[a]||(b[a]={})};var c=function(b,c,d){var e=this[a][b],f=p(arguments,3),g={callback:c,context:d,args:f};
e?e.push(g):e=this[a][b]=[g]},d=function(b,c,d){var e,f=this[a][b];if(f){for(e=0;e<f.length;e+=1){var g=f[e];g.callback!==c||d&&d!==g.context||(f.splice(e,1),e-=1)}0===f.length&&delete this[a][b]}};t.make_proto_listenable=function(e){e.on=function(a,b,d){return j(a)?c.apply(this,arguments):(d=b,n(a,function(a,b){c.call(this,b,a,d)},this)),this},e.once=function(b,c,d){var e=this[a][b];h(e)||(e=this[a][b]=[]);var f=p(arguments,3);return e.push({callback:c,context:d,once:!0,args:f}),this},e.off=function(a){return j(a)?d.apply(this,arguments):n(a,function(a,b){d.call(this,b,a)},this),this},e.forward_event=function(){var a=s(arguments),b=a[a.length-1];this._emit.apply(this,[b].concat(a.slice(0,a.length-1)))},e[b]=function(b){var c,d=p(arguments);d.push(b);var e=this[a][b];if(e){var f=e.slice(),g=f.length,h=0;for(c=0;g>c;c+=1){var i=f[c],j=i.context||this;i.callback.apply(j,i.args.concat(d)),i.once===!0&&(e.splice(c-h,1),h+=1)}0===e.length&&this[a]&&delete this[a][b]}}},t.destroy_this_listenable=function(b){delete b[a]}}(),function(){var a="__options";t.make_this_optionable=function(b){b[a]=m.apply(this,[{}].concat(Array.prototype.slice.call(arguments,1)))},t.make_proto_optionable=function(b){b._get_option=function(b){var c=this[a][b];return i(c)?c.call(this):c},b._set_option=function(b,c){this[a][b]=c},b._on_option_set=function(){},b._on_options_set=function(){},b.option=function(a,b){var c;if(0===arguments.length)return this;if(j(a)){if(1===arguments.length)return this._get_option(a);c=p(arguments,2),this._set_option.apply(this,[a,b].concat(c)),this._on_option_set.apply(this,[a,b].concat(c));var d={};return d[a]=b,this._on_options_set.apply(this,[d].concat(c)),this}return c=p(arguments,1),n(a,function(a,b){this._set_option.apply(this,[b,a].concat(c)),this._on_option_set.apply(this,[b,a].concat(c))},this),this._on_options_set.apply(this,[a].concat(c)),this}},t.destroy_this_optionable=function(b){delete b[a]}}(),t}(this);!function(a){function b(a){var b=r[a]={};return k(a.split(/\s+/),function(a){b[a]=!0}),b}var c={},d=Array.prototype,e=Object.prototype,f=e.hasOwnProperty,g=e.toString,h=d.forEach,i=d.indexOf,j=d.slice,k=function(a,b,d){var e,g,i;if(a)if(h&&a.forEach===h)a.forEach(b,d);else if(a.length===+a.length){for(g=0,i=a.length;i>g;g++)if(g in a&&b.call(d,a[g],g,a)===c)return}else for(e in a)if(f.call(a,e)&&b.call(d,a[e],e,a)===c)return},l=function(a){return!!(a&&a.constructor&&a.call&&a.apply)},m=function(a){return k(j.call(arguments,1),function(b){var c;for(c in b)void 0!==b[c]&&(a[c]=b[c])}),a},n=function(a,b,c){var d;if(b){if(i)return i.call(b,a,c);for(d=b.length,c=c?0>c?Math.max(0,d+c):c:0;d>c;c++)if(c in b&&b[c]===a)return c}return-1},o={};k("Boolean Number String Function Array Date RegExp Object".split(" "),function(a){o["[object "+a+"]"]=a.toLowerCase()});var p=function(a){return null==a?String(a):o[g.call(a)]||"object"},q={},r={};q.Callbacks=function(a){a="string"==typeof a?r[a]||b(a):m({},a);var c,d,e,f,g,h,i=[],j=!a.once&&[],l=function(b){for(c=a.memory&&b,d=!0,h=f||0,f=0,g=i.length,e=!0;i&&g>h;h++)if(i[h].apply(b[0],b[1])===!1&&a.stopOnFalse){c=!1;break}e=!1,i&&(j?j.length&&l(j.shift()):c?i=[]:o.disable())},o={add:function(){if(i){var b=i.length;!function d(b){k(b,function(b){var c=p(b);"function"===c?a.unique&&o.has(b)||i.push(b):b&&b.length&&"string"!==c&&d(b)})}(arguments),e?g=i.length:c&&(f=b,l(c))}return this},remove:function(){return i&&k(arguments,function(a){for(var b;(b=n(a,i,b))>-1;)i.splice(b,1),e&&(g>=b&&g--,h>=b&&h--)}),this},has:function(a){return n(a,i)>-1},empty:function(){return i=[],this},disable:function(){return i=j=c=void 0,this},disabled:function(){return!i},lock:function(){return j=void 0,c||o.disable(),this},locked:function(){return!j},fireWith:function(a,b){return b=b||[],b=[a,b.slice?b.slice():b],!i||d&&!j||(e?j.push(b):l(b)),this},fire:function(){return o.fireWith(this,arguments),this},fired:function(){return!!d}};return o},q.Deferred=function(a){var b=[["resolve","done",q.Callbacks("once memory"),"resolved"],["reject","fail",q.Callbacks("once memory"),"rejected"],["notify","progress",q.Callbacks("memory")]],c="pending",d={state:function(){return c},always:function(){return e.done(arguments).fail(arguments),this},then:function(){var a=arguments;return q.Deferred(function(c){k(b,function(b,d){var f=b[0],g=a[d];e[b[1]](l(g)?function(){var a;try{a=g.apply(this,arguments)}catch(b){return void c.reject(b)}a&&l(a.promise)?a.promise().done(c.resolve).fail(c.reject).progress(c.notify):c["notify"!==f?"resolveWith":f+"With"](this===e?c:this,[a])}:c[f])}),a=null}).promise()},promise:function(a){return null!=a?m(a,d):d}},e={};return d.pipe=d.then,k(b,function(a,f){var g=a[2],h=a[3];d[a[1]]=g.add,h&&g.add(function(){c=h},b[1^f][2].disable,b[2][2].lock),e[a[0]]=g.fire,e[a[0]+"With"]=g.fireWith}),d.promise(e),a&&a.call(e,e),e},q.when=function(a){var b=0,c="array"===p(a)&&1===arguments.length?a:j.call(arguments),d=c.length;"array"===p(a)&&1===a.length&&(a=a[0]);var e,f,g,h=1!==d||a&&l(a.promise)?d:0,i=1===h?a:q.Deferred(),k=function(a,b,c){return function(d){b[a]=this,c[a]=arguments.length>1?j.call(arguments):d,c===e?i.notifyWith(b,c):--h||i.resolveWith(b,c)}};if(d>1)for(e=new Array(d),f=new Array(d),g=new Array(d);d>b;b++)c[b]&&l(c[b].promise)?c[b].promise().done(k(b,g,c)).fail(i.reject).progress(k(b,f,e)):--h;return h||i.resolveWith(g,c),i.promise()},"undefined"!=typeof module&&module.exports?module.exports=q:"undefined"!=typeof a._?a._.mixin(q):a._=q}(this),function(){"use strict";{var a=window._,b=/-([a-z]|[0-9])/gi,c=/^-ms-/,d=function(a,b){return String(b).toUpperCase()};a.clone}a.mixin({remove_index:function(a,b,c){var d=a.slice((c||b)+1||a.length);return a.length=0>b?a.length+b:b,a.push.apply(a,d)},remove:function(a,b){var c=e(a,b);c>=0&&f(a,c)},remove_all:function(a,b){var c;do c=e(a,b),c>=0&&f(a,c);while(c>=0)},index_of:function(a,b,c){return void 0===c&&(c=function(a,b){return a===b}),g(a,function(a){return c(b,a)})},index_where:function(a,b){var c,d=a.length;for(c=0;d>c;c++)if(b(a[c],c))return c;return-1},clear:function(a){a.length=0},insert_at:function(a,b,c){var d;return void 0===c?a.push(b):(d=a.slice(c),a.length=c,a.push(b),a.push.apply(a,d))},set_index:function(a,b,c){if(b>=0&&b<a.length&&c>=0&&c<a.length){var d=a[b];return f(a,b),h(a,d,c),d}return!1},diff:cjs.arrayDiff,proto_extend:function(a,b){var c=function(){};c.prototype=b.prototype,a.prototype=new c,a.prototype.constructor=a,a.superclass=b.prototype,b.prototype.constructor===Object.prototype.constructor&&(b.prototype.constructor=b)},camel_case:function(a){return a.replace(c,"ms-").replace(b,d)},deepExtend:function(b){var c=new RegExp("#{\\s*?_\\s*?}"),d=Array.prototype.slice,e=Object.prototype.hasOwnProperty,f=a.bind(a.isNull,a);return a.each(d.call(arguments,1),function(d){for(var g in d)if(e.call(d,g))if(a.isUndefined(b[g]))b[g]=d[g];else if(a.isString(d[g])&&c.test(d[g]))a.isString(b[g])&&(b[g]=d[g].replace(c,b[g]));else if(a.isArray(b[g])||a.isArray(d[g])){if(!a.isArray(b[g])||!a.isArray(d[g]))throw"Error: Trying to combine an array with a non-array ("+g+")";b[g]=a.reject(a.deepExtend(b[g],d[g]),f)}else if(a.isObject(b[g])||a.isObject(d[g])){if(!a.isObject(b[g])||!a.isObject(d[g]))throw"Error: Trying to combine an object with a non-object ("+g+")";b[g]=a.deepExtend(b[g],d[g])}else b[g]=d[g]}),b}}),a.isTextElement=function(a){return!(!a||3!==a.nodeType)},a.isCommentElement=function(a){return!(!a||8!==a.nodeType)};var e=a.index_of,f=a.remove_index,g=a.index_where,h=(a.any,a.insert_at)}();var interstate=function(a){"use strict";var b={cjs:cjs.noConflict(),_:_.noConflict(),esprima:esprima,version:"<%= version %>",build_time:"<%= build_time %>",__log_errors:!0,__debug:!1,__empty_files:!1,__garbage_collect:!0,root_name:"sketch"};b.cjs.__debug=b.__debug,b.__debug_statecharts=b.__debug,able.make_this_listenable(b),able.make_proto_listenable(b);var c={};b.register_uid=function(a,d){c[a]=d,b._emit("uid_registered",a,d)},b.unregister_uid=function(a){delete c[a],b._emit("uid_unregistered",a)},b.find_uid=function(a){return c[a]};var d=/^[a-zA-Z_$][0-9a-zA-Z_$]*$/;return b.is_valid_prop_name=function(a){return a.match(d)},b.async_js=function(b,c){var d=a.document,e="script",f=d.createElement(e),g=d.getElementsByTagName("head")[0];f.type="text/javascript",f.src=b,c&&f.addEventListener("load",function(a){c(a)},!1),g.appendChild(f)},b}(this);!function(a){"use strict";function b(a){var b,c,d={},e=a.split(""),f=[],g=e[0],h=256;for(c=1;c<e.length;c+=1)b=e[c],null!=d[g+b]?g+=b:(f.push(g.length>1?d[g]:g.charCodeAt(0)),d[g+b]=h,h+=1,g=b);for(f.push(g.length>1?d[g]:g.charCodeAt(0)),c=0;c<f.length;c+=1)f[c]=String.fromCharCode(f[c]);return f.join("")}function c(a){var b,c,d={},e=a.split(""),f=e[0],g=f,h=[f],i=256;for(c=1;c<e.length;c+=1){var j=e[c].charCodeAt(0);b=256>j?e[c]:d[j]||g+f,h.push(b),f=b.charAt(0),d[i]=g+f,i+=1,g=b}return h.join("")}function d(b){var c,d=f.rest(arguments);for(c=0;c<h.length;c+=1){{var e=h[c];e.type}if(e.instance_check(b))return f.extend({type:e.name},e.serialize.apply(b,d))}var g={};return f.each(b,function(b,c){g[c]=a.serialize.apply(a,[b].concat(d))}),g}var e=a.cjs,f=a._,g="$$pointer",h=[];a.register_serializable_type=function(a,b,c,d){h.push({name:a,instance_check:b,serialize:c,deserialize:d})},a.register_serializable_type("cjs_array",function(a){return e.isArrayConstraint(a)},function(){var b=f.toArray(arguments),c=f.map(this.toArray(),function(c){return a.serialize.apply(a,[c].concat(b))});return{value:c}},function(b){var c=f.rest(arguments);return e.array({value:f.map(b.value,function(b){return a.deserialize.apply(a,[b].concat(c))})})}),a.register_serializable_type("cjs_map",function(a){return e.isMapConstraint(a)},function(){var b=f.toArray(arguments),c=f.map(this.keys(),function(c){return a.serialize.apply(a,[c].concat(b))}),d=f.map(this.values(),function(c){return a.serialize.apply(a,[c].concat(b))});return{keys:c,values:d}},function(b){var c=f.rest(arguments);return e.map({keys:f.map(b.keys,function(b){return a.deserialize.apply(a,[b].concat(c))}),values:f.map(b.values,function(b){return a.deserialize.apply(a,[b].concat(c))})})});var i,j,k=!1,l=function(a){return f.indexOf(i,a)},m=function(a){var b=l(a);return 0>b&&(b=i.length,i.push(a),j[b]=d.apply(this,arguments)),b},n=function(){return{type:g,id:m.apply(this,arguments)}};a.serialize=function(b){var c=f.rest(arguments),d=!1;if(k||(k=!0,d=!0,i=[],j=[]),null==b||"object"!=typeof b&&"function"!=typeof b)return b;if(f.isArray(b))return f.map(b,function(b){return a.serialize.apply(a,[b].concat(c))});if(d){var e=n.apply(this,arguments),g={serialized_objs:j,root:e};return k=!1,i=void 0,j=void 0,g}return n.apply(this,arguments)},a.stringify=function(){var b=a.serialize.apply(a,arguments),c=JSON.stringify(b);return c},a.stringify_and_compress=function(){var c=a.stringify.apply(a,arguments);return b(c)};var o,p,q=!1,r=function(b){var c,d=f.rest(arguments),e=b&&f.has(b,"type")?b.type:!1;for(c=0;c<h.length;c+=1){var g=h[c];if(e===g.name)return g.deserialize.apply(g,[b].concat(d))}var i={};return f.each(b,function(b,c){i[c]=a.deserialize.apply(a,[b].concat(d))}),i},s=function(a){var b=f.rest(arguments);if(a.type===g){var c=a.id,d=p[c];return void 0===d&&(d=p[c]=r.apply(this,[o[c]].concat(b)),f.has(d,"initialize")&&(d.initialize(),delete d.initialize)),d}return r.apply(this,[a].concat(b))};a.deserialize=function(b){var c,d=f.rest(arguments);if(q===!1){if(q=!0,a.__debug)o=b.serialized_objs,p=[],c=a.deserialize.apply(a,[b.root].concat(d)),o=p=void 0,q=!1;else try{o=b.serialized_objs,p=[],c=a.deserialize.apply(a,[b.root].concat(d))}finally{o=p=void 0,q=!1}return c}return null==b||"object"!=typeof b?b:f.isArray(b)?f.map(b,function(b){return a.deserialize.apply(a,[b].concat(d))}):s.apply(this,[b].concat(d))},a.destringify=function(b){var c=f.rest(arguments);return a.deserialize.apply(a,[JSON.parse(b)].concat(c))},a.decompress_and_destringify=function(b){var d=f.rest(arguments),e=c(b);return a.destringify.apply(a,[e].concat(d))};var t={};a.loaded_program_name=e(),a.getSavedProgramMap=function(b){f.isString(b)||(b="");var c={};f.each(a.ls(b),function(a){var d=u+a+v+b,e=window.localStorage.getItem(d);c[a]=e});var d=e(c),g=t[b];f.isArray(g)?t[b].push(d):t[b]=[d];var h=d.destroy;return d.destroy=function(){if(1===t[b].length)delete t[b];else{var a=t[b].indexOf(d);t[b].splice(a,1)}h.apply(d,arguments)},d.savedType=function(){return b},d};var u="_",v="$";a.save=function(b,c,d){if(!f.isString(c)&&(c=a.loaded_program_name.get(),!c)){var e=a.ls(),g="sketch_"+e.length,h=0;for(c=g;e.indexOf(c)>=0;)c=g+"_"+h,h++}f.isString(d)||(d="");var i=u+c+v+d,j=a.stringify(b);return window.localStorage.setItem(i,j),f.each(t[d],function(a){a.item(c,j)}),d||a.setDefaultProgramName(c),c},a.saveAndSetCurrent=function(b,c,d){return c=a.save(b,c,d),a.loaded_program_name.set(c),c},a.loadString=function(a,b){var c=u+a+v+b;return window.localStorage.getItem(c)},a.load=function(b,c){if(!f.isString(b)&&(b=a.getDefaultProgramName(),!b))return!1;f.isString(c)||(c="");var d,e=a.loadString(b,c);if(!e)return!1;if(a.__debug)return d=a.destringify(e),c||(a.loaded_program_name.set(b),a.setDefaultProgramName(b)),d;try{return d=a.destringify(e),c||(a.loaded_program_name.set(b),a.setDefaultProgramName(b)),d}catch(g){return console.error("Error loading "+b+":"),console.error(g),!1}},a.ls=function(a){var b,c=window.localStorage.length,d=[];f.isString(a)||(a="");var e,g=new RegExp("^"+u+"(.*)\\"+v+a+"$");for(b=0;c>b;b+=1){var h=window.localStorage.key(b);(e=h.match(g))&&d.push(e[1])}return d},a.rm=function(b,c){f.isString(b)||(b="default"),f.isString(c)||(c="");var d=u+b+v+c;return f.each(t[c],function(a){a.remove(b)}),window.localStorage.removeItem(d),a.ls()},a.rename=function(b,c,d){var e=u+b+v+d,g=u+c+v+d,h=a.loaded_program_name.get()===b;return localStorage.getItem(g)?!1:(localStorage.setItem(g,localStorage.getItem(e)),localStorage.removeItem(e),h&&(a.loaded_program_name.set(c),a.setDefaultProgramName(c)),f.each(t[d],function(a){a.item(c,a.item(b)),a.remove(b)}),void 0)},a.nuke=function(){var b=a.ls();return f.each(b,a.rm),f.each(t,function(a){f.each(a,function(a){a.clear()})}),a.ls()};var w="IST_DEFAULT_PROGRAM";a.getDefaultProgramName=function(){var a=localStorage.getItem(w);return null===a?!1:a},a.setDefaultProgramName=function(a){window.localStorage.setItem(w,a)}}(interstate),function(a){"use strict";var b=(a.cjs,a._),c={WARNING:1,ERROR:2};a.Error=function(b){var c=b.prototype;return c.type=function(){return this.options.type},c.message=function(){return this.options.message},a.register_serializable_type("error",function(a){return a instanceof b},function(){return{type:this.type(),message:this.message()}},function(a){var c=new b({type:a.type,message:a.message});return c}),b}(function(a){this.options=b.extend({type:c.ERROR,message:""},a)}),a.get_prop_name_error=function(a){if(0===a.length)return"Must be at least one character";if(a[0].match(/[0-9]/))return"First letter should not be a number";if(a[0].match(/[a-zA-Z_$]/)){if(a.match(/\s/))return"Should not contain spaces";for(var c,d=[],e=/[0-9a-zA-Z_$]/,f=1;f<a.length;f++)c=a[f],c.match(e)||d.push(c);var g=b.map(d,function(a,b){return b===d.length-1?"and '"+a+"'":"'"+a+"'"}).join(", ");return"Invalid characters: "+g+"."}return"First character should be a letter"}}(interstate),function(a){"use strict";var b=(a.cjs,a._);a.install_proto_builtins=function(a,c){b.each(c,function(c,d){var e=c.getter_name||"get_"+d;c._get_getter_name=function(){return e},b.isFunction(c.getter)?a[e]=function(){return c.getter.apply(this,[this._builtins[d]].concat(b.toArray(arguments)))}:c.gettable!==!1&&(a[e]=function(){return this._builtins[d]});var f=c.setter_name||"set_"+d;c._get_setter_name=function(){return f},b.isFunction(c.setter)?a[f]=function(){return c.setter.apply(this,[this._builtins[d]].concat(b.toArray(arguments)))}:c.settable!==!1&&(a[f]=function(a){this._builtins[d]=a});var g=c.env_name||d;c._get_env_name=function(){return g}})},a.install_instance_builtins=function(a,c,d){var e=d.builtins;a._builtins=a._builtins||{},b.each(e,function(d,e){var f=d.setter_name||"set_"+e;b.isFunction(d.start_with)&&(a._builtins[e]=d.start_with.call(a)),d.settable===!1?b.isFunction(d.start_with)||(c&&b.has(c,e)?a._builtins[e]=c[e]:b.isFunction(d["default"])&&(a._builtins[e]=d["default"].call(a))):c&&b.has(c,e)?a[f](c[e]):b.isFunction(d["default"])&&a[f](d["default"].call(a))})},a.unset_instance_builtins=function(a,c){var d=c.builtins;b.each(d,function(c,d){b.isFunction(c.destroy)&&c.destroy.call(a,a._builtins[d]),delete a._builtins[d]})}}(interstate),function(a){"use strict";function b(a,b){if(a.length>b)return a.substring(0,b-3)+"...";if(a.length<b){for(var c=a;c.length<b;)c+=" ";return c}return a}function c(){var c,d,e,g=f.last(arguments),h=console;!g||g instanceof a.Statechart?(e=!1,c=f.toArray(arguments)):(e=g,c=f.first(arguments,arguments.length-1)),d=f.map(c,function(a){var b=uid.strip_prefix(a.id()),c=a.basis();return c&&(b+=":"+uid.strip_prefix(a.basis().id())),b}).join(" "),h.group("  Statechart "+d),f.each(c,function(c){if(!c.is_initialized())return void h.log("(not initialized)");var d=f.without(c.flatten_substates(e),c),g=f.flatten(f.map(d,function(a){return[a].concat(a.get_outgoing_transitions())}),!0);f.each(g,function(c){var d;if(c instanceof a.State)d=b(c.get_name(),j-2);else if(c instanceof a.StatechartTransition){var e=c.from(),f=c.to();d=b(e.get_name()+"->"+f.get_name(),l-2),d+=b(c.stringify(),m)}d=c.is_active()?"* "+d:"  "+d,d=b(uid.strip_prefix(c.id())+(c.basis()?":"+uid.strip_prefix(c.basis().id()):""),k)+d,h.log(d)})}),h.groupEnd()}function d(d,l){l=l||console;var m,n=function(b,c){var d,g,h,i;if(f.isUndefined(b))return"(undefined)";if(f.isNull(b))return"(null)";if(f.isNumber(b)||f.isBoolean(b))return b.toString();if(f.isString(b))return'"'+b+'"';if(f.isFunction(b))return"(func)";if(f.isElement(b))return"(dom)";if(b instanceof a.StatefulObj)return"(stateful:"+(c&&c instanceof a.ContextualObject?uid.strip_prefix(c.id())+":":"")+uid.strip_prefix(b.id())+")";if(b instanceof a.Dict)return"(dict:"+(c&&c instanceof a.ContextualObject?uid.strip_prefix(c.id())+":":"")+uid.strip_prefix(b.id())+")";if(b instanceof a.Cell)return"(cell:"+uid.strip_prefix(b.id())+")";if(b instanceof a.StatefulProp)return"(prop:"+uid.strip_prefix(b.id())+")";if(b instanceof a.ParsedFunction)return"(parsed fn)";if(b instanceof a.WrapperClient)return"("+b.type()+" client wrapper "+b.cobj_id+")";if(b instanceof a.Query)return n(b.value());if(b instanceof a.Pointer)return d=b.points_at(),g=b.special_contexts(),h=n(d),i=f.map(g,function(a){return a.id().toString()}).join(","),g.length>0&&(h=h+" "+i),h;if(b instanceof a.ContextualObject){var j=b.get_pointer();return d=j.points_at(),g=j.special_contexts(),h=n(d,b),i=f.map(g,function(a){return a.id().toString()}).join(","),g.length>0&&(h=h+" "+i),h}if(b instanceof a.CopyContext)return b.id();if(f.isArray(b))return"["+f.map(b,function(a){return n(a)}).join(", ")+"]";if(e.isArrayConstraint(b)){var k=b.toArray();return"$"+n(k)}return"{ "+f.map(b,function(a,b){return b+": "+a}).join(", ")+" }"},o=function(b){return f.isUndefined(b)?"(undefined)":f.isNull(b)?"(null)":f.isString(b)?'"'+b+'"':f.isNumber(b)||f.isBoolean(b)?b.toString():f.isFunction(b)?"function () {...}":b instanceof a.Dict?"":b instanceof a.Cell?"=("+uid.strip_prefix(b.id())+")= "+b.get_str():b.toString()},p=function(e){if(e instanceof a.ContextualDict){if(e instanceof a.ContextualStatefulObj){var m=e.get_statecharts();c.apply(this,m.concat(l))}var q=e.children();f.each(q,function(c){var j,k,m=c.value;k=m instanceof a.ContextualDict?m.is_template():!1,k?(j=m.instances(),console.group("("+j.length+" manifestations)")):j=[m];var q=c.name,r=c.inherited;f.each(j,function(c){var j=c instanceof a.ContextualObject?c.get_pointer():!1,k=j?j.points_at():c,m=k&&d.has(k),s=j&&d.eq(j),t=q;r&&(t+=" (i)"),t=s?"> "+t:"  "+t,k instanceof a.StatefulProp?(t=b(t,g),t+=b("("+(c instanceof a.ContextualObject?uid.strip_prefix(c.id())+":":"")+uid.strip_prefix(k.id())+")",h)):t=b(t,g+h);var u=c instanceof a.ContextualObject?c.val():c;if(t=b(t+n(u),g+h+i),k instanceof a.Dict||k instanceof a.StatefulProp?(l[m?"group":"groupCollapsed"](t),p(c),l.groupEnd()):l.log(t+o(k)),"protos"===q){var v=e.get_all_protos(),w=b("  inherits from",g+h)+"["+f.map(v,function(a){return n(a)}).join(", ")+"]";l.log(w)}}),k&&console.groupEnd()})}else if(e instanceof a.ContextualStatefulProp){var r=e.get_values();f.each(r,function(c){var d,e=c.value,f=(o(e),c.state);if(f){if(f instanceof a.State)d=b(f.get_name(),j-2);else if(f instanceof a.StatechartTransition){var g=f.from(),h=f.to();d=b(g.get_name()+"->"+h.get_name(),j-2)}d=c.active?"*"+d:" "+d,d=c.using?"*"+d:" "+d,d=b(uid.strip_prefix(f.id()),k)+d}else d=b("",k+j);var i=c.value,m=d+o(i);l.log(m)})}},q=d.points_at(0);m=d.points_at()===q?">"+a.root_name:a.root_name;var r=a.find_or_put_contextual_obj(q);return l.log(b(m,g)+n(q,r)),p(r),"ok..."}var e=a.cjs,f=a._,g=30,h=15,i=40,j=40,k=15,l=60,m=40;a.print=d,a.print_statechart=c}(interstate),function(ist){"use strict";var cjs=ist.cjs,_=ist._,esprima=window.esprima,destroy_if_constraint=function(a,b){cjs.isConstraint(a)&&a.destroy(b)},set_destroy=function(a,b){if(cjs.isConstraint(a)){var c=a.destroy;a.destroy=function(){b.apply(a,arguments),c.apply(a,arguments)}}};ist.construct=function(constructor,args){function F(){return constructor.apply(this,args)}if(constructor===Date){var rv=eval("new constructor("+args.join(",")+")");return rv}return F.prototype=constructor.prototype,new F},ist.MultiExpression=function(a){this.expressions=a},function(a){var b=a.prototype;b.get_expressions=function(){return this.expressions},b.first=function(){return _.first(this.expressions)},b.rest=function(){return _.rest(this.expressions)},b.last=function(){return _.last(this.expressions)}}(ist.MultiExpression),ist.on_event=function(a,b,c){if("timeout"===a){var d=new ist.TimeoutEvent(b);return d}if("time"===a){var e=new ist.TimeEvent(b);return e}if("frame"===a){var f=new ist.FrameEvent;return f}if("cross"===a){var g=b,h=c,i=new ist.CrossEvent(g,h);return i}if("collision"===a){var j=b,k=c,l=new ist.CollisionEvent(j,k);return l}var m=_.rest(arguments),n=[];if(m){var o=a,p=new ist.TransitionEvent(m,o);n.push(p),arguments.length<=1&&(m=window);var q=a,r=new ist.IstObjEvent(q,m);n.push(r)}arguments.length<=1&&(m=window);var s=new ist.DOMEvent(a,m);return n.push(s),new ist.CombinationEvent(n)},ist.register_serializable_type("ist_on_event_func",function(a){return a===ist.on_event},function(){return{}},function(){return ist.on_event}),ist.binary_operators={"===":function(a,b){return ist.check_contextual_object_equality_eqeqeq(a,b)},"!==":function(a,b){return!ist.check_contextual_object_equality_eqeqeq(a,b)},"==":function(a,b){return ist.check_contextual_object_equality_eqeqeq(a,b)},"!=":function(a,b){return!ist.check_contextual_object_equality_eqeqeq(a,b)},">":function(a,b){return a>b},">=":function(a,b){return a>=b},"<":function(a,b){return b>a},"<=":function(a,b){return b>=a},"+":function(a,b){return a+b},"-":function(a,b){return a-b},"*":function(a,b){return a*b},"/":function(a,b){return a/b},"%":function(a,b){return a%b},"&&":function(a,b){return a&&b},"||":function(a,b){return a||b},"&":function(a,b){return a&b},"|":function(a,b){return a|b},"^":function(a,b){return a^b},"<<":function(a,b){return a<<b},">>":function(a,b){return a>>b},">>>":function(a,b){return a>>>b},"in":function(a,b){return a in b},"instanceof":function(a,b){return a instanceof b}},ist.unary_operators={"-":function(a){return-a},"!":function(a){return!a},"~":function(a){return~a},"typeof":function(a){return typeof a}};var destroy_constraint_fn=cjs.Constraint.prototype.destroy,get_op_val=function(a,b,c){var d=a.context,e=_.rest(arguments,3);if(a.get_constraint){var f=cjs(function(){var f,g=cjs.get(c,a.auto_add_dependency),h=_.map(e,function(b){return cjs.get(b,a.auto_add_dependency)}),i=cjs.get(b,a.auto_add_dependency);if(g===ist.find_fn)return f=g.apply(d,h);if(_.isFunction(g))return f=g.apply(i,h);if(g instanceof ist.ParsedFunction)return g._apply(i,d,h,a);throw new Error("Calling a non-function")});return f.destroy=function(){destroy_constraint_fn.apply(this,arguments)},f}if(_.isFunction(c))return c.apply(b,e);if(c instanceof ist.ParsedFunction)return c._apply(b,d,e);throw new Error("Calling a non-function")},AND_OP=0,OR_OP=1,get_logical_val=function(a,b,c,d){if(d.get_constraint){var e;"&&"===a?e=AND_OP:"||"===a?e=OR_OP:console.error("Unknown op "+a);var f=cjs(function(){switch(e){case AND_OP:return cjs.get(b,d.auto_add_dependency)&&cjs.get(c,d.auto_add_dependency);case OR_OP:return cjs.get(b,d.auto_add_dependency)||cjs.get(c,d.auto_add_dependency)}});return f.destroy=function(){destroy_constraint_fn.apply(this,arguments)},f}return"&&"===a?b&&c:"||"===a?b||c:void console.error("Unknown op "+a)},get_conditional_val=function(a,b,c,d){if(d.get_constraint){var e=cjs(function(){var e=cjs.get(a,d.auto_add_dependency);return e?cjs.get(b,d.auto_add_dependency):cjs.get(c,d.auto_add_dependency)});return e.destroy=function(){destroy_constraint_fn.apply(this,arguments)},e}return a?b:c},IDENTIFIER={COBJ_ROOT:ist.root_name,JS_ROOT:"window",CONTAINER:"container",PROTO_THIS:"$this",ROOT_THIS:"$$this"},get_identifier_val=function(a,b){var c,d=b.context,e=b.ignore_inherited_in_contexts||[];if(a===IDENTIFIER.COBJ_ROOT)return ist.find_or_put_contextual_obj(d.root(),d.slice(0,1));if(a===IDENTIFIER.JS_ROOT)return window;if(a===IDENTIFIER.PROTO_THIS||a===IDENTIFIER.ROOT_THIS){if(c=b.inherited_from_cobj){if(a===IDENTIFIER.PROTO_THIS)d=c.get_pointer();else if(a===IDENTIFIER.ROOT_THIS){do d=c,c=c.is_inherited();while(c);d=d.get_pointer()}return get_this_val(_.extend({},b,{context:d}))}return get_this_val(b)}var f=function(){var b,c,f,g;if(a===IDENTIFIER.CONTAINER){var h=!1;for(c=d,f=c.points_at();!c.is_empty();){if(f instanceof ist.Dict){if(h)return g=ist.find_or_put_contextual_obj(f,c);h=!0}c=c.pop(),f=c.points_at()}}for(c=d,f=c.points_at();!c.is_empty();){if(f instanceof ist.Dict){var i=ist.find_or_put_contextual_obj(f,c);if(i.has(a,_.indexOf(e,f)>=0))return g=i.prop_val(a)}else if(f instanceof ist.ProvisionalContext&&f.has(a))return f.get(a);if(c.has_special_contexts()){var j=c.special_contexts(),k=j.length;for(b=0;k>b;b+=1){var l=j[b],m=l.get_context_obj();if(m.hasOwnProperty(a))return cjs.get(m[a].value)}}c=c.pop(),f=c.points_at()}if(window.hasOwnProperty(a))return window[a];throw new Error("Could not find variable '"+a+"'")};if(b.get_constraint){var g=cjs(f);return g.destroy=function(){d=!1,destroy_constraint_fn.apply(this,arguments)},g}return f()},get_this_val=function(a){var b=a.context,c=function(){for(var a=b,c=a.points_at();!a.is_empty();){if(c instanceof ist.Dict){var d=ist.find_or_put_contextual_obj(c,a);return d}a=a.pop(),c=a.points_at()}throw new Error("Could not find this")};if(a.get_constraint){var d=cjs(c);return d.destroy=function(){destroy_constraint_fn.apply(this,arguments)},d}return c()},get_member_val=function(a,b,c){var d=function(a,b){var c,d;if(!a)return void 0;if(a instanceof ist.ContextualObject){if("container"===b)for(var e=!1,f=a.get_pointer(),g=f.points_at();!f.is_empty();){if(g instanceof ist.Dict){if(e)return c=ist.find_or_put_contextual_obj(g,f);e=!0}f=f.pop(),g=f.points_at()}else if(a.is_template&&a.is_template()){if(_.isNumber(b)){if(d=a.instances(),d.hasOwnProperty(b))return d[b];throw new Error("No such property '"+b+"'")}if("length"===b)return d=a.instances(),d.length}if(c=a.prop_val(b),void 0===c&&!a.has(b))throw new Error("No such property '"+b+"'");return c}return cjs.isArrayConstraint(a)?_.isNumber(b)?a.item(b):"length"===b?a.length():void 0:cjs.isMapConstraint(a)?a.get(b):a[b]};if(c.get_constraint){var e=cjs(function(){var e=cjs.get(a,c.auto_add_dependency),f=cjs.get(b,c.auto_add_dependency);return d(e,f)});return e.destroy=function(){destroy_constraint_fn.apply(this,arguments)},e}return d(a,b)},get_array_val=function(a,b){if(b.get_constraint){var c=cjs(function(){return _.map(a,function(a){return cjs.get(a,b.auto_add_dependency)})});return c.destroy=function(){destroy_constraint_fn.apply(this,arguments)},c}return a},get_new_$=function(a,b,c){var d=a.context,e=_.rest(arguments,3);if(a.get_constraint){var f=cjs(function(){var f=cjs.get(c,a.auto_add_dependency),g=_.map(e,function(b){return cjs.get(b,a.auto_add_dependency)}),h=cjs.get(b,a.auto_add_dependency);if(_.isFunction(f)){var i=ist.construct.call(h,f,g);return i}if(f instanceof ist.ParsedFunction)return f._apply(h,d,g,a);throw new Error("Calling a non-function")});return f.destroy=function(){destroy_constraint_fn.apply(this,arguments)},f}if(_.isFunction(c)){var g=ist.construct.call(b,c,e);return g}if(c instanceof ist.ParsedFunction)return c._apply(b,d,e);throw new Error("Calling a non-function")},get_val=ist.get_parsed_val=function(a,b){var c,d,e,f,g,h,i,j,k,l;if(!a)return void 0;var m=a.type;if("ExpressionStatement"===m)j=get_val(a.expression,b);else if("Literal"===m)j=a.value;else if("BinaryExpression"===m)c=ist.binary_operators[a.operator],d=get_val(a.left,b),e=get_val(a.right,b),j=get_op_val(b,window,c,d,e),set_destroy(j,function(a){destroy_if_constraint(d,a),destroy_if_constraint(e,a)});else if("UnaryExpression"===m)c=ist.unary_operators[a.operator],f=get_val(a.argument,b),j=get_op_val(b,window,c,f),set_destroy(j,function(a){destroy_if_constraint(f,a)});else if("CallExpression"===m){var n=a.callee;"MemberExpression"===n.type?(k=h=get_val(n.object,b),l=n.computed?get_val(n.property,b):n.property.name,g=get_member_val(k,l,b),set_destroy(g,function(a){destroy_if_constraint(k,a),destroy_if_constraint(l,a)})):(g=get_val(n,b),h=window),i=_.map(a.arguments,function(a){return get_val(a,b)}),j=get_op_val.apply(this,[b,h,g].concat(i)),set_destroy(j,function(a){destroy_if_constraint(g,a),_.each(i,function(b){destroy_if_constraint(b,a)})})}else if("Identifier"===m)j=get_identifier_val(a.name,b);else if("ThisExpression"===m)j=get_this_val(b);else if("MemberExpression"===m)k=get_val(a.object,b),l=a.computed?get_val(a.property,b):a.property.name,j=get_member_val(k,l,b),set_destroy(j,function(a){destroy_if_constraint(k,a),destroy_if_constraint(l,a)});else if("ArrayExpression"===m){var o=_.map(a.elements,function(a){return get_val(a,b)});j=get_array_val(o,b),set_destroy(j,function(a){_.each(o,function(b){destroy_if_constraint(b,a)})})}else if("ConditionalExpression"===m){var p=get_val(a.test,b),q=get_val(a.consequent,b),r=get_val(a.alternate,b);j=get_conditional_val(p,q,r,b),set_destroy(j,function(a){destroy_if_constraint(p,a),destroy_if_constraint(q,a),destroy_if_constraint(r,a)})}else"LogicalExpression"===m?(d=get_val(a.left,b),e=get_val(a.right,b),j=get_logical_val(a.operator,d,e,b),set_destroy(j,function(a){destroy_if_constraint(d,a),destroy_if_constraint(e,a)})):"FunctionExpression"===m?j=ist.get_fn_$(a,b):"NewExpression"===m?(g=get_val(a.callee,b),h=window,"MemberExpression"===a.callee.type&&(h=get_val(a.callee.object,b)),i=_.map(a.arguments,function(a){return get_val(a,b)}),j=get_new_$.apply(this,[b,h,g].concat(i)),set_destroy(j,function(a){destroy_if_constraint(g,a),destroy_if_constraint(h,a),_.each(i,function(b){destroy_if_constraint(b,a)})})):"ObjectExpression"===m?(j={},_.each(a.properties,function(a){var c=a.key.name,d=get_val(a.value,b);j[c]=d})):"Program"===m?j=0===a.body.length?null:1===a.body.length?get_val(a.body[0],b):new ist.MultiExpression(_.map(a.body,function(a,c){return b.only_parse_first&&0!==c?a:get_val(a,b)})):console.log(m,a);return j};ist.get_parsed_$=function(a,b){var c=ist.get_parsed_val(a,_.extend({get_constraint:!0,auto_add_dependency:!0},b));return c};var func_regex=new RegExp("^\\s*function\\s*\\((\\s*[a-zA-Z$][\\w\\$]*\\s*,)*\\s*([a-zA-Z$][\\w\\$]*\\s*)?\\)\\s*{.*}\\s*$"),block_regex=new RegExp("^\\s*{.*}\\s*$");ist.parse=function(a){(a.replace(/\n/g,"").match(func_regex)||a.match(block_regex))&&(a="("+a+")");try{return esprima.parse(a)}catch(b){return new ist.Error({message:b.description})
}}}(interstate),function(a){"use strict";var b=a.cjs,c=a._,d={},e={},f={},g={"=":function(a,b){return b},"+=":function(a,b){return a+b},"-=":function(a,b){return a-b},"*=":function(a,b){return a*b},"/=":function(a,b){return a/b},"|=":function(a,b){return a|b},"&=":function(a,b){return a&b},"^=":function(a,b){return a^b}},h=function(i,j){var k,l,m,n,o,p,q,r,s,t,u,v,w,x;if(!i)return void 0;var y=i.type;if("BlockStatement"===y){var z=i.body.length;for(k=0;z>k;k+=1){var A=i.body[k];if(n=h(A,j),n===d||n===e||n===f)return n}}else{if("VariableDeclaration"===y)return l=j.var_map,void c.each(i.declarations,function(a){var c=a.id.name,d=h(a.init,j),e=l[c];e&&b.isConstraint(e)&&e.destroy(),l[c]=d});if("Literal"===y)return i.value;if("ExpressionStatement"===y)return h(i.expression,j);if("AssignmentExpression"===y){var B=i.left,C=h(i.right,j);if(l=j.var_map,"Identifier"===B.type){v=B.name;var D=l[v];D&&b.isConstraint(D)&&D.destroy(),l[v]=g[i.operator](D,C)}else"MemberExpression"===B.type?(r=h(B.object,j),q=B.computed?h(B.property,j):B.property.name,r[q]=C):console.error("Unset")}else{if("BinaryExpression"===y){m=a.binary_operators[i.operator];var E=h(i.left,j),F=h(i.right,j);return m.call(window,E,F)}if("UnaryExpression"===y){m=a.unary_operators[i.operator];var G=h(i.argument,j);return m.call(window,G)}if("Identifier"===y){var H=i.name;if(H===a.root_name)return a.find_or_put_contextual_obj(j.pcontext.root(),j.pcontext.slice(0,1));if("container"!==H)return c.has(j.var_map,H)?b.get(j.var_map[H],j.auto_add_dependency):a.get_parsed_val(i,{context:j.pcontext});for(s=!1,t=j.pcontext,u=t.points_at();!t.is_empty();){if(u instanceof a.Dict){if(s)return n=a.find_or_put_contextual_obj(u,t);s=!0}t=t.pop(),u=t.points_at()}}else{if("ReturnStatement"===y)return j.rv=h(i.argument,j),d;if("IfStatement"===y)return h(i.test,j)?h(i.consequent,j):h(i.alternate,j);if("WhileStatement"===y)for(o=i.test,p=i.body;h(o,j);){if(n=h(p,j),n===d)return n;if(n===e)break}else if("ForStatement"===y){var I=i.init,J=i.update;for(p=i.body,o=i.test,h(I,j);h(o,j);h(J,j)){if(n=h(p,j),n===d)return n;if(n===e)break}}else if("DoWhileStatement"===y){o=i.test,p=i.body;do{if(n=h(p,j),n===d)return n;if(n===e)break}while(h(o,j))}else{if("ConditionalExpression"===y)return h(i.test,j)?h(i.consequent,j):h(i.alternate,j);if("MemberExpression"===y){if(r=h(i.object,j),i.computed)q=h(i.property,j);else if(q=i.property.name,r instanceof a.ContextualObject&&"parent"===q)for(s=!1,t=r.get_pointer(),u=t.points_at();!t.is_empty();){if(u instanceof a.Dict){if(s)return n=a.find_or_put_contextual_obj(u,t);s=!0}t=t.pop(),u=t.points_at()}if(r instanceof a.ContextualObject){if(r.is_template&&r.is_template()){var K;if(c.isNumber(q)){if(K=r.instances(),K.hasOwnProperty(q))return K[q];throw new Error("No such property '"+q+"'")}if("length"===q)return K=r.instances(),K.length}return r.prop_val(q)}if(r)return r[q]}else if("CallExpression"===y){if(w=window,"MemberExpression"===i.callee.type&&(w=h(i.callee.object,j)),m=h(i.callee,j),x=c.map(i.arguments,function(a){return h(a,j)}),c.isFunction(m))return m.apply(w,x);if(m instanceof a.ParsedFunction)return m._apply(j.js_context,j.pcontext,x)}else if("LogicalExpression"===y){var L=i.operator;if("&&"===L)return h(i.left,j)&&h(i.right,j);if("||"===L)return h(i.left,j)||h(i.right,j);console.log("No op "+L)}else{if("UpdateExpression"===y){var M,N=h(i.argument,j),O=i.operator;return"++"===O?M=N+1:"--"===O?M=N-1:console.error("Unknown operator ",O),"Identifier"===i.argument.type?(v=i.argument.name,j.var_map[v]=M):console.error("Unset"),i.prefix?N:M}if("ThisExpression"===y)return j.js_context;if("BreakStatement"===y)return e;if("ContinueStatement"===y)return f;if("NewExpression"===y){if(w=window,"MemberExpression"===i.callee.type&&(w=h(i.callee.object,j)),m=h(i.callee,j),x=c.map(i.arguments,function(a){return h(a,j)}),c.isFunction(m))return a.construct(m,x);m instanceof a.ParsedFunction&&console.error("unhandled case")}else{if("ObjectExpression"===y)return n={},c.each(i.properties,function(a){var b=a.key.name,c=h(a.value,j);n[b]=c}),n;if("DebuggerStatement"===y);else{if("EmptyStatement"!==y)return;console.log(y,i)}}}}}}}};a.ParsedFunction=function(a,b){this.node=a,this.options=b},function(a){var b=a.prototype;b._apply=function(a,b,e,f){var g=this.node,i={};i.arguments=e,c.each(g.params,function(a,b){var c=a.name,d=e[b];i[c]=d});var j={var_map:i,js_context:a,pcontext:b,ignore_inherited_in_contexts:this.options.ignore_inherited_in_contexts,auto_add_dependency:f&&f.auto_add_dependency},k=h(g.body,j);return k===d?j.rv:void 0},b._call=function(a,b){return this._apply.apply(this,[a,b,c.rest(arguments,2)])}}(a.ParsedFunction),a.get_fn_$=function(b,c){return new a.ParsedFunction(b,c)}}(interstate),function(a){"use strict";var b=a.cjs,c=a._,d=function(a,b){a.splice(b,1)},e=function(a,b){return a===b};a.get_map_diff=function(a,f,g,h,i,j){var k,l,m,n,o,p,q,r,s,t,u,v,w=b.arrayDiff(a,f,i),x=[],y=[],z=[],A=[],B=0,C=w.mapping,D=C.length;for(j=j||e;D>B;)l=C[B],c.has(l,"from")?c.has(l,"to")?(m=l.from,o=l.to,n=l.from_item,p=l.to_item,q=g[m],r=h[o],j(q,r)||A.push({key:p,from:q,to:r})):(m=l.from,n=l.from_item,q=g[m],y.push({key:n,value:q,from:m})):(o=l.to,p=l.to_item,r=h[o],x.push({key:p,value:r,to:o})),B++;for(B=0,s=x.length,t=y.length;s>B;){for(u=x[B],k=0;t>k;){if(v=y[B],j(g[v.from],h[u.to])){z.push({from:v.key,to:u.key}),d(x,B),d(y,k),B--,t--,s--;break}k++}B++}return{set:x,unset:y,key_change:z,value_change:A}}}(interstate,jQuery),function(a){"use strict";function b(){return(new Date).getTime()}var c=a.cjs,d=a._;a.createMouseObject=function(){var b=c(0),d=c(0),e=c(0),f=c(0),g=c(0),h=c(0),i=function(a){c.wait(),b.set(a.clientX),d.set(a.clientY),e.set(a.pageX),f.set(a.pageY),g.set(a.screenX),h.set(a.screenY),c.signal()},j=function(){window.addEventListener("mousemove",i)},k=function(){window.removeEventListener("mousemove",i)},l=function(a){c.wait(),k(),b.destroy(a),d.destroy(a),e.destroy(a),f.destroy(a),g.destroy(a),h.destroy(a),c.signal()},m=new a.Dict({has_protos:!1,value:{x:e,y:f,clientX:b,clientY:d,pageX:e,pageY:f,screenX:g,screenY:h}});return m.destroy=function(){a.Dict.prototype.destroy.apply(this,arguments),l()},m.__is_mouse_device__=!0,j(),m},a.register_serializable_type("ist_device_mouse",function(a){return a.__is_mouse_device__},function(){return{}},function(){return a.createMouseObject()}),a.createKeyboardObject=function(){var b={shift:16,ctrl:17,alt:18,cmd_left:91,cmd_right:93},e={},f={};d.each(b,function(a,b){f[b]=c(!1),e[a]=b});var g=function(a){var b=a.keyCode,c=e[b];c&&(f[c].set(!0),a.preventDefault())},h=function(a){var b=a.keyCode,c=e[b];e[b]&&(f[c].set(!1),a.preventDefault())},i=function(){window.addEventListener("keydown",g),window.addEventListener("keyup",h)},j=function(){window.removeEventListener("keydown",g),window.removeEventListener("keyup",h)},k=function(a){c.wait(),j(),l.destroy(a),m.destroy(a),n.destroy(a),o.destroy(a),p.destroy(a),q.destroy(a),c.signal()},l=f.shift,m=f.ctrl,n=f.alt,o=f.cmd_left,p=f.cmd_right,q=o.or(p),r=new a.Dict({has_protos:!1,value:{shift:l,ctrl:m,alt:n,cmd_left:o,cmd_right:p,cmd:q}});return r.destroy=function(){a.Dict.prototype.destroy.apply(this,arguments),k()},r.__is_keyboard_device__=!0,i(),r},a.register_serializable_type("ist_device_keyboard",function(a){return a.__is_keyboard_device__},function(){return{}},function(){return a.createKeyboardObject()}),a.createTouchscreenObject=function(){var e=["identifier","screenX","screenY","clientX","clientY","pageX","pageY","radiusX","radiusY","rotationAngle"],f={x:"pageX",y:"pageY"},g=c([]),h=c({}),i=function(a){c.wait(),d.each(a.changedTouches,function(a){var i,j,k=a.identifier;h.has(k)?(i=h.get(k),d.each(e,function(b){var c=a[b];i.put(b,c)})):(j={},i=c({}),h.put(k,i),d.each(e,function(b){var c=a[b];i.put(b,c),j[b]=c}),d.each(f,function(b,c){var d=a[b];i.put(c,d),j[c]=d}),i.put("start",j).put("end",!1).put("startTime",b()).put("endTime",!1).put("duration",!1)),g.indexOf(k)<0&&g.push(k)}),a.preventDefault(),c.signal()},j=function(a){c.wait(),d.each(a.changedTouches,function(a){var b=a.identifier;if(h.has(b)){var c=h.get(b);d.each(e,function(b){var d=a[b];c.put(b,d)}),d.each(f,function(b,d){var e=a[b];c.put(d,e)})}else console.error("Could not find changed touch")}),a.preventDefault(),c.signal()},k=function(a){c.wait(),d.each(a.changedTouches,function(a){var c=a.identifier;if(h.has(c)){var i=g.indexOf(c),j=h.get(c),k={};i>=0?(d.each(e,function(b){var c=a[b];k[b]=c}),d.each(f,function(b,c){var d=a[b];k[c]=d}),g.splice(i,1),j.put("end",k).put("endTime",b()).put("duration",j.get("endTime")-j.get("startTime"))):console.error("Could not find touch")}else console.error("Could not find ended touch")}),a.preventDefault(),c.signal()},l=function(){window.addEventListener("touchstart",i),window.addEventListener("touchmove",j),window.addEventListener("touchend",k),window.addEventListener("touchcancel",k)},m=function(){window.removeEventListener("touchstart",i),window.removeEventListener("touchmove",j),window.removeEventListener("touchend",k),window.removeEventListener("touchcancel",k)},n=function(a){c.wait(),m(),o.destroy(a),c.signal()},o=c(function(){return g.length()}),p=function(a){var b=g.item(a);return d.isNumber(b)?q(b):!1},q=function(a){var b=h.get(a);return b?b:!1},r=new a.Dict({has_protos:!1,value:{finger_count:o,getTouch:p,getTouchByID:q}});return r.destroy=function(){a.Dict.prototype.destroy.apply(this,arguments),n()},r.__is_touchscreen_device__=!0,l(),r},a.register_serializable_type("ist_device_touchscreen",function(a){return a.__is_touchscreen_device__},function(){return{}},function(){return a.createTouchscreenObject()}),a.createAccelorometerObject=function(){var b=c(0),d=c(0),e=c(0),f=function(a){c.wait(),b.set(a.accelerationIncludingGravity.x),d.set(a.accelerationIncludingGravity.y),e.set(a.accelerationIncludingGravity.z),c.signal()},g=function(){window.addEventListener("devicemotion",f)},h=function(){window.removeEventListener("devicemotion",f)},i=function(a){c.wait(),h(),b.destroy(a),d.destroy(a),e.destroy(a),c.signal()},j=new a.Dict({has_protos:!1,value:{x:b,y:d,z:e}});return j.destroy=function(){a.Dict.prototype.destroy.apply(this,arguments),i()},j.__is_accelorometer_device__=!0,g(),j},a.register_serializable_type("ist_device_accelorometer",function(a){return a.__is_accelorometer_device__},function(){return{}},function(){return a.createAccelorometerObject()}),a.createGyroscopeObject=function(){var b=c(0),d=c(0),e=c(0),f=c(0),g=c(0),h=function(a){c.wait(),b.set(a.alpha),d.set(a.beta),e.set(a.gamma),f.set(a.heading),g.set(a.accuracy),c.signal()},i=function(){window.addEventListener("deviceorientation",h)},j=function(){window.removeEventListener("deviceorientation",h)},k=function(a){c.wait(),j(),b.destroy(a),d.destroy(a),e.destroy(a),f.destroy(a),g.destroy(a),c.signal()},l=new a.Dict({has_protos:!1,value:{alpha:b,beta:d,gamma:e,heading:f,accuracy:g}});return l.destroy=function(){a.Dict.prototype.destroy.apply(this,arguments),k()},l.__is_gyroscope_device__=!0,i(),l},a.register_serializable_type("ist_device_gyroscope",function(a){return a.__is_gyroscope_device__},function(){return{}},function(){return a.createGyroscopeObject()}),a.createDevices=function(){var b=c(window.innerWidth),d=c(window.innerHeight),e=c(window.orientation),f=function(){c.wait(),b.set(window.innerWidth),d.set(window.innerHeight),c.signal()},g=function(){e.set(window.orientation)},h=function(){window.addEventListener("resize",f),window.addEventListener("orientationchange",g)},i=function(){window.removeEventListener("resize",f),window.removeEventListener("orientationchange",g)},j=function(a){c.wait(),i(),b.destroy(a),d.destroy(a),c.signal()},k=a.createMouseObject(),l=a.createKeyboardObject(),m=a.createTouchscreenObject(),n=a.createAccelorometerObject(),o=a.createGyroscopeObject(),p=new a.Dict({has_protos:!1,value:{mouse:k,keyboard:l,touchscreen:m,accelorometer:n,gyroscope:o,width:b,height:d}});return p.destroy=function(){a.Dict.prototype.destroy.apply(this,arguments),j()},p.__is_device__=!0,h(),p},a.register_serializable_type("ist_device",function(a){return a.__is_device__},function(){return{}},function(){return a.createDevices()})}(interstate),function(a){"use strict";var b=(a.cjs,a._);a.find_fn=function(b){if(0===arguments.length){var c=this;b=a.find_or_put_contextual_obj(c.root())}return new a.Query({value:b})},a.register_serializable_type("ist_find_fn_func",function(b){return b===a.find_fn},function(){return{}},function(){return a.find_fn}),a.Query=function(c){this.options=b.extend({value:[],parent_query:null},c),b.isArray(this.options.value)||(this.options.value=[this.options.value]),this.options.value=b.chain(this.options.value).map(function(b){return b instanceof a.ContextualDict&&b.is_template()?b.instances():b}).flatten(!0).value(),this.type=c.type||"root"},function(c){var d=c.prototype,e={lt:function(a,b){return b>a},gt:function(a,b){return a>b},le:function(a,b){return b>=a},ge:function(a,b){return a>=b},eq:function(a,b){return a===b}},f={in_state:function(b,c,d,e){var f,g,h;for(f=b instanceof a.ContextualStatefulObj?b.get_statecharts():[],g=0;g<f.length;g+=1){var i=f[g],j=i.get_active_states();for(h=0;h<j.length;h+=1){var k=j[h];if(k.get_name()===e)return!0}}return!1}};b.each(e,function(a,b){f[b]=function(b,c,d,e){var f=b.get_pointer(),g=f.val();return a(g,e)}}),b.each(f,function(a,c){d[c]=function(){var c=b.toArray(arguments);return this.filter(function(){return a.apply(this,b.toArray(arguments).concat(c))})}});var g={prop:function(a,b,c,d){var e=a.prop(d);return e},container:function(b){var c=b.get_pointer(),d=c.pop(),e=d.points_at(),f=a.find_or_put_contextual_obj(e,d);return f}};b.each(g,function(a,c){d[c]=function(){var c=b.toArray(arguments);return this.map(function(){return a.apply(this,b.toArray(arguments).concat(c))})}}),d.filter=function(a,c){return this.op(function(d){return b.filter(d,a,c)})},d.eq=function(a){var b=this.value();return b[a]},d.map=function(a,c){return this.op(function(d){return b.map(d,a,c)})},d.size=function(){return this.value().length},d.is_empty=function(){return 0===this.size()};var h=function(){var c=b.chain(arguments).map(function(c){var d;return d=c instanceof a.Query?c.value():b.isArray(c)?c:[c]}).flatten(!0).value();return c};d.add=function(){var b=new RedSet({value:this.value(),equals:a.check_contextual_object_equality,hash:"hash"}),c=h.apply(this,arguments),d=b.add.apply(b,c),e=new a.Query({value:d.toArray(),parent_query:this,type:"add"});return e},d.not=d.remove=function(){var b=new RedSet({value:this.value(),equals:a.check_contextual_object_equality,hash:"hash"}),c=h.apply(this,arguments);b.remove.apply(b,c);var d=new a.Query({value:b.toArray(),parent_query:this,type:"not"});return d},d.op=function(a,b){var d=a.call(b||window,this.value()),e=new c({value:d,parent_query:this,type:"op"});return e},d.value=function(){return this.options.value},d.parent_query=function(){return this.options.parent_query};var i=function(b){return b instanceof a.ContextualDict},j=function(a,c){var d=c?a:b.filter(a,i);return b.each(d,function(a){var c=a.children();b.each(c,function(a){var b=a.value;i(b)&&(b.is_template()?d.push.apply(d,j(b.instances(),!0)):d.push.apply(d,j([b],!0)))})}),d};d.inheritsFrom=function(a){var d=j(this.value()),e=b.filter(d,function(b){return b.inherits_from(a)}),f=new c({value:e,parent_query:this,type:"inheritsFrom"});return f}}(a.Query)}(interstate),function(a){"use strict";var b=(a.cjs,a._);a.get_default_root=function(b){var c=new a.Dict({has_protos:!1,direct_attachments:[new a.DomAttachment({instance_options:{tag:"div"}})]});return a.initialize_root(c,b),c},a.initialize_root=function(c,d){if(d!==!1&&!b.isArray(d)||b.indexOf(d,"svg")>=0){var e=new a.Dict({has_protos:!1});c.set("svg",e);var f=new a.Dict({has_protos:!1,direct_attachments:[new a.PaperAttachment]});f.set("width",new a.Cell({str:"400"})),f.set("height",new a.Cell({str:"400"})),f.set("fill",new a.Cell({str:"'white'"})),e.set("paper",f);var g=new a.Dict({has_protos:!1,direct_attachments:[new a.ShapeAttachment({instance_options:{shape_type:"circle",constructor_params:[0,0,0]}})]});e.set("circle",g),g.set("show",new a.Cell({str:"true"})),g.set("clip_rect",new a.Cell({str:"null"})),g.set("cursor",new a.Cell({str:"'default'"})),g.set("cx",new a.Cell({str:"2*r"})),g.set("cy",new a.Cell({str:"2*r"})),g.set("fill",new a.Cell({str:"'teal'"})),g.set("fill_opacity",new a.Cell({str:"1.0"})),g.set("opacity",new a.Cell({str:"1.0"})),g.set("r",new a.Cell({str:"50"})),g.set("stroke",new a.Cell({str:"'none'"})),g.set("stroke_dasharray",new a.Cell({str:"''"})),g.set("stroke_opacity",new a.Cell({str:"1.0"})),g.set("stroke_width",new a.Cell({str:"1"})),g.set("transform",new a.Cell({str:"''"})),g.set("animated_properties",new a.Cell({str:"false"})),g.set("animation_duration",new a.Cell({str:"300"})),g.set("animation_easing",new a.Cell({str:"'linear'"})),g.set("shape",new a.Cell({str:"'circle'"}));var h=new a.Dict({has_protos:!1,direct_attachments:[new a.ShapeAttachment({instance_options:{shape_type:"ellipse",constructor_params:[0,0,0,0]}})]});e.set("ellipse",h),h.set("show",new a.Cell({str:"true"})),h.set("clip_rect",new a.Cell({str:"null"})),h.set("cursor",new a.Cell({str:"'default'"})),h.set("cx",new a.Cell({str:"2*rx"})),h.set("cy",new a.Cell({str:"2*ry"})),h.set("fill",new a.Cell({str:"'yellow'"})),h.set("fill_opacity",new a.Cell({str:"1.0"})),h.set("opacity",new a.Cell({str:"1.0"})),h.set("rx",new a.Cell({str:"150"})),h.set("ry",new a.Cell({str:"90"})),h.set("stroke",new a.Cell({str:"'none'"})),h.set("stroke_dasharray",new a.Cell({str:"''"})),h.set("stroke_opacity",new a.Cell({str:"1.0"})),h.set("stroke_width",new a.Cell({str:"1"})),h.set("transform",new a.Cell({str:"''"})),h.set("animated_properties",new a.Cell({str:"false"})),h.set("animation_duration",new a.Cell({str:"300"})),h.set("animation_easing",new a.Cell({str:"'linear'"})),h.set("shape",new a.Cell({str:"'ellipse'"}));var i=new a.Dict({has_protos:!1,direct_attachments:[new a.ShapeAttachment({instance_options:{shape_type:"image",constructor_params:["",0,0,0,0]}})]});e.set("image",i),i.set("show",new a.Cell({str:"true"})),i.set("clip_rect",new a.Cell({str:"null"})),i.set("cursor",new a.Cell({str:"'default'"})),i.set("opacity",new a.Cell({str:"1.0"})),i.set("src",new a.Cell({str:"'http://interstate.from.so/images/interstate_logo.png'"})),i.set("transform",new a.Cell({str:"''"})),i.set("x",new a.Cell({str:"20"})),i.set("y",new a.Cell({str:"20"})),i.set("width",new a.Cell({str:"150"})),i.set("height",new a.Cell({str:"150"})),i.set("animated_properties",new a.Cell({str:"false"})),i.set("animation_duration",new a.Cell({str:"300"})),i.set("animation_easing",new a.Cell({str:"'linear'"})),i.set("shape",new a.Cell({str:"'image'"}));var j=new a.Dict({has_protos:!1,direct_attachments:[new a.ShapeAttachment({instance_options:{shape_type:"rect",constructor_params:[0,0,0,0]}})]});e.set("rectangle",j),j.set("show",new a.Cell({str:"true"})),j.set("clip_rect",new a.Cell({str:"null"})),j.set("cursor",new a.Cell({str:"'default'"})),j.set("x",new a.Cell({str:"10"})),j.set("y",new a.Cell({str:"10"})),j.set("fill",new a.Cell({str:"'Chartreuse'"})),j.set("fill_opacity",new a.Cell({str:"1.0"})),j.set("opacity",new a.Cell({str:"1.0"})),j.set("r",new a.Cell({str:"0"})),j.set("stroke",new a.Cell({str:"'none'"})),j.set("stroke_dasharray",new a.Cell({str:"''"})),j.set("stroke_opacity",new a.Cell({str:"1.0"})),j.set("stroke_width",new a.Cell({str:"1"})),j.set("transform",new a.Cell({str:"''"})),j.set("width",new a.Cell({str:"150"})),j.set("height",new a.Cell({str:"100"})),j.set("animated_properties",new a.Cell({str:"false"})),j.set("animation_duration",new a.Cell({str:"300"})),j.set("animation_easing",new a.Cell({str:"'linear'"})),j.set("shape",new a.Cell({str:"'rectangle'"}));var k=new a.Dict({has_protos:!1,direct_attachments:[new a.ShapeAttachment({instance_options:{shape_type:"text",constructor_params:[0,0,""]}})]});e.set("text",k),k.set("show",new a.Cell({str:"true"})),k.set("clip_rect",new a.Cell({str:"null"})),k.set("cursor",new a.Cell({str:"'default'"})),k.set("x",new a.Cell({str:"200"})),k.set("y",new a.Cell({str:"150"})),k.set("opacity",new a.Cell({str:"1.0"})),k.set("stroke",new a.Cell({str:"'none'"})),k.set("fill",new a.Cell({str:"'grey'"})),k.set("fill_opacity",new a.Cell({str:"1.0"})),k.set("stroke_dasharray",new a.Cell({str:"''"})),k.set("stroke_opacity",new a.Cell({str:"1.0"})),k.set("stroke_width",new a.Cell({str:"1"})),k.set("transform",new a.Cell({str:"''"})),k.set("text",new a.Cell({str:"'hello world'"})),k.set("text_anchor",new a.Cell({str:"'middle'"})),k.set("font_family",new a.Cell({str:"'Arial'"})),k.set("font_size",new a.Cell({str:"40"})),k.set("font_weight",new a.Cell({str:"400"})),k.set("font_style",new a.Cell({str:"'normal'"})),k.set("animated_properties",new a.Cell({str:"false"})),k.set("animation_duration",new a.Cell({str:"300"})),k.set("animation_easing",new a.Cell({str:"'linear'"})),k.set("shape",new a.Cell({str:"'text'"}));var l=new a.Dict({has_protos:!1,direct_attachments:[new a.ShapeAttachment({instance_options:{shape_type:"path",constructor_params:["M0,0"]}})]});e.set("path",l),l.set("show",new a.Cell({str:"true"})),l.set("clip_rect",new a.Cell({str:"null"})),l.set("cursor",new a.Cell({str:"'default'"})),l.set("fill",new a.Cell({str:"'none'"})),l.set("fill_opacity",new a.Cell({str:"1.0"})),l.set("opacity",new a.Cell({str:"1.0"})),l.set("stroke",new a.Cell({str:"'RoyalBlue'"})),l.set("stroke_dasharray",new a.Cell({str:"''"})),l.set("stroke_opacity",new a.Cell({str:"1.0"})),l.set("stroke_miterlimit",new a.Cell({str:"0"})),l.set("stroke_width",new a.Cell({str:"1"})),l.set("path",new a.Cell({str:"'M0,0L300,300'"})),l.set("transform",new a.Cell({str:"''"})),l.set("animated_properties",new a.Cell({str:"false"})),l.set("animation_duration",new a.Cell({str:"300"})),l.set("animation_easing",new a.Cell({str:"'linear'"})),l.set("shape",new a.Cell({str:"'path'"}));var m=new a.Dict({has_protos:!1,direct_attachments:[new a.GroupAttachment]});e.set("group",m),m.set("showChildren",new a.Cell({str:"true"}))}if(d!==!1&&!b.isArray(d)||b.indexOf(d,"dom")>=0){var n=new a.Dict({has_protos:!1});c.set("dom",n);var o=new a.Dict({direct_attachments:[new a.DomAttachment]});n.set("node",o),o.set("tag",new a.Cell({str:"'div'"})),o.set("attr",new a.Dict),o.set("style",new a.Dict),o.set("textContent",new a.Cell({str:"'no text'"})),o.set("show",new a.Cell({str:"true"})),o.set("showChildren",new a.Cell({str:"true"}));var p=new a.Dict;n.set("div",p),p._set_direct_protos(new a.Cell({ignore_inherited_in_first_dict:!0,str:"dom.node"})),p.set("tag",new a.Cell({str:"'div'"}));var q=new a.Dict;n.set("input",q),q._set_direct_protos(new a.Cell({ignore_inherited_in_first_dict:!0,str:"dom.node"})),q.set("tag",new a.Cell({str:"'input'"})).set("textContent",new a.Cell({str:"''"})),b.each(["strong","span","ul","ol","li","h1","h2","h3","h4","h5","h6","table","tbody","tr","td","th","p","pre","br","a","label","img","select","option","button","hr"],function(b){var c=new a.Dict;n.set(b,c),c._set_direct_protos(new a.Cell({ignore_inherited_in_first_dict:!0,str:"dom.node"})),c.set("tag",new a.Cell({str:"'"+b+"'"}))})}if(d!==!1&&!b.isArray(d)||b.indexOf(d,"physics")>=0){var r=new a.Dict({has_protos:!1});c.set("physics",r);var s=new a.Dict({direct_attachments:[new a.WorldAttachment]});r.set("world",s),s.set("gx",new a.Cell({str:"0.0"})),s.set("gy",new a.Cell({str:"9.8"}));var t=new a.Dict({direct_attachments:[new a.FixtureAttachment]});r.set("fixture",t),t.set("fixed",new a.Cell({str:"true"})),t.set("restitution",new a.Cell({str:"0.2"})),t.set("friction",new a.Cell({str:"0.5"})),t.set("density",new a.Cell({str:"1.0"})),t.set("world",new a.Cell({str:"physics.world"})),t.set("computed_x",new a.Cell({str:"fetch_physics_info(this, 'getComputedX')"})),t.set("computed_y",new a.Cell({str:"fetch_physics_info(this, 'getComputedY')"})),t.set("computed_theta",new a.Cell({str:"fetch_physics_info(this, 'getComputedTheta')"})),t.set("applyForce",new a.Cell({str:"physics_call(this, 'applyForce')"})),t.set("applyImpulse",new a.Cell({str:"physics_call(this, 'applyImpulse')"})),t.set("physics_call",new a.Cell({str:"function(p, prop_name) {var fixture_attachment = interstate.get_attachment(p, 'box2d_fixture');return fixture_attachment[prop_name].bind(fixture_attachment);}"})),t.set("fetch_physics_info",new a.Cell({str:"function(p, prop_name) {var fixture_attachment = interstate.get_attachment(p, 'box2d_fixture');return fixture_attachment[prop_name]();}"}))}if((d!==!1&&!b.isArray(d)||b.indexOf(d,"functions")>=0)&&(c.set("on",a.on_event),c.set("find",a.find_fn),c.set("emit",a.emit)),d!==!1&&!b.isArray(d)||b.indexOf(d,"device")>=0){var u=a.createDevices();c.set("device",u)}}}(interstate),function(a){"use strict";a.cjs,a._;a.BasicObject=function(b,c){able.make_this_listenable(this),b=b||{},this._id=b.uid||uid(),this._hash=uid.strip_prefix(this.id()),this.options=b,a.register_uid(this.id(),this),c!==!0&&this.initialize(b)},function(b){var c=b.prototype;able.make_proto_listenable(c),b.builtins={},a.install_proto_builtins(c,b.builtins),c.initialize=function(c){a.install_instance_builtins(this,c,b)},c.clone=function(){},c.begin_destroy=function(){this._emit("begin_destroy")},c.destroy=function(){this.constructor===b&&this.begin_destroy(),a.unset_instance_builtins(this,b),a.unregister_uid(this.id()),this._emit("destroyed"),able.destroy_this_listenable(this),this._destroyed=!0},c.id=function(){return this._id},c.hash=function(){return this._hash},c.sid=function(){return parseInt(uid.strip_prefix(this.id()),10)},c.summarize=function(){return this.id()}}(a.BasicObject)}(interstate),function(a){"use strict";var b=a.cjs,c=a._;a.Cell=function(){a.Cell.superclass.constructor.apply(this,arguments)},function(d){c.proto_extend(d,a.BasicObject);var e=d.prototype;d.builtins={str:{start_with:function(){return b("")},getter:function(a){return a.get()},setter:function(a,b){a.set(b,!0)},destroy:function(a){a.destroy(!0)}},ignore_inherited_in_first_dict:{"default":function(){return!1}},contextual_values:{"default":function(){return b.map({equals:a.check_pointer_equality,hash:"hash"})},settable:!1,serialize:!1,destroy:function(a){a.forEach(function(a){a.destroy(!0)}),a.destroy(!0)}},substantiated:{"default":function(){return!1},getter_name:"is_substantiated"}},a.install_proto_builtins(e,d.builtins),e.initialize=function(c){d.superclass.initialize.apply(this,arguments),a.install_instance_builtins(this,c,d),this._tree=b(function(){var b=this.get_str();return a.parse(b)},{context:this}),this._is_static=b(function(){var a=this._tree.get();return 0===a.body.length||1===a.body.length&&"ExpressionStatement"===a.body[0].type&&"Literal"===a.body[0].expression.type},{context:this}),this._static_value=b(function(){var a=this._tree.get();return a.body.length>0?a.body[0].expression.value:void 0},{context:this})},e.substantiate=function(){this.set_substantiated(!0),this._emit("substantiated")},e.clone=function(){return new a.Cell({str:this.get_str()})},e.get_ignore_inherited_in_contexts=function(b){var c;if(this.get_ignore_inherited_in_first_dict())for(c=b.length()-1;c>=0;c-=1){var d=b.points_at(c);if(d instanceof a.Dict)return[d]}return[]},e.get_syntax_errors=function(){var b=this._tree.get();return b instanceof a.Error?[b.message()]:[]},e.constraint_in_context=function(b,c){if(this._is_static.get())return this._static_value.get();var d=this._tree.get();return a.get_parsed_$(d,{context:b,ignore_inherited_in_contexts:this.get_ignore_inherited_in_contexts(b),get_constraint:!0,inherited_from_cobj:c})},e.value_in_context=function(b,c){if(this._is_static.get())return this._static_value.get();var d=this._tree.get();return a.get_parsed_$(d,{context:b,ignore_inherited_in_contexts:this.get_ignore_inherited_in_contexts(b),get_constraint:!1,inherited_from_cobj:c})},e.destroy=function(){this.constructor===d&&this.begin_destroy(),a.unset_instance_builtins(this,d),this._tree.destroy(!0),delete this._tree,this._static_value.destroy(!0),delete this._static_value,this._is_static.destroy(!0),delete this._is_static,d.superclass.destroy.apply(this,arguments)},a.register_serializable_type("cell",function(a){return a instanceof d},function(b){var e={};return b&&(e.uid=this.id()),c.each(d.builtins,function(b,c){if(b.serialize!==!1){var d=b.getter_name||"get_"+c;e[c]=a.serialize(this[d]())}},this),e},function(b){var f=c.rest(arguments),g={};c.each(d.builtins,function(a,c){a.serialize!==!1&&(g[c]=b[c])});var h=new d({uid:b.uid},!0),i=e.initialize;return h.initialize=function(){delete this.initialize;var b={};c.each(g,function(c,d){b[d]=a.deserialize.apply(a,[c].concat(f))}),i.call(this,b)},h})}(a.Cell)}(interstate),function(a){"use strict";var b=a.cjs,c=a._;a.POINTERS_PROPERTY={},a.MANIFESTATIONS_PROPERTY={},a.is_inherited=function(b){return void 0!==a.inherited_root(b)},a.inherited_root=function(a){var b,c;b=a.points_at();var d,e,f=!1;for(e=a.length()-2;e>=0;e-=1){if(c=a.points_at(e),d=c.src_for_prop(b,a.slice(0,e+1)),d===c){if(f)return a.slice(0,e+3)}else void 0!==d&&(f=!0);b=c}return void 0},a.Dict=function(b,d){b=c.extend({value:{},keys:[],values:[],has_protos:!0,has_copies:!0},b),a.Dict.superclass.constructor.call(this,b,d),this.type="ist_dict"},function(d){c.proto_extend(d,a.BasicObject);var e=d.prototype;e.initialize=function(b){d.superclass.initialize.apply(this,arguments),a.install_instance_builtins(this,b,d);var c=this.direct_props();c.setValueEqualityCheck(function(a,b){return a.value===b.value})},d.builtins={direct_protos:{"default":function(){return b.array()},getter_name:"direct_protos",setter_name:"_set_direct_protos",env_visible:!0,env_name:"prototypes",destroy:function(a){a.destroy(!0)}},direct_attachments:{"default":function(){return[]},getter_name:"direct_attachments",destroy:function(a){b.isArrayConstraint(a)?(a.forEach(function(a){a.destroy(!0)}),a.destroy(!0)):c.isArray(a)&&c.each(a,function(a){a.destroy(!0)})}},direct_props:{"default":function(){var a=this.options.keys,d=c.map(this.options.values,function(a){return{value:a,owner:this}},this),e={};c.each(this.options.value,function(a,b){e[b]={value:a,owner:this}},this);var f=b.map({keys:a,values:d,value:e});return f},getter_name:"direct_props",destroy:function(a){a.forEach(function(a){a.value.destroy&&a.value.destroy(!0),delete a.owner,delete a.value}),a.destroy(!0)}},copies:{start_with:function(){return b.constraint(new a.Cell({str:""}))},env_visible:!1,env_name:"copies",getter:function(a){return a.get()},setter:function(a,b){var c=a.get();c&&c.destroy&&c.destroy(!0),a.set(b,!0)},destroy:function(a){var b=a.get();b&&b.destroy&&b.destroy(),a.destroy(!0)}}},a.install_proto_builtins(e,d.builtins),e.has_protos=function(){return this.options.has_protos},e.has_copies=function(){return this.options.has_copies},e.set=e.set_prop=e._set_direct_prop=function(a,b,d){var e=c.extend({value:b,owner:this},d);return this.direct_props().put(a,e,e.index),this},e.unset=e.unset_prop=e._unset_direct_prop=function(a){return this.direct_props().remove(a),this},e._get_direct_prop=function(a){var b=this._get_direct_prop_info(a);return b?b.value:void 0},e._get_direct_prop_info=function(a){return this.direct_props().get(a)},e._has_direct_prop=function(a){return this.direct_props().has(a)},e.move=e.move_prop=e._move_direct_prop=function(a,b){return this.direct_props().move(a,b),this},e.index=e.prop_index=e._direct_prop_index=function(a){return this.direct_props().indexOf(a)},e.rename=e._rename_direct_prop=function(a,c){if(this._has_direct_prop(c))throw new Error("Already a property with name "+c);var d=this.direct_props(),e=d.indexOf(a);if(!(e>=0))throw new Error("No such property "+a);var f=d.get(a);b.wait(),d.remove(a).put(c,f,e),b.signal()},e._get_direct_prop_names=function(){return this.direct_props().keys()},e.get_builtins=function(){for(var a=c.clone(this.constructor.builtins),b=this.constructor.superclass;b;)c.extend(a,b.constructor.builtins),b=b.superclass;return a};var f=["prototypes"],g=[];e._get_builtin_prop_names=function(){return this.has_protos()?f:g
},e._get_builtin_prop_info=function(a){var b,c=this.get_builtins();for(b in c)if(c.hasOwnProperty(b)){var d=c[b];if(d.env_visible===!0){var e=d.env_name||b;if(a===e){var f=d.getter_name||"get_"+b;return{value:this[f]()}}}}},e._get_builtin_prop=function(a){var b=this._get_builtin_prop_info(a);return b?b.value:void 0},e._has_builtin_prop=function(a){return"prototypes"===a&&this.has_protos()},e._get_direct_attachments=function(){var a=this.direct_attachments();return b.isArrayConstraint(a)?this.direct_attachments().toArray():c.isArray(a)?a:[a]},e.clone=function(){return a.deserialize(a.serialize(this,!1))},e.destroy=function(){this.constructor===d&&this.begin_destroy(),a.unset_instance_builtins(this,d),d.superclass.destroy.apply(this,arguments)},e.toString=function(){return"dict:"+this.uid},e.serialize=function(b){var d={has_protos:this.has_protos(),has_copies:this.has_copies()};b&&(d.uid=this.id());var e=c.toArray(arguments);return c.each(this.get_builtins(),function(b,c){var f=b._get_getter_name();d[c]=a.serialize.apply(a,[this[f]()].concat(e))},this),d},a.register_serializable_type("dict",function(a){return a instanceof d&&a.constructor===d},e.serialize,function(b){var f=c.rest(arguments),g={};c.each(d.builtins,function(a,c){g[c]=b[c]});var h=new d({uid:b.uid,has_protos:b.has_protos,has_copies:b.has_copies},!0),i=e.initialize;return h.initialize=function(){delete this.initialize;var b={};c.each(g,function(c,d){b[d]=a.deserialize.apply(a,[c].concat(f))}),i.call(this,b)},h})}(a.Dict)}(interstate),function(a){"use strict";var b=(a.cjs,a._);a.StatefulObj=function(){a.StatefulObj.superclass.constructor.apply(this,arguments),this.type="ist_stateful_obj"},function(c){b.proto_extend(c,a.Dict);var d=c.prototype;d.initialize=function(b){c.superclass.initialize.apply(this,arguments),a.install_instance_builtins(this,b,c)},c.builtins={direct_statechart:{"default":function(){return new a.Statechart},getter_name:"get_own_statechart",settable:!1,destroy:function(a){a.destroy(!0)}}},a.install_proto_builtins(d,c.builtins),d.destroy=function(){this.constructor===c&&this.begin_destroy(),c.superclass.destroy.apply(this,arguments),a.unset_instance_builtins(this,c)},a.register_serializable_type("stateful_obj",function(a){return a instanceof c},c.superclass.serialize,function(e){var f=b.rest(arguments),g=b.extend({},c.builtins,c.superclass.constructor.builtins),h={};b.each(g,function(a,b){h[b]=e[b]});var i=new c({uid:e.uid},!0),j=d.initialize;return i.initialize=function(){var c={};b.each(h,function(b,d){c[d]=a.deserialize.apply(a,[b].concat(f))}),j.call(this,c)},i})}(a.StatefulObj)}(interstate),function(a){"use strict";var b=a.cjs,c=a._;a.StatefulProp=function(){a.StatefulProp.superclass.constructor.apply(this,arguments)},function(d){c.proto_extend(d,a.BasicObject);var e=d.prototype;e.initialize=function(b){d.superclass.initialize.apply(this,arguments),a.install_instance_builtins(this,b,d),this.get_direct_values().setHash("hash")},d.builtins={direct_values:{"default":function(){return b.map()},env_visible:!1,destroy:function(a){a.forEach(function(a){a.destroy(!0)}),a.destroy(!0)}},can_inherit:{"default":function(){return!0}},statechart_parent:{"default":function(){return"parent"},destroy:function(){}}},a.install_proto_builtins(e,d.builtins);var f=function(a){var b=a.basis();return c.isUndefined(b)&&(b=a),b};e.set=e._set_direct_value_for_state=function(b,c){c instanceof a.Cell&&(this.get_can_inherit()||c.set_ignore_inherited_in_first_dict(!0)),b=f(b),this.get_direct_values().put(b,c)},e.clone=function(d){var e=d.get_values(),f=[],g=[];c.each(e,function(a){f.push(a.state.basis()),g.push(a.value.clone())});var h=b.map({keys:f,values:g}),i=new a.StatefulProp({direct_values:h});return i},e.unset=e._unset_direct_value_for_state=function(a){var b=this.get_direct_values();a=f(a),b.remove(a)},e._direct_value_for_state=function(a){return a=f(a),this.get_direct_values().get(a)},e._has_direct_value_for_state=function(a){return a=f(a),this.get_direct_values().has(a)},e.destroy=function(){this.constructor===d&&this.begin_destroy(),a.unset_instance_builtins(this,d),d.superclass.destroy.apply(this,arguments)},a.register_serializable_type("stateful_prop",function(a){return a instanceof d},function(b){var e=c.toArray(arguments),f={};return c.each(d.builtins,function(b,c){if(b.serialize!==!1){var d=b._get_getter_name();f[c]=a.serialize.apply(a,[this[d]()].concat(e))}},this),b&&(f.uid=this.id()),f},function(b,f){var g=new d({uid:b.uid},!0),h={};c.each(d.builtins,function(a,c){a.serialize!==!1&&(h[c]=b[c])});var i=c.rest(arguments,2),j=e.initialize;return g.initialize=function(){delete this.initialize,f=c.extend({},f),c.each(h,function(b,c){f[c]=a.deserialize.apply(a,[b,f].concat(i))}),j.call(this,f),f=null},g})}(a.StatefulProp)}(interstate),function(a){"use strict";var b=(a.cjs,a._);a.find_stateful_obj_and_context=function(b){for(var c,d;!b.is_empty();){if(d=b.points_at(),d instanceof a.StatefulObj)return{stateful_obj:d,context:b};c=d,b=b.pop()}return void 0},a.Pointer=function(a){if(this._stack=a&&a.stack||[],this._hashes=a&&a.hashes||[],this._special_contexts=a&&a.special_contexts||new Array(this._stack.length),this._stack.length!==this._special_contexts.length)throw new Error("Different lengths for stack and special contexts")},function(c){var d=c.prototype;d.points_at=function(a){return b.isNumber(a)?0>a&&(a+=this._stack.length):a=this._stack.length-1,this._stack[a]},d.length=function(){return this._stack.length},d.special_contexts=function(a){return b.isNumber(a)?0>a&&(a+=this._special_contexts.length):a=this._special_contexts.length-1,this._special_contexts[a]||[]},d.has_special_contexts=function(a){return b.isNumber(a)||(a=this._special_contexts.length-1),b.isArray(this._special_contexts[a])},d.raw_last_special_contexts=function(){return this._special_contexts[this._special_contexts.length-1]},d.slice=function(){return new a.Pointer({stack:this._stack.slice.apply(this._stack,arguments),special_contexts:this._special_contexts.slice.apply(this._special_contexts,arguments),hashes:this._hashes.slice.apply(this._hashes,arguments)})},d.splice=function(){var c=b.clone(this._stack),d=b.clone(this._special_contexts),e=b.clone(this._hashes);return c.splice.apply(c,arguments),d.splice.apply(d,arguments),hahes_copy.splice.apply(e,arguments),new a.Pointer({stack:c,special_contexts:d,hashees:e})},d.push=function(c,d){var e;return e=this._special_contexts.concat(d?b.isArray(d)?d.length>0?[d]:void 0:[[d]]:void 0),new a.Pointer({stack:this._stack.concat(c),special_contexts:e,hashes:b.clone(this.hashes)})},d.push_special_context=function(c){var d=b.clone(this._special_contexts),e=d.length-1,f=d[e];return d[e]=f?f.concat(c):[c],new a.Pointer({stack:this._stack,special_contexts:d,hashes:b.clone(this.hashes)})},d.pop=function(){var b=this._stack.length-1;return new a.Pointer({stack:this._stack.slice(0,b),special_contexts:this._special_contexts.slice(0,b),hashes:this._hashes.slice(0,b)})},d.has=function(a){return this.indexOf(a)>=0},d.indexOf=function(a){return this._stack.indexOf(a)},d.lastIndexOf=function(a){return this._stack.lastIndexOf(a)},d.root=function(){return this._stack[0]},d.is_empty=function(){return 0===this._stack.length},d.eq=function(a){if(this===a)return!0;if(this.hash()!==a.hash())return!1;var b=this._stack,c=a._stack,d=b.length,e=c.length;if(d!==e)return!1;var f,g;for(f=d-1;f>=0;f-=1){if(b[f]!==c[f])return!1;var h=this._special_contexts[f],i=a._special_contexts[f];if(h&&i){var j=h.length;if(j!==i.length)return!1;for(g=0;j>g;g++)if(!h[g].eq(i[g]))return!1}else if(h||i)return!1}return!0};var e=2;d.compute_hash=function(){for(var a=0,b=this._stack.length-1,c=Math.max(0,b-e);b>=c;)a+=this.itemHash(b--);return a},d.compute_item_hash=function(a){var b,c=1,d=0,e=this._special_contexts[a];if(this._stack[a].hash&&(c+=this._stack[a].hash()),e)for(b=e.length;b>d;)c+=e[d++].hash();return c},d.hash=function(){return this.computed_hash||(this.computed_hash=this.compute_hash())},d.itemHash=function(a){return this._hashes[a]||(this._hashes[a]=this.compute_item_hash(a))},d.toString=function(){return"pointer ("+b.map(this._stack,function(c,d){var e=c.id?uid.strip_prefix(c.id()):c.toString(),f=this._special_contexts[d];return f&&b.each(f,function(b){b instanceof a.CopyContext&&(e+="["+b.get_copy_num()+"]")}),e},this).join(", ")+")"},d.getContextualObjects=function(){return b.map(this._stack,function(b,c){return a.find_or_put_contextual_obj(b,this.slice(0,c+1))},this)},d.summarize=function(){var c=b.map(this._stack,function(a){return a.id()}),d=b.map(this._special_contexts,function(c){return b.isArray(c)?b.map(c,function(b){return b instanceof a.CopyContext?{type:"manifestation_context",index:b.get_copy_num()}:b instanceof a.StateContext?{type:"event_context"}:void console.error("Unknown special context type")}):void 0});return{stack_ids:c,special_context_info:d}},c.desummarize=function(c){var d,e=b.map(c.stack_ids,function(b){return a.find_uid(b)}),f=[],g=c.special_context_info,h=function(b){if("manifestation_context"===b.type){var c=a.create("pointer",{stack:e.slice(0,d)}),f=e[d];f.get_manifestations(c)}else console.error("Unhandled special context type")};for(d=0;d<g.length;d+=1)f[d]=b.isArray(g[d])?b.map(g[d],h):void 0;var i=a.create("pointer",{stack:e,special_contexts:f});return i}}(a.Pointer),a.is_pointer=function(b){return b instanceof a.Cell||b instanceof a.StatefulProp},a.check_pointer_equality=a.check_pointer_equality_eqeqeq=function(b,c){return b instanceof a.Pointer&&c instanceof a.Pointer?b.eq(c):b===c},a.pointer_hash=function(a){return a&&a.hash?a.hash():a.toString()},a.check_special_context_equality=function(a,b){var c,d=a.length,e=b.length;if(d===e){for(c=d-1;c>=0;c-=1)if(!a[c].eq(b[c]))return!1;return!0}return!1}}(interstate),function(a){"use strict";var b=(a.cjs,a._),c=0;a.SpecialContext=function(){this._id="c"+(c+=1),this.context_obj={}},function(a){var b=a.prototype;b.id=b.hash=function(){return this._id},b.get_context_obj=function(){return this.context_obj},b.eq=function(a){return this===a}}(a.SpecialContext),a.ProvisionalContext=function(a){this.values=a||{}},function(c){b.proto_extend(c,a.SpecialContext);var d=c.prototype;d.has=function(a){return this.values.hasOwnProperty(a)},d.get=function(a){return this.values[a]},d.set=function(a,b){this.values[a]=b},d.eq=function(a){return a instanceof c}}(a.ProvisionalContext),a.StateContext=function(b){a.StateContext.superclass.constructor.apply(this,arguments),this.state=b,this.context_obj={event:{value:b._last_run_event}}},function(c){b.proto_extend(c,a.SpecialContext);var d=c.prototype;d.get_state=function(){return this.state},d.get_event=function(){var a=this.get_state();return a.get_event()},d.eq=function(a){return a instanceof c&&a.state===this.state},d.hash=function(){return this.state.hash()}}(a.StateContext),a.CopyContext=function(c,d,e,f){a.CopyContext.superclass.constructor.apply(this,arguments),this.my_copy=d,this.copy_num=e,this.context_obj={my_copy:b.extend({value:d},f),copy_num:b.extend({value:e},f)},this._owner=c},function(c){b.proto_extend(c,a.SpecialContext);var d=c.prototype;d.get_copy_num=function(){return this.copy_num},d.hash=function(){return this.copy_num+1}}(a.CopyContext)}(interstate),function(a){"use strict";var b=a.cjs,c=a._;a.ContextualObject=function(c){var d=uid();a.register_uid(d,this),this._id=d,this._hash=uid.strip_prefix(d),this._initialized=!1,this._destroyed=!1,this._type="none",this._cobj_children=b.map({hash:function(a){return a.hash()},equals:function(a,b){return a.eq(b)}}),able.make_this_listenable(this),this.object=c.object,this.pointer=c.pointer,this.inherited_from=c.inherited_from||!1,this.$value=new b.Constraint(this._getter,{context:this,check_on_nullify:c&&c.check_on_nullify===!0,equals:c&&c.equals||void 0}),this._do_destroy_no_args=function(){this.destroy()},this.object.on("begin_destroy",this._do_destroy_no_args,this),c.defer_initialization!==!0&&this.initialize(c)},function(d){var e=d.prototype;able.make_proto_listenable(e),e.initialize=function(){this.constructor===d&&this.flag_as_initialized(),this.constructor===d&&this.shout_initialization()},e.flag_as_initialized=function(){this._initialized=!0},e.shout_initialization=function(){this._emit("initialized",this)},e.is_initialized=function(){return this._initialized},e.is_inherited=function(){return this.inherited_from},e.is_template=function(){return!1},e.instances=function(){return!1},e.get_name=function(){var b,c,d,e=this.get_pointer(),f=e.indexOf(this.get_object());return 0===f?a.root_name:(b=e.points_at(f-1),c=e.slice(0,f-1),b instanceof a.Dict?d=a.Dict.get_prop_name(b,this.get_object(),this.get_pointer().pop()):void 0)},e.get_colloquial_name=function(){var b=this.get_pointer(),c=b.indexOf(this.get_object());if(0===c)return"("+a.root_name+")";{var d=b.points_at(c-1);b.slice(0,c-1)}if(d instanceof a.Dict){var e=b.special_contexts(),f="";if(e.length>0)for(var g,h=0;h<e.length;h++)if(g=e[h],g instanceof a.CopyContext){f="["+g.copy_num+"]";break}var i=a.Dict.get_prop_name(d,this.get_object(),this.get_pointer().pop());return"("+i+f+")"}return"(object)"},e.id=function(){return this._id},e.hash=function(){return this._hash},e.sid=function(){return parseInt(uid.strip_prefix(this.id()),10)},e.get_pointer=function(){return this.pointer},e.get_object=function(){return this.object},e.is_destroyed=function(){return this._destroyed},e._getter=function(){return this.get_object()},e.type=function(){return this._type},e.val=function(){return this.$value.get()},e.summarize=function(){var a=this.get_pointer(),b=this.get_object(),c=a.summarize(),d=b.id();return{id:this.id(),pointer:c,object_uid:d,obj_id:b.id(),type:this.type()}},e.desummarize=function(b){var c=a.Pointer.desummarize(b.pointer),d=a.find_uid(b.object_uid);return a.find_or_put_contextual_obj(d,c)},e.toString=function(){return"p_"+this.get_pointer().toString()},e.emit_begin_destroy=function(){this._emit("begin_destroy",this)},e.begin_destroy=function(){this.$value.setOption("check_on_nullify",!1),this.object&&(this.object.off("begin_destroy",this._do_destroy_no_args,this),delete this._do_destroy_no_args);var a=this._cobj_children.values();c.each(a,function(a){a.off("begin_destroy",this.remove_cobj_child,this),a.begin_destroy(!0)},this),this.emit_begin_destroy()},e.destroy=function(b){this.constructor!==d||b||this.begin_destroy(!0);var e=this._cobj_children.values();c.each(e,function(a){a.destroy(!0)}),this._cobj_children.clear(),this._destroyed=!0,a.remove_cobj_cached_item(this),this.$value.destroy(!0),delete this.object,delete this.pointer,delete this.inherited_from,delete this.$value,a.unregister_uid(this.id()),this._emit("destroyed"),able.destroy_this_listenable(this)},e._get_valid_cobj_children=function(){return[]},e.update_cobj_children=function(){b.wait();var d=this._get_valid_cobj_children(),e={},f=[],g=c.bind(function(b,d,h){var i=this._cobj_children.get(d);if(i){if(e[i.id()]=!1,i instanceof a.ContextualDict&&i.is_template()){var j=i.instances();c.each(j,function(a){g(a.get_object(),a.get_pointer())},this)}}else i=a.create_contextual_object(b,d,c.extend({defer_initialization:!0},h)),this._cobj_children.put(d,i),i.on("begin_destroy",this.remove_cobj_child,this,d),f.push(i)},this);this._cobj_children.forEach(function(a){e[a.id()]=a}),c.each(d,function(a){g(a.obj,a.pointer,a.options)},this),c.each(f,function(b){if(b.initialize(),b instanceof a.ContextualDict&&b.is_template()){var d=b.instances();c.each(d,function(a){g(a.get_object(),a.get_pointer())},this)}},this);var h=c.compact(c.values(e));c.each(h,function(a){a.begin_destroy()}),c.each(h,function(a){a.destroy(!0)}),this.updateAttachments(),b.signal()},e.get_or_put_cobj_child=function(b,d,e,f,g){var h=this.pointer.push(b,d),i=!1,j=this._cobj_children.getOrPut(h,function(){var d=a.create_contextual_object(b,h,c.extend({defer_initialization:!0},f));return i=!0,d});return i&&(g!==!0&&j.initialize(),j.on("begin_destroy",this.remove_cobj_child,this,h)),j},e.remove_cobj_child=function(a,b){this._cobj_children.remove(a,b)},e.pause=function(){},e.resume=function(){},e.updateAttachments=function(){},e.toString=function(){return d+" "+this.id()},e.print=function(b){return a.print(this.pointer,b)}}(a.ContextualObject),a.check_contextual_object_equality=a.check_contextual_object_equality_eqeqeq=function(b,c){return b instanceof a.ContextualObject&&c instanceof a.ContextualObject?b.get_pointer().eq(c.get_pointer())&&b.get_object()===c.get_object():b===c},a.create_contextual_object=function(b,d,e){e=c.extend({object:b,pointer:d},e);var f;return f=b instanceof a.Cell?new a.ContextualCell(e):b instanceof a.StatefulProp?new a.ContextualStatefulProp(e):b instanceof a.StatefulObj?new a.ContextualStatefulObj(e):b instanceof a.Dict?new a.ContextualDict(e):new a.ContextualObject(e)};var d=b.map({equals:function(a,b){return a.eq(b)},hash:function(a){return a.hash()}}),e={};a.find_or_put_contextual_obj=function(b,f,g){f||(f=new a.Pointer({stack:[b]}));var h=!1,i=d.getOrPut(f,function(){var d,h,i,j,k,l,m=f.length();for(d=f.root(),k=d.id(),l=e[k],l||(l=1===m?e[k]=a.create_contextual_object(b,f,c.extend({defer_initialization:!0},g)):a.find_or_put_contextual_obj(d,f.slice(0,1))),h=1;m>h;)i=f.points_at(h),j=f.special_contexts(h),k=f.itemHash(h),l=l.get_or_put_cobj_child(i,j,k,h===m-1?g:!1),h++;return l});return h&&i.initialize(),i},a.remove_cobj_cached_item=function(a){var b=a.get_pointer(),c=a.get_object();d.remove(b),1===b.length()&&(delete e[c.id()],d.clear(),d.destroy())}}(interstate),function(a){"use strict";var b=a.cjs,c=a._,d=function(a,b){var d;if(c.isArray(a)&&c.isArray(b)){var e=a.length;if(e!==b.length)return!1;for(d=0;e>d;d+=1)if(a[d]!==b[d])return!1;return!0}return a===b},e=function(b){return b&&b instanceof a.ContextualDict};a.Dict.get_proto_vals=function(b,d){for(var f,g,h,i=b,j=new RedSet({value:[i],hash:"hash",equals:a.check_contextual_object_equality}),k=0;k<j.len()&&(b=j.item(k),g=b instanceof a.ContextualDict?b.proto_cobj():[],f=g instanceof a.ContextualObject?g.val():g,c.isArray(f)||(f=[f]),f=c.filter(f,e),j.add_at.apply(j,[k+1].concat(f)),k++,!d););return h=j.toArray(),h.slice(1)},a.Dict.get_prop_name=function(b,d,e){var f,g,h,i,j,k=b.direct_props(),l=k.keyForValue({value:d});if(c.isUndefined(l)&&e)for(f=a.find_or_put_contextual_obj(b,e),h=f.get_all_protos(),g=0,j=h.length;j>g&&(i=h[g],l=i.get_direct_prop_name(d),c.isUndefined(l));g++);return l},a.Dict.get_prop_info=function(a,b,c){return a._has_builtin_prop(b)?a._get_builtin_prop_info(b):a._has_direct_prop(b)?a._get_direct_prop_info(b):a._has_special_context_prop(b,c)?a._get_special_context_prop_info(b,c):this._get_inherited_prop_info(b,c)},a.Dict.get_prop=function(b,c,d){var e=a.Dict.get_prop_info(b,c,d);return e?e.value:void 0};var f=function(b,c,d){var e=c.push(b);if(b instanceof a.Dict||b instanceof a.Cell||b instanceof a.StatefulProp){var f=a.find_or_put_contextual_obj(b,e,d);return f}return b};a.get_dom_obj=function(a){return a.get_dom_obj?a.get_dom_obj():!1},a.ContextualDict=function(){this.inherits_from=b.memoize(this._inherits_from,{context:this}),this.get_all_protos=b.memoize(this._get_all_protos,{context:this}),this.get_dom_obj_and_src=b.memoize(this._get_dom_obj_and_src,{context:this}),this.prop_val=b.memoize(this._prop_val,{context:this}),this.prop=b.memoize(this._prop,{context:this}),this.children=b.memoize(this._children,{context:this}),this.instances=b.memoize(this._instances,{context:this}),this.is_template=b.memoize(this._is_template,{context:this}),this.get_dom_children=b.memoize(this._get_dom_children,{context:this}),this.has=b.memoize(this._has,{context:this}),this._attachment_instances={},this._manifestation_objects=new RedMap({}),a.ContextualDict.superclass.constructor.apply(this,arguments),this._type="dict"},function(e){c.proto_extend(e,a.ContextualObject);var g=e.prototype;g.initialize=function(){this.constructor===e&&this.flag_as_initialized(),e.superclass.initialize.apply(this,arguments),a.__garbage_collect&&(this._live_cobj_child_updater=b.liven(function(){this.update_cobj_children()},{context:this,priority:2,pause_while_running:!0})),this.constructor===e&&this.shout_initialization()},g.proto_cobj=function(){var c,e=this.get_object(),f=e.direct_protos();return b.isArrayConstraint(f)?f.toArray():f?(c=this.get_pointer(),a.find_or_put_contextual_obj(f,c.push(f),{check_on_nullify:!0,equals:d})):[]},g.has_copies=function(){var a=this.object;return a.has_copies()},g._get_all_protos=function(b){return this.is_template()?[]:a.Dict.get_proto_vals(this,b)},g.raw_children=function(b){var d,e=this.get_object(),f=this.get_pointer(),g=f.lastIndexOf(e),h=[],i=b===!0?[]:e._get_builtin_prop_names(),j=this.get_direct_prop_names(),k={},l=this.get_all_protos(!0),m=[];if(c.each(i,function(a){k[a]=this},this),c.each(j,function(a){k[a]=this},this),b!==!0&&g>=0){var n,o,p=f.special_contexts(g),q=p.length,r=function(a,b){k.hasOwnProperty(b)||(k[b]=n,h.push(b))};for(d=0;q>d;d++)n=p[d],o=n.get_context_obj(),c.each(o,r)}c.each(l,function(a){var b=a.raw_children(!0);c.each(b,function(b){var c=b.name;k.hasOwnProperty(c)||(k[c]=a,m.push(c))})},this);var s=[];return c.each([["special_context",h],["builtin",i],["direct",j],["inherited",m]],function(b){var d,e=b[0],f=b[1],g="inherited"===e,h="builtin"===e||"special_context"===e;"builtin"===e?d=c.map(f,function(a){return this.get_builtin_prop_info(a)},this):"direct"===e?d=c.map(f,function(a){return this.prop_info(a,!0)},this):"inherited"===e?d=c.map(f,function(b){var c=k[b],d=c.prop(b),e=d instanceof a.ContextualObject?d.get_object():d,f={value:e,owner:c,inherited_from:d};return f},this):"special_context"===e&&(d=c.map(f,function(a){var b=k[a],c=b.get_context_obj();return c[a]},this));var i=c.map(d,function(a,b){var c=f[b];return{name:c,value:a.value,inherited_from:a.inherited_from||!1,inherited:g,builtin:h}},this);s.push.apply(s,i)},this),s},g.builtin_children=function(){if(this.is_template())return[];var a=this.object,b=this.pointer,d=b.lastIndexOf(a),e=a._get_builtin_prop_names(),g=[],h={},i=c.map(e,function(b){return a._get_builtin_prop_info(b)}),j=c.map(i,function(a,b){var c=e[b];return{name:c,value:a.value,inherited:!1,builtin:!0}},this);if(d>=0){var k,l,m,n=b.special_contexts(d),o=n.length,p=function(a,b){h[b]=k,g.push(b)};for(m=0;o>m;m+=1)k=n[m],l=k.get_context_obj(),c.each(l,p)}var q=c.map(g,function(a){var b=h[a],c=b.get_context_obj();return c[a]}),r=c.map(q,function(a,b){var c=g[b];return{name:c,value:a.value,inherited:!1,builtin:!0}},this),s=r.concat(j),t=c.map(s,function(a){var d={};return a.inherits_from&&(d.inherits_from=a.inherits_from),c.extend({},a,{value:f(a.value,b,d)})});return t},g._children=function(a){if(this.is_template())return[];var b=this.raw_children(a),d=this.pointer,e=c.map(b,function(a){var b={};return a.inherited_from&&(b.inherited_from=a.inherited_from),c.extend({},a,{value:f(a.value,d,b)})});return e},g.parent=function(){var b=this.pointer.pop(),c=a.find_or_put_contextual_obj(b.points_at(),b);return c},g._has=function(a,b){if(this.is_template())return!1;var d,e=this.get_object();if(e._has_direct_prop(a)||e._has_builtin_prop(a))return!0;if(b!==!0){var f=this.get_all_protos();if(c.any(f,function(b){return b.has_direct_prop(a)}))return!0;var g=this.get_pointer(),h=g.lastIndexOf(e);if(h>=0){var i,j,k=g.special_contexts(h),l=k.length;for(d=0;l>d;d+=1)if(i=k[d],j=i.get_context_obj(),j.hasOwnProperty(a))return!0}}return!1},g.prop_info=function(a,b){var d,e,f,g=this.get_object();if(g._has_builtin_prop(a))d=g._get_builtin_prop_info(a);else if(g._has_direct_prop(a))d=g._get_direct_prop_info(a);else{var h=this.get_pointer(),i=h.lastIndexOf(g);if(i>=0){var j=h.special_contexts(i);f=j.length;var k,l;for(e=0;f>e;e+=1)if(k=j[e],l=k.get_context_obj(),l.hasOwnProperty(a)){d=l[a];break}}if(!d&&b!==!0){var m=this.get_all_protos();f=m.length;var n;for(e=0;f>e;e+=1)if(n=m[e],n.has_direct_prop(a)){d=c.extend({inherited_from:n},n.get_direct_prop_info(a));break}}}return d},g._prop=function(a,b){var c=this.prop_info(a,b);if(c){var d=this.get_pointer(),e={};c.inherited_from&&(e.inherited_from=c.inherited_from);var g=f(c.value,d,e);return g}return void 0},g._prop_val=function(c,d){var e=this.prop(c,d);return e instanceof a.ContextualObject?e.val():b.get(e)},g.copies_obj=function(){var a=this.get_object(),b=a.get_copies();return b},g.get_direct_prop_name=function(a){var b=this.get_object(),c=b.direct_props(),d=c.keyForValue({value:a});return d},g.get_direct_prop_names=function(){var a=this.get_object();return a._get_direct_prop_names()},g.get_builtin_prop_info=function(a){var b=this.get_object();return b._get_builtin_prop_info(a)},g.has_direct_prop=function(a){var b=this.get_object();return b._has_direct_prop(a)},g.get_direct_prop_info=function(a){var b=this.get_object();return b._get_direct_prop_info(a)},g.get_direct_attachments=function(){var a=this.get_object();return a.direct_attachments()},g.get_manifestations_value=function(){var c=this.get_pointer(),d=this.copies_obj();if(d instanceof a.Cell){var e=d.value_in_context(c);return b.get(e)}return b.get(d)},g.is_instance=function(){var b,c,d,e=this.get_pointer(),f=this.get_object(),g=e.lastIndexOf(f);if(g>=0)for(c=e.special_contexts(g),b=c.length-1;b>=0;b-=1)if(d=c[b],d instanceof a.CopyContext)return!0;return!1},g._is_template=function(){if(this.is_instance())return!1;var a=this.get_manifestations_value();return c.isNumber(a)&&!isNaN(a)||c.isArray(a)},g._inherits_from=function(a){var b=this.get_all_protos(),d=c.contains(b,a);return d},g.is_instance=function(){var b,c=this.get_pointer(),d=this.get_object(),e=c.lastIndexOf(d);if(e>=0){var f,g=c.special_contexts(e);for(b=g.length-1;b>=0;b-=1)if(f=g[b],f instanceof a.CopyContext)return!0}return!1},g.get_template_info=function(){var b,c=this.get_pointer(),d=this.get_object(),e=c.lastIndexOf(d);if(e>=0){var f=c.slice(0,e);f=f.push(d);var g,h=c.special_contexts(e);for(b=h.length-1;b>=0;b-=1)if(g=h[b],g instanceof a.CopyContext)return{cobj:a.find_or_put_contextual_obj(d,f),index:g.get_copy_num()}}return!1},g.instance_pointers=function(){var b,d=this.get_manifestations_value();if(c.isNumber(d)){var e=d;for(d=[],b=0;e>b;b+=1)d[b]=b}var f=this.get_pointer(),g=c.map(d,function(b,c){var d=this._manifestation_objects.get_or_put(b,function(){return new a.CopyContext(this,b,c)},this),e=f.push_special_context(d);return e},this);return g},g._instances=function(){var b=this.get_object(),d=this.instance_pointers(),e=c.map(d,function(c){var d=a.find_or_put_contextual_obj(b,c);return d});return e},g.get_attachment_instance=function(a){var b=this.get_attachment_instance_and_src(a);if(b){var c,d=b.attachment;return this._attachment_instances.hasOwnProperty(a)?(c=this._attachment_instances[a],c.get_creator()!==b.attachment&&(c.destroy(),c=this._attachment_instances[a]=d.create_instance(this,b.owner),c.on_ready())):(c=this._attachment_instances[a]=d.create_instance(this,b.owner),c.on_ready()),c}return void 0},g.get_attachment_instance_and_src=function(a){var b,c;if(!this.is_template()){var d,e,f,g=this.get_object(),h=g.direct_attachments(),i=h.length;for(e=0;i>e;e+=1)if(d=h[e],d.get_type()===a){b={attachment:d,owner:g};break}if(!b){var j,k=this.get_all_protos(),l=k.length;a:for(e=0;l>e;e+=1)for(j=k[e],h=j.get_direct_attachments(),i=h.length,f=0;i>f;f+=1)if(d=h[f],d.get_type()===a){b={attachment:d,owner:g};break a}}}return b?b:void(this._attachment_instances.hasOwnProperty(a)&&(c=this._attachment_instances[a],c.destroy(),delete this._attachment_instances[a]))},g.updateAttachments=function(){this.get_attachment_instance("dom"),this.get_attachment_instance("shape"),this.get_attachment_instance("box2d_fixture")},g._get_valid_cobj_children=function(){var b=[],d=this.get_pointer(),e=this.is_template();if(!e){var f=this.get_all_protos();b.push.apply(b,c.chain(f).map(function(b){if(b instanceof a.ContextualDict){var c=b.proto_cobj();if(c instanceof a.ContextualObject)return{obj:c.get_object(),pointer:c.get_pointer()}}}).compact().value());var g=this.raw_children();c.each(g,function(c){var e,f=c.value;(f instanceof a.Dict||f instanceof a.Cell||f instanceof a.StatefulProp)&&(e=d.push(f),b.push({obj:f,pointer:e,options:{inherited_from:c.inherited_from}}))},this)}return b},g.begin_destroy=function(){c.each(this._attachment_instances,function(a,b){a.destroy(!0),delete this._attachment_instances[b]},this),delete this._attachment_instances,this._live_cobj_child_updater&&(this._live_cobj_child_updater.destroy(!0),delete this._live_cobj_child_updater),e.superclass.begin_destroy.apply(this,arguments)},g.destroy=function(a){this.constructor!==e||a||this.begin_destroy(!0),this._manifestation_objects.destroy(!0),delete this._manifestation_objects,e.superclass.destroy.apply(this,arguments),this.get_all_protos.destroy&&(this.get_all_protos.destroy(!0),delete this.get_all_protos.options.context,delete this.get_all_protos.options.args_map),this.inherits_from.destroy&&(this.inherits_from.destroy(!0),delete this.inherits_from.options.context,delete this.inherits_from.options.args_map),this.get_dom_obj_and_src.destroy&&(this.get_dom_obj_and_src.destroy(!0),delete this.get_dom_obj_and_src.options.context,delete this.get_dom_obj_and_src.options.args_map),this.prop_val.destroy&&(this.prop_val.destroy(!0),delete this.prop_val.options.context,delete this.prop_val.options.args_map),this.prop.destroy&&(this.prop.destroy(!0),delete this.prop.options.context,delete this.prop.options.args_map),this.children.destroy&&(this.children.destroy(!0),delete this.children.options.context,delete this.children.options.args_map),this.instances.destroy&&(this.instances.destroy(!0),delete this.instances.options.context,delete this.instances.options.args_map),this.is_template.destroy&&(this.is_template.destroy(!0),delete this.is_template.options.context,delete this.is_template.options.args_map),this.get_dom_children.destroy&&(this.get_dom_children.destroy(!0),delete this.get_dom_children.options.context,delete this.get_dom_children.options.args_map),this.has.destroy&&(this.has.destroy(!0),delete this.has.options.context,delete this.has.options.args_map)},g._getter=function(){return this},g._get_dom_obj_and_src=function(){var a,b,d=this.get_attachment_instance("dom"),e=this.has("show")?this.prop_val("show"):!0;if(e)if(d){if(a=d.get_dom_obj())return[a,d]}else{var f=this.get_attachment_instance("paper");if(f){if(a=f.get_dom_obj())return[a,f]}else{var g=this.get_attachment_instance("shape");if(g){if(b=g.get_robj())return[b[0],g]}else{var h=this.get_attachment_instance("group");if(h){var i=c.compact(c.map(h.get_children(),function(a){var b=a.get_robj();return b?[b[0],a]:!1})),j=[c.pluck(i,0),c.pluck(i,1)];return j}}}}return!1},g.get_dom_obj=function(){var a=this.get_dom_obj_and_src();return a[0]},g._get_dom_children=function(){if(this.is_template()){var a=this.instances(),b=c.chain(a).map(function(a){return a.get_dom_obj_and_src()}).compact().value(),d=c.pluck(b,0),e=c.pluck(b,1);return{srcs:e,children:d}}var f=this.get_dom_obj_and_src();return f?{srcs:[f[1]],children:[f[0]]}:!1},g.pause=function(a){e.superclass.pause.apply(this,arguments)},g.resume=function(a){e.superclass.resume.apply(this,arguments)}}(a.ContextualDict)}(interstate),function(a){"use strict";var b=a.cjs,c=a._;a.ContextualCell=function(){a.ContextualCell.superclass.constructor.apply(this,arguments),this._errors=new b.Constraint([]);var c=!1,d=this.get_pointer(),e=this.is_inherited();this.value_constraint=b(function(){return c&&c.destroy&&c.destroy(!0),c=this.object.constraint_in_context(d,e)},{context:this});var f=this.value_constraint.destroy;this.value_constraint.destroy=function(){c&&c.destroy&&(c.destroy(!0),c=!1),f.apply(this,arguments)},this._type="cell"},function(d){c.proto_extend(d,a.ContextualObject);var e=d.prototype;e.initialize=function(){this.constructor===d&&this.flag_as_initialized(),d.superclass.initialize.apply(this,arguments),this.constructor===d&&this.shout_initialization()},e.destroy=function(a){this.constructor!==d||a||this.begin_destroy(!0),this.value_constraint.destroy(!0),delete this.value_constraint,d.superclass.destroy.apply(this,arguments)
},e._getter=function(c,d){var e;if(a.__debug&&!d)e=b.get(this.value_constraint.get());else try{e=b.get(this.value_constraint.get())}catch(f){a.__log_errors&&console.error(f)}return e},e.get_str=function(){var a=this.get_object();return a.get_str()},e.get_syntax_errors=function(){var a=this.get_object();return a.get_syntax_errors()}}(a.ContextualCell)}(interstate),function(a){"use strict";var b=a.cjs,c=a._;a.ContextualStatefulObj=function(){this.statecharts_per_proto=new RedMap({hash:"hash"}),a.ContextualStatefulObj.superclass.constructor.apply(this,arguments),this._type="stateful"},function(d){c.proto_extend(d,a.ContextualDict);var e=d.prototype;e.initialize=function(){this.constructor===d&&this.flag_as_initialized(),d.superclass.initialize.apply(this,arguments),this._live_statechart_child_updater=b.liven(function(){this.update_statecharts()},{context:this,priority:1,pause_while_running:!0}),this.constructor===d&&this.shout_initialization()},e.get_own_statechart=function(){return this.get_statechart_for_proto(this.get_object())},e.get_statechart_for_proto=function(a){b.wait();var c=!1,d=this.statecharts_per_proto.get_or_put(a,function(){var b=a.get_own_statechart(),d=b.create_shadow({context:this.get_pointer(),running:!0,basis:b,concurrent:b.is_concurrent(),set_basis_as_root:!0},!0);return c=b,d},this);if(c){d.initialize()}return b.signal(),d},e.update_statecharts=function(){var a=this.get_valid_statecharts(),b=(this.statecharts_per_proto.values(),{});this.statecharts_per_proto.forEach(function(a,c){b[a.id()]={key:c,sc:a}}),c.each(a,function(a){b[a.id()]=!1});var d=c.compact(c.values(b));c.each(d,function(a){var b=a.sc,c=a.key;this.statecharts_per_proto.remove(c),b.destroy(!0)},this)},e.get_valid_statecharts=function(){return this.get_statecharts()},e.get_statecharts=function(){if(this.is_template())return[];var b=this.get_all_protos(),d=c.chain(b).map(function(b){return b instanceof a.ContextualStatefulObj?this.get_statechart_for_proto(b.get_object()):!1},this).compact().value();return[this.get_own_statechart()].concat(d)},e.reset=function(){var a=this.get_statecharts();c.each(a,function(a){a.reset()},this)},e.begin_destroy=function(){this._live_statechart_child_updater&&(this._live_statechart_child_updater.destroy(!0),delete this._live_statechart_child_updater),this.statecharts_per_proto.forEach(function(a){a.destroy(!0)}),this.statecharts_per_proto.destroy(!0),delete this.statecharts_per_proto,d.superclass.begin_destroy.apply(this,arguments)},e.destroy=function(a){b.wait(),this.constructor!==d||a||this.begin_destroy(!0),d.superclass.destroy.apply(this,arguments),b.signal()},e.pause=function(){d.superclass.pause.apply(this,arguments);var a=this.get_statecharts();c.each(a,function(a){a.pause()})},e.resume=function(){d.superclass.resume.apply(this,arguments);var a=this.get_statecharts();c.each(a,function(a){a.resume()})}}(a.ContextualStatefulObj)}(interstate),function(a){"use strict";var b=a.cjs,c=a._,d={};a.ContextualStatefulProp=function(){this.transition_times_run={},this._last_value=d,this.$active_value=new b.Constraint(this.active_value_getter,{context:this}),this._has_runtime_errors=!1,this.$runtime_errors=new b.Constraint([]),a.ContextualStatefulProp.superclass.constructor.apply(this,arguments),this._type="stateful_prop"},function(b){c.proto_extend(b,a.ContextualObject);var e=b.prototype;e.initialize=function(){this.constructor===b&&this.flag_as_initialized(),b.superclass.initialize.apply(this,arguments);var a=this.active_value();this.$value.onChange(this.$value.get,this.$value),a.is_fallback&&this.$active_value.invalidate(),this.constructor===b&&this.shout_initialization()},e.get_parent=function(){for(var b,c,d,e=this.get_pointer();!e.is_empty();){if(d=e.points_at(),d instanceof a.StatefulObj)return b=a.find_or_put_contextual_obj(d,e);c=d,e=e.pop()}return void 0},e.get_states=function(){var b,d=this.get_parent(),e=this.get_object();if(e.get_can_inherit())b=d.get_statecharts();else{var f=e.get_statechart_parent();"parent"===f&&(f=d.get_object()),b=[d.get_statechart_for_proto(f)]}var g=c.chain(b).map(function(a){var b=a.flatten_substates(!0),c=b.splice(0,b.length-1);return c}).flatten(!0).map(function(b){var d=b.get_incoming_transitions();return d=c.filter(d,function(b){return b.from()instanceof a.Statechart}),[b].concat(d)}).flatten(!0).value();return g},e.get_raw_values=function(b){var d,e,f,g,h=this.get_parent(),i=this.get_object();if(i.get_can_inherit()&&b!==!0){var j=this.get_pointer(),k=[];f=j.lastIndexOf(h.get_object());var l,m=j.length(),n=j.points_at(f);for(f+=1;m>f;)l=j.points_at(f),e=a.Dict.get_prop_name(n,l,j.slice(0,f)),k.push(e),n=l,f+=1;var o=k.length,p=h.get_all_protos(!0),q=c.chain(p).map(function(b){var c;for(c=0;o>c;c+=1){if(e=k[c],!(b instanceof a.ContextualDict&&b.has(e)))return!1;b=b.prop(e)}return b},this).compact().value();q=c.uniq([this].concat(q)),d=[];var r,s,t=q.length,u=function(a){a.inherited_from=r};for(f=0;t>f;f+=1)r=q[f],r instanceof a.ContextualObject&&(s=r.get_object(),r instanceof a.ContextualStatefulProp?(g=r.get_raw_values(r===this?!0:!1),c.each(g,u),d.push.apply(d,g)):r instanceof a.ContextualCell&&d.push({key:void 0,value:s,inherited_from:r}))}else{if(this.is_inherited())return[];g=i.get_direct_values(),d=g.entries(),c.each(d,function(a){a.inherited_from=r});var v=i.get_statechart_parent();"parent"===v&&(v=h)}return d},e.get_values=function(){var b=this.get_raw_values(),d=this.get_parent(),e=this.get_object(),f=e.get_can_inherit()?d.get_statecharts():[d.get_statechart_for_proto(d.get_object())],g=f.length,h=c.map(b,function(b){var c,d,e=b.key;if(e)for(d=0;g>d;d+=1){var h=f[d];if(e.root()===h.basis()){if(e instanceof a.State)try{c=a.find_equivalent_state(e,h)}catch(i){continue}else if(e instanceof a.StatechartTransition)try{c=a.find_equivalent_transition(e,h)}catch(i){continue}break}}else c=void 0;return{state:c,value:b.value,inherited_from:b.inherited_from,root_sv_index:d}},this);h=c.compact(h);return h=h.sort(function(a,b){return a.root_sv_index-b.root_sv_index})},e.get_transition_times_run=function(a){var b=a.id();return this.transition_times_run[b]||0},e.set_transition_times_run=function(a,b){var c=a.id();this.transition_times_run[c]=b};var f="transition",g="state";e.active_value_getter=function(){var b,c,e,h,i,j,k,l,m=(this.get_object(),this.get_values()),n=m.length,o=!1,p=d;for(h=0;n>h;h+=1)if(e=m[h],j=e.state,k=e.value,j instanceof a.StartState)if(j.is_active()&&(p===d||b.order(j)<0))c=e,p=k,b=j,l=g;else{var q=j.get_outgoing_transition();q&&(i=q.get_times_run(),i>this.get_transition_times_run(q)&&(this.set_transition_times_run(q,i),c=e,p=k,b=j,l=f))}else j instanceof a.State?j.is_active()&&(p===d||b.order(j)<0)&&(c=e,p=k,b=j,l=g):j instanceof a.StatechartTransition&&(i=j.get_times_run(),i>this.get_transition_times_run(j)&&(this.set_transition_times_run(j,i),b instanceof a.StatechartTransition||(c=e,p=k,b=j,l=f)));if(p===d)if(this._last_value===d)c=p=b=l=void 0;else{for(o=!0,b=this._from_state,p=void 0,c=void 0,h=0;n>h;h++)if(e=m[h],j=e.state,k=e.value,j===b){p=k,c=e;break}b instanceof a.State?l=g:b instanceof a.StatechartTransition&&(l=f)}else this._last_info=c,this._last_value=p,this._from_state=b,this._using_as=l;return{value:p,state:b,info:c,using_as:l,is_fallback:o}},e.active_value=function(){return this.$active_value.get()},e._getter=function(b,d){var e=(this._last_value,this.active_value());if(e){var g,h=e.info,i=e.value,j=e.state,k=e.using_as,l=(e.inherited_from,e.is_fallback);if(k===f){if(l)return this._last_rv;e.is_fallback=!0;var m=c.bind(function(){this.$value&&this.$value.invalidate()},this),n=c.bind(function(){this.$active_value&&this.$active_value.invalidate()},this);2===a.event_queue.end_queue_round?a.event_queue.once("end_event_queue_round_3",m):6===a.event_queue.end_queue_round?a.event_queue.once("end_event_queue_round_7",m):n()}{this.get_object()}if(i){var o,p=this.get_pointer();o=j instanceof a.StartState?p.push(i):p.push(i,new a.StateContext(j));var q=a.find_or_put_contextual_obj(i,o,{inherited_from:h.inherited_from});if(!d&&a.__debug)g=q.val();else try{g=q.val(),g instanceof a.Error&&(g=void 0),this._has_runtime_errors&&(this._has_runtime_errors=!1,this.$runtime_errors.set([]))}catch(r){g=void 0,this.$runtime_errors.set([r.message]),this._has_runtime_errors=!0}return this._last_rv=g,g}return void 0}},e.begin_destroy=function(){this.$value.offChange(this.$value.get,this.$value),b.superclass.begin_destroy.apply(this,arguments)},e.destroy=function(a){this.constructor!==b||a||this.begin_destroy(!0),this.$active_value.destroy(!0),delete this.$active_value,b.superclass.destroy.apply(this,arguments)},e.get_runtime_errors=function(){return this.$runtime_errors.get()},e.pause=function(a){b.superclass.pause.apply(this,arguments)},e.resume=function(a){b.superclass.resume.apply(this,arguments)}}(a.ContextualStatefulProp)}(interstate),function(a){"use strict";var b=a.cjs,c=a._;a.find_equivalent_state=function(a,b){var d,e,f=b.basis(),g=f.get_lineage(),h=a.get_lineage(),i=g.length,j=h.length,k=i-1;a:for(;k>=0;){for(e=j-1;e>=0;e-=1)if(h[e]===g[k]){d=e;break a}k-=1}var l=b,m=i-1-k;for(c.times(m,function(){l=l.parent()}),e=d+1;j>e;e+=1){var n=h[e-1].get_name_for_substate(h[e]);l=l.get_substate_with_name(n)}if(l.basis()!==a)throw new Error("Could not find correct equivalent item");return l},a.State=function(c){this._constructed=!1,c=c||{},this._started_construction||(this._started_construction=!0,able.make_this_listenable(this),this._initialized=!1,this.$initialized=b(!1),this._id=c.id||uid(),this._hash=uid.strip_prefix(this._id),this._running=c.running===!0,this.$running=b(this._running),a.register_uid(this._id,this)),c.avoid_constructor||(this._last_run_event=b(!1),this._puppet=c.puppet===!0,this._parent=c.parent,this._context=c.context,this.$active=b(c.active===!0||!this._parent&&!this._puppet),this._basis=c.basis,this._basis&&this.add_basis_listeners())},function(b){var d=b.prototype;able.make_proto_listenable(d),a.__debug_statecharts&&(d.get_$running=function(){return this.$running.get()}),d.is_constructed=function(){return this._constructed},d.initialize=function(){this._basis&&c.each(this.get_outgoing_transitions(),function(a){a.initialize()}),this._initialized=!0,this.$initialized.set(!0),this._emit("initialized")},d.is_initialized=function(){return this.$initialized.get()},d.is_puppet=function(){return this._puppet},d.is_running=function(){return this._running},d.run=function(){this.is_puppet()?(this._running=!0,this._emit("run",{target:this,type:"run"}),this.$running.set(!0)):this.is_running()||(a.event_queue.wait(),this.enable_outgoing_transitions(),this._running=!0,this._emit("run",{target:this,type:"run"}),this.$running.set(!0),a.event_queue.signal())},d.stop=function(){this.is_puppet()?(this._running=!1,this._emit("stop",{type:"stop",target:this}),this.$running.set(!1)):(a.event_queue.wait(),this._running=!1,this.disable_outgoing_transitions(),this._emit("stop",{type:"stop",target:this}),this.$running.set(!1),a.event_queue.signal())},d.reset=function(){return this.is_running()&&(a.event_queue.wait(),this.stop(),this.run(),a.event_queue.signal()),this},d.do_shadow_transitions=function(a){var b=this.basis(),d=b.get_outgoing_transitions(),e=c.map(d,a);c.each(e,function(a){var b=a.from(),c=a.to();b._add_direct_outgoing_transition(a),c._add_direct_incoming_transition(a)},this);var f=this.get_substates(!0);c.each(f,function(b){b.do_shadow_transitions(a)},this)},d.set_active=function(a){if(this.$active){this.$active.set(a===!0),a||c.each(this.get_substates(!0),function(a){a.set_active(!1),a.disable_outgoing_transitions(),a.stop()},this);var b=a?"active":"inactive";this._emit(b,{type:b,target:this})}},d.flatten_substates=function(a){return c.flatten(c.map(this.get_substates(a),function(b){return b.flatten_substates(a)})).concat([this])},d.is_active=function(){return this.$active&&this.$active.get()},d.get_name=function(a){var b=this.parent();a?"parent"===a&&(a=b):a=this.root();var c=b?b.get_name_for_substate(this):"";if(b===a)return c;var d=b?b.get_name(a):"";return""===d?c:d+"."+c},d.id=function(){return this._id},d.hash=function(){return this._hash},d.sid=function(){return parseInt(uid.strip_prefix(this.id()),10)},d.basis=function(){return this._basis},d.parent=function(){return this._parent},d.context=function(){return this._context},d.set_parent=function(a){return this._parent=a,this},d.set_context=function(a){return this._context=a,this},d.is_based_on=function(a){return this.basis()===a},d.is_child_of=function(a){for(var b=this.parent();b;){if(b===a)return!0;b=b.parent()}return!1},d.get_lineage=function(a){var b=this,c=[],d=0;do{if(c[d]=b,d+=1,b===a)break;b=b.parent()}while(b);return c.reverse()},d.root=function(){var a=this.parent();return a?a.root():this},d.on_outgoing_transition_fire=function(b,d){var e;if(this.is_running()&&c.indexOf(this.get_outgoing_transitions(),b)>=0){b._last_run_event.set(d);var f=this.get_lineage(),g=b.to(),h=g.get_lineage(),i=h.length,j=Math.min(i,f.length);for(e=0;j>e;e+=1)if(h[e]!==f[e]){e--;break}e===i&&(e-=2);for(var k,l;i-1>e;)l=h[e],k=h[e+1],l.set_active_substate(k,b,d),e++;if(k instanceof a.Statechart){var m=k.get_start_state();k.set_active_substate(m,b,d)}return a.event_queue.once("end_event_queue_round_0",function(){this._emit("pre_transition_fire",{type:"pre_transition_fire",transition:b,event:d,state:g}),b.set_active(!0)},this),a.event_queue.once("end_event_queue_round_2",function(){b.increment_times_run()},this),a.event_queue.once("end_event_queue_round_4",function(){b.set_active(!1),this._emit("post_transition_fire",{type:"post_transition_fire",transition:b,event:d,state:g})},this),!0}return!1},d.order=function(a){var b,c=this.get_lineage(),d=a.get_lineage(),e=c[0],f=d[0];if(e!==f)return 0;var g,h,i=Math.min(c.length,d.length);for(b=1;i>b;b+=1){if(g=e.get_substate_index(c[b]),h=f.get_substate_index(d[b]),h>g)return 1;if(g>h)return-1;e=c[b],f=d[b]}return d.length>c.length?-1:d.length<c.length?1:0},d.enable_outgoing_transitions=function(){var a=this.get_outgoing_transitions();c.each(a,function(a){a.enable()})},d.disable_outgoing_transitions=function(){this.disable_immediate_outgoing_transitions();var a=this.get_substates();c.each(a,function(a){a.disable_outgoing_transitions()})},d.disable_immediate_outgoing_transitions=function(){var a=this.get_outgoing_transitions();c.each(a,function(a){a.disable()})},d.disable_immediate_incoming_transitions=function(){var a=this.get_incoming_transitions();c.each(a,function(a){a.disable()})},d.parent_is_concurrent=function(){var a=this.parent();return a?a.is_concurrent():!1},d.summarize=function(){var a,b=this.context();b&&(a=b.summarize());var c=this.basis()||this;return{basis_id:c.id(),context:a}},b.desummarize=function(b){if(b.context){var c=a.find_uid(b.basis_id),d=a.Pointer.desummarize(b.context),e=d.points_at(),f=e.get_statechart_for_context(d),g=a.find_equivalent_state(c,f);return g}return a.find_uid(b.basis_id)},d.add_basis_listeners=function(){this._basis.on("add_transition",this.onBasisAddTransition,this),this._basis.on("add_substate",this.onBasisAddSubstate,this),this._basis.on("remove_substate",this.onBasisRemoveSubstate,this),this._basis.on("rename_substate",this.onBasisRenameSubstate,this),this._basis.on("move_substate",this.onBasisMoveSubstate,this),this._basis.on("make_concurrent",this.onBasisMakeConcurrent,this),this._basis.on("on_transition",this.onBasisOnTransition,this),this._basis.on("off_transition",this.onBasisOffTransition,this),this._basis.on("destroy",this.onBasisDestroy,this)},d.remove_basis_listeners=function(){this._basis.off("add_transition",this.onBasisAddTransition,this),this._basis.off("add_substate",this.onBasisAddSubstate,this),this._basis.off("remove_substate",this.onBasisRemoveSubstate,this),this._basis.off("rename_substate",this.onBasisRenameSubstate,this),this._basis.off("move_substate",this.onBasisMoveSubstate,this),this._basis.off("make_concurrent",this.onBasisMakeConcurrent,this),this._basis.off("on_transition",this.onBasisOnTransition,this),this._basis.off("off_transition",this.onBasisOffTransition,this),this._basis.off("destroy",this.onBasisDestroy,this)},d.onBasisAddTransition=function(b){var c=b.transition,d=a.find_equivalent_state(b.from_state,this),e=a.find_equivalent_state(b.to_state,this),f=c.create_shadow(d,e,this,this.context());d._add_direct_outgoing_transition(f),e._add_direct_incoming_transition(f),this.add_transition(f)},d.onBasisAddSubstate=function(a){var b=a.state_name,c=a.state,d=a.index;this.add_substate(b,c.create_shadow({parent:this,context:this.context()}),d)},d.onBasisRemoveSubstate=function(a){this.remove_substate(a.name,void 0,!1)},d.onBasisRenameSubstate=function(a){var b=a.from,c=a.to;this.rename_substate(b,c)},d.onBasisMoveSubstate=function(a){var b=a.state_name,c=a.index;this.move_state(b,c)},d.onBasisMakeConcurrent=function(a){this.make_concurrent(a.concurrent)},d.onBasisOnTransition=function(a){this.on_transition(a.str,a.activation_listener,a.deactivation_listener,a.context)},d.onBasisOffTransition=function(a){this.off_transition(a.str,a.activation_listener,a.deactivation_listener,a.context)},d.onBasisDestroy=function(){this.destroy(!0)},d.destroy=function(b){this.destroyed=!0,this.$active&&(this.$active.destroy(b),delete this.$active),this.$running&&(this.$running.destroy(b),delete this.$running),this.$initialized.destroy(b),this._last_run_event.destroy(b),delete this._last_run_event,this._basis&&(this.remove_basis_listeners(),delete this._basis),delete this._parent,delete this._context,able.destroy_this_listenable(this),a.unregister_uid(this.id())},d.pause=function(){this.is_active()&&(this.disable_immediate_outgoing_transitions(),c.each(this.get_substates(!0),function(a){a.pause()}))},d.resume=function(){this.is_active()&&(this.enable_outgoing_transitions(),c.each(this.get_substates(!0),function(a){a.resume()}))}}(a.State)}(interstate),function(a){"use strict";var b=a.cjs,c=a._;a.StartState=function(b){b=b||{},a.StartState.superclass.constructor.apply(this,arguments),b.avoid_constructor||(this.outgoingTransition=b.outgoing_transition,this._constructed=!0)},function(d){c.proto_extend(d,a.State);var e=d.prototype;e.initialize=function(){this.outgoingTransition||(this.outgoingTransition=new a.StatechartTransition({from:this,to:this,event:new a.StatechartEvent({target:"me",spec:"run"})})),d.superclass.initialize.apply(this,arguments)},e.setTo=function(a){var b=this.outgoingTransition,c=this.parent();a.is_child_of(c)&&b.setTo(a)},e.set_parent=function(){return d.superclass.set_parent.apply(this,arguments)},e.getTo=function(){var a=this.outgoingTransition;return a.to()},e.get_substates=function(){return[]},e.get_active_states=function(){return[]},e.get_outgoing_transitions=function(){return this.outgoingTransition?[this.outgoingTransition]:[]},e.get_incoming_transitions=function(){return this.outgoingTransition&&this.outgoingTransition.to()===this?[this.outgoingTransition]:[]},e._add_direct_incoming_transition=function(a){if(a!==this.outgoingTransition)throw new Error("Should never have a transition other than outgoing transition")},e._remove_direct_incoming_transition=function(a){if(a!==this.outgoingTransition)throw new Error("Should never have a transition other than outgoing transition")},e._add_direct_outgoing_transition=function(a){if(this.outgoingTransition)throw new Error("Should never have a transition other than outgoing transition");this.outgoingTransition=a},e._remove_direct_outgoing_transition=function(){throw new Error("Should never remove outgoing transition from start state")},e.is_running=function(){return this._running},e.destroy=function(a){this._emit("destroy",{type:"destroy",target:this}),b.wait(),this.outgoingTransition&&(this.outgoingTransition.destroy(a),delete this.outgoingTransition),d.superclass.destroy.apply(this,arguments),b.signal()},e.get_transitions_to=function(a){return this.getTo()===a?this.get_outgoing_transitions():[]},e.get_transitions_from=function(a){return a===this&&this.getTo()===this?this.get_outgoing_transitions():[]},e.get_outgoing_transition=function(){return this.outgoingTransition},e.set_outgoing_transition=function(a){this.outgoingTransition=a},e.create_shadow=function(b,d){var e=new a.StartState(c.extend({basis:this},b),d);return e},a.register_serializable_type("start_state",function(a){return a instanceof d},function(b){var d=c.toArray(arguments),e={outgoing_transition:a.serialize.apply(a,[this.get_outgoing_transition()].concat(d)),parent:a.serialize.apply(a,[this.parent()].concat(d))};return b&&(e.id=this.id()),e},function(b){var e,f=c.rest(arguments);return b.id&&(e=a.find_uid(b.id))?e:(e=new d({avoid_constructor:!0}),e.initialize=function(){delete this.initialize,d.call(this,{id:b.id,outgoing_transition:a.deserialize.apply(a,[b.outgoing_transition].concat(f)),parent:a.deserialize.apply(a,[b.parent].concat(f))})},e)})}(a.StartState)}(interstate),function(a){"use strict";var b=a.cjs,c=a._,d=a.any_state={},e=/\s*(([\w\.]+((\s*,\s*[\w\.]+)*))|\*)(\s*(>(\d+)?-|-(\d+)?>|<(\d+)?-|-(\d+)?<|<-(\d+)?->|>-(\d+)?-<)\s*(([\w\.]+(\s*,\s*[\w\.]+)*)|\*))?\s*/,f=function(a){return"*"===a?d:c.map(a.split(","),function(a){return a.trim()})},g=function(a){var b=a.match(e);if(b){var d=f(b[1]),g=b[6];if(g){var h=f(b[13]);if(g.indexOf("<")>=0&&g.indexOf(">")<0){g=g.split("").reverse().join("");var i=d;d=h,h=i}var j=b[7]||b[8]||b[9]||b[10]||b[11]||b[12]||!1;c.isString(j)&&(j=parseInt(j,10));var k=">"===g[0]&&"<"===g[g.length-1]||"<"===g[0]&&">"===g[g.length-1];return{type:"transition",from:d,to:h,pre:">"===g[0],bidirectional:k,transition_no:j}}return{type:"state",states:d}}throw new Error(a+" does not match format")},h=function(a,b,c){var e,f;if(b===d)return!0;var g=c.get_name(a);for(f=b.length,e=0;f>e;e+=1){var h=b[e];if(h===c||h===g)return!0}return!1},i=function(b,d,e,f,i){i=i||this;var j;j=c.isString(b)?g(b):b;var k,l,m=j.type;if("state"===m){k="pre_transition_fire";var n=!1;l=function(b){var c=arguments,g=h(d,j.states,b.state);n===!1&&g?(n=!0,a.event_queue.once("end_event_queue_round_6",function(){e.apply(i,c)},this)):n!==!0||g||(n=!1,a.event_queue.once("end_event_queue_round_2",function(){f.apply(i,c)},this))}}else{if("transition"!==m)throw new Error("Unexpected type "+m);k=j.pre?"pre_transition_fire":"post_transition_fire",l=function(b){var g=b.transition,k=g.from(),l=g.to(),m=!1;if(c.isNumber(j.transition_no)){var n=k.get_transitions_to(l);m=n[j.transition_no]}if((!m||g===m)&&(h(d,j.from,k)&&h(d,j.to,l)||j.bidirectional&&h(d,j.to,k)&&h(d,j.from,l))){var o=arguments;e.apply(i,o),j.pre?a.event_queue.once("end_event_queue_round_1",function(){f.apply(i,o)}):a.event_queue.once("end_event_queue_round_5",function(){f.apply(i,o)})}}}return d.on(k,l),{str:b,statechart:d,activation_listener:e,deactivation_listener:f,context:i,destroy:function(){d.off(k,l)}}};a.Statechart=function(d,e){if(d=d||{},a.Statechart.superclass.constructor.apply(this,arguments),!d.avoid_constructor){this._transition_listeners={},this.$substates=d.substates||b.map(),this.$substates.setValueHash("hash"),this.$concurrent=b(d.concurrent===!0),this._parent=d.parent,this.$incoming_transitions=d.incoming_transitions||b.array(),this.$outgoing_transitions=d.outgoing_transitions||b.array(),this._start_state=d.start_state;var f,g;if(this._basis){f=this._basis.get_start_state(),g=f.getTo();var h=this.is_running(),i=this.context(),j=this.is_concurrent();if(c.each(this._basis.get_substates(!0),function(b,c){var d=b.create_shadow({context:i,parent:this,running:h&&(g===b||j),active:h&&(g===b||j),set_basis_as_root:!1},e);d instanceof a.StartState?this.set_start_state(d):this.add_substate(c,d)},this),c.each(this._basis._transition_listeners,function(a){c.each(a,function(a){this.on_transition(a.str,a.activation_listener,a.deactivation_listener,a.context)},this)},this),d.set_basis_as_root===!0){var k=this,l=c.memoize(function(b){var c=a.find_equivalent_state(b.from(),k),d=a.find_equivalent_state(b.to(),k);return b.create_shadow(c,d,k,i,!0)},function(a){return a.id()});this.do_shadow_transitions(l)}}this._start_state||(this._start_state=new a.StartState({parent:this,to:d.start_at,context:d.context}));var m;this._running&&this._basis?(f=this._basis.get_start_state(),g=f.getTo(),m=g===f?this._start_state:a.find_equivalent_state(g,this)):m=this._start_state,this.$local_state=new b.Constraint(m),this.is_active()&&(d.concurrent===!0?this.is_puppet()||c.each(this.get_substates(),function(a){a.disable_immediate_outgoing_transitions(),a.disable_immediate_incoming_transitions(),a.set_active(!0),a.run()}):this.is_puppet()||(m.set_active(!0),m.run())),this._constructed=!0,(!this._parent&&e!==!0||this._parent&&this._parent.is_initialized())&&this.initialize()}},function(d){c.proto_extend(d,a.State);var e=d.prototype;d.START_STATE_NAME="(start)",e.increment_start_state_times_run=function(a){var b=a._start_state.get_outgoing_transition();b&&b.increment_times_run()},e.initialize=function(){c.each(this.get_substates(!0),function(a){a.initialize()}),d.superclass.initialize.apply(this,arguments)},e.is_concurrent=function(){return this.$concurrent.get()},e.make_concurrent=function(a){a=a===!0,this.$concurrent.set(a),this._emit("make_concurrent",{target:this,concurrent:a});var b=this.get_start_state();if(!this.is_puppet())if(a)(this.is_active()||void 0===this.parent())&&c.each(this.get_substates(),function(a){a.disable_immediate_outgoing_transitions(),a.disable_immediate_incoming_transitions(),a.set_active(!0),a.run();var b=a.get_active_substate();b.set_active(!0),b.run()}),b.set_active(!1);else{var d=this.get_active_substate();c.each(this.get_substates(),function(a){a!==d&&(a.set_active(!1),a.stop())}),d.set_active(!0),d.run()}return this},e.get_substates=function(a){if(this.$substates){var b={};return this.$substates.forEach(function(a,c){b[c]=a}),a&&(b[d.START_STATE_NAME]=this.get_start_state()),b}return[]},e.run=function(){b.wait();var a=this.is_running();if(d.superclass.run.apply(this,arguments),!a)if(this.is_concurrent())c.each(this.get_substates(),function(a){a.run(),a.set_active(!0)});else{var e=this.$local_state.get();e.run(),e.set_active(!0)}b.signal()},e.stop=function(){b.wait();var a=this.is_running();if(d.superclass.stop.apply(this,arguments),a)if(this.is_concurrent())c.forEach(this.get_substates(!0),function(a){a.set_active(!1),a.stop()});else{var e=this.$local_state.get();e&&e.set_active(!1),this.$local_state.set(this._start_state),c.forEach(this.get_substates(!0),function(a){a.stop()})}b.signal()},e.get_start_state=function(){return this._start_state},e.set_start_state=function(a){b.wait(),this._start_state&&this._start_state.destroy(!0),this.$local_state&&this.$local_state.get()===this.get_start_state()&&this.$local_state.set(a),this._start_state=a,b.signal()},e.get_incoming_transitions=function(){return this.$incoming_transitions?this.$incoming_transitions.toArray():[]},e.get_outgoing_transitions=function(){return this.$outgoing_transitions?this.$outgoing_transitions.toArray():[]},e.get_active_substate=function(){return this.$local_state.get()},e.get_state_index=function(a){return this.$substates.indexOf(a)},e.set_active_substate=function(d,e,f){if(e)a.event_queue.once("end_event_queue_round_3",function(){if(this.is_concurrent())c.each(this.get_substates(!0),function(b){if(b.set_active(!0),b.run(),b instanceof a.Statechart){var c=b.get_active_substate();b.set_active_substate(c)}});else{var e=this.$local_state.get();b.wait(),e!==d&&(e&&(e.stop(),e.set_active(!1)),e=d,this.$local_state.set(e),e._last_run_event.set(f)),e&&(e.set_active(!0),e.run()),b.signal()}},this);else if(this.is_concurrent())c.each(this.get_substates(!0),function(b){if(b.set_active(!0),b.run(),b instanceof a.Statechart){var c=b.get_active_substate();b.set_active_substate(c)}});else{var g=this.$local_state.get();g!==d&&(g&&(g.stop(),g.set_active(!1)),g=d,this.$local_state.set(g)),g&&(g.set_active(!0),g.run())}},e.get_name_for_substate=function(a){return a===this.get_start_state()?d.START_STATE_NAME:this.$substates.keyForValue(a)},e.get_active_direct_substates=function(){return this.is_concurrent()?this.get_substates():[this.$local_state.get()]},e.get_active_states=function(){return c.chain(this.get_active_direct_substates()).map(function(a){return[a].concat(a.get_active_states())}).flatten(!0).value()},e.get_substate_with_name=function(a){return a===d.START_STATE_NAME?this.get_start_state():this.$substates.get(a)},e.has_substate_with_name=function(a){return a===d.START_STATE_NAME?!0:this.$substates.has(a)},e.find_state=function(b,d,e,f){var g;if(b instanceof a.State)return b;if(c.isArray(b)){if(c.isEmpty(b))return this;var h=c.first(b);return 1===c.size(b)?(this.has_substate_with_name(h)||d!==!0||this.add_substate(h,e,f),g=this.get_substate_with_name(h),g||void 0):(d!==!0||this.has_substate_with_name(h)||this.add_substate(h),g=this.get_substate_with_name(h),g?g.find_state(c.rest(b),d,e,f):void 0)}return c.isString(b)?this.find_state(b.split("."),d,e,f):void 0},e.find_transitions=function(a,b,d){if(a=this.find_state(a),b=this.find_state(b),!a||!b)return void 0;var e=a.get_transitions_to(b);return c.isNumber(d)?e[d]:e},e.get_substate_index=function(a){var b=a.get_name(this);return this.$substates.indexOf(b)},e.add_substate=function(b,c,d){if(c instanceof a.Statechart?c.set_parent(this):c=new a.Statechart({parent:this,context:this.context()}),c.on("pre_transition_fire",this.forward_event,this),c.on("post_transition_fire",this.forward_event,this),this.$substates.put(b,c,d),this._emit("add_substate",{type:"add_substate",state_name:b,state:c,index:d}),this.is_active()&&!this.is_puppet()&&this.is_concurrent()){c.set_active(!0),c.run();var e=c.get_active_substate();c.set_active_substate(e)}},e.remove_substate=function(d,e,f){e=e||this.$substates.get(d),b.wait(),e.off("pre_transition_fire",this.forward_event,this),e.off("post_transition_fire",this.forward_event,this);var g=e.get_incoming_transitions(),h=e.get_outgoing_transitions();c.each(g,function(b){var c=b.from();c instanceof a.StartState?c.setTo(c):b.remove()}),c.forEach(h,function(a){a.remove()}),this.get_active_substate()===e&&this.set_active_substate(this.get_start_state().getTo()),this.$substates.remove(d),b.signal(),this._emit("remove_substate",{type:"remove_substate",state:e,name:d,also_destroy:f}),f!==!1&&e.destroy()},e.rename_substate=function(a,c){var d=this.$substates.indexOf(a);if(d>=0){var e=this.$substates.get(a);b.wait(),this.$substates.remove(a).put(c,e,d),this._emit("rename_substate",{type:"rename_substate",state:e,from:a,to:c}),b.signal()}},e.move_substate=function(a,b){this.$substates.move(a,b),this._emit("move_substate",{type:"move_substate",state_name:a,index:b})},e.add_state=function(a,b,c){if(this.find_state(a))throw new Error("State with name '"+a+"' already exists.");return this.find_state(a,!0,b,c),this},e.remove_state=function(a,b){var d=this.find_state(a);if(!c.isUndefined(d)){var e=d.parent();c.isUndefined(e)||e.remove_substate(a,d,b)}return this},e.rename_state=function(a,d){var e=this.find_state(a);if(e){var f=e.parent();if(f){var g=d.split("."),h=this.find_state(c.initial(g),!0),i=c.last(g);if(f===h){var j=a.split("."),k=c.last(j);f.rename_substate(k,i)}else b.wait(),f.remove_state(e,!1),h.add_state(i,e),b.signal()}}return this},e.move_state=function(a,b){var c=this.find_state(a);if(c){var d=c.parent();d&&(a=d.get_name_for_substate(c),d.move_substate(a,b))}return this},e.destroy=function(e){this._emit("destroy",{type:"destroy",target:this}),b.wait(),c.forEach(this.get_incoming_transitions(),function(b){var c=b.from();c instanceof a.StartState?c.setTo(c):b.remove().destroy(e)}),c.forEach(this.get_outgoing_transitions(),function(a){a.remove().destroy(e)}),c.forEach(this.get_substates(!0),function(a){a.destroy(e)}),this.$substates&&(this.$substates.destroy(e),delete this.$substates),delete this._start_state,this.$concurrent&&(this.$concurrent.destroy(e),delete this.$concurrent),this.$incoming_transitions&&(this.$incoming_transitions.destroy(e),delete this.$incoming_transitions),this.$outgoing_transitions&&(this.$outgoing_transitions.destroy(e),delete this.$outgoing_transitions),this.$local_state&&(this.$local_state.destroy(!0),delete this.$local_state),d.superclass.destroy.apply(this,arguments),b.signal()
},e.get_substate_names=function(){return this.$substates.keys()},e.add_transition=function(b,c,d){var e,f,g;if(1===arguments.length)b instanceof a.StatechartTransition&&(g=b,e=g.from(),f=g.to());else{if(e=this.find_state(b),!e)throw new Error("No state '"+b+"'");if(f=this.find_state(c),!f)throw new Error("No state '"+c+"'");var h=d;g=new a.StatechartTransition({from:e,to:f,event:h}),this._last_transition=g,e._add_direct_outgoing_transition(g),f._add_direct_incoming_transition(g)}return e.is_active()?g.enable():g.disable(),this._emit("add_transition",{type:"add_transition",target:this,transition:g,from_state:e,to_state:f}),this},e.get_transitions_to=function(a){return this.$outgoing_transitions.filter(function(b){return b.to()===a})},e.get_transitions_from=function(a){return this.$incoming_transitions.filter(function(b){return b.from()===a})},e._add_direct_outgoing_transition=function(a,b){c.isNumber(b)?this.$outgoing_transitions.splice(b,0,a):this.$outgoing_transitions.push(a)},e._add_direct_incoming_transition=function(a,b){c.isNumber(b)?this.$incoming_transitions.splice(b,0,a):this.$incoming_transitions.push(a)},e._remove_direct_outgoing_transition=function(a){var b=this.$outgoing_transitions.indexOf(a);b>=0&&this.$outgoing_transitions.splice(b,1)},e._remove_direct_incoming_transition=function(a){var b=this.$incoming_transitions.indexOf(a);b>=0&&this.$incoming_transitions.splice(b,1)},e.get_initial_state=function(){var a=this.get_start_state();return a.getTo()},e.starts_at=e.set_initial_state=function(a){if(a=this.find_state(a,!1),!a)throw new Error("Could not find state "+a);var b=this.get_start_state();return b.setTo(a),this},e.create_shadow=function(b,d){var e=new a.Statechart(c.extend({basis:this,concurrent:this.is_concurrent(),set_basis_as_root:!0},b),d);return e},e.get_transitions=function(){return this.get_incoming_transitions().concat(this.get_outgoing_transitions())},e.get_substate_transitions=function(){var a=this.get_transitions();return c.uniq(c.flatten(a.concat(c.map(this.get_substates(),function(a){return a.get_substate_transitions()})),!0))},e.on_transition=e.on_state=function(a,b,d,e){var f=i(a,this,b,d,e);this._emit("on_transition",{type:"on_transition",target:this,str:a,activation_listener:b,deactivation_listener:d,context:e});var g=this._transition_listeners[a];return c.isArray(g)?g.push(f):g=this._transition_listeners[a]=[f],this},e.off_transition=e.on_state=function(a,b,d,e){this._emit("off_transition",{type:"off_transition",target:this,str:a,activation_listener:b,deactivation_listener:d,context:e});var f,g=this._transition_listeners[a];if(c.isArray(g)){for(f=0;f<g.length;f+=1){var h=g[f];h.activation_listener===b&&h.deactivation_listener===d&&(h.destroy(),g.splice(f,1),f-=1)}0===g.length&&delete this._transition_listeners[a]}},e.print=function(){a.print_statechart.apply(a,[this].concat(c.toArray(arguments)))},a.register_serializable_type("statechart",function(a){return a instanceof d},function(b){var d=c.toArray(arguments),e={substates:a.serialize.apply(a,[this.$substates].concat(d)),concurrent:this.is_concurrent(),start_state:a.serialize.apply(a,[this.get_start_state()].concat(d)),outgoing_transitions:a.serialize.apply(a,[this.$outgoing_transitions].concat(d)),incoming_transitions:a.serialize.apply(a,[this.$incoming_transitions].concat(d)),parent:a.serialize.apply(a,[this.parent()].concat(d))};return b&&(e.id=this.id()),e},function(b){var e,f=c.rest(arguments);if(b.id&&(e=a.find_uid(b.id)))return e;e=new d({avoid_constructor:!0});var g=function(){delete this.initialize;var c=a.deserialize.apply(a,[b.substates].concat(f));c.forEach(function(a){a.do_initialize_substate(),delete a.do_initialize_substate}),d.call(this,{id:b.id,concurrent:b.concurrent,substates:c,start_state:a.deserialize.apply(a,[b.start_state].concat(f)),outgoing_transitions:a.deserialize.apply(a,[b.outgoing_transitions].concat(f)),incoming_transitions:a.deserialize.apply(a,[b.incoming_transitions].concat(f)),parent:a.deserialize.apply(a,[b.parent].concat(f))})};return b.parent?e.do_initialize_substate=g:e.initialize=g,e})}(a.Statechart)}(interstate),function(a){"use strict";var b=a.cjs,c=a._;a.find_equivalent_transition=function(b,c){var d,e=b.from(),f=(b.to(),a.find_equivalent_state(e,c)),g=f.get_outgoing_transitions(),h=g.length;for(d=0;h>d;d+=1){var i=g[d];if(i.basis()===b)return i}throw new Error("Could not find equivalent transition")},a.StatechartTransition=function(c,d){c=c||{},this._started_construction||(this._started_construction=!0,this._initialized=b(!1),able.make_this_listenable(this),this._id=c.id||uid(),a.register_uid(this._id,this)),c.avoid_constructor||(this._last_run_event=b(!1),this._enabled=c.enabled===!0,a.__debug_statecharts&&(this.$enabled=b(this._enabled)),this._puppet=c.puppet===!0,this.$active=b(!1),this.is_start_transition=c.from instanceof a.StartState,this._times_run=c.times_run||(this.is_start_transition?1:0),this.$times_run=b(this._times_run),this._from_state=new b.Constraint(c.from),this._to_state=new b.Constraint(c.to),this._context=c.context,this.set_basis(c.basis),this.set_event(c.event),d!==!0&&this.initialize(c))},function(d){var e=d.prototype;able.make_proto_listenable(e),e.initialize=function(){this._event&&this._event.initialize(),this._initialized.set(!0),this._emit("initialized")},e.updateTo=function(b){var c=b.state,d=this.to(),e=a.find_equivalent_state(c,d);this.setTo(e)},e.updateFrom=function(b){var c=b.state,d=this.from(),e=a.find_equivalent_state(c,d);this.setFrom(e)},e.is_puppet=function(){return this._puppet},e.is_initialized=function(){return this._initialized.get()},e.increment_times_run=function(){this.$times_run.set(++this._times_run)},e.get_times_run=function(){return this.$times_run.get()},e.context=function(){return this._context},e.set_active=function(a){a=a===!0,this.$active.set(a)},e.is_active=function(){return this.$active.get()},e.basis=function(){return this._basis},e.set_basis=function(a){return this._basis&&(this._basis.off("setTo",this.updateTo,this),this._basis.off("setFrom",this.updateFrom,this),this._basis.off("remove",this.remove,this),this._basis.off("destroy",this.destroy,this)),this._basis=a,this._basis&&(this._basis.on("setTo",this.updateTo,this),this._basis.on("setFrom",this.updateFrom,this),this._basis.on("remove",this.remove,this),this._basis.on("destroy",this.destroy,this)),this},e.id=e.hash=function(){return this._id},e.sid=function(){return parseInt(uid.strip_prefix(this.id()),10)},e.from=function(){return this._from_state.get()},e.to=function(){return this._to_state.get()},e.setFrom=function(a){var b=this.from();b&&b._remove_direct_outgoing_transition(this),this._from_state.set(a);var c=function(){a._add_direct_outgoing_transition(this),a.is_active()?this.enable():this.disable()};return a.is_initialized()?c.call(this):a.once("initialized",c,this),this._emit("setFrom",{type:"setFrom",target:this,state:a}),this},e.setTo=function(b){var c=this.to();c&&c._remove_direct_incoming_transition(this),this._to_state.set(b);var d=function(){if(b._add_direct_incoming_transition(this),this.is_start_transition){var c=this.from();c.is_active()&&c.is_running()&&(a.event_queue.wait(),this.fire({}),a.event_queue.signal())}};return b.is_initialized()?d.call(this):b.once("initialized",d,this),this._emit("setTo",{type:"setTo",target:this,state:b}),this},e.set_event=function(a){this._event&&(this._event.off_fire(this.fire,this),this._event.destroy()),this._event=a,this._event&&(this._event.set_transition(this),this._event.on_fire(this.fire,this))},e.order=function(b){return b instanceof a.State?1:0},e.event=function(){return this._event},e.involves=function(a){return this.from()===a||this.to()===a},e.destroy=function(c){this.destroyed=!0,this._emit("destroy",{type:"destroy",target:this}),b.wait(),this.$active&&this.$active.destroy(c),this._from_state.destroy(c),delete this._from_state,this._to_state.destroy(c),delete this._to_state,this.set_basis(void 0),this._event.off_fire(this.fire,this),this._event.destroy(c),delete this._event,this._initialized.destroy(c),delete this._initialized,this._last_run_event.destroy(c),delete this._last_run_event,this.$active.destroy(c),delete this.$active,this.$times_run.destroy(c),delete this.$times_run,delete this._context,a.__debug_statecharts&&(this.$enabled.destroy(c),delete this.$enabled),b.signal(),able.destroy_this_listenable(this),a.unregister_uid(this.id())},e.fire=function(a){this.is_puppet()?this._emit("fire",{type:"fire",target:this}):this.from().on_outgoing_transition_fire(this,a)&&this._emit("fire",{type:"fire",target:this})},e.create_shadow=function(b,c,d,e,f){var g=this.event(),h=g.create_shadow(d,e,b.is_running()),i=new a.StatechartTransition({from:b,to:c,event:h,basis:this,context:e},f);return i},e.stringify=function(){var a=this.event(),b=a?a.stringify():"";return b.toString()},e.remove=function(){var a=this.from(),c=this.to();return this.disable(),b.wait(),a._remove_direct_outgoing_transition(this),c._remove_direct_incoming_transition(this),b.signal(),this._emit("remove",{type:"remove",transition:this}),this},e.root=function(){return this.from().root()},e.enable=function(){if(!this._enabled){this._enabled=!0;var b=this.event();b.enable(),a.__debug_statecharts&&this.$enabled.set(!0)}},e.disable=function(){if(this._enabled){this._enabled=!1;var b=this.event();b.disable(),a.__debug_statecharts&&this.$enabled.set(!1)}},e.is_enabled=function(){return this._enabled},a.__debug_statecharts&&(e.get_$enabled=function(){return this.$enabled.get()}),e.summarize=function(){var a,b=this.context();b&&(a=b.summarize());var c=this.basis()||this;return{basis_id:c.id(),context:a}},d.desummarize=function(b){if(b.context){var c=a.find_uid(b.basis_id),d=a.Pointer.desummarize(b.context),e=d.points_at(),f=e.get_statechart_for_context(d),g=a.find_equivalent_transition(c,f);return g}return a.find_uid(b.basis_id)},a.register_serializable_type("statechart_transition",function(a){return a instanceof d},function(b){var d=c.toArray(arguments),e={from:a.serialize.apply(a,[this.from()].concat(d)),to:a.serialize.apply(a,[this.to()].concat(d)),event:a.serialize.apply(a,[this.event()].concat(d))};return b&&(e.id=this.id()),e},function(b){var e=c.rest(arguments),f=new d({avoid_constructor:!0});return f.initialize=function(){delete this.initialize,d.call(this,{id:b.id,from:a.deserialize.apply(a,[b.from].concat(e)),to:a.deserialize.apply(a,[b.to].concat(e)),event:a.deserialize.apply(a,[b.event].concat(e))})},f})}(a.StatechartTransition)}(interstate),function(a){"use strict";var b=(a.cjs,a._),c=function(){able.make_this_listenable(this),this.end_queue_round=!1,this.queue=[],this.running_event_queue=!1;var a=0;this.wait=function(){a--},this.signal=function(){a++,a>=0&&this.run_event_queue()},this.is_ready=function(){return a>=0},this.num_post_event_queue_rounds=7,this.destroyed=!1};!function(b){var c=b.prototype;able.make_proto_listenable(c),c.is_running=function(){return this.running_event_queue===!1},c.clear=function(){this.queue.splice(0,this.queue.length)},c.run_event_queue=function(){var a;if(this.running_event_queue===!1){for(this.running_event_queue=!0,this._emit("begin_event_queue",{type:"begin_event_queue",target:this}),this.do_run_event_queue(),a=0;a<=this.num_post_event_queue_rounds;a+=1){this.end_queue_round=a;var b="end_event_queue_round_"+a;this._emit(b,{type:b,target:this,round:a})}this.end_queue_round=!1,this.running_event_queue=!1,this.deferred_req&&(this.deferred_req=!1,this.run_event_queue())}else this.deferred_req=!0},c.push=function(a,b){this.queue.push({context:a,args:b})},c.do_run_event_queue=function(){for(var b=a.Event.prototype._fire;this.queue.length>0;){var c=this.queue.shift();b.apply(c.context,c.args)}}}(c),a.event_queue=new c;var d=0;a.Event=function(){able.make_this_listenable(this),this.actual_firetime_listeners=[],this.requested_firetime_listeners=[],this._transition=void 0,this._enabled=!1,this._id=d++,this.on_create.apply(this,arguments),this._initialized=!1},function(c){var d=c.prototype;able.make_proto_listenable(d),d.id=function(){return this._id},d.initialize=function(){this._initialized=!0},d.id=function(){return this._id},d.sid=function(){return parseInt(uid.strip_prefix(this.id()),10)},d.on_create=function(a){this._enabled=a&&a.enabled},d.on_ready=function(){},d.fire=function(){var c=b.toArray(arguments);a.event_queue.push(this,c),b.forEach(this.requested_firetime_listeners,function(a){a.callback.apply(a.context||this,a.args.concat(c))},this),a.event_queue.is_ready()&&a.event_queue.run_event_queue()},d.on_fire_request=function(a,c){var d=b.rest(arguments,2);this.requested_firetime_listeners.push({callback:a,context:c,args:d})},d.off_fire_request=function(a,b){for(var c=0;c<this.requested_firetime_listeners.length;c++){var d=this.requested_firetime_listeners[c];d.callback!==a||b&&d.context!==b||(this.requested_firetime_listeners.splice(c,1),c--)}},d.on_fire=d.add_listener=function(a,c){var d=b.rest(arguments,2);this.actual_firetime_listeners.push({callback:a,context:c,args:d})},d.off_fire=d.remove_listener=function(a,b){for(var c=0;c<this.actual_firetime_listeners.length;c++){var d=this.actual_firetime_listeners[c];d.callback!==a||b&&d.context!==b||(this.actual_firetime_listeners.splice(c,1),c--)}},d.set_transition=function(a){this._transition=a},d.get_transition=function(){return this._transition},d._fire=function(){var a=b.toArray(arguments);b.forEach(this.actual_firetime_listeners,function(b){b.callback.apply(b.context||this,b.args.concat(a))},this)},d.guard=d.when=function(b){var c=new a.Event;return this.on_fire(function(){b.apply(this,arguments)&&c.fire.apply(c,arguments)}),c},d.when_eq=function(a,b){return this.guard(function(c){return c&&c[a]===b})},d.throttle=function(c){(!b.isNumber(c)||0>c)&&(c=50);var d,e=!1,f=new a.Event;this.on_fire(function(){d=arguments,e||(e=!0,window.setTimeout(function(){e=!1,f.fire.apply(f,b.toArray(d))},c))});var g=f.enable,h=f.disable,i=f.destroy;return f.enable=b.bind(function(){g.apply(f,arguments),this.enable()},this),f.disable=b.bind(function(){h.apply(f,arguments),this.disable()},this),f.destroy=b.bind(function(){i.apply(f,arguments),this.destroy(),delete f.enable,delete f.disable,delete f.destroy},this),f},d.preventDefault=function(){return this.on_fire_request(function(a){a.preventDefault&&a.preventDefault()}),this},d.stopPropagation=function(){return this.on_fire_request(function(a){a.stopPropagation&&a.stopPropagation()}),this},d.destroy=function(){this.destroyed=!0,this._emit("destroy"),delete this.actual_firetime_listeners,delete this.requested_firetime_listeners,delete this._transition,delete this._enabled,able.destroy_this_listenable(this)},d.create_shadow=function(){return new a.Event},d.stringify=function(){return""},d.type=function(){return this._type},d.enable=function(){this._enabled=!0},d.disable=function(){this._enabled=!1},d.is_enabled=function(){return this._enabled}}(a.Event)}(interstate),function(a){"use strict";var b=(a.cjs,a._),c=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}();a.requestAnimationFrame=c,a.FrameEvent=function(){a.Event.apply(this,arguments),this._type="frame_event"},function(d){b.proto_extend(d,a.Event);var e=d.prototype;e.on_create=function(){this.created_at=(new Date).getTime()},e.set_transition=function(a){if(this._transition=a,a){var b=a.from();b.on("active",this.enter_listener,this),b.on("inactive",this.leave_listener,this),b.is_active()&&this.enter_listener()}},e.notify=function(){this.fire({type:"frame",current_time:(new Date).getTime(),created_at:this.created_at})},e.enter_listener=function(){this.req&&(window.cancelAnimationFrame(this.req),this.req=void 0),this.req=c(b.bind(this.notify,this))},e.leave_listener=function(){this.req&&(window.cancelAnimationFrame(this.req),this.req=void 0)},e.destroy=function(){d.superclass.destroy.apply(this,arguments)},e.enable=function(){d.superclass.enable.apply(this,arguments),this.enter_listener()},e.disable=function(){d.superclass.disable.apply(this,arguments),this.req&&(window.cancelAnimationFrame(this.req),this.req=void 0)}}(a.FrameEvent)}(interstate),function(a){"use strict";var b=a.cjs,c=a._;a.CollisionEvent=function(){a.Event.apply(this,arguments),this._type="collision"},function(d){c.proto_extend(d,a.Event);var e=d.prototype;e.on_create=function(d,e){var f=[],g=[],h=c.bind(this.notify,this);this.live_fn=b.liven(function(){var b,i;d instanceof a.ContextualDict&&e instanceof a.ContextualDict?(b=d.is_template()?d.instances():[d],i=e.is_template()?e.instances():[e]):b=i=[],c.each(f,function(b){var e,f,h=a.contact_listeners.get(b),i=h.length;c.each(g,function(b){for(f=0;i>f;f++)if(e=h[f],e.target===b){1===i?a.contact_listeners.remove(d):h.splice(f,1),i--;break}},this)},this),c.each(b,function(b){var d=a.contact_listeners.get_or_put(b,function(){return[]});d.push.apply(d,c.map(i,function(a){return{target:a,callback:h}},this))},this),f=b,g=i},{context:this})},e.set_transition=function(a){if(this._transition=a,a){var b=a.from();b.on("active",this.enter_listener,this),b.on("inactive",this.leave_listener,this)}},e.enter_listener=function(){},e.leave_listener=function(){},e.notify=function(){this.fire({type:"collision"})},e.destroy=function(){this._transition,d.superclass.destroy.apply(this,arguments)},e.enable=function(){d.superclass.enable.apply(this,arguments)},e.disable=function(){d.superclass.disable.apply(this,arguments)}}(a.CollisionEvent)}(interstate),function(a){"use strict";var b=a.cjs,c=a._,d=new RedMap({equals:a.check_contextual_object_equality,hash:function(a){return a.hash?a.hash():a.toString()}});a.emit=function(b,e){e=e||window;var f=d.get(e);if(f){var g=f[b];if(g&&g.length>0){var h=c.rest(arguments,2);0===h.length&&(h=[{target:e,timestamp:(new Date).getTime()}]),a.event_queue.wait(),c.each(g,function(a){a.fire.apply(a,h)}),a.event_queue.signal()}}},a.register_serializable_type("ist_emit_func",function(b){return b===a.emit},function(){return{}},function(){return a.emit}),a.IstObjEvent=function(){a.Event.apply(this,arguments),this._type="ist_obj_event"},function(e){c.proto_extend(e,a.Event);var f=e.prototype;f.on_create=function(d,e){this.specified_type=d,this.specified_targets=e,this.targets=[],this.live_fn=b.liven(function(){var d=b.get(this.specified_type),e=b.get(this.specified_targets);c.isArray(e)||(e=[e]);var f=c.chain(e).map(function(b){return b instanceof a.Query?b.value():b}).flatten(!0).map(function(b){return b instanceof a.ContextualDict?b.is_template()?b.instances():b:b===window?b:!1}).flatten(!0).compact().map(function(a){return{cobj:a,type:d}}).value(),g=c.diff(this.targets,f,function(a,b){return a.cobj===b.cobj&&a.type===b.type});c.each(g.removed,function(a){this.remove_listener(a.from_item)},this),c.each(g.added,function(a){this.add_listener(a.item)},this),this.targets=f},{context:this,run_on_create:!1}),this.is_enabled()?this.live_fn.run(!1):this.live_fn.pause()},f.add_listeners=function(){c.each(this.targets,this.add_listener,this)},f.add_listener=function(b){var c=b.cobj,e=b.type;c instanceof a.ContextualObject&&c.on("begin_destroy",this.remove_listener,this,b);var f=!0,g=d.get_or_put(c,function(){f=!1;var a={};return a[e]=[this],a},this);if(f){var h=g[e];h?h.push(this):g[e]=[this]}},f.remove_listener=function(b){var e=b.cobj,f=b.type,g=d.get(e);if(g){var h=g[f];if(c.isArray(h)){var i=c.indexOf(h,this);if(i>=0){h.splice(i,1),e instanceof a.ContextualObject&&e.off("begin_destroy",this.remove_listener,this);var j=h.length;0===j&&(delete g[f],0===c.size(g)&&d.remove(e))}}}},f.remove_listeners=function(){c.each(this.targets,this.remove_listener,this),this.targets=[]},f.create_shadow=function(){var a=new e;return this.on_fire(function(){a.fire()}),a},f.destroy=function(){this.live_fn.destroy(!0),this.remove_listeners(),delete this.targets,e.superclass.destroy.apply(this,arguments)},f.enable=function(){this.is_enabled()||this.live_fn.resume()&&this.live_fn.run(),e.superclass.enable.apply(this,arguments)},f.disable=function(){this.is_enabled()&&(this.live_fn.pause(),this.live_fn.invalidate(),this.remove_listeners()),e.superclass.disable.apply(this,arguments)}}(a.IstObjEvent)}(interstate),function(a){"use strict";var b=(a.cjs,a._);a.ManualEvent=function(){a.Event.apply(this,arguments),this._type="manual_event"},function(c){b.proto_extend(c,a.Event);var d=c.prototype;d.create_shadow=function(){var a=new c;return this.on_fire(function(){a.fire()}),a},d.destroy=function(){c.superclass.destroy.apply(this,arguments)}}(a.ManualEvent)}(interstate),function(a){"use strict";var b=a.cjs,c=a._;a.DOMEvent=function(){a.Event.apply(this,arguments),this._type="dom_event"},function(d){function e(b){c.isArray(b)||(b=[b]);var d=c.chain(b).map(function(b){return b instanceof a.Query?b.value():b}).flatten(!0).value();return d}function f(b){var d=c.chain(b).map(function(b){return c.isElement(b)||b===window?{dom_obj:b,cobj:b}:b instanceof a.ContextualDict?b.is_template()?c.chain(b.instances()).map(a.get_instance_targs).flatten(!0).value():a.get_instance_targs(b):!1}).flatten(!0).compact().value();return d}function g(a){return f(e(a))}c.proto_extend(d,a.Event);var h=d.prototype;h.on_create=function(d,e){this.get_target_listener=b.memoize(function(b){var d=this,e=(this._id,function(e){a.event_queue.wait();var f=c.extend({},e,{ist_target:b,preventDefault:e.preventDefault?c.bind(e.preventDefault,e):function(){},stopPropagation:e.stopPropagation?c.bind(e.stopPropagation,e):function(){},stopImmediatePropagation:e.stopImmediatePropagation?c.bind(e.stopImmediatePropagation,e):function(){}});d.fire(f),c.defer(function(){a.event_queue.signal()})});return e.destroy=function(){d=null,delete e.destroy},e},{context:this,hash:function(b){return c.map(b,function(b){return b instanceof a.ContextualObject?b.hash():b+""}).join("")}}),this.specified_targets=e,this.specified_type=d,this.targets=[],this.live_fn=b.liven(function(){var a=b.get(this.specified_type),d=g(b.get(this.specified_targets));c.each(d,function(b){b.type=a});var e=c.diff(this.targets,d,function(a,b){return a.dom_obj===b.dom_obj&&a.type===b.type});c.each(e.removed,function(a){this.remove_listener(a.from_item)},this),c.each(e.added,function(a){this.add_listener(a.item)},this),this.targets=d},{context:this,run_on_create:!1}),this.is_enabled()?this.run_live_fn_and_check_for_uninitialized_cobjs(!1):this.live_fn.pause()},h.run_live_fn_and_check_for_uninitialized_cobjs=function(d){var f=e(b.get(this.specified_targets)),g=c.filter(f,function(b){return b instanceof a.ContextualDict&&!b.is_initialized()});if(g.length>0){var h=c.bind(function(a){if(0===g.length)this.live_fn.run(d),h=!1;else{var b=g.indexOf(a);g.splice(b,1)}},this);c.each(g,function(a){a.once("initialized",h)})}else this.live_fn.run(d)},h.clone=function(){return new d(this.type,this.targets)},h.add_listeners=function(){c.each(this.targets,this.add_listener,this)},h.add_listener=function(a){var b=a.dom_obj,d=a.cobj;c.isString(a.type)&&c.each(a.type.split(","),function(a){b.addEventListener(a,this.get_target_listener(d),!1)},this)},h.remove_listeners=function(){c.each(this.targets,this.remove_listener,this)},h.remove_listener=function(a){var b=a.dom_obj,d=a.cobj;c.isString(a.type)&&c.each(a.type.split(","),function(a){b.removeEventListener(a,this.get_target_listener(d),!1)},this)},h.destroy=function(){this.live_fn.destroy(!0),delete this.live_fn,this.remove_listeners();this.get_target_listener.each(function(a){a.get().destroy()}),this.get_target_listener.destroy(!0),delete this.get_target_listener,delete this.targets,delete this.specified_targets,delete this.specified_type,d.superclass.destroy.apply(this,arguments)},h.enable=function(){this.is_enabled()||(this.add_listeners(),this.live_fn.resume()&&this.run_live_fn_and_check_for_uninitialized_cobjs()),d.superclass.enable.apply(this,arguments)},h.disable=function(){this.is_enabled()&&(this.live_fn.pause(),this.remove_listeners()),d.superclass.disable.apply(this,arguments)},a.get_instance_targs=function(a){var b=a.get_dom_obj();return b?c.isArray(b)?c.map(b,function(b){return{dom_obj:b,cobj:a}}):{dom_obj:b,cobj:a}:!1}}(a.DOMEvent)}(interstate),function(a){"use strict";var b=(a.cjs,a._);a.TimeEvent=function(){a.Event.apply(this,arguments),this._type="time"},function(c){b.proto_extend(c,a.Event);var d=c.prototype;d.on_create=function(a){this.time=a;var b=(new Date).getTime(),c=this.time-b,d=this;window.setTimeout(function(){d.fire({type:"time",time:a,current_time:(new Date).getTime(),created_at:b})},c)},d.destroy=function(){c.superclass.destroy.apply(this,arguments)}}(a.TimeEvent),a.TimeoutEvent=function(){a.Event.apply(this,arguments),this._type="timeout",this.timeout=void 0},function(c){b.proto_extend(c,a.Event);var d=c.prototype;d.on_create=function(a){this.delay=a,this.created_at=(new Date).getTime()},d.set_transition=function(a){if(this._transition=a,a){var b=a.from();b.on("active",this.enter_listener,this),b.on("inactive",this.leave_listener,this),b.is_active()&&this.enter_listener()}},d.enter_listener=function(){this.timeout&&(window.clearTimeout(this.timeout),this.timeout=void 0),this.timeout=b.delay(function(a){a.notify()},this.delay,this)},d.leave_listener=function(){this.timeout&&(window.clearTimeout(this.timeout),this.timeout=void 0)},d.notify=function(){this.fire({type:"timeout",delay:this.delay,current_time:(new Date).getTime(),created_at:this.created_at})},d.destroy=function(){this._transition,c.superclass.destroy.apply(this,arguments)},d.enable=function(){c.superclass.enable.apply(this,arguments)},d.disable=function(){c.superclass.disable.apply(this,arguments)}}(a.TimeoutEvent)}(interstate),function(a){"use strict";var b=a.cjs,c=a._;a.TransitionEvent=function(){a.Event.apply(this,arguments),this._type="statechart_event"},function(d){c.proto_extend(d,a.Event);var e=d.prototype;e.on_create=function(d,e){this.targets=d,this.spec=e,this.get_activation_listener=b.memoize(function(){var a=function(a){this.fire(a)};return a}),this.get_deactivation_listener=b.memoize(function(){var a=function(){};return a}),this.live_fn=b.liven(function(){this.remove_listeners();var d;this.spec=b.get(this.spec),d&&d.destroy&&d.destroy();var e=b.get(this.targets);c.isArray(e)||(e=[e]),this.processed_targets=c.isString(this.spec)?c.chain(e).map(function(b){var d;if(b instanceof a.ContextualStatefulObj){if(b.is_template()){var e=b.instances();return d=c.map(e,function(a){var b=a.get_statecharts();return b}),c.flatten(d,!0)}return d=b.get_statecharts()}return!1}).flatten(!0).compact().value():[],this.is_enabled()&&this.add_listeners()},{context:this})},e.destroy=function(){this.live_fn.destroy(!0),delete this.live_fn,this.remove_listeners(),this.spec&&this.spec.destroy&&this.spec.destroy(!0),delete this.spec,this.targets&&this.targets.destroy&&this.targets.destroy(!0),delete this.target,this.get_activation_listener.destroy(!0),this.get_deactivation_listener.destroy(!0),delete this.get_activation_listener,delete this.get_deactivation_listener,d.superclass.destroy.apply(this,arguments)},e.add_listeners=function(){c.each(this.processed_targets,function(a){a.on_transition(this.spec,this.get_activation_listener(a),this.get_deactivation_listener(a),this)},this)},e.remove_listeners=function(){c.each(this.processed_targets,function(a){a.destroyed||a.off_transition(this.spec,this.get_activation_listener(a),this.get_deactivation_listener(a),this)},this)},e.stringify=function(){return this.statecharts[0].id()+":"+this._spec},a.register_serializable_type("transition_event",function(a){return a instanceof d},function(){var b=c.toArray(arguments);return{targets:a.serialize.apply(a,[this.targets].concat(b)),spec:this.spec}},function(b){var e=c.rest(arguments);return new d(a.deserialize.apply(a,[b.targets].concat(e)),b.spec)}),e.enable=function(){d.superclass.enable.apply(this,arguments),this.add_listeners()},e.disable=function(){d.superclass.disable.apply(this,arguments),this.remove_listeners()}}(a.TransitionEvent),a.StatechartEvent=function(){a.Event.apply(this,arguments),this._type="statechart_event"},function(b){c.proto_extend(b,a.Event);var d=b.prototype;d.on_create=function(b){this._id=uid(),a.register_uid(this._id,this),this.options=b,this.specified_target=b.target,this.spec=b.spec,c.isString(this.specified_target)||this.set_target(this.specified_target)},d.on_spec=function(){this.fire.apply(this,arguments)},d.set_transition=function(a){var d;b.superclass.set_transition.apply(this,arguments),c.isString(this.specified_target)&&("parent"===this.specified_target?(a=this.get_transition(),a&&(d=a.from(),this.set_target(d.parent()))):"me"===this.specified_target?(a=this.get_transition(),a&&(d=a.from(),this.set_target(d))):console.error("Unknown target "+this.specified_target))},d.id=function(){return this._id},d.set_target=function(a){this.target&&this.target.off(this.spec,this.on_spec,this),this.target=a,this.options.inert!==!0&&this.is_enabled()&&this.target.on(this.spec,this.on_spec,this)},d.destroy=function(){b.superclass.destroy.apply(this,arguments),a.unregister_uid(this.id()),this.target&&(this.target.off(this.spec,this.on_spec,this),delete this.target)},d.create_shadow=function(){return new b({target:this.specified_target,spec:this.spec,inert:this.options.inert_shadows,inert_shadows:this.options.inert_shadows})},d.enable=function(){this.is_enabled()||(b.superclass.enable.apply(this,arguments),this.options.inert!==!0&&this.target&&this.target.on(this.spec,this.on_spec,this))},d.disable=function(){this.is_enabled()&&(b.superclass.disable.apply(this,arguments),this.target&&this.target.off(this.spec,this.on_spec,this))},d.stringify=function(){return":"},a.register_serializable_type("statechart_event",function(a){return a instanceof b},function(){var a;return a=c.isString(this.specified_target)?this.specified_target:this.specified_target.summarize(),{specified_target:a,spec:this.spec}},function(d){var e;e=c.isString(d.specified_target)?d.specified_target:a.State.desummarize(d.specified_target);var f=d.spec;return new b({target:e,spec:f})})}(a.StatechartEvent)}(interstate);var UNDEF={};!function(a){"use strict";var b=a.cjs,c=a._;a.ConstraintEvent=function(){a.Event.apply(this,arguments),this._type="constraint_event"},function(d){c.proto_extend(d,a.Event);var e=d.prototype;e.on_create=function(a){this.constraint=a,this._last_val=UNDEF},e.set_transition=function(a){if(this._transition=a,a){var b=a.from();b.on("active",this.enter_listener,this),b.on("inactive",this.leave_listener,this),b.is_active()&&this.enter_listener()}},e.check_constraint_val=function(){var a=b.get(this.constraint,!1),c=this._last_val;this._last_val=a,a&&c!==a&&this.fire({value:a,timestamp:(new Date).getTime()})},e.destroy=function(){b.isConstraint(this.constraint)&&(this.constraint.offChange(this.check_constraint_val,this),this.constraint.destroy(!0)),delete this.constraint},e.enable=function(){d.superclass.enable.apply(this,arguments),b.isConstraint(this.constraint)&&this.constraint.onChange(this.check_constraint_val,this),this.check_constraint_val()},e.disable=function(){d.superclass.disable.apply(this,arguments),b.isConstraint(this.constraint)&&this.constraint.offChange(this.check_constraint_val,this)},e.enter_listener=function(){this._last_val=UNDEF},e.leave_listener=function(){}}(a.ConstraintEvent)}(interstate),function(a){"use strict";var b=a.cjs,c=a._,d=function(c,d,e){var f,g,h=a.get_parsed_$(c,d);if(h instanceof a.MultiExpression?(g=h.rest(),h=h.first()):g=[],f=b.get(h),f instanceof a.Event)return{event:f,actions:g};b.isConstraint(h)&&b.removeDependency(h,e._constraint);var i=new a.ConstraintEvent(h,f);return{event:i,actions:g}};a.ParsedEvent=function(){a.Event.apply(this,arguments),this._type="parsed_event",this._has_errors=!1},function(e){c.proto_extend(e,a.Event);var f=e.prototype;f.set_transition=function(){e.superclass.set_transition.apply(this,arguments),this._old_event&&this._old_event.set_transition(this.get_transition())},f.initialize=function(){e.superclass.initialize.apply(this,arguments),this._live_event_creator&&(this.is_enabled()?this._live_event_creator.run(!1):this._live_event_creator.pause())
},f.on_create=function(c){if(e.superclass.on_create.apply(this,arguments),this.$errors=new b.Constraint([]),this._id=uid(),a.register_uid(this._id,this),this.options=c,this._str=b.isConstraint(c.str)?c.str:b(c.str),c.inert!==!0){var f,g,h=a.find_stateful_obj_and_context(c.context);h?(f=h.context,g=h.stateful_obj):(f=c.context,g=c.context.points_at()),this._tree=b(function(){return esprima.parse(this.get_str())},{context:this}),this._old_event=null,this._live_event_creator=b.liven(function(){this._old_event&&(this._old_event.off_fire(this.child_fired,this),this._old_event.destroy(!0));var c,e=!1,h=!1;if(b.wait(),a.__debug)c=this._tree.get(),c instanceof a.Error?h=null:(e=d(c,{parent:g,context:f,only_parse_first:!0},this._live_event_creator),h=e.event),b.signal();else try{c=this._tree.get(),c instanceof a.Error?h=null:(e=d(c,{parent:g,context:f,only_parse_first:!0},this._live_event_creator),h=e.event,this._has_errors&&(this.$errors.set([]),this._has_errors=!1))}catch(i){var j=i.hasOwnProperty("message")?i.message:i.description;this.$errors.set([j]),this._has_errors=!0}finally{b.signal()}h&&(h.set_transition(this.get_transition()),h.on_fire(this.child_fired,this,e.actions,g,f),this.is_enabled()&&h.enable()),this._old_event=h},{context:this,run_on_create:!1})}},f.get_errors=function(){return this.$errors.get()},f.child_fired=function(b,d,e,f){if(this.fire.apply(this,c.rest(arguments,3)),b.length>0){var g=e.push(new a.ProvisionalContext,new a.EventContext(f));c.each(b,function(b){if(a.__debug)a.get_parsed_$(b,{parent:d,context:g,get_constraint:!1,auto_add_dependency:!1});else try{a.get_parsed_$(b,{parent:d,context:g,get_constraint:!1,auto_add_dependency:!1})}catch(c){console.error(c)}})}},f.get_str=function(){return this._str.get()},f.set_str=function(a){this._str.set(a),this._emit("setString",{to:a})},f.create_shadow=function(a,b,c){var d=new e({str:this.get_str(),context:b,inert_shadows:this.options.inert_shadows,inert:this.options.inert_shadows,enabled:c});return this.on("setString",function(a){d.set_str(a.to)}),d},f.destroy=function(){this._old_event&&(this._old_event.off_fire(this.$child_fired),this._old_event.destroy(),delete this._old_event),this._live_event_creator&&(this._live_event_creator.destroy(!0),delete this._live_event_creator),this._str&&(this._str.destroy(),delete this._str),this.$errors.destroy(!0),delete this.$errors,a.unregister_uid(this.id()),e.superclass.destroy.apply(this,arguments)},f.clone=function(){},f.stringify=function(){return this._str.get()},a.register_serializable_type("parsed_event",function(a){return a instanceof e},function(){return{str:this.get_str(),inert:this.options.inert}},function(a){return new e({str:a.str,inert:a.inert})}),f.enable=function(){e.superclass.enable.apply(this,arguments),this._old_event&&this._old_event.enable(),this._live_event_creator&&this._live_event_creator.resume()&&this._live_event_creator.run()},f.disable=function(){e.superclass.disable.apply(this,arguments),this._old_event&&this._old_event.disable(),this._live_event_creator&&this._live_event_creator.pause()}}(a.ParsedEvent)}(interstate),function(a){"use strict";var b=(a.cjs,a._);a.CombinationEvent=function(){a.Event.apply(this,arguments),this._type="combination_event"},function(c){b.proto_extend(c,a.Event);var d=c.prototype;d.on_create=function(a){this.events=a,b.each(this.events,function(a){a.parent=this,a.on_fire_request(b.bind(function(){this.fire.apply(this,arguments)},this))},this),c.superclass.on_create.apply(this,arguments)},d.destroy=function(){var a=arguments;b.each(this.events,function(b){b.destroy.apply(b,a)}),delete this.events,c.superclass.destroy.apply(this,arguments)},d.enable=function(){c.superclass.enable.apply(this,arguments),b.each(this.events,function(a){a.enable()})},d.disable=function(){c.superclass.disable.apply(this,arguments),b.each(this.events,function(a){a.disable()})}}(a.CombinationEvent)}(interstate),function(a){"use strict";var b=a.cjs,c=a._;a.CrossEvent=function(){a.Event.apply(this,arguments),this._type="cross"},function(d){c.proto_extend(d,a.Event);var e=d.prototype;e.on_create=function(a,d){this.path=a,this.min_velocity=d,this._curr_path=null,this._crossing_path_listener_id=!1,this.live_fn=b.liven(function(){this.remove_listener();var a=b.get(this.min_velocity);c.isNumber(a)||(a=0),this._min_velocity=a,this._curr_path=b.get(this.path),this.add_listener()},{context:this,run_on_create:!1}),this.live_fn.run(!1)},e.remove_listener=function(){this._crossing_path_listener_id&&(W(this._crossing_path_listener_id),this._crossing_path_listener_id=!1)},e.add_listener=function(){this._crossing_path_listener_id=V(this._curr_path,function(b){b>=this._min_velocity&&(a.event_queue.wait(),this.fire(),c.defer(function(){a.event_queue.signal()}))},this)},e.enable=function(){this.is_enabled()||this.live_fn.resume()&&(this.add_listener(),this.live_fn.run()),d.superclass.enable.apply(this,arguments)},e.disable=function(){this.is_enabled()&&(this.live_fn.pause(),this.remove_listener()),d.superclass.disable.apply(this,arguments)},e.destroy=function(){d.superclass.destroy.apply(this,arguments),this._crossing_path_listener_id&&W(this._crossing_path_listener_id)}}(a.CrossEvent);var d,e,f,g=String.prototype.toLowerCase,h=String.prototype.toUpperCase,i={NaN:1,Infinity:1,"-Infinity":1},j=/([achlmrqstvz])[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029,]*((-?\d*\.?\d*(?:e[\-+]?\d+)?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*)+)/gi,k=/(-?\d*\.?\d*(?:e[\-+]?\d+)?)[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*/gi,l=function(a,b,c,d){return[a,b,c,d,c,d]},m=function(a,b,c,d,e,f){var g=1/3,h=2/3;return[g*a+h*c,g*b+h*d,g*e+h*c,g*f+h*d,e,f]},n=function(a,b,c,d,e){var f=-3*b+9*c-9*d+3*e,g=a*f+6*b-12*c+6*d;return a*g-3*b+3*c},o=function(a,b,c,d,e,f,g,h,i){void 0===i&&(i=1),i=i>1?1:0>i?0:i;for(var j=i/2,k=12,l=[-.1252,.1252,-.3678,.3678,-.5873,.5873,-.7699,.7699,-.9041,.9041,-.9816,.9816],m=[.2491,.2491,.2335,.2335,.2032,.2032,.1601,.1601,.1069,.1069,.0472,.0472],o=0,p=0;k>p;p++){var q=j*l[p]+j,r=n(q,a,c,e,g),s=n(q,b,d,f,h),t=r*r+s*s;o+=m[p]*Math.sqrt(t)}return j*o},p=function(a,b,c,d,e,f,g,h,i,j){var k,l,m,n,o,q=120*Math.PI/180,r=Math.PI/180*(+e||0),s=[],t=w(function(a,b,c){var d=a*Math.cos(c)-b*Math.sin(c),e=a*Math.sin(c)+b*Math.cos(c);return{x:d,y:e}});if(j)l=j[0],m=j[1],n=j[2],o=j[3];else{k=t(a,b,-r),a=k.x,b=k.y,k=t(h,i,-r),h=k.x,i=k.y;var u=(Math.cos(Math.PI/180*e),Math.sin(Math.PI/180*e),(a-h)/2),v=(b-i)/2,x=u*u/(c*c)+v*v/(d*d);x>1&&(x=Math.sqrt(x),c=x*c,d=x*d);var y=c*c,z=d*d,A=(f==g?-1:1)*Math.sqrt(Math.abs((y*z-y*v*v-z*u*u)/(y*v*v+z*u*u)));n=A*c*v/d+.5*(a+h),o=A*-d*u/c+.5*(b+i),l=Math.asin(((b-o)/d).toFixed(9)),m=Math.asin(((i-o)/d).toFixed(9)),l=n>a?Math.PI-l:l,m=n>h?Math.PI-m:m,0>l&&(l=2*Math.PI+l),0>m&&(m=2*Math.PI+m),g&&l>m&&(l-=2*Math.PI),!g&&m>l&&(m-=2*Math.PI)}var B=m-l;if(Math.abs(B)>q){var C=m,D=h,E=i;m=l+q*(g&&m>l?1:-1),h=n+c*Math.cos(m),i=o+d*Math.sin(m),s=p(h,i,c,d,e,0,g,D,E,[m,C,n,o])}B=m-l;var F=Math.cos(l),G=Math.sin(l),H=Math.cos(m),I=Math.sin(m),J=Math.tan(B/4),K=4/3*c*J,L=4/3*d*J,M=[a,b],N=[a+K*G,b-L*F],O=[h+K*I,i-L*H],P=[h,i];if(N[0]=2*M[0]-N[0],N[1]=2*M[1]-N[1],j)return[N,O,P].concat(s);s=[N,O,P].concat(s).join().split(",");for(var Q=[],R=0,S=s.length;S>R;R++)Q[R]=R%2?t(s[R-1],s[R],r).y:t(s[R],s[R+1],r).x;return Q},q=function(a,b,c,d,e,f,g,h){F(a,"array")||(a=[a,b,c,d,e,f,g,h]);var i=x.apply(null,a);return{x:i.min.x,y:i.min.y,x2:i.max.x,y2:i.max.y,width:i.max.x-i.min.x,height:i.max.y-i.min.y}},r=function(a,b,c){return b>=a.x&&b<=a.x2&&c>=a.y&&c<=a.y2},s=function(a,b){var c=r;return c(b,a.x,a.y)||c(b,a.x2,a.y)||c(b,a.x,a.y2)||c(b,a.x2,a.y2)||c(a,b.x,b.y)||c(a,b.x2,b.y)||c(a,b.x,b.y2)||c(a,b.x2,b.y2)||(a.x<b.x2&&a.x>b.x||b.x<a.x2&&b.x>a.x)&&(a.y<b.y2&&a.y>b.y||b.y<a.y2&&b.y>a.y)},t=function(a,b,c,d,e,f,g,h,i){var j=1-i,k=Math.pow(j,3),l=Math.pow(j,2),m=i*i,n=m*i,o=k*a+3*l*i*c+3*j*i*i*e+n*g,p=k*b+3*l*i*d+3*j*i*i*f+n*h,q=a+2*i*(c-a)+m*(e-2*c+a),r=b+2*i*(d-b)+m*(f-2*d+b),s=c+2*i*(e-c)+m*(g-2*e+c),t=d+2*i*(f-d)+m*(h-2*f+d),u=j*a+i*c,v=j*b+i*d,w=j*e+i*g,x=j*f+i*h,y=90-180*Math.atan2(q-s,r-t)/Math.PI;return(q>s||t>r)&&(y+=180),{x:o,y:p,m:{x:q,y:r},n:{x:s,y:t},start:{x:u,y:v},end:{x:w,y:x},alpha:y}},u=function(a,b,c,d,e,f,g,h,i){var j=1-i;return{x:Math.pow(j,3)*a+3*Math.pow(j,2)*i*c+3*j*i*i*e+Math.pow(i,3)*g,y:Math.pow(j,3)*b+3*Math.pow(j,2)*i*d+3*j*i*i*f+Math.pow(i,3)*h}},v=function(a,b){for(var c=0,d=a.length;d>c;c++)if(a[c]===b)return a.push(a.splice(c,1)[0])},w=function(a,b,c){function d(){var e=Array.prototype.slice.call(arguments,0),f=e.join("␀"),g=d.cache=d.cache||{},h=d.count=d.count||[];return g.hasOwnProperty(f)?(v(h,f),c?c(g[f]):g[f]):(h.length>=1e3&&delete g[h.shift()],h.push(f),g[f]=a.apply(b,e),c?c(g[f]):g[f])}return d},x=w(function(a,b,c,d,e,f,g,h){var i,j=e-2*c+a-(g-2*e+c),k=2*(c-a)-2*(e-c),l=a-c,m=(-k+Math.sqrt(k*k-4*j*l))/2/j,n=(-k-Math.sqrt(k*k-4*j*l))/2/j,o=[b,h],p=[a,g];return Math.abs(m)>"1e12"&&(m=.5),Math.abs(n)>"1e12"&&(n=.5),m>0&&1>m&&(i=u(a,b,c,d,e,f,g,h,m),p.push(i.x),o.push(i.y)),n>0&&1>n&&(i=u(a,b,c,d,e,f,g,h,n),p.push(i.x),o.push(i.y)),j=f-2*d+b-(h-2*f+d),k=2*(d-b)-2*(f-d),l=b-d,m=(-k+Math.sqrt(k*k-4*j*l))/2/j,n=(-k-Math.sqrt(k*k-4*j*l))/2/j,Math.abs(m)>"1e12"&&(m=.5),Math.abs(n)>"1e12"&&(n=.5),m>0&&1>m&&(i=u(a,b,c,d,e,f,g,h,m),p.push(i.x),o.push(i.y)),n>0&&1>n&&(i=u(a,b,c,d,e,f,g,h,n),p.push(i.x),o.push(i.y)),{min:{x:Math.min.apply(0,p),y:Math.min.apply(0,o)},max:{x:Math.max.apply(0,p),y:Math.max.apply(0,o)}}}),y=function(a,b,c,d,e,f,g,h){if(!(Math.max(a,c)<Math.min(e,g)||Math.min(a,c)>Math.max(e,g)||Math.max(b,d)<Math.min(f,h)||Math.min(b,d)>Math.max(f,h))){var i=(a*d-b*c)*(e-g)-(a-c)*(e*h-f*g),j=(a*d-b*c)*(f-h)-(b-d)*(e*h-f*g),k=(a-c)*(f-h)-(b-d)*(e-g);if(k){var l=i/k,m=j/k,n=+l.toFixed(2),o=+m.toFixed(2);if(!(n<+Math.min(a,c).toFixed(2)||n>+Math.max(a,c).toFixed(2)||n<+Math.min(e,g).toFixed(2)||n>+Math.max(e,g).toFixed(2)||o<+Math.min(b,d).toFixed(2)||o>+Math.max(b,d).toFixed(2)||o<+Math.min(f,h).toFixed(2)||o>+Math.max(f,h).toFixed(2)))return{x:l,y:m}}}},z=function(a,b,c){var d=q(a),e=q(b);if(!s(d,e))return c?!1:[];for(var f,g=o.apply(0,a),h=o.apply(0,b),i=Math.max(~~(g/5),1),j=Math.max(~~(h/5),1),k=[],l=[],m={},n=c?!1:[],p=0;i+1>p;p++)f=t.apply(this,a.concat(p/i)),k.push({x:f.x,y:f.y,t:p/i});for(p=0;j+1>p;p++)f=t.apply(this,b.concat(p/j)),l.push({x:f.x,y:f.y,t:p/j});for(p=0;i>p;p++)for(var r=0;j>r;r++){var u=k[p],v=k[p+1],w=l[r],x=l[r+1],z=Math.abs(v.x-u.x)<.001?"y":"x",A=Math.abs(x.x-w.x)<.001?"y":"x",B=y(u.x,u.y,v.x,v.y,w.x,w.y,x.x,x.y);if(B){if(m[B.x.toFixed(4)]==B.y.toFixed(4))continue;m[B.x.toFixed(4)]=B.y.toFixed(4);var C=u.t+Math.abs((B[z]-u[z])/(v[z]-u[z]))*(v.t-u.t),D=w.t+Math.abs((B[A]-w[A])/(x[A]-w[A]))*(x.t-w.t);if(C>=0&&1.001>=C&&D>=0&&1.001>=D){if(c)return!0;n.push({x:B.x,y:B.y,t1:Math.min(C,1),t2:Math.min(D,1)})}}}return n},A=function(){return this.join(",").replace(p2s,"$1")},B=function(a){if("function"==typeof a||Object(a)!==a)return a;var b=new a.constructor;for(var c in a)a.hasOwnProperty(c)&&(b[c]=B(a[c]));return b},C=function(a){var b=B(a);return b.toString=A,b},D=function(a){var b=D.ps=D.ps||{};return b[a]?b[a].sleep=100:b[a]={sleep:100},setTimeout(function(){for(var c in b)b.hasOwnProperty(c)&&c!=a&&(b[c].sleep--,b[c].sleep||delete b[c])}),b[a]},E=function(a){if(!a)return null;var b=D(a);if(b.arr)return C(b.arr);var c={a:7,c:6,h:1,l:2,m:2,r:4,q:4,s:4,t:2,v:1,z:0},d=[];return F(a,"array")&&F(a[0],"array")&&(d=C(a)),d.length||String(a).replace(j,function(a,b,e){var f=[],g=b.toLowerCase();if(e.replace(k,function(a,b){b&&f.push(+b)}),"m"==g&&f.length>2&&(d.push([b].concat(f.splice(0,2))),g="l",b="m"==b?"l":"L"),"r"==g)d.push([b].concat(f));else for(;f.length>=c[g]&&(d.push([b].concat(f.splice(0,c[g]))),c[g]););}),d.toString=A,b.arr=C(d),d},F=function(a,b){return b=g.call(b),"finite"==b?!i[has](+a):"array"==b?a instanceof Array:"null"==b&&null===a||b==typeof a&&null!==a||"object"==b&&a===Object(a)||"array"==b&&Array.isArray&&Array.isArray(a)||objectToString.call(a).slice(8,-1).toLowerCase()==b},G=function(a,b){for(var c=[],d=0,e=a.length;e-2*!b>d;d+=2){var f=[{x:+a[d-2],y:+a[d-1]},{x:+a[d],y:+a[d+1]},{x:+a[d+2],y:+a[d+3]},{x:+a[d+4],y:+a[d+5]}];b?d?e-4==d?f[3]={x:+a[0],y:+a[1]}:e-2==d&&(f[2]={x:+a[0],y:+a[1]},f[3]={x:+a[2],y:+a[3]}):f[0]={x:+a[e-2],y:+a[e-1]}:e-4==d?f[3]=f[2]:d||(f[0]={x:+a[d],y:+a[d+1]}),c.push(["C",(-f[0].x+6*f[1].x+f[2].x)/6,(-f[0].y+6*f[1].y+f[2].y)/6,(f[1].x+6*f[2].x-f[3].x)/6,(f[1].y+6*f[2].y-f[3].y)/6,f[2].x,f[2].y])}return c},H=function(a){var b=D(a);if(b.abs)return C(b.abs);if(F(a,"array")&&F(a&&a[0],"array")||(a=E(a)),!a||!a.length)return[["M",0,0]];var c,d=[],e=0,f=0,g=0,i=0,j=0;"M"==a[0][0]&&(e=+a[0][1],f=+a[0][2],g=e,i=f,j++,d[0]=["M",e,f]);for(var k,l,m=3==a.length&&"M"==a[0][0]&&"R"==a[1][0].toUpperCase()&&"Z"==a[2][0].toUpperCase(),n=j,o=a.length;o>n;n++){if(d.push(k=[]),l=a[n],l[0]!=h.call(l[0]))switch(k[0]=h.call(l[0]),k[0]){case"A":k[1]=l[1],k[2]=l[2],k[3]=l[3],k[4]=l[4],k[5]=l[5],k[6]=+(l[6]+e),k[7]=+(l[7]+f);break;case"V":k[1]=+l[1]+f;break;case"H":k[1]=+l[1]+e;break;case"R":c=[e,f].concat(l.slice(1));for(var p=2,q=c.length;q>p;p++)c[p]=+c[p]+e,c[++p]=+c[p]+f;d.pop(),d=d.concat(G(c,m));break;case"M":g=+l[1]+e,i=+l[2]+f;default:for(p=1,q=l.length;q>p;p++)k[p]=+l[p]+(p%2?e:f)}else if("R"==l[0])c=[e,f].concat(l.slice(1)),d.pop(),d=d.concat(G(c,m)),k=["R"].concat(l.slice(-2));else for(var r=0,s=l.length;s>r;r++)k[r]=l[r];switch(k[0]){case"Z":e=g,f=i;break;case"H":e=k[1];break;case"V":f=k[1];break;case"M":g=k[k.length-2],i=k[k.length-1];default:e=k[k.length-2],f=k[k.length-1]}}return d.toString=A,b.abs=C(d),d},I=w(function(a,b){var c=!b&&D(a);if(!b&&c.curve)return C(c.curve);for(var d=H(a),e=b&&H(b),f={x:0,y:0,bx:0,by:0,X:0,Y:0,qx:null,qy:null},g={x:0,y:0,bx:0,by:0,X:0,Y:0,qx:null,qy:null},h=(function(a,b,c){var d,e;if(!a)return["C",b.x,b.y,b.x,b.y,b.x,b.y];switch(a[0]in{T:1,Q:1}||(b.qx=b.qy=null),a[0]){case"M":b.X=a[1],b.Y=a[2];break;case"A":a=["C"].concat(p.apply(0,[b.x,b.y].concat(a.slice(1))));break;case"S":"C"==c||"S"==c?(d=2*b.x-b.bx,e=2*b.y-b.by):(d=b.x,e=b.y),a=["C",d,e].concat(a.slice(1));break;case"T":"Q"==c||"T"==c?(b.qx=2*b.x-b.qx,b.qy=2*b.y-b.qy):(b.qx=b.x,b.qy=b.y),a=["C"].concat(m(b.x,b.y,b.qx,b.qy,a[1],a[2]));break;case"Q":b.qx=a[1],b.qy=a[2],a=["C"].concat(m(b.x,b.y,a[1],a[2],a[3],a[4]));break;case"L":a=["C"].concat(l(b.x,b.y,a[1],a[2]));break;case"H":a=["C"].concat(l(b.x,b.y,a[1],b.y));break;case"V":a=["C"].concat(l(b.x,b.y,b.x,a[1]));break;case"Z":a=["C"].concat(l(b.x,b.y,b.X,b.Y))}return a}),i=function(a,b){if(a[b].length>7){a[b].shift();for(var c=a[b];c.length;)a.splice(b++,0,["C"].concat(c.splice(0,6)));a.splice(b,1),n=Math.max(d.length,e&&e.length||0)}},j=function(a,b,c,f,g){a&&b&&"M"==a[g][0]&&"M"!=b[g][0]&&(b.splice(g,0,["M",f.x,f.y]),c.bx=0,c.by=0,c.x=a[g][1],c.y=a[g][2],n=Math.max(d.length,e&&e.length||0))},k=0,n=Math.max(d.length,e&&e.length||0);n>k;k++){d[k]=h(d[k],f),i(d,k),e&&(e[k]=h(e[k],g),i(e,k)),j(d,e,f,g,k),j(e,d,g,f,k);var o=d[k],q=e&&e[k],r=o.length,s=e&&q.length;f.x=o[r-2],f.y=o[r-1],f.bx=parseFloat(o[r-4])||f.x,f.by=parseFloat(o[r-3])||f.y,g.bx=e&&(parseFloat(q[s-4])||g.x),g.by=e&&(parseFloat(q[s-3])||g.y),g.x=e&&q[s-2],g.y=e&&q[s-1]}return e||(c.curve=C(d)),e?[d,e]:d},null,C),J=function(a,b,c){a=I(a);for(var d,e,f,g,h,i,j,k,l,m,n=c?!1:[],o=0,p=a.length;p>o;o++){var q=a[o];if("M"==q[0])d=h=q[1],e=i=q[2];else{"C"==q[0]?(l=[d,e].concat(q.slice(1)),d=l[6],e=l[7]):(l=[d,e,d,e,h,i,h,i],d=h,e=i);for(var r=0,s=b.length;s>r;r++){var t=b[r];if("M"==t[0])f=j=t[1],g=k=t[2];else{"C"==t[0]?(m=[f,g].concat(t.slice(1)),f=m[6],g=m[7]):(m=[f,g,f,g,j,k,j,k],f=j,g=k);var u=z(l,m,c);if(c){if(u)return!0}else{for(var v=0,w=u.length;w>v;v++)u[v].segment1=o,u[v].segment2=r,u[v].bez1=l,u[v].bez2=m;n=n.concat(u)}}}}}return n},K=[],L=[],M=function(a){var b,c,e,g,h,i,j=K.length,k=0,l=a.length,m=(new Date).getTime(),n=m-f;if(f=m,d&&d.length===a.length)a:for(k;l>k;k++)for(c=a[k].x,e=a[k].y,g=d[k].x,h=d[k].y,b=[["M",g,h],["C",g,h,c,e,c,e]],i=0;j>i;i++){var o=J(K[i],b,!0);if(o){var p=c-g,q=e-h,r=Math.sqrt(Math.pow(p,2),Math.pow(q,2)),s=r/n,t=L[i];t.callback.call(t.context||this,s);break a}}d=B(a)},N=!1,O=function(){N=!1;var a=c.map(e,function(a){return{x:a.pageX,y:a.pageY}});M(a)},P=function(a){e=a.touches,1===e.length&&(N=window.setTimeout(O,30)),a.preventDefault()},Q=function(a){N===!1&&(N=window.setTimeout(O,30)),e=a.touches,a.preventDefault()},R=function(a){e=a.touches,0===e.length?(N&&(window.clearTimeout(N),N=!1),e=a.touches,O()):(e=a.touches,N===!1&&(N=window.setTimeout(O,30))),a.preventDefault()},S=function(){window.addEventListener("touchstart",P),window.addEventListener("touchmove",Q),window.addEventListener("touchend",R)},T=function(){window.removeEventListener("touchstart",P),window.removeEventListener("touchmove",Q),window.removeEventListener("touchend",R)},U=1,V=function(a,b,c){var d=U;return U+=1,K.push(a),L.push({callback:b,context:c,id:d}),1===K.length&&S(),d},W=function(a){var b,c,d=0,e=K.length;for(d;e>d;d++)b=K[d],c=L[d],(b===a||c.id===a)&&(K.splice(d,1),L.splice(d,1),e-=1,0===e&&T())}}(interstate),function(a){"use strict";var b=a.cjs,c=a._;a.AttachmentInstance=function(a){this.options=a||{},this.contextual_object=this.options.contextual_object,this.creator=this.options.creator,this.type="(generic)"},function(a){var b=a.prototype;b.destroy=function(){delete this.options,delete this.contextual_object,delete this.creator,delete this.type},b.get_type=function(){return this.type},b.get_contextual_object=function(){return this.contextual_object},b.get_creator=function(){return this.creator},b.hash=function(){return this._context.hash()}}(a.AttachmentInstance),a.Attachment=function(b){b=b||{},this._multiple_allowed=b.multiple_allowed===!0?!0:!1,this._InstanceClass=b.instance_class||a.AttachmentInstance,this.type="(generic)",this.instance_options=b.instance_options||{}},function(a){var b=a.prototype;b.create_instance=function(a,b){var d=c.extend({contextual_object:a,owner:b,creator:this},this.instance_options),e=new this._InstanceClass(d);return e},b.destroy_instance=function(a){a.destroy()},b.set_instance_context=function(a,b){a.set_context(b)},b.get_type=function(){return this.type},b.multiple_allowed=function(){return this._multiple_allowed},b.hash=function(){return this.type},b.do_destroy=function(){},b.destroy=function(){delete this.type,delete this._multiple_allowed,delete this._InstanceClass,delete this.instance_options,this.do_destroy()}}(a.Attachment),a.register_attachments=function(b){var d="_attachment";c.each(b,function(b,c){var e=a.register_attachment(c,b);a.define(c+d,function(a){return new e(a)})})},a.register_attachment=function(d,e){var f="_attachment",g=0,h=function(){h.superclass.constructor.apply(this,arguments),this.type=d,this.id=g++};!function(d){c.proto_extend(d,a.AttachmentInstance);var f=d.prototype;f.on_ready=function(){e.ready.call(this),this._listeners={};var a=this.get_contextual_object();c.each(e.parameters,function(d,e){if(c.isFunction(d))this._listeners[e]=b.liven(function(){d.call(this,a)},{context:this});else if("list"===d.type){var f=d.add,g=d.remove,h=d.move,i=d.getter,j=[];this._listeners[e]=b.liven(function(){var b=i.call(this,a),d=c.diff(j,b);c.forEach(d.removed,function(a){var b=a.from,c=a.from_item;g.call(this,c,b)},this),c.forEach(d.added,function(a){var b=a.to,c=a.item;f.call(this,c,b)},this),c.forEach(d.moved,function(a){var b=a.from,c=a.to,d=a.item;h.call(this,d,b,c)},this),j=b},{context:this})}},this)},f.on_pause=function(){c.each(this._listeners,function(a){a.pause()})},f.on_resume=function(){c.each(this._listeners,function(a){a.resume()})},f.destroy=function(a){c.each(e.parameters,function(a,b){this._listeners[b].destroy(!0)},this),delete this._listeners,d.superclass.destroy.apply(this,arguments),e.destroy&&e.destroy.call(this,a)},c.each(e.proto_props,function(a,b){f[b]=a})}(h);var i=function(a){a=c.extend({instance_class:h},a),i.superclass.constructor.call(this,a),this.type=d};return function(b){c.proto_extend(b,a.Attachment);var g=b.prototype;e.attachment_destroy&&(g.do_destroy=e.attachment_destroy),a.register_serializable_type(d+f,function(a){return a instanceof b},function(){return{instance_options:a.serialize(this.instance_options)}},function(c){return new b({instance_options:a.deserialize(c.instance_options)})})}(i),i},a.get_attachment=function(a,b){var c=a.get_attachment_instance(b);return c}}(interstate),function(a,b){"use strict";function c(a){return!!d(a).body}function d(a){for(var b=a;b.parentNode;)b=b.parentNode;return b}var e=a.cjs,f=a._,g=function(a,b,c){var d=b.childNodes;if(d.length<=c)try{b.appendChild(a)}catch(e){}else{var f=d[c];b.insertBefore(a,f)}},h=function(a){var b=a.parentNode;b&&b.removeChild(a)},i=function(a,b,c){var d=a.parentNode;d&&(c>b&&(c+=1),g(a,d,c))};a.DomAttachmentInstance=function(b){a.DomAttachmentInstance.superclass.constructor.apply(this,arguments),this.type="dom",this.id=f.uniqueId(),b.tag?(this._dom_obj=window.document.createElement(b.tag),this._dom_obj.__ist_contextual_object__=this.contextual_object):(this._dom_obj=e(),this._tag_change_listener=this.add_tag_change_listener()),this._style_change_listener=this.add_style_change_listeners(),this._attr_change_listener=this.add_attribute_change_listeners(),this._children_change_listener=this.add_children_change_listener(),this.current_children_srcs=[]},function(d){f.proto_extend(d,a.AttachmentInstance);var j=d.prototype;j.on_ready=function(){},j.get_owner=function(){return this._owner},j.destroy=function(){if(f.has(this,"_tag_change_listener")&&(this._tag_change_listener.destroy(),delete this._tag_change_listener),f.has(this,"_style_change_listener")&&(this._style_change_listener.destroy(),delete this._style_change_listener),f.has(this,"_attr_change_listener")&&(this._attr_change_listener.destroy(),delete this._attr_change_listener),f.has(this,"_style_change_listeners")&&f.each(this._style_change_listeners,function(a){a.destroy()}),f.has(this,"_attr_change_listeners")&&f.each(this._attr_change_listeners,function(a){a.destroy()}),f.has(this,"_children_change_listener")&&(this._children_change_listener.destroy(),delete this._children_change_listener),this._dom_obj.destroy){var a=this._dom_obj.get();a&&delete a.__ist_contextual_object__,this._dom_obj.destroy()}else delete this._dom_obj.__ist_contextual_object__},j.get_dom_obj=function(){f.has(this,"_tag_change_listener")&&this._tag_change_listener.run();var a=e.get(this._dom_obj);return a},j.add_tag_change_listener=function(){var a,b=this.get_contextual_object();return e.liven(function(){var c=b.prop_val("tag");if(f.isString(c)||(c+=""),c=c.replace(/[^a-zA-Z0-9]/g,""),c!==a){a=c;var d=window.document.createElement(c);d.__ist_contextual_object__=b,this._dom_obj.set(d)}},{context:this,pause_while_running:!0})},j.add_style_change_listeners=function(){var b,c=this.get_contextual_object(),d=[],g={};return this._style_change_listeners=g,e.liven(function(){var e,h=c.prop("style"),i={};if(h instanceof a.ContextualDict){e=h.children(!0);var j=f.pluck(e,"name");f.each(e,function(a){i[a.name]=a.value}),b=j}else e=[],b=[];var k=f.diff(d,b);d=b;var l;k.removed.length>0&&(l=this.get_dom_obj()),f.each(k.removed,function(a){var b=a.from_item,c=g[b];c.destroy(),delete k.removed[b],l&&(l.style[b]="",delete l.style[b])},this),f.each(k.added,function(a){var b=a.item;g[b]=this.add_style_change_listener(b,i[b])},this)},{context:this,pause_while_running:!0})},j.add_style_change_listener=function(a,b){this.get_contextual_object();return e.liven(function(){var c=this.get_dom_obj();if(c){var d=b.val();d?c.style[a]=d.toString():(c.style[a]="",delete c.style[a])}},{context:this,pause_while_running:!0})},j.add_attribute_change_listeners=function(){var b,c=this.get_contextual_object(),d=[],g={};return this._attr_change_listeners=g,e.liven(function(){var e,h=c.prop("attr"),i={};if(h instanceof a.ContextualDict){e=h.children(!0);var j=f.pluck(e,"name");f.each(e,function(a){i[a.name]=a.value}),b=j}else e=[],b=[];var k=f.diff(d,b);d=b;var l;k.removed.length>0&&(l=this.get_dom_obj()),f.each(k.removed,function(a){var b=a.from_item,c=g[b];c.destroy(),delete k.removed[b],l&&(l.style[b]="",delete l.style[b])},this),f.each(k.added,function(a){var b=a.item;g[b]=this.add_attribute_change_listener(b,i[b])},this)},{context:this,pause_while_running:!0})},j.add_attribute_change_listener=function(a,b){this.get_contextual_object();return e.liven(function(){var c=this.get_dom_obj();if(c){var d=b.val();d?c.setAttribute(a,d):c.removeAttribute(a)}},{context:this,pause_while_running:!0})};var k=function(b){return b instanceof a.ContextualDict?b.get_dom_children():!1};j.is_paused=function(){return this._paused},j.pause=function(){this._paused=!0,f.has(this,"_tag_change_listener")&&this._tag_change_listener.pause(),f.has(this,"_style_change_listener")&&this._style_change_listener.pause(),f.has(this,"_attr_change_listener")&&this._attr_change_listener.pause(),f.has(this,"_style_change_listeners")&&f.each(this._style_change_listeners,function(a){a.pause()}),f.has(this,"_attr_change_listeners")&&f.each(this._attr_change_listeners,function(a){a.pause()}),f.has(this,"_children_change_listener")&&this._children_change_listener.pause();var c=this.current_children_srcs;f.each(c,function(c){if(c instanceof a.DomAttachmentInstance)c.pause();else if(f.isElement(c)){var d=b(c).data("pause");d&&d()}})},j.resume=function(){this._paused=!1,f.has(this,"_tag_change_listener")&&this._tag_change_listener.resume(),f.has(this,"_style_change_listener")&&this._style_change_listener.resume(),f.has(this,"_attr_change_listener")&&this._attr_change_listener.resume(),f.has(this,"_style_change_listeners")&&f.each(this._style_change_listeners,function(a){a.resume(),a.run()}),f.has(this,"_attr_change_listeners")&&f.each(this._attr_change_listeners,function(a){a.resume(),a.run()}),f.has(this,"_children_change_listener")&&this._children_change_listener.resume(),f.has(this,"_tag_change_listener")&&this._tag_change_listener.run(),f.has(this,"_style_change_listener")&&this._style_change_listener.run(),f.has(this,"_attr_change_listener")&&this._attr_change_listener.run(),f.has(this,"_children_change_listener")&&this._children_change_listener.run();var c=this.current_children_srcs;f.each(c,function(c){if(c instanceof a.DomAttachmentInstance)c.resume();else if(f.isElement(c)){var d=b(c).data("resume");d&&d()}})},j.on_remove=function(){var a=this.get_dom_obj();a&&c(a)||this.pause()},j.on_add=function(){var a=this.get_dom_obj();a&&c(a)&&this.resume()},j.add_children_change_listener=function(){var c=this.get_contextual_object(),d=e.liven(function(){var d=this.get_dom_obj();if(f.isElement(d)){if(c.has("innerHTML"))return void(d.innerHTML=c.prop_val("innerHTML"));var e,j=f.toArray(d.childNodes),l=[],m=[],n=c.prop_val("showChildren"),o=c.prop_val("textContent");o&&(m.push(document.createTextNode(o)),l.push(!1)),void 0===n&&(n=!0),f.isArray(n)?(e=c.children(),f.each(n,function(a){var b=f.index_where(e,function(b){return b.value===a||b.name===a});if(b>=0){var c=k(e[b].value);c&&(l.push.apply(l,c.srcs),m.push.apply(m,c.children)),e.splice(b,1)}},this)):n!==!1&&(e=c.children(),f.each(e,function(a){if(n===!0||n===a.name||n===a.value){var b=k(a.value);b&&(l.push.apply(l,b.srcs),m.push.apply(m,b.children))}},this));var p,q=j.length,r=!1;if(q===m.length){var s=!1;for(p=0;q>p;p++)if(j[p]!==m[p]){s=!0;break}s||(r=!0)}if(r)return void(this.current_children_srcs=l);var t=f.diff(j,m);f.forEach(t.removed,function(c){var d=c.from,e=c.from_item,g=this.current_children_srcs[d];if(h(e),g instanceof a.DomAttachmentInstance)g.on_remove();else if(f.isElement(g)){var i=b(g).data("pause");i&&i()}},this),f.forEach(t.added,function(c){var e=c.to,h=c.item,i=l[e];if(g(h,d,e),i instanceof a.DomAttachmentInstance)i.on_add();else if(f.isElement(i)){var j=b(i).data("resume");j&&j()}},this),f.forEach(t.moved,function(a){var b=a.from,c=a.to,d=a.item;i(d,b,c)},this),this.current_children_srcs=l}},{context:this,pause_while_running:!0});return d}}(a.DomAttachmentInstance),a.DomAttachment=function(b){b=f.extend({instance_class:a.DomAttachmentInstance},b),a.DomAttachment.superclass.constructor.call(this,b),this.type="dom"},function(b){f.proto_extend(b,a.Attachment);b.prototype;a.register_serializable_type("dom_attachment",function(a){return a instanceof b},function(){return{instance_options:a.serialize(this.instance_options)}},function(c){return new b({instance_options:a.deserialize(c.instance_options)})})}(a.DomAttachment)}(interstate,jQuery),function(a,b){"use strict";var c=a.cjs,d=a._,e=function(b){var c=[];return d.each(b,function(b){if(b instanceof a.ContextualDict)if(b.is_template()){var d=b.instances();c.push.apply(c,e(d))}else{var f=b.get_attachment_instance("shape");if(f){var g=b.prop_val("show");g&&c.push(f),c.push.apply(c,f.get_children())}var h=b.get_attachment_instance("group");h&&c.push.apply(c,h.get_children())}},this),c},f=function(a){var b,c,f=a.prop_val("showChildren");return d.isArray(f)?(c=a.children(),b=[],d.each(f,function(a){var f=d.index_where(c,function(b){return b.value===a||b.name===a});f>=0&&(b.push.apply(b,e([c[f].value])),c.splice(f,1))})):f!==!1?(c=a.children(),b=e(d.pluck(c,"value"))):b=[],b};a.PaperAttachment=a.register_attachment("paper",{ready:function(){this.dom_obj=window.document.createElement("span"),this.paper=new Raphael(this.dom_obj,0,0)},destroy:function(){this.paper.clear(),this.paper.remove(),delete this.paper,delete this.dom_obj},parameters:{width_height:function(a){var b=a.prop_val("width"),c=a.prop_val("height");this.paper.setSize(b,c)},fill:function(a){var c=a.prop_val("fill"),d=this.get_dom_obj();b("svg",d).css("background-color",c)},screen:{type:"list",add:function(a,b){var c,d,e=a.create_robj(this.paper),f=0;this.paper.forEach(function(a){f===b&&(c=a),d=f,f++}),c!==e&&(b>=d?e.toBack():e.insertBefore(c))},remove:function(a){a.remove()},move:function(a,b,c){var d=a.get_robj(),e=0;c>b&&(c+=1);var f,g;this.paper.forEach(function(a){e===c&&(f=a),g=e,e++}),c>=g?d.toBack():d.insertBefore(f)},getter:function(a){return f(a)}}},proto_props:{get_dom_obj:function(){return this.dom_obj}}});var g=["r","cx","cy","x","y","width","height","path","fill","stroke","opacity","fill_opacity","stroke_opacity","transform"],h={};d.each(g,function(a){h[a]=!0}),a.ShapeAttachment=a.register_attachment("shape",{ready:function(){this.shape_type=this.options.shape_type,"rectangle"===this.shape_type&&(this.shape_type="rect"),this.constructor_params=this.options.constructor_params,this.$robj=c(!1),this.$children=c(this.child_getter,{context:this})},destroy:function(a){this.remove(),this.$robj.destroy(a),this.$children.destroy(a),delete this.constructor_params,delete this.$robj,delete this.$children},parameters:function(b){var e={};return d.each(b,function(b,f){e[b]=function(e){if(e.has(b)){var g=e.prop_val(b),i=this.get_robj();if(i){var j;if(h[b]===!0&&(j=e.prop_val("animated_properties"))&&(j===!0||"*"===j)||d.isArray(j)&&d.indexOf(j,b)>=0){var k=e.prop_val("animation_duration");d.isNumber(k)||(k=300);var l=e.prop_val("animation_easing");d.isString(l)||(l="linear");var m={};m[f]=c.get(g);try{i.animate(m,k,l)}catch(n){a.__log_errors&&console.error(n)}}else try{i.attr(f,c.get(g))}catch(n){a.__log_errors&&console.error(n)}}}}},this),e}({opacity:"opacity","arrow-end":"arrow_end","arrow-start":"arrow_start",blur:"blur","clip-rect":"clip_rect",cursor:"cursor",cx:"cx",cy:"cy",fill:"fill","fill-opacity":"fill_opacity",font:"font","font-family":"font_family","font-size":"font_size","font-style":"font_style","font-weight":"font_weight",height:"height",href:"href","letter-spacing":"letter_spacing",path:"path",r:"r",rx:"rx",ry:"ry",src:"src",stroke:"stroke","stroke-dasharray":"stroke_dasharray","stroke-linecap":"stroke_linecap","stroke-linejoin":"stroke_linejoin","stroke-miterlimit":"stroke_miterlimit","stroke-opacity":"stroke_opacity","stroke-width":"stroke_width",target:"target","text-anchor":"text_anchor",text:"text",title:"title",transform:"transform",width:"width",x:"x",y:"y"}),proto_props:{create_robj:function(a){var b=this.get_robj();
return b?b:(b=a[this.shape_type].apply(a,this.constructor_params),b[0].__ist_contextual_object__=this.get_contextual_object(),this.$robj.set(b),b)},get_robj:function(){return c.get(this.$robj)},remove:function(){var a=this.get_robj();a&&(a.remove(),this.$robj.set(!1))},child_getter:function(){var a,b,c,f=this.get_contextual_object(),g=f.prop_val("show");return d.isArray(g)||d.isString(g)?(d.isString(g)&&(g=[g]),b=d.filter(f.children(),function(a){return d.contains(g,a.name)}),c=d.pluck(b,"value"),c.reverse(),a=e(c)):g?(b=f.children(),c=d.pluck(b,"value"),c.reverse(),a=e(c)):a=[],a},get_children:function(){return this.$children.get()}},attachment_destroy:function(){}}),a.GroupAttachment=a.register_attachment("group",{ready:function(){this.$children=c(this.child_getter,{context:this})},destroy:function(a){this.$children.destroy(a),delete this.$children},parameters:{children:function(){}},proto_props:{child_getter:function(){var a=this.get_contextual_object();return f(a)},get_children:function(){return this.$children.get()}}})}(interstate,jQuery),function(a){"use strict";if(window.Box2D){var b=a.cjs,c=a._,d=30,e=Box2D.Common.Math.b2Vec2,f=(Box2D.Collision.b2AABB,Box2D.Dynamics.b2BodyDef),g=Box2D.Dynamics.b2Body,h=Box2D.Dynamics.b2FixtureDef,i=(Box2D.Dynamics.b2Fixture,Box2D.Dynamics.b2World),j=(Box2D.Collision.Shapes.b2MassData,Box2D.Collision.Shapes.b2PolygonShape),k=Box2D.Collision.Shapes.b2CircleShape,l=(Box2D.Dynamics.Joints.b2MouseJointDef,Box2D.Dynamics.b2DebugDraw,Box2D.Dynamics.b2ContactListener,new h);l.density=1,l.friction=.5,l.restitution=.2;var m=new f;m.type=g.b2_dynamicBody,a.contact_listeners=new RedMap({equals:a.check_contextual_object_equality,hash:function(a){return a.hash?a.hash():a.toString()}}),a.WorldAttachment=a.register_attachment("box2d_world",{ready:function(){this.world=new i(new e(0,0),!0),this.world.SetContactListener({BeginContact:function(){},EndContact:function(b){var d=b.m_fixtureA.cobj,e=b.m_fixtureB.cobj,f=c.filter(a.contact_listeners.get(d),function(b){return a.check_contextual_object_equality(b.target,e)}).concat(c.filter(a.contact_listeners.get(e),function(b){return a.check_contextual_object_equality(b.target,d)}));window.setTimeout(function(){c.each(f,function(a){a.callback(b)})},0)},PreSolve:function(){},PostSolve:function(){}});var b=c.bind(function(){this.world.Step(1/60,10,10),a.requestAnimationFrame.call(window,b)},this);a.requestAnimationFrame.call(window,b)},parameters:{gravity:function(a){var b=a.prop_val("gx"),c=a.prop_val("gy"),d=new e(b,c);this.world.SetGravity(d);for(var f=this.world.GetBodyList(),g=this.world.GetBodyCount(),h=0;g>h;h++)f.SetAwake(!0),f=f.GetNext()}},proto_props:{get_world:function(){return this.world}}}),a.FixtureAttachment=a.register_attachment("box2d_fixture",{ready:function(){var a=this.get_contextual_object();this.b2x=b.constraint(function(){var b=a.prop_val("shape");if("circle"===b)return a.prop_val("cx");if("rectangle"===b){var c=a.prop_val("x"),d=a.prop_val("width");return c+d/2}return-1}),this.b2y=b.constraint(function(){var b=a.prop_val("shape");if("circle"===b)return a.prop_val("cy");if("rectangle"===b){var c=a.prop_val("y"),d=a.prop_val("height");return c+d/2}return-1}),this.b2vx=b.constraint(0),this.b2vy=b.constraint(0),this.b2t=b.constraint(0),this.b2vt=b.constraint(0),this.body=b.constraint(),this.shape=b.constraint(),this.fixture=b.constraint(),this._update_interval=window.setInterval(c.bind(function(){var a=this.get_body();if(a){var c=a.GetPosition(),e=a.GetAngle(),f=a.GetLinearVelocity(),g=a.GetAngularVelocity();b.wait();var h=this.shape.get();if(h instanceof k)this.b2x.set(c.x*d),this.b2y.set(c.y*d);else if(h instanceof j){var i=h.m_vertices[0],l=h.m_vertices[2],m=Math.abs(i.x-l.x),n=Math.abs(i.y-l.y);this.b2x.set((c.x-m/2)*d),this.b2y.set((c.y-n/2)*d)}this.b2vx.set(f.x),this.b2vy.set(f.y),this.b2t.set(e),this.b2vt.set(g),b.signal()}},this),1e3/60)},destroy:function(){window.clearInterval(this._update_interval);var a=this.get_body();if(a){var b=a.m_world;b.DestroyBody(a)}},parameters:{radius:function(a){var b=this.shape.get();if(b instanceof k){var c=a.prop_val("r");b.SetRadius(c/d)}},fixture_attributes:function(a){var b=this.get_fixture();if(b){var c=a.prop_val("density"),d=a.prop_val("friction"),e=a.prop_val("restitution");b.density=c,b.friction=d,b.restition=e}},path:function(a){var b=this.shape.get();if(b instanceof j){var c=a.prop_val("width"),e=a.prop_val("height");b.SetAsBox(c/(2*d),e/(2*d))}},fixed:function(a){var b=a.prop_val("fixed"),c=this.body.get();if(c)if(b){var f,h,i=this.shape.get();if(i instanceof k){{a.prop_val("r")}f=a.prop_val("cx")/d,h=a.prop_val("cy")/d}else if(i instanceof j){var l=a.prop_val("width")/2,m=a.prop_val("height")/2;f=(a.prop_val("x")+l)/d,h=(a.prop_val("y")+m)/d}c.SetType(g.b2_staticBody),c.SetPosition(new e(f,h))}else c.SetType(g.b2_dynamicBody),c.SetAwake(!0)},world:function(a){var b=a.prop_val("world");if(b){var c=b.get_attachment_instance("box2d_world"),e=c.get_world();if(this.world!==e){var f=a.prop_val("shape");if("circle"===f||"rectangle"===f){var h,i=a.prop_val("density"),n=a.prop_val("friction"),o=a.prop_val("restitution"),p=a.prop_val("fixed");if(l.density=i,l.friction=n,l.restitution=o,m.type=p?g.b2_staticBody:g.b2_dynamicBody,"circle"===f){var q=a.prop_val("cx"),r=a.prop_val("cy"),s=a.prop_val("r");m.position.x=q/d,m.position.y=r/d,l.shape=new k(s/d)}else if("rectangle"===f){var t=a.prop_val("x"),u=a.prop_val("y"),v=a.prop_val("width")/2,w=a.prop_val("height")/2;m.position.x=(t+v)/d,m.position.y=(u+w)/d,l.shape=new j,l.shape.SetAsBox(v/d,w/d)}h=e.CreateBody(m).CreateFixture(l),h.cobj=a,this.fixture.set(h);var x=h.GetBody();this.body.set(x),this.shape.set(h.GetShape());var y=x.GetPosition(),z=x.GetAngle(),A=x.GetLinearVelocity(),B=x.GetAngularVelocity();this.b2x.set(y.x*d),this.b2y.set(y.y*d),this.b2vx.set(A.x),this.b2vy.set(A.y),this.b2t.set(z),this.b2vt.set(B),this.world=e}}}}},proto_props:{get_fixture:function(){return this.fixture.get()},get_body:function(){return this.body.get()},get_shape:function(){return this.shape.get()},getComputedX:function(){return this.b2x.get()},getComputedY:function(){return this.b2y.get()},getComputedTheta:function(){return this.b2t.get()},applyForce:function(a,b){var c=this.get_body();c&&setTimeout(function(){c.ApplyForce(new e(a,b),c.GetWorldCenter())})},applyImpulse:function(a,b){var c=this.get_body();c&&setTimeout(function(){c.ApplyImpulse(new e(a,b),c.GetWorldCenter())})}}})}}(interstate,jQuery),function(a){"use strict";var b=a.cjs,c=a._,d=0,e="changed",f="get",g="value",h="destroy_server",i="destroy_client",j=function(e){this.comm_mechanism=!1,this._id=d++,this.message_signature="rc_"+this._id,this.value=b(function(){return a.summarize_value_for_comm_wrapper(b.get(e))}),this.$onChange=c.bind(this.onChange,this),this.$onMessage=c.bind(this.onMessage,this),this.value.onChange(this.$onChange)};!function(a){var b=a.prototype;b.id=function(){return this._id},b.onChange=function(){this.comm_mechanism.post({type:this.message_signature,subtype:e})},b.onMessage=function(a){a.subtype===f&&this.comm_mechanism.post({type:this.message_signature,subtype:g,value:this.value.get(),client_id:a.client_id})},b.destroy=function(){this.comm_mechanism.post({type:this.message_signature,subtype:h}),this.comm_mechanism.off(this.message_signature,this.$on_message),this.value.offChange(this.$onChange),this.value.destroy(!0),delete this.$onChange,delete this.$onMessage,delete this.comm_mechanism},b.set_communication_mechanism=function(a){this.comm_mechanism&&this.comm_mechanism.off(this.message_signature,this.$on_message),this.comm_mechanism=a,this.comm_mechanism.on(this.message_signature,this.$onMessage)}}(j);var k=0,l=function(a){this.comm_mechanism=!1,this._id=k++,this.server_id=a,this.message_signature="rc_"+this.server_id,this.$onMessage=c.bind(this.onMessage,this),this.$value=b()};!function(a){var b=a.prototype;b.requestUpdate=function(){this.comm_mechanism.post({type:this.message_signature,subtype:f,client_id:this._id})},b.get=function(){return this.$value.isValid()||this.requestUpdate(),this.$value.get()},b.onMessage=function(a){switch(a.subtype){case g:this.$value.set(a.value);break;case e:this.$value.invalidate()}},b.destroy=function(){this.comm_mechanism.post({type:this.message_signature,subtype:i}),this.$value.destroy(!0),this.comm_mechanism.off(this.message_signature,this.$on_message),delete this.$onMessage,delete this.comm_mechanism},b.set_communication_mechanism=function(a){this.comm_mechanism&&this.comm_mechanism.off(this.message_signature,this.$on_message),this.comm_mechanism=a,this.comm_mechanism.on(this.message_signature,this.$onMessage),this.requestUpdate()}}(l),a.RemoteConstraintServer=j,a.RemoteConstraintClient=l;var m=a.summarize_value_for_comm_wrapper=function(d,e){var f;if(d instanceof a.ContextualObject){var g=d.id(),h=d.type(),i={type:h,id:g,obj_id:d.get_object().id(),colloquial_name:d.get_colloquial_name(),name:d.get_name()};if(("dict"===h||"stateful"===h)&&e!==!0){var j,k,l,n,o=d.is_template();if(o)j=l=k=!1,n=d.instances();else if(n=!1,j=d.is_instance()){var p=d.get_template_info();k=p.cobj,l=p.index}else k=l=!1;i.is_template=o,i.is_instance=j,i.template=m(k,!0),i.instances=n?c.map(n,function(a){return m(a,!0)}):n,i.index=l}f={__type__:"summarized_obj",__value__:"contextual_obj",object_summary:i}}else d instanceof a.StartState?f={__type__:"summarized_obj",__value__:"state",object_summary:{type:"start_state",id:d.id()}}:d instanceof a.Statechart?f={__type__:"summarized_obj",__value__:"state",object_summary:{type:"statechart",id:d.id()}}:d instanceof a.StatechartTransition?f={__type__:"summarized_obj",__value__:"transition",object_summary:{type:"transition",id:d.id()}}:d instanceof a.Event?f={__type__:"summarized_obj",__value__:"event",object_summary:{type:"event",id:d.id(),event_type:d.type()}}:d instanceof a.Cell?f={__type__:"summarized_obj",__value__:"contextual_obj",object_summary:{type:"raw_cell",id:d.id()}}:d instanceof a.WrapperClient?f={__type__:"summarized_obj",__value__:"client_wrapper"}:b.isConstraint(d)?f={__type__:"summarized_obj",__value__:"constraint"}:c.isArray(d)?f=c.map(d,m):c.isFunction(d)?f={__type__:"summarized_obj",__value__:"function"}:c.isElement(d)?f={__type__:"summarized_obj",__value__:"dom_elem"}:window.Box2D&&d instanceof Box2D.Dynamics.b2World?f={__type__:"summarized_obj",__value__:"box2d_world"}:d instanceof a.ParsedFunction?f={__type__:"summarized_obj",__value__:"function"}:c.isObject(d)?(f={},c.each(d,function(a,b){f[b]=m(a)})):f=d;return f}}(interstate,jQuery),function(a){"use strict";var b=(a.cjs,a._),c=window.location.protocol+"//"+window.location.host;a.InterWindowCommWrapper=function(a,c){able.make_this_listenable(this),this.remote_window=a,this.client_id=c,this.$on_message=b.bind(this.on_message,this),window.addEventListener("message",this.$on_message)},function(a){var d=a.prototype;able.make_proto_listenable(d),d.on_message=function(a){if(a.source===this.remote_window){var b=a.data;if(b.client_id===this.client_id){var c=b.message;this._emit(c.type,c)}}},d.post=function(a,d){this.remote_window.postMessage({message:a,client_id:this.client_id},c),b.isFunction(d)&&d()},d.destroy=function(){window.removeEventListener("message",this.$on_messsage),delete this.$on_message}}(a.InterWindowCommWrapper);var d=[];a.SameWindowCommWrapper=function(a,b){able.make_this_listenable(this),this.client_id=a,this.message_delay=b,d.push(this)},function(a){var c=a.prototype;able.make_proto_listenable(c),c.post=function(a,c){for(var e=d.length,f=this.client_id,g=0;e>g;g++){var h=d[g];this!==h&&h.client_id===f&&h.on_message(a)}b.isFunction(c)&&c()},c.on_message=function(a){if(this.message_delay||b.isNumber(this.message_delay)){var c=b.isNumber(this.message_delay)?this.message_delay:0;b.defer(b.bind(function(){this._emit(a.type,a)},this),c)}else this._emit(a.type,a)},c.destroy=function(){for(var a=0;a<d.length;a++)d[a]===this&&(d.splice(a,1),a--)}}(a.SameWindowCommWrapper),a.SocketCommWrapper=function(a,d){able.make_this_listenable(this),this.client_id=a,this.is_server=d,this.socket=io.connect(c),this.socket.emit("comm_wrapper",this.client_id,this.is_server),this.$on_message=b.bind(this.on_message,this),this.socket.on("message",this.$on_message)},function(a){var c=a.prototype;able.make_proto_listenable(c),c.on_message=function(a){a.client_id===this.client_id&&this._emit(a.type,a.message)},c.post=function(a,c){this.socket.emit("message",{type:a.type,message:a,client_id:this.client_id}),b.isFunction(c)&&c()},c.destroy=function(){this.socket.disconnect(),delete this.socket}}(a.SocketCommWrapper)}(interstate),function(a){"use strict";var b=a.cjs,c=a._,d=0,e={},f={};a.WrapperServer=function(a){this._id=d++,able.make_this_listenable(this),this.object=a.object,this.object.on("begin_destroy",this.on_begin_destroy,this),this.object.on("destroyed",this.destroy,this),this._type="none",this._event_type_listeners=a.listen_to||[],this.client_count=0,this.client_ids={},c.each(a.client_ids,function(a){this.add_client_id(a)},this),this.add_emission_listeners(),this.fn_call_constraints=new RedMap({hash:function(a){return a[0]},equals:function(a,b){var c,d=a.length;if(d!==b.length)return!1;for(c=0;d>c;c+=1)if(!i(a[c],b[c]))return!1;return!0}})},function(d){var g=d.prototype;able.make_proto_listenable(g),g.id=function(){return this._id},g.add_client_id=function(a){this.client_ids.hasOwnProperty(a)||(this.client_ids[a]=e,this.client_count++)},g.remove_client_id=function(a){this.client_ids.hasOwnProperty(a)&&(delete this.client_ids[a],this.client_count--)},g.has_clients=function(){return this.client_count>0},g.add_emission_listeners=function(){var a=this.get_object();c.each(this._event_type_listeners,function(b){a.on(b,this.on_emit,this)},this)},g.remove_emission_listeners=function(){var a=this.get_object();c.each(this._event_type_listeners,function(b){a.off(b,this.on_emit,this)},this)},g.client_paused=function(a){this.client_ids.hasOwnProperty(a)&&(this.client_ids[a]=f)},g.client_resumed=function(a){this.client_ids.hasOwnProperty(a)&&(this.client_ids[a]=e)},g.on_begin_destroy=function(){this._emit("begin_destroy"),this.object.off("begin_destroy",this.on_begin_destroy,this),this.remove_emission_listeners(),this.clear_fn_call_constraints()},g.clear_fn_call_constraints=function(){this.fn_call_constraints.each(function(a,b){var c=a.constraint;c.destroy(),this.fn_call_constraints.remove(b)},this)},g.destroy=function(){this._emit("destroy"),this.object.destroyed||(this.object.off("begin_destroy",this.on_begin_destroy,this),this.object.off("destroyed",this.destroy,this),this.remove_emission_listeners()),this.clear_fn_call_constraints(),this.fn_call_constraints.destroy(),delete this.fn_call_constraints,able.destroy_this_listenable(this)},g.type=function(){return this._type},g.get_object=function(){return this.object},g.on_emit=function(){this.remote_emit.apply(this,arguments)},g.remote_emit=function(){var b=c.last(arguments),d=c.first(arguments,arguments.length-1);d=c.map(d,a.summarize_value_for_comm_wrapper),this._emit("emit",{event_type:b,args:d})},g.client_destroyed=function(a,b){var c=h(a),d=this.fn_call_constraints.get(c);d&&d.clients.hasOwnProperty(b)&&(delete d.clients[b],d.client_count--,d.client_count<=0&&(d.constraint.destroy(),this.fn_call_constraints.remove(c)))},g.request=function(d,f,g,h){var i=d,j=i[0],k=c.rest(i),l=this.get_object();if(g){var m=!0,n=this.fn_call_constraints.get_or_put(i,function(){var a=new b.Constraint(function(){var a=l[j].apply(l,k);return a}),d=c.bind(function(){this._emit("changed",i)},this);a.onChange(d);var f=a.destroy;a.destroy=function(){a.offChange(d),f.call(a,!0)},m=!1;var g={};return g[h]=e,{constraint:a,client_count:1,clients:g}},this);m&&(n.clients.hasOwnProperty(h)||(n.clients[h]=e,n.client_count++));var o=n.constraint;f(a.summarize_value_for_comm_wrapper(o.get()))}else{var p=l[j].apply(l,k);f(a.summarize_value_for_comm_wrapper(p))}}}(a.WrapperServer);var g=function(a){return a},h=function(a){return c.map(a,g)},i=function(a,b){return a===b}}(interstate),function(a){"use strict";var b=a.cjs,c=a._,d=function(a){return a},e=function(a){return c.map(a,d)},f=function(a,b){return a===b},g=0,h=0;a.WrapperClient=function(a){able.make_this_listenable(this),this.paused=!1,this.semaphore=0,this.comm_mechanism=a.comm_mechanism,this.cobj_id=a.cobj_id,this.obj_id=a.obj_id,this._type=a.type,this.object_summary=a.object_summary,this.colloquial_name=this.object_summary.colloquial_name,this.program_state_client=a.program_state_client,this._id=g,g+=1,this.fn_call_constraints=new RedMap({hash:function(a){return a[0]},equals:function(a,b){var c,d=a.length;if(d!==b.length)return!1;for(c=0;d>c;c+=1)if(!f(a[c],b[c]))return!1;return!0}})},function(d){var f=d.prototype;able.make_proto_listenable(f),f.on_ready=function(){this.post({type:"register_listener",cobj_id:this.cobj_id})},f.signal_interest=function(){++this.semaphore>0&&this.resume()},f.signal_destroy=function(){--this.semaphore<=0&&this.pause()},f.pause=function(){this.paused||(this.paused=!0,this.post({type:"pause"}))},f.resume=function(){this.paused&&(this.paused=!1,this.post({type:"resume"}))},f.destroy=function(){this._emit("wc_destroy"),this.post({type:"destroy"}),this.fn_call_constraints.each(function(a,b){this.destroy_$(a,b)},this),this.fn_call_constraints.destroy(),delete this.fn_call_constraints,able.destroy_this_listenable(this),delete this.comm_mechanism,delete this.program_state_client,delete this.object_summary},f.post=function(a){var b=h;return h+=1,this.comm_mechanism.post({type:"wrapper_client",client_id:this.id(),message:a,message_id:b,cobj_id:this.cobj_id}),b},f.id=function(){return this._id},a.__debug&&(f.sid=function(){return parseInt(uid.strip_prefix(this.id()),10)}),f.type=function(){return this._type},f.async_get=function(){var a,b,d;c.isFunction(arguments[arguments.length-2])&&!c.isFunction(arguments[arguments.length-1])?(b=arguments[arguments.length-2],d=arguments[arguments.length-1],a=e(c.first(arguments,arguments.length-2))):(b=arguments[arguments.length-1],d=window,a=e(c.first(arguments,arguments.length-1)));var f=this.post({type:"async_get",getting:a});this.program_state_client.register_response_listener(f,c.bind(function(a){var c=this.process_value(a);b.call(d,c)},this))},f.destroy_$=function(a,b){a.request_ids;c.each(a.request_ids,function(a){this.program_state_client.deregister_response_listener(a)},this),delete a.request_ids,this.fn_call_constraints.remove(b),this.post({getting:b,type:"destroy_$"})},f.get_$=function(){var a=e(arguments),c=!1,d=this,f=this.fn_call_constraints.get_or_put(a,function(){var e=new b.Constraint,g=(e._id,e.destroy);e.destroy=function(){d.destroy_$(e,a),g.apply(e,arguments),d=e=f=null};var h=0;return e.signal_interest=function(){h++},e.signal_destroy=function(){--h<=0&&e.destroy()},e.request_ids={},c=!0,e});return f.signal_interest(),c&&this.update(a,f),f},f.update=function(a,b){if(b=b||this.fn_call_constraints.get(a),!b)return!1;var d=this.post({type:"get_$",getting:a});b.request_ids[d]=d,this.program_state_client.register_response_listener(d,c.bind(function(a){delete b.request_ids[d],b.set(this.process_value(a))},this))},f.on_change=function(){var a=e(arguments);this.update(a)},f.on_emit=function(a){var b=c.rest(arguments);b=this.process_value(b),this._emit.apply(this,[a].concat(b))},f.process_value=function(a){if(a&&a.__type__&&"summarized_obj"===a.__type__){var b,d,e=a.__value__;return"function"===e?"(native function)":"cjs_object"===e?"(native object)":"contextual_obj"===e?(b=a.object_summary,d=this.program_state_client.get_wrapper_client(b,this.comm_mechanism)):"state"===e?(b=a.object_summary,d=this.program_state_client.get_wrapper_client(b,this.comm_mechanism)):"transition"===e?(b=a.object_summary,d=this.program_state_client.get_wrapper_client(b,this.comm_mechanism)):"event"===e?(b=a.object_summary,d=this.program_state_client.get_wrapper_client(b,this.comm_mechanism)):"client_wrapper"===e?"(communication wrapper)":"constraint"===e?"(cjs constraint)":"dom_elem"===e?"(dom element)":e}if(c.isArray(a))return c.map(a,c.bind(this.process_value,this));if(c.isObject(a)){var f={};return c.each(a,function(a,b){f[b]=this.process_value(a)},this),f}return a}}(a.WrapperClient)}(interstate),function(a){"use strict";var b=a.cjs,c=a._,d={};a.create_remote_statechart=function(e,f){var g,h,i,j,k,l,m=e.cobj_id,n=a.find_uid(m),o=!1;if(n=!1,!n){if(e.signal_interest(),d.hasOwnProperty(m))n=d[m],f&&n.parent()!==f&&n.set_parent(f);else{var p=e.type();if("statechart"===p){n=d[m]=new a.Statechart({avoid_constructor:!0}),n.puppet_master_id=m;var q,r=c.Deferred(),s=[];e.async_get("get_substates",function(d){q=b.map({}),c.each(d,function(b,d){var e=a.create_remote_statechart(b,n);if(q.put(d,e),!e.is_constructed()){var f=c.Deferred();s.push(f.promise()),e.once("_constructed",function(){f.resolve()})}}),r.resolve()});var t,u=c.Deferred();e.async_get("get_start_state",function(b){if(t=a.create_remote_statechart(b,n),!t.is_constructed()){var d=c.Deferred();s.push(d.promise()),t.once("_constructed",function(){d.resolve()})}u.resolve()});var v,w=c.Deferred();e.async_get("get_outgoing_transitions",function(d){var e=c.map(d,function(b){var c=a.create_remote_transition(b);return c});v=b.array({value:e}),w.resolve()});var x,y=c.Deferred();e.async_get("get_incoming_transitions",function(d){var e=c.map(d,function(b){var c=a.create_remote_transition(b);return c});x=b.array({value:e}),y.resolve()});var z,A=c.Deferred();e.async_get("is_concurrent",function(a){z=a,A.resolve()}),g=c.Deferred(),e.async_get("is_active",function(a){h=a,g.resolve()}),i=c.Deferred(),e.async_get("is_running",function(a){j=a,i.resolve()}),k=[r.promise(),w.promise(),y.promise(),A.promise(),g.promise(),u.promise(),i.promise()],l={add_substate:function(b){var c=b.state_name,d=b.index,e=b.state,f=a.create_remote_statechart(e,n);n.add_substate(c,f,d)},remove_substate:function(a){var b=a.name;n.remove_substate(b,void 0,!1)},rename_substate:function(a){var b=a.from,c=a.to;n.rename_substate(b,c)},move_substate:function(a){var b=a.state_name,c=a.index;n.move_state(b,c)},make_concurrent:function(a){n.make_concurrent(a.concurrent)},destroy:function(){n.destroy()},add_transition:function(b){var c=b.transition,d=b.from_state,e=b.to_state,f=a.create_remote_statechart(d),g=a.create_remote_statechart(e),h=a.create_remote_transition(c);f._add_direct_outgoing_transition(h),g._add_direct_incoming_transition(h)},active:function(){n.set_active(!0)},inactive:function(){n.set_active(!1)},run:function(){n.run()},stop:function(){n.stop()}},c.when(k).done(function(){n.destroyed||c.when(s).done(function(){o||(a.Statechart.call(n,{substates:q,concurrent:z,outgoing_transitions:v,incoming_transitions:x,parent:f,start_state:t,active:h,puppet:!0,running:j}),e.on(l),f&&n._emit("_constructed"))})})}else{n=d[m]=new a.StartState({avoid_constructor:!0}),n.puppet_master_id=m;var B,C=c.Deferred();l={active:function(){n.set_active(!0)},inactive:function(){n.set_active(!1)},run:function(){n.run()},stop:function(){n.stop()}},e.async_get("get_outgoing_transition",function(b){B=a.create_remote_transition(b),B.is_initialized()?C.resolve():B.once("_constructed",function(){C.resolve()})}),g=c.Deferred(),e.async_get("is_active",function(a){h=a,g.resolve()}),i=c.Deferred(),e.async_get("is_running",function(a){j=a,i.resolve()}),k=[C.promise(),g.promise(),i.promise()],c.when(k).done(function(){n.destroyed||(a.StartState.call(n,{outgoing_transition:B,parent:f,active:h,puppet:!0,running:j}),n._emit("_constructed"),e.on(l))})}}var D=function(){o=!0,n.off("destroy",D),e.off(l),delete d[m]};n.on("destroy",D),f||e.on("wc_destroy",function(){n.destroyed||n.destroy()})}return n};var e={};a.create_remote_transition=function(b){var d,f=b.cobj_id,g=a.find_uid(f);g=!1;var h=!1;if(!g){if(b.signal_interest(),e.hasOwnProperty(f))g=e[f];else{g=e[f]=new a.StatechartTransition({avoid_constructor:!0}),g.puppet_master_id=f;var i,j=c.Deferred();b.async_get("from",function(b){i=a.create_remote_statechart(b),j.resolve()});var k,l=c.Deferred();b.async_get("to",function(b){k=a.create_remote_statechart(b),l.resolve()});var m,n=c.Deferred();b.async_get("event",function(b){m=a.create_remote_event(b),n.resolve()}),d={setTo:function(b){var c=b.state,d=a.create_remote_statechart(c);g.setTo(d)},setFrom:function(b){var c=b.state,d=a.create_remote_statechart(c);g.setFrom(d)},remove:function(){g.remove()},destroy:function(){g.destroy()},fire:function(a){var b=a.event;g.fire(b)}};var o=[j.promise(),l.promise(),n.promise()];c.when(o).done(function(){h||(a.StatechartTransition.call(g,{from:i,to:k,event:m,puppet:!0}),g._emit("_constructed"),b.on(d))})}var p=function(){b.off(d),g.off("destroy",p),b.signal_destroy(),delete e[f]};g.on("destroy",p)}return g};var f={};a.create_remote_event=function(c){var d,e=c.cobj_id,g=a.find_uid(e),h=!1;if(g=!1,!g){if(c.signal_interest(),f.hasOwnProperty(e))g=f[e],d={};else{var i=c.object_summary.event_type;if("statechart_event"===i)g=f[e]=new a.StatechartEvent({inert:!0});else if("parsed_event"===i){g=f[e]=new a.ParsedEvent({inert:!0});c.async_get("get_str",function(a){h||g.set_str(a)});var j=c.get_$("get_errors"),k=b.liven(function(){if(!h){var a=j.get();a&&a.length>0?(g.$errors.set(a),g._has_errors=!0):g._has_errors&&(g.$errors.set([]),g._has_errors=!1)}},{destroy:function(){j.signal_destroy(),j=null}});d={setString:function(a){var b=a.to;g.set_str(b)}},c.on(d)}}var l=function(){h=!0,k&&(k.destroy(),k=null),c.off(d),g.off("destroy",l),c.signal_destroy(),delete f[e]};g.on("destroy",l)}return g}}(interstate),function(a,b){"use strict";var c=a.cjs,d=a._;a.ProgramStateClient=function(a){if(able.make_this_listenable(this),this.comm_mechanism=a.comm_mechanism,this.wrapper_clients={},this.clients={},this.response_listeners={},this.pending_responses={},this.loaded=!1,a.ready_func===!0){var b=window.ready;window.ready=d.bind(function(){this.on_loaded(),window.ready=b},this)}else"complete"===window.document.readyState?d.defer(d.bind(this.on_loaded,this),this):window.addEventListener("load",d.bind(this.on_loaded,this));this.info_servers={},this.comm_mechanism.on("croot",this.on_croot,this).on("response",this.on_response,this).on("cobj_links",this.on_cobj_links,this).on("wrapper_server",this.on_wrapper_server,this).on("stringified_root",this.post_forward,this).on("get_ptr_response",this.post_forward,this).on("inspect",this.post_forward,this).on("stringified_obj",this.post_forward,this)},function(c){var e=c.prototype;able.make_proto_listenable(e),e.on_loaded=function(){this.loaded||(this.loaded=!0,this.add_message_listener(),this.post({type:"ready"}))},e.add_message_listener=function(){this.comm_mechanism.on("message",this.on_message,this)},e.remove_message_listener=function(){this.comm_mechanism.off("message",this.on_message,this)},e.disconnect=function(){this.destroy_every_client(),this.post({type:"disconnect"})},e.destroy_every_client=function(){d.each(this.clients,function(a,b){a.destroy(),delete this.clients[b]},this)},e.post_forward=function(a){this._emit(a.type,a)};var f={};e.on_croot=function(c){this.root_client&&this._emit("root_changed",c);{var e=c.summary;c.info_servers}e&&(this.root_client=this.get_wrapper_client(e),d.each(c.info_servers,function(b,c){this.info_servers[c]=new a.RemoteConstraintClient(b),this.info_servers[c].set_communication_mechanism(this.comm_mechanism)},this)),this._emit("loaded",this.root_client,this.info_servers),this.post({type:"loaded"}),this.clist=b("<div />").appendTo(this.element).component_list({info_servers:this.info_servers})},e.on_wrapper_server=function(a){if(this.clients){var b=a.server_message,c=b.client_id,d=b.type,e=this.clients[c];e&&("changed"===d?e.on_change.apply(e,b.getting):"emit"===d&&e.on_emit.apply(e,[b.event_type].concat(b.args)))}},e.on_response=function(a){var b=a.request_id,c=a.response;if(this.response_listeners.hasOwnProperty(b)){var d=this.response_listeners[b];d!==f&&d(c),delete this.response_listeners[b]}else this.pending_responses[b]=c},e.on_cobj_links=function(a){this._emit("cobj_links",a)},e.register_response_listener=function(a,b){this.pending_responses.hasOwnProperty(a)?(b(this.pending_responses[a]),delete this.pending_responses[a]):this.response_listeners[a]=b},e.deregister_response_listener=function(a){this.pending_responses.hasOwnProperty(a)&&delete this.pending_responses[a],this.response_listeners.hasOwnProperty(a)&&(this.response_listeners[a]=f)},e.get_wrapper_client=function(b){var c,e=b.id;if(this.wrapper_clients.hasOwnProperty(e))return c=this.wrapper_clients[e],c.object_summary=b,c;var f=b.type,g=b.obj_id;c=new a.WrapperClient({comm_mechanism:this.comm_mechanism,cobj_id:e,obj_id:g,type:f,object_summary:b,program_state_client:this});var h=c.id();this.clients[h]=c,this.wrapper_clients[e]=c,c.on_ready();var i=d.bind(function(){c.off("wc_destroy",i),this.destroy_wrapper_client(h,e)},this);return c.on("wc_destroy",i),c},e.destroy_wrapper_client=function(a,b){delete this.clients[a],delete this.wrapper_clients[b]},e.destroy=function(a){this.disconnect(),able.destroy_this_listenable(this),this.remove_message_listener(),this.destroy_every_client(),delete this.wrapper_clients,delete this.clients,delete this.root_client,a!==!1&&this.comm_mechanism&&(this.comm_mechanism.destroy(),delete this.comm_mechanism)},e.post=function(a,b){this.comm_mechanism.post(a,b)},e.post_command=function(b,c){var d;return d=["undo","redo","reset","export","upload","store"].indexOf(b)>=0?b:a.stringify(b),this.post({type:"command",command:d},c),d}}(a.ProgramStateClient),a.indirectClient=function(b){var e,f,g=c.get(b),h=g,i=d.rest(arguments),j=1!==i.length;if(g instanceof a.WrapperClient?(g.signal_interest(),e=!0):e=!1,j)f=c.map({keys:d.map(i,function(a){return d.isArray(a)?a[0]:a}),values:d.map(i,function(b){var c=d.isArray(b)?b:[b];return g instanceof a.WrapperClient?g.get_$.apply(g,c):!1})});else{var k=d.isArray(i[0])?i[0]:[i[0]];f=c.constraint(g instanceof a.WrapperClient?g.get_$.apply(g,k):!1)}var l=function(){h=g;var k=h instanceof a.WrapperClient;if(g=c.get(b),e=g instanceof a.WrapperClient,j)d.each(i,function(b){if(g instanceof a.WrapperClient){var c=d.isArray(b)?b:[b];f.put(c[0],g.get_$.apply(g,c)),f.do_debug&&console.log(b,c)}else f.remove(b)});else if(g instanceof a.WrapperClient){var l=d.isArray(i[0])?i[0]:[i[0]];f.set(g.get_$.apply(g,l))}else f.set(!1);e&&!k?g.signal_interest():k&&!e?h.signal_destroy():k&&e&&h!==g&&(h.signal_destroy(),g.signal_interest())};c.isConstraint(b)&&b.onChange(l);var m=f.destroy;return f.destroy=function(){c.isConstraint(b)&&b.offChange(l),m.apply(f,arguments),g instanceof a.WrapperClient&&g.signal_destroy()},f}}(interstate,jQuery),function(a){"use strict";var b=a.cjs,c=a._;a.ProgramStateServer=function(c){able.make_this_listenable(this),this.root=c.root,this.root&&(this.contextual_root=a.find_or_put_contextual_obj(this.root)),this.command_stack=c.command_stack,this.connected=!1,this.wrapper_servers={},this.full_programs=a.getSavedProgramMap(),this.program_components=a.getSavedProgramMap("component"),this.$dirty_program=c.dirty_program,this.$programs=b(function(){return this.full_programs.keys()},{context:this}),this.$components=b(function(){return this.program_components.keys()},{context:this}),this.info_servers={programs:new a.RemoteConstraintServer(this.$programs),components:new a.RemoteConstraintServer(this.$components),loaded_program:new a.RemoteConstraintServer(a.loaded_program_name),undo_description:new a.RemoteConstraintServer(this.command_stack.$undo_description),redo_description:new a.RemoteConstraintServer(this.command_stack.$redo_description),dirty_program:new a.RemoteConstraintServer(this.$dirty_program)}},function(b){var d=b.prototype;able.make_proto_listenable(d),d.add_message_listeners=function(){this.comm_mechanism.on("ready",this.on_ready,this).on("loaded",this.on_loaded,this).on("message",this.on_message,this).on("disconnect",this.on_disconnect,this).on("command",this.on_command,this).on("wrapper_client",this.on_wrapper_client,this).on("remove_storage",this.on_remove_storage,this).on("save_curr",this.post_forward,this).on("save_curr_as",this.post_forward,this).on("create_program",this.post_forward,this).on("download_program",this.download_program,this).on("upload_program",this.download_program,this).on("load_program",this.load_program,this).on("stringified_root",this.post_forward,this).on("load_file",this.post_forward,this).on("save_component",this.post_forward,this).on("copy_component",this.post_forward,this).on("rename_program",this.post_forward,this).on("add_highlight",this.post_forward,this).on("remove_highlight",this.post_forward,this).on("get_ptr",this.get_ptr,this)
},d.remove_message_listeners=function(){this.comm_mechanism&&this.comm_mechanism.off("ready",this.on_ready,this).off("loaded",this.on_loaded,this).off("message",this.on_message,this).off("disconnect",this.on_disconnect,this).off("command",this.on_command,this).off("wrapper_client",this.on_wrapper_client,this).off("remove_storage",this.on_remove_storage,this).off("save_curr",this.post_forward,this).off("save_curr_as",this.post_forward,this).off("create_program",this.post_forward,this).off("download_program",this.download_program,this).off("upload_program",this.download_program,this).off("load_program",this.load_program,this).off("stringified_root",this.post_forward,this).off("load_file",this.post_forward,this).off("save_component",this.post_forward,this).off("copy_component",this.post_forward,this).off("rename_program",this.post_forward,this).off("get_ptr",this.get_ptr,this)},d.post_forward=function(a){this._emit(a.type,a)},d.on_remove_storage=function(b){a.rm(b.name,"component"===b.storage_type?"component":"")},d.on_save_curr=function(b){a.save(this.root,b.name,"component"===b.storage_type?"component":"")},d.get_ptr=function(b){var d=b.cobj_id,e=a.find_uid(d);if(e){var f=e.get_pointer();this.post({type:"get_ptr_response",cobj_id:d,cobjs:c.map(f.getContextualObjects(),function(a){return a.summarize()})})}},d.download_program=function(a){this._emit("download_program",a.name,"component"===a.storage_type?"component":"")},d.upload_program=function(a){console.log("upload",a)},d.load_program=function(a){this._emit("load_program",a.name)},d.set_communication_mechanism=function(a){this.comm_mechanism&&(this.remove_message_listeners(),delete this.comm_mechanism),this.comm_mechanism=a,this.add_message_listeners(),c.each(this.info_servers,function(b){b.set_communication_mechanism(a)})},d.set_root=function(b){this.destroy_every_wrapper_server(),this.root=b,this.contextual_root=a.find_or_put_contextual_obj(this.root),this.send_info()},d.send_info=function(){var a=this.contextual_root?this.contextual_root.summarize():null,b={};c.each(this.info_servers,function(a,c){b[c]=a.id()}),this.post({type:"croot",summary:a,info_servers:b})},d.on_ready=function(){this.connected=!0,this.send_info()},d.on_loaded=function(){this._emit("connected")},d.on_disconnect=function(){c.each(this.wrapper_servers,function(a,b){a.has_clients()||(a.destroy(),delete this.wrapper_servers[b])},this),this.cleanup_closed_client(),this._emit("disconnected")},d.on_command=function(b){var c=b.command;if(["undo","redo","reset","export","upload","store"].indexOf(c)>=0)this._emit("command",c);else{var d=a.destringify(c);this._emit("command",d)}},d.on_wrapper_client=function(b){var d,e,f,g,h,i=b.message,j=i.type;if("register_listener"===j)e=i.cobj_id,h=a.find_uid(e),f=b.client_id,g=this.get_wrapper_server(h,f),g.on("emit",c.bind(function(a){var b={type:"wrapper_server",server_message:c.extend({type:"emit",client_id:f},a)};this.post(b)},this)).on("changed",c.bind(function(a){var b={type:"wrapper_server",server_message:{type:"changed",cobj_id:e,getting:a,client_id:f}};this.post(b)},this));else if("get_$"===j||"async_get"===j){e=b.cobj_id,h=a.find_uid(e),f=b.client_id;var k=b.message_id;if(h){g=this.get_wrapper_server(h,f);var l="get_$"===i.type;g.request(i.getting,c.bind(function(a){this.post({type:"response",request_id:k,client_id:f,response:a})},this),l,f)}else this.post({type:"response",request_id:k,client_id:f,error:"cobj_destroyed"})}else"destroy_$"===j?(e=b.cobj_id,f=b.client_id,this.wrapper_servers.hasOwnProperty(e)&&(d=this.wrapper_servers[e],d.client_destroyed(i.getting,f))):"destroy"===j?(e=b.cobj_id,f=b.client_id,this.wrapper_servers.hasOwnProperty(e)&&(d=this.wrapper_servers[e],d.remove_client_id(f),d.has_clients()||(d.destroy(),delete this.wrapper_servers[e]))):"pause"===j?(e=b.cobj_id,f=b.client_id,this.wrapper_servers.hasOwnProperty(e)&&(d=this.wrapper_servers[e],d.client_paused(e))):"resume"===j&&this.wrapper_servers.hasOwnProperty(e)&&(d=this.wrapper_servers[e],d.client_resumed(e))},d.get_wrapper_server=function(b,c){var d,e=b.id();if(this.wrapper_servers.hasOwnProperty(e))return d=this.wrapper_servers[e],d.add_client_id(c),d;var f;return f=b instanceof a.State?["add_transition","add_substate","remove_substate","rename_substate","move_substate","make_concurrent","destroy","active","inactive","run","stop"]:b instanceof a.StatechartTransition?["setTo","setFrom","remove","destroy","fire","enable","disable"]:b instanceof a.ParsedEvent?["setString"]:["destroy","begin_destroy"],d=new a.WrapperServer({object:b,listen_to:f,client_ids:[c]}),d.on("destroy",this.wrapper_server_destroyed,this,d,e),this.wrapper_servers[e]=d,d},d.wrapper_server_destroyed=function(a,b){a.off("destroy",this.wrapper_server_destroyed),delete this.wrapper_servers[b]},d.post=function(a){if(!this.connected)throw new Error("Trying to send a message to a disconnected client");this.comm_mechanism.post(a)},d.is_connected=function(){return this.connected},d.cleanup_closed_client=function(){this.connected=!1},d.destroy_every_wrapper_server=function(){c.each(this.wrapper_servers,function(a,b){a.destroy(),delete this.wrapper_servers[b]},this)},d.destroy=function(a){this.cleanup_closed_client(),able.destroy_this_listenable(this),this.remove_message_listeners(),this.destroy_every_wrapper_server(),c.each(this.info_servers,function(a){a.destroy()}),this.$programs.destroy(),this.$components.destroy(),delete this.$programs._options,delete this.$components._options,delete this.wrapper_servers,delete this.root,delete this.contextual_root,delete this.command_stack,a!==!1&&this.comm_mechanism&&(this.comm_mechanism.destroy(),delete this.comm_mechanism)}}(a.ProgramStateServer)}(interstate,jQuery),function(a){"use strict";a.cjs,a._;a.Command=function(a){this._in_effect=a&&a.in_effect===!0,this._undoable=!0},function(a){var b=a.prototype;b.is_undoable=function(){return this._undoable},b._do=function(){this._in_effect=!0,this._execute()},b._undo=function(){this._in_effect=!1,this._unexecute()},b.destroy=function(){this._do_destroy(this.in_effect())},b.in_effect=function(){return this._in_effect},b._execute=function(){},b._unexecute=function(){},b._do_destroy=function(){},b.to_undo_string=function(){return"Undo"},b.to_redo_string=function(){return"Redo"}}(a.Command)}(interstate),function(a){"use strict";var b=(a.cjs,a._);a.SetPropCommand=function(c){if(a.SetPropCommand.superclass.constructor.apply(this,arguments),this._options=c||{},!this._options.parent||!this._options.value)throw new Error("Must select a parent object");if(this._parent=this._options.parent,!this._options.name&&this._parent instanceof a.Dict){var d=this._parent,e=d._get_direct_prop_names(),f="prop";this._options.value instanceof a.Dict&&(f="obj");for(var g=f+"_"+e.length,h=g,i=0;b.indexOf(e,h)>=0;)h=g+"_"+i,i+=1;this._prop_name=h}else this._prop_name=this._options.name;this._prop_value=this._options.value,this._prop_index=this._options.index},function(c){b.proto_extend(c,a.Command);var d=c.prototype;d._execute=function(){var a;b.isNumber(this._prop_index)&&(a=this._prop_index),this._old_prop_value=this._parent._get_direct_prop(this._prop_name),this._parent.set_prop(this._prop_name,this._prop_value,{index:a})},d._unexecute=function(){b.isUndefined(this._old_prop_value)?this._parent.unset_prop(this._prop_name):this._parent.set_prop(this._prop_name,this._old_prop_value)},d._do_destroy=function(a){c.superclass._do_destroy.apply(this,arguments),a?this._old_prop_value&&this._old_prop_value.destroy&&this._old_prop_value.destroy(!0):this._prop_value&&this._prop_value.destroy&&this._prop_value.destroy(!0),delete this._parent,delete this._options,delete this._old_prop_value,delete this._prop_value,delete this._prop_name},a.register_serializable_type("set_prop_command",function(a){return a instanceof c},function(){var c=b.toArray(arguments);return{parent_uid:this._parent.id(),name:this._prop_name,value:a.serialize.apply(a,[this._prop_value].concat(c)),index:this._prop_index}},function(b){return new c({parent:a.find_uid(b.parent_uid),name:b.name,value:a.deserialize(b.value),index:b.index})}),d.to_undo_string=function(){return"remove '"+this._prop_name+"'"},d.to_redo_string=function(){return"add '"+this._prop_name+"'"}}(a.SetPropCommand),a.InheritPropCommand=function(b){if(a.InheritPropCommand.superclass.constructor.apply(this,arguments),this._options=b||{},!this._options.cobj||!this._options.name)throw new Error("Must select a parent object");this._cobj=this._options.cobj,this._prop_name=this._options.name},function(c){b.proto_extend(c,a.Command);var d=c.prototype;d._execute=function(){var b=this._cobj.get_pointer(),c=b.pop(),d=a.find_or_put_contextual_obj(c.points_at(),c),e=d.get_object();if(!this._prop_value&&d instanceof a.ContextualStatefulObj){var f=this._cobj.get_object();if(f instanceof a.Cell){var g=d.get_own_statechart(),h=g.get_start_state();this._prop_value=new a.StatefulProp,this._prop_value.set(h,f.clone())}else this._prop_value=f instanceof a.StatefulProp?f.clone(this._cobj):f instanceof a.Dict?f.clone():f}e.set_prop(this._prop_name,this._prop_value)},d._unexecute=function(){var a=this._parent.get_object();a.unset_prop(this._prop_name)},d._do_destroy=function(a){c.superclass._do_destroy.apply(this,arguments),a?this._old_prop_value&&this._old_prop_value.destroy(!0):(this._prop_value&&this._prop_value.destroy&&this._prop_value.destroy(!0),this._value&&this._value.destroy&&this._value.destroy(!0)),delete this._parent,delete this._prop_name,delete this._value,delete this._options},a.register_serializable_type("inherit_prop_command",function(a){return a instanceof c},function(){b.toArray(arguments);return{cobj_uid:this._cobj.id(),name:this._prop_name}},function(b){return new c({cobj:a.find_uid(b.cobj_uid),name:b.name})})}(a.InheritPropCommand),a.UnsetPropCommand=function(b){if(a.UnsetPropCommand.superclass.constructor.apply(this,arguments),this._options=b||{},!this._options.parent)throw new Error("Must select a parent object");this._parent=this._options.parent,this._prop_name=this._options.name},function(c){b.proto_extend(c,a.Command);var d=c.prototype;d._execute=function(){this._prop_index=this._parent.prop_index(this._prop_name),this._has_direct_prop=this._parent._has_direct_prop(this._prop_name),this._has_direct_prop&&(this._prop_value=this._parent._get_direct_prop(this._prop_name)),this._parent.unset_prop(this._prop_name)},d._unexecute=function(){this._has_direct_prop&&this._parent.set_prop(this._prop_name,this._prop_value,{index:this._prop_index})},d._do_destroy=function(a){c.superclass._do_destroy.apply(this,arguments),a&&this._prop_value&&this._prop_value.destroy&&this._prop_value.destroy(!0),delete this._options,delete this._parent,delete this._prop_name,delete this._prop_value,delete this._prop_index,delete this._old_prop_value},a.register_serializable_type("unset_prop_command",function(a){return a instanceof c},function(){return{parent_uid:this._parent.id(),name:this._prop_name}},function(b){return new c({parent:a.find_uid(b.parent_uid),name:b.name})})}(a.UnsetPropCommand),a.RenamePropCommand=function(b){if(a.RenamePropCommand.superclass.constructor.apply(this,arguments),this._options=b||{},!this._options.parent||!this._options.from||!this._options.to)throw new Error("Must select a parent object");this._parent=this._options.parent,this._from_name=this._options.from,this._to_name=this._options.to},function(c){b.proto_extend(c,a.Command);var d=c.prototype;d._execute=function(){this._parent.rename(this._from_name,this._to_name)},d._unexecute=function(){this._parent.rename(this._to_name,this._from_name)},d._do_destroy=function(){c.superclass._do_destroy.apply(this,arguments),delete this._options,delete this._parent,delete this._from_name,delete this._to_name},a.register_serializable_type("rename_prop_command",function(a){return a instanceof c},function(){return{parent_uid:this._parent.id(),from_name:this._from_name,to_name:this._to_name}},function(b){return new c({parent:a.find_uid(b.parent_uid),from:b.from_name,to:b.to_name})})}(a.RenamePropCommand),a.MovePropCommand=function(b){if(a.MovePropCommand.superclass.constructor.apply(this,arguments),this._options=b||{},!this._options.parent)throw new Error("Must select a parent object");this._parent=this._options.parent,this._prop_name=this._options.name,this._to_index=this._options.to},function(c){b.proto_extend(c,a.Command);var d=c.prototype;d._execute=function(){this._from_index=this._parent.prop_index(this._prop_name),this._parent.move_prop(this._prop_name,this._to_index)},d._unexecute=function(){this._parent.move_prop(this._prop_name,this._from_index)},d._do_destroy=function(){c.superclass._do_destroy.apply(this,arguments),delete this._parent,delete this._prop_name,delete this._to_index,delete this._options},a.register_serializable_type("move_prop_command",function(a){return a instanceof c},function(){return{parent_uid:this._parent.id(),name:this._prop_name,to:this._to_index}},function(b){return new c({parent:a.find_uid(b.parent_uid),name:b.name,to:b.to})})}(a.MovePropCommand),a.SetStatefulPropValueCommand=function(b){if(a.SetStatefulPropValueCommand.superclass.constructor.apply(this,arguments),this._options=b||{},!this._options.stateful_prop||!this._options.state||!this._options.value)throw new Error("Must select a stateful_prop object");this._stateful_prop=this._options.stateful_prop,this._state=this._options.state,this._value=this._options.value},function(c){b.proto_extend(c,a.Command);var d=c.prototype;d._execute=function(){this._old_value=this._stateful_prop._direct_value_for_state(this._state),this._stateful_prop.set(this._state,this._value)},d._unexecute=function(){this._old_value?this._stateful_prop.set(this._state,this._old_value):this._stateful_prop.unset(this._state)},d._do_destroy=function(a){c.superclass._do_destroy.apply(this,arguments),a?this._old_value&&this._old_value.destroy&&this._old_value.destroy(!0):this._value&&this._value.destroy&&this._value.destroy(!0),delete this._options,delete this._stateful_prop,delete this._state,delete this._value,delete this._old_value},a.register_serializable_type("set_stateful_prop_value_command",function(a){return a instanceof c},function(){var c=b.toArray(arguments);return{stateful_prop_uid:this._stateful_prop.id(),state_uid:this._state.id(),value:a.serialize.apply(a,[this._value].concat(c))}},function(b){return new c({stateful_prop:a.find_uid(b.stateful_prop_uid),state:a.find_uid(b.state_uid),value:a.deserialize(b.value)})})}(a.SetStatefulPropValueCommand),a.UnsetStatefulPropValueCommand=function(b){if(a.UnsetStatefulPropValueCommand.superclass.constructor.apply(this,arguments),this._options=b||{},!this._options.stateful_prop)throw new Error("Must select a stateful_prop object");this._stateful_prop=this._options.stateful_prop,this._state=this._options.state},function(c){b.proto_extend(c,a.Command);var d=c.prototype;d._execute=function(){this._value=this._stateful_prop._direct_value_for_state(this._state),this._stateful_prop.unset(this._state)},d._unexecute=function(){this._stateful_prop.set(this._state,this._value)},d._do_destroy=function(a){c.superclass._do_destroy.apply(this,arguments),a&&this._value&&this._value.destroy&&this._value.destroy(!0),delete this._options,delete this._stateful_prop,delete this._state,delete this._value},a.register_serializable_type("unset_stateful_prop_value_command",function(a){return a instanceof c},function(){return{parent_uid:this._stateful_prop.id(),state_uid:this._state.id()}},function(b){return new c({stateful_prop:a.find_uid(b.parent_uid),state:a.find_uid(b.state_uid)})})}(a.UnsetStatefulPropValueCommand),a.SetBuiltinCommand=function(b){if(a.SetBuiltinCommand.superclass.constructor.apply(this,arguments),this._options=b||{},!this._options.parent)throw new Error("Must select a parent object");this._parent=this._options.parent,this._builtin_name=this._options.name,this._value=this._options.value},function(c){b.proto_extend(c,a.Command);var d=c.prototype;d._execute=function(){var a,b=this._parent.get_builtins();for(a in b)if(b.hasOwnProperty(a)){var c=b[a],d=c._get_env_name();if(this._builtin_name===d){var e=c._get_getter_name(),f=c._get_setter_name();this._old_value=this._parent[e](),this._parent[f](this._value);break}}},d._unexecute=function(){var a,b=this._parent.get_builtins();for(a in b)if(b.hasOwnProperty(a)){var c=b[a],d=c._get_env_name();if(this._builtin_name===d){var e=c._get_setter_name();this._parent[e](this._old_value);break}}},d._do_destroy=function(a){c.superclass._do_destroy.apply(this,arguments),a?this._old_value&&this._old_value.destroy&&this._old_value.destroy(!0):this._value&&this._value.destroy&&this._value.destroy(!0),delete this._options,delete this._parent,delete this._builtin_name,delete this._value},a.register_serializable_type("set_builtin_command",function(a){return a instanceof c},function(){var c=b.toArray(arguments);return{parent_uid:this._parent.id(),name:this._builtin_name,value:a.serialize.apply(a,[this._value].concat(c))}},function(b){return new c({parent:a.find_uid(b.parent_uid),name:b.name,value:a.deserialize(b.value)})})}(a.SetBuiltinCommand),a.SetCopiesCommand=function(c){if(a.SetCopiesCommand.superclass.constructor.apply(this,arguments),this._options=c||{},!this._options.parent)throw new Error("Must select a parent object");this._parent=this._options.parent,this._value=this._options.value,b.isString(this._value)&&(this._value=new a.Cell({str:this._value}))},function(c){b.proto_extend(c,a.Command);var d=c.prototype;d._execute=function(){this._parent.set_copies(this._value)},d._unexecute=function(){console.log("unset copies",this._value)},d._do_destroy=function(a){c.superclass._do_destroy.apply(this,arguments),delete this._parent,delete this._value},a.register_serializable_type("set_copies",function(a){return a instanceof c},function(){var c=b.toArray(arguments);return{parent_uid:this._parent.id(),value:a.serialize.apply(a,[this._value].concat(c))}},function(b){return new c({parent:a.find_uid(b.parent_uid),value:a.deserialize(b.value)})})}(a.SetCopiesCommand),a.ResetCommand=function(b){if(a.ResetCommand.superclass.constructor.apply(this,arguments),this._options=b||{},!this._options.parent)throw new Error("Must select a parent object");this._parent=this._options.parent,this._undoable=!1},function(c){b.proto_extend(c,a.Command);var d=c.prototype;d._execute=function(){this._parent.reset()},d._unexecute=function(){console.log("reset")},d._do_destroy=function(a){c.superclass._do_destroy.apply(this,arguments),delete this._options,delete this._parent},a.register_serializable_type("reset",function(a){return a instanceof c},function(){b.toArray(arguments);return{parent_uid:this._parent.id()}},function(b){return new c({parent:a.find_uid(b.parent_uid)})})}(a.ResetCommand),a.MovePropAboveBelowCommand=function(b){a.MovePropCommand.superclass.constructor.apply(this,arguments),this._options=b||{},this._from_obj=this._options.from_obj,this._from_name=this._options.from_name,this._target_obj=this._options.target_obj,this._target_name=this._options.target_name,this._above_below=this._options.above_below},function(c){b.proto_extend(c,a.Command);var d=c.prototype;d._execute=function(){if(b.isNumber(this._to_index)||(this._target_name?(this._to_index=this._target_obj.prop_index(this._target_name),"below"===this._above_below&&this._to_index++):this._to_index=0,this._from_index=this._from_obj.prop_index(this._from_name),this._from_obj===this._target_obj&&this._from_index<this._to_index&&this._to_index--),this._from_obj===this._target_obj)this._from_obj.move_prop(this._from_name,this._to_index);else{var a=this._from_obj._get_direct_prop(this._from_name);this._from_obj.unset_prop(this._from_name),this._target_obj.set_prop(this._from_name,a,this._to_index)}},d._unexecute=function(){if(this._from_obj===this._target_obj)this._from_obj.move_prop(this._from_name,this._from_index);else{var a=this._target_obj._get_direct_prop(this._from_name);this._target_obj.unset_prop(this._from_name),this._from_obj.set_prop(this._from_name,a,this._to_index)}},d._do_destroy=function(){c.superclass._do_destroy.apply(this,arguments),delete this._options,delete this._from_obj,delete this._from_name,delete this._target_obj,delete this._target_name,delete this._above_below},a.register_serializable_type("move_prop_above_below_command",function(a){return a instanceof c},function(){return{from_obj:this._from_obj.id(),target_obj:this._target_obj.id(),from_name:this._from_name,target_name:this._target_name,above_below:this._above_below}},function(b){return new c({from_obj:a.find_uid(b.from_obj),target_obj:a.find_uid(b.target_obj),from_name:b.from_name,target_name:b.target_name,above_below:b.above_below})})}(a.MovePropAboveBelowCommand)}(interstate),function(a){"use strict";var b=(a.cjs,a._);a.ChangeCellCommand=function(c){if(a.ChangeCellCommand.superclass.constructor.apply(this,arguments),this._options=c||{},!this._options.cell||!b.isString(this._options.str))throw new Error("Must select a cell");this._cell=this._options.cell,this._cell instanceof a.ContextualCell&&(this._cell=this._cell.get_object()),this._to_str=this._options.str},function(c){b.proto_extend(c,a.Command);var d=c.prototype;d._execute=function(){this._from_str=this._cell.get_str(),this._cell.set_str(this._to_str),this._cell.is_substantiated()||this._cell.substantiate()},d._unexecute=function(){this._cell.set_str(this._from_str)},a.register_serializable_type("change_cell_command",function(a){return a instanceof c},function(){return{cell_uid:this._cell.id(),str:this._to_str}},function(b){return new c({cell:a.find_uid(b.cell_uid),str:b.str})}),d.to_undo_string=function(){return"change cell back to '"+this._from_str+"'"},d.to_redo_string=function(){return"change cell to '"+this._to_str+"'"},d._do_destroy=function(){c.superclass._do_destroy.apply(this,arguments),delete this._options,delete this._cell,delete this._from_str,delete this._to_str}}(a.ChangeCellCommand)}(interstate),function(a){"use strict";var b=(a.cjs,a._);a.AddStateCommand=function(b){if(a.AddStateCommand.superclass.constructor.apply(this,arguments),this._options=b||{},!this._options.statechart)throw new Error("Must select a statechart");this._statechart=this._options.statechart,this._state_name=this._options.name,this._options.state&&(this._state=this._options.state),this._index=this._options.index,this._make_start=this._options.make_start,this._statechart.basis&&this._statechart.basis()&&(this._statechart=this._statechart.basis())},function(c){b.proto_extend(c,a.Command);var d=c.prototype;d._execute=function(){b.has(this,"_state")?this._statechart.add_state(this._state_name,this._state,this._index):(this._statechart.add_state(this._state_name,"statechart",this._index),this._state=this._statechart.find_state(this._state_name)),this._make_start&&this._statechart.starts_at(this._state)},d._unexecute=function(){this._statechart.remove_state(this._state_name,!1)},d._do_destroy=function(a){c.superclass._do_destroy.apply(this,arguments),a||this._state.destroy(),delete this._options,delete this._statechart,delete this._state_name,delete this._state,delete this._index,delete this._make_start},a.register_serializable_type("add_state_command",function(a){return a instanceof c},function(){var c=b.toArray(arguments);return{statechart:this._statechart.id(),name:this._state_name,index:this._index,state:a.serialize.apply(a,[this._state].concat(c)),make_start:this._make_start}},function(b){return new c({statechart:a.find_uid(b.statechart),name:b.name,index:b.index,state:a.deserialize(b.state),make_start:b.make_start})})}(a.AddStateCommand),a.RemoveStateCommand=function(b){if(a.RemoveStateCommand.superclass.constructor.apply(this,arguments),this._options=b||{},!this._options.statechart)throw new Error("Must select a statechart");this._statechart=this._options.statechart,this._state_name=this._options.name,this._statechart.basis&&this._statechart.basis()&&(this._statechart=this._statechart.basis())},function(c){b.proto_extend(c,a.Command);var d=c.prototype;d._execute=function(){this._index=this._statechart.get_state_index(this._state_name),this._state=this._statechart.find_state(this._state_name);var a=new RedSet({hash:"hash"}),b=this._state.get_incoming_transitions(),c=this._state.get_outgoing_transitions();a.add.apply(a,b),a.add.apply(a,c),this._transitions=a.toArray(),this._statechart.remove_state(this._state_name,!1)},d._unexecute=function(){this._statechart.add_state(this._state_name,this._state,this._index);var a=this;b.forEach(this._transitions,function(b){a._statechart.add_transition(b)})},d._do_destroy=function(a){c.superclass._do_destroy.apply(this,arguments),a&&(this._statechart&&this._statechart.destroy&&this._statechart.destroy(),b.forEach(this._transitions,function(a){a.destroy()})),delete this._options,delete this._statechart,delete this._state_name},a.register_serializable_type("remove_state_command",function(a){return a instanceof c},function(){return{statechart:this._statechart.id(),name:this._state_name}},function(b){return new c({statechart:a.find_uid(b.statechart),name:b.name})})}(a.RemoveStateCommand),a.MoveStateCommand=function(b){if(a.MoveStateCommand.superclass.constructor.apply(this,arguments),this._options=b||{},!this._options.statechart)throw new Error("Must select a statechart");this._statechart=this._options.statechart,this._state_name=this._options.name,this._to_index=this._options.index},function(c){b.proto_extend(c,a.Command);var d=c.prototype;d._execute=function(){this._from_index=this._statechart.get_substate_index(this._state_name),this._statechart.move_state(this._state_name,this._to_index)},d._unexecute=function(){this._statechart.move_state(this._state_name,this._from_index)},d._do_destroy=function(){c.superclass._do_destroy.apply(this,arguments)},a.register_serializable_type("move_state_command",function(a){return a instanceof c},function(){return{statechart:this._statechart.id(),name:this._state_name,index:this._to_index}},function(b){return new c({statechart:a.find_uid(b.statechart),name:b.name,index:b.index})})}(a.MoveStateCommand),a.RenameStateCommand=function(b){if(a.RenameStateCommand.superclass.constructor.apply(this,arguments),this._options=b||{},!this._options.statechart)throw new Error("Must select a statechart");this._statechart=this._options.statechart,this._from_state_name=this._options.from,this._to_state_name=this._options.to,this._statechart.basis&&this._statechart.basis()&&(this._statechart=this._statechart.basis())},function(c){b.proto_extend(c,a.Command);var d=c.prototype;d._execute=function(){this._statechart.rename_state(this._from_state_name,this._to_state_name)},d._unexecute=function(){this._statechart.rename_state(this._to_state_name,this._from_state_name)},d._do_destroy=function(){c.superclass._do_destroy.apply(this,arguments)},a.register_serializable_type("rename_state_command",function(a){return a instanceof c},function(){return{statechart:this._statechart.id(),from:this._from_state_name,to:this._to_state_name}},function(b){return new c({statechart:a.find_uid(b.statechart),from:b.from,to:b.to})})}(a.RenameStateCommand),a.MakeConcurrentCommand=function(b){if(a.MakeConcurrentCommand.superclass.constructor.apply(this,arguments),this._options=b||{},!this._options.statechart)throw new Error("Must select a statechart");this._statechart=this._options.statechart,this._concurrent=!!this._options.concurrent,this._statechart.basis&&this._statechart.basis()&&(this._statechart=this._statechart.basis())},function(c){b.proto_extend(c,a.Command);var d=c.prototype;d._execute=function(){this._statechart.make_concurrent(this._concurrent)},d._unexecute=function(){this._statechart.make_concurrent(!this._concurrent)},d._do_destroy=function(){c.superclass._do_destroy.apply(this,arguments)},a.register_serializable_type("make_concurrent_command",function(a){return a instanceof c},function(){return{statechart:this._statechart.id(),concurrent:this._concurrent}},function(b){return new c({statechart:a.find_uid(b.statechart),concurrent:b.concurrent})})}(a.MakeConcurrentCommand),a.AddTransitionCommand=function(b){if(a.AddTransitionCommand.superclass.constructor.apply(this,arguments),this._options=b||{},!this._options.from||!this._options.to||!this._options.statechart)throw new Error("Must specify statechart, from, and to");this._options.transition&&(this._transition=this._options.transition),this._statechart=this._options.statechart,this._from_state=this._options.from,this._to_state=this._options.to,this._event=this._options.event,this._statechart.basis&&this._statechart.basis()&&(this._statechart=this._statechart.basis()),this._from_state.basis&&this._from_state.basis()&&(this._from_state=this._from_state.basis()),this._to_state.basis&&this._to_state.basis()&&(this._to_state=this._to_state.basis())},function(c){b.proto_extend(c,a.Command);var d=c.prototype;d._execute=function(){b.has(this,"_transition")?this._statechart.add_transition(this._transition):(this._statechart.add_transition(this._from_state,this._to_state,this._event),this._transition=this._statechart._last_transition)},d._unexecute=function(){this._transition.remove(!1)},d._do_destroy=function(a){c.superclass._do_destroy.apply(this,arguments),a||this._transition.destroy()},a.register_serializable_type("add_transition_command",function(a){return a instanceof c},function(){var c=b.toArray(arguments);return{statechart_id:this._statechart.id(),from_id:this._from_state.id(),to_id:this._to_state.id(),event:a.serialize.apply(a,[this._event].concat(c)),transition:a.serialize.apply(a,[this._transition].concat(c))}},function(b){return new c({statechart:a.find_uid(b.statechart_id),from:a.find_uid(b.from_id),to:a.find_uid(b.to_id),event:a.deserialize(b.event),transition:a.deserialize(b.transition)})})}(a.AddTransitionCommand),a.RemoveTransitionCommand=function(b){if(a.RemoveTransitionCommand.superclass.constructor.apply(this,arguments),this._options=b||{},!this._options.statechart)throw new Error("Must select a statechart");this._statechart=this._options.statechart,this._transition=this._options.transition||this._statechart.get_transition_by_id(this._options.id),this._statechart.basis&&this._statechart.basis()&&(this._statechart=this._statechart.basis()),this._transition.basis&&this._transition.basis()&&(this._transition=this._transition.basis())},function(c){b.proto_extend(c,a.Command);var d=c.prototype;d._execute=function(){this._transition.remove(!1)},d._unexecute=function(){this._transition.from()._add_direct_outgoing_transition(this._transition),this._transition.to()._add_direct_incoming_transition(this._transition),this._statechart.add_transition(this._transition)},d._do_destroy=function(a){c.superclass._do_destroy.apply(this,arguments),a&&this._transition.destroy()},a.register_serializable_type("remove_transition_command",function(a){return a instanceof c},function(){b.toArray(arguments);return{statechart:this._statechart.id(),transition:this._transition.id()}},function(b){return new c({statechart:a.find_uid(b.statechart),transition:a.find_uid(b.transition)})})}(a.RemoveTransitionCommand),a.SetTransitionEventCommand=function(b){if(a.SetTransitionEventCommand.superclass.constructor.apply(this,arguments),this._options=b||{},!this._options.transition)throw new Error("Must select a transition");this._event_str=this._options.event,this._transition=this._options.transition||this._options.statechart.get_transition_by_id(this.options.id),this._transition.basis&&this._transition.basis()&&(this._transition=this._transition.basis())},function(c){b.proto_extend(c,a.Command);var d=c.prototype;d._execute=function(){var a=this._transition.event();this._from_str=a.get_str(),a.set_str(this._event_str)},d._unexecute=function(){var a=this._transition.event();a.set_str(this._from_str)},d._do_destroy=function(){c.superclass._do_destroy.apply(this,arguments)},a.register_serializable_type("set_transition_event_command",function(a){return a instanceof c},function(){b.toArray(arguments);return{transition_id:this._transition.id(),event_str:this._event_str}
},function(b){return new c({transition:a.find_uid(b.transition_id),event:b.event_str})})}(a.SetTransitionEventCommand),a.SetTransitionFromCommand=function(b){if(a.SetTransitionFromCommand.superclass.constructor.apply(this,arguments),this._options=b||{},!this._options.statechart)throw new Error("Must select a statechart");this._transition=this._options.transition,this._statechart=this._options.statechart,this._transition.basis&&this._transition.basis()&&(this._transition=this._transition.basis()),this._statechart.basis&&this._statechart.basis()&&(this._statechart=this._statechart.basis())},function(c){b.proto_extend(c,a.Command);var d=c.prototype;d._execute=function(){this._old_statechart=this._transition.from(),this._transition.setFrom(this._statechart)},d._unexecute=function(){this._transition.setFrom(this._old_statechart)},d._do_destroy=function(){c.superclass._do_destroy.apply(this,arguments)},a.register_serializable_type("set_transition_from_command",function(a){return a instanceof c},function(){b.toArray(arguments);return{transition_id:this._transition.id(),state_id:this._statechart.id()}},function(b){return new c({transition:a.find_uid(b.transition_id),statechart:a.find_uid(b.state_id)})})}(a.SetTransitionFromCommand),a.SetTransitionToCommand=function(b){if(a.SetTransitionToCommand.superclass.constructor.apply(this,arguments),this._options=b||{},!this._options.statechart)throw new Error("Must select a statechart");this._transition=this._options.transition,this._statechart=this._options.statechart,this._transition.basis&&this._transition.basis()&&(this._transition=this._transition.basis()),this._statechart.basis&&this._statechart.basis()&&(this._statechart=this._statechart.basis())},function(c){b.proto_extend(c,a.Command);var d=c.prototype;d._execute=function(){this._old_statechart=this._transition.to(),this._transition.setTo(this._statechart)},d._unexecute=function(){this._transition.setTo(this._old_statechart)},d._do_destroy=function(){c.superclass._do_destroy.apply(this,arguments)},a.register_serializable_type("set_transition_to_command",function(a){return a instanceof c},function(){b.toArray(arguments);return{transition_id:this._transition.id(),state_id:this._statechart.id()}},function(b){return new c({transition:a.find_uid(b.transition_id),statechart:a.find_uid(b.state_id)})})}(a.SetTransitionToCommand);var c=function(){};a.StatechartOnCommand=function(b){if(a.StatechartOnCommand.superclass.constructor.apply(this,arguments),this._options=b||{},!this._options.statechart)throw new Error("Must select a statechart");if(this._statechart=this._options.statechart,this._context=this._options.context,this._options.listener instanceof a.ParsedFunction){var c=this._options.listener;this._listener=function(b){var d,e=b.state,f=b.event,g=e.context();g&&(d=a.find_or_put_contextual_obj(g.points_at(),g)),c._call(d,g,f)}}else this._listener=this._options.listener;this._spec=this._options.spec},function(d){b.proto_extend(d,a.Command);var e=d.prototype;e._execute=function(){this._statechart.on_transition(this._spec,this._listener,c,this._context)},e._unexecute=function(){this._statechart.off_transition(this._spec,this._listener,c,this._context)},e._do_destroy=function(){d.superclass._do_destroy.apply(this,arguments)},a.register_serializable_type("set_transition_on_command",function(a){return a instanceof d},function(){var c=b.toArray(arguments);return{statechart_id:this._statechart.id(),context:a.serialize.apply(a,[this._context].concat(c)),pcontext:a.serialize.apply(a,[this._pcontext].concat(c)),listener:a.serialize.apply(a,[this._listener].concat(c)),spec:this._spec}},function(b){return new d({statechart:a.find_uid(b.statechart_id),context:a.deserialize(b.context),pcontext:a.deserialize(b.pcontext),listener:a.deserialize(b.listener),spec:b._spec})})}(a.StatechartOnCommand),a.StatechartOff=function(b){if(a.StatechartOff.superclass.constructor.apply(this,arguments),this._options=b||{},!this._options.statechart)throw new Error("Must select a statechart");this._statechart=this._options.statechart,this._context=this._options.context,this._listener=this._options.listener,this._spec=this._options.spec},function(d){b.proto_extend(d,a.Command);var e=d.prototype;e._execute=function(){this._statechart.off_transition(this._spec,this._listener,c,this._context)},e._unexecute=function(){this._statechart.on_transition(this._spec,this._listener,c,this._context)},e._do_destroy=function(){d.superclass._do_destroy.apply(this,arguments)},a.register_serializable_type("set_transition_off_command",function(a){return a instanceof d},function(){var c=b.toArray(arguments);return{statechart_id:this._statechart.id(),context:a.serialize.apply(a,[this._context].concat(c)),pcontext:a.serialize.apply(a,[this._pcontext].concat(c)),listener:a.serialize.apply(a,[this._listener].concat(c)),spec:this._spec}},function(b){return new d({statechart:a.find_uid(b.statechart_id),context:a.deserialize(b.context),pcontext:a.deserialize(b.pcontext),listener:a.deserialize(b.listener),spec:b._spec})})}(a.StatechartOff)}(interstate),function(a){"use strict";var b=(a.cjs,a._);a.CombinedCommand=function(b){if(a.CombinedCommand.superclass.constructor.apply(this,arguments),this._options=b||{},!this._options.commands)throw new Error("Must specify commands!");this._commands=b.commands},function(c){b.proto_extend(c,a.Command);var d=c.prototype;d._execute=function(){b.forEach(this._commands,function(a){a._do()})},d._unexecute=function(){b.forEach(this._commands.reverse(),function(a){a._undo()})},d._do_destroy=function(a){c.superclass._do_destroy.apply(this,arguments),b.forEach(this._commands,function(b){b.destroy(a)}),delete this._options,delete this._commands},a.register_serializable_type("combined_command",function(a){return a instanceof c},function(){var c=b.toArray(arguments);return{commands:a.serialize.apply(a,[this._commands].concat(c))}},function(b){return new c({commands:a.deserialize(b.commands)})})}(a.CombinedCommand)}(interstate),function(a){"use strict";var b=a.cjs,c=a._;a.CommandStack=function(){var d=[],e=-1,f=[],g=function(a){var f=d.splice(e+1,d.length-e);c.forEach(f,function(a){b.isConstraint(a)&&a.destroy()}),a.is_undoable()&&(d.push(a),e+=1),b.wait(),this.$undo_description.invalidate(),this.$redo_description.invalidate(),b.signal()};this.complete_transient=function(){var b=new a.CombinedCommand({commands:f});g.call(this,b),f=[]},this._do=function(a,c){b.wait(),a._do(),c?f.push(a):g.call(this,a),b.signal()},this._undo=function(){if(this.can_undo()){b.wait();var a=d[e];a._undo(),e-=1,this.$undo_description.invalidate(),this.$redo_description.invalidate(),b.signal()}},this._redo=function(){if(this.can_redo()){b.wait();var a=d[e+1];a._do(),e+=1,this.$undo_description.invalidate(),this.$redo_description.invalidate(),b.signal()}},this.can_undo=function(){return e>=0},this.can_redo=function(){return e<d.length-1},this.get_undo_description=function(){if(this.can_undo()){var a=d[e];return a.to_undo_string()}return!1},this.get_redo_description=function(){if(this.can_redo()){var a=d[e+1];return a.to_redo_string()}return!1},this.$undo_description=b(this.get_undo_description,{context:this}),this.$redo_description=b(this.get_redo_description,{context:this}),this.clear=function(){for(var a=0;a<d.length;a++)d[a].destroy();d=[],e=-1,b.wait(),this.$undo_description.invalidate(),this.$redo_description.invalidate(),b.signal()},this.destroy=function(){this.clear(),this.$undo_description.destroy(),this.$redo_description.destroy()}}}(interstate),function(a){"use strict";var b=(a.cjs,a._);a.Environment=function(c){this._command_stack=new a.CommandStack;var d;d=c&&b.has(c,"root")?c.root:a.get_default_root(!c||c.builtins),this.pointer=new a.Pointer({stack:[d]}),this.print_on_return=!1},function(c){var d=c.prototype;d.default_return_value=function(){return this.print_on_return?this.print():this},d.get_root_pointer=function(){return this.pointer.slice(0,1)},d.get_root=function(){return this.pointer.root()},d.get_pointer_obj=function(){return this.pointer.points_at()},d.get_current_statechart=function(){var b,c=a.find_stateful_obj_and_context(this.pointer),d=c.stateful_obj;if(b=d.get_own_statechart(),!b)throw new Error("Could not find statechart");return b},d.find_state=function(b){var c,d,e;if(b instanceof a.State||b instanceof a.StatechartTransition)return b.basis()||b;var f=a.find_stateful_obj_and_context(this.pointer),g=f.stateful_obj,h=g.get_own_statechart(),i=b.split(/->|-(\d+)>/);if(i.length>1){var j=i[0].trim(),k=i[2].trim(),l=parseInt(i[1],10)||0,m=h.find_transitions(j,k,l);if(!m){var n=this.get_pointer_obj();for(d=n.get_inherited_statecharts(this.pointer),c=0;c<d.length&&(e=d[c],!(m=e.find_transitions(j,k,l)));c+=1);}return m.basis()||m}var o=h.find_state(b);if(!o){var p=a.find_or_put_contextual_obj(f.stateful_obj,f.context),q=p.get_statecharts();for(d=q.slice(1),c=0;c<d.length&&(e=d[c],!(o=e.find_state(b)));c+=1);}return o.basis()||o},d._do=function(a){this._command_stack._do(a)},d.undo=function(){this._command_stack._undo()},d.redo=function(){this._command_stack._redo()},d.cd=function(a){var b=this.pointer.points_at(),c=b._get_direct_prop(a);return c&&(this.pointer=this.pointer.push(c)),this.default_return_value()},d.top=function(){return this.pointer=this.pointer.slice(0,1),this.default_return_value()},d.up=function(){return this.pointer=this.pointer.pop(),this.default_return_value()},d.reset=function(){var b=this.get_pointer_obj(),c=a.find_or_put_contextual_obj(b,this.pointer);if(!(c instanceof a.ContextualStatefulObj))throw new Error("Trying to reset non-stateful");return c.reset(),this.default_return_value()},d.set=function(c,d,e,f){var g,h,i,j,k,l,m=[],n=!1,o=this.get_pointer_obj();if("("===c[0]&&")"===c[c.length-1]){g=c.slice(1,c.length-1);var p=o.get_builtins();for(h in p)if(p.hasOwnProperty(h)){var q=p[h],r=q._get_env_name();if(g===r){n=q;break}}}if(l=1===arguments.length?o instanceof a.StatefulObj?"<stateful_prop>":"<stateful>":b.last(arguments),b.isString(l))if("<dict>"===l){l=new a.Dict({});var s=new a.Cell({ignore_inherited_in_first_dict:!0});l._set_direct_protos(s)}else"<stateful>"===l?(l=new a.StatefulObj(void 0,!0),l.initialize({direct_protos:new a.StatefulProp({can_inherit:!1,statechart_parent:l})})):"<stateful_prop>"===l&&(l=new a.StatefulProp);if(3===arguments.length||4===arguments.length&&b.isNumber(f)){var t=this.find_state(d);if(i=f,l instanceof a.StatefulProp)throw new Error("Value is an instanceof a stateful prop");if(n)if(j=n._get_getter_name(),k=o[j]()){if(!(k instanceof a.StatefulProp))throw new Error("Trying to set value for non stateful prop");var u=k._direct_value_for_state(t);m.push(u instanceof a.Cell&&b.isString(l)?new a.ChangeCellCommand({cell:u,str:l}):new a.SetStatefulPropValueCommand({stateful_prop:k,state:t,value:b.isString(l)?new a.Cell({str:l}):l}))}else k=new a.StatefulProp,m.push(new a.SetBuiltinCommand({parent:o,name:g,value:l})),m.push(new a.SetStatefulPropValueCommand({stateful_prop:k,state:t,value:l}));else if(o._has_direct_prop(c))if(k=o._get_direct_prop(c),k instanceof a.StatefulProp)if(k._has_direct_value_for_state(t)){var v=k._direct_value_for_state(t);m.push(v instanceof a.Cell&&b.isString(e)?new a.ChangeCellCommand({cell:v,str:l}):new a.SetStatefulPropValueCommand({stateful_prop:k,state:t,value:b.isString(l)?new a.Cell({str:l}):l}))}else m.push(new a.SetStatefulPropValueCommand({stateful_prop:k,state:t,value:b.isString(l)?new a.Cell({str:l}):l}));else k=new a.StatefulProp,m.push(new a.SetPropCommand({parent:o,name:c,value:k,index:i})),m.push(new a.SetStatefulPropValueCommand({stateful_prop:k,state:t,value:b.isString(l)?new a.Cell({str:l}):l}));else k=new a.StatefulProp,m.push(new a.SetPropCommand({parent:o,name:c,value:k,index:i})),m.push(new a.SetStatefulPropValueCommand({stateful_prop:k,state:t,value:b.isString(l)?new a.Cell({str:l}):l}))}else 2===arguments.length||3===arguments.length&&b.isNumber(e)?(i=e,o=this.get_pointer_obj(),n?(j=n._get_getter_name(),k=o[j](),m.push(k?k instanceof a.Cell&&b.isString(d)?new a.ChangeCellCommand({cell:k,str:d}):new a.SetBuiltinCommand({parent:o,name:g,value:l}):new a.SetBuiltinCommand({parent:o,name:g,value:l}))):o._has_direct_prop(c)?(k=o._get_direct_prop(c),m.push(k instanceof a.Cell&&b.isString(d)?new a.ChangeCellCommand({cell:k,str:l}):new a.SetPropCommand({parent:o,name:c,value:b.isString(l)?new a.Cell({str:l}):l,index:i}))):m.push(new a.SetPropCommand({parent:o,name:c,value:b.isString(l)?new a.Cell({str:l}):l,index:i}))):1===arguments.length&&(n?(j=n._get_getter_name(),m.push(new a.SetBuiltinCommand({parent:o,name:g,value:b.isString(l)?new a.Cell({str:l}):l}))):m.push(new a.SetPropCommand({parent:o,name:c,value:b.isString(l)?new a.Cell({str:l}):l,index:i})));var w;return w=1===m.length?m[0]:new a.CombinedCommand({commands:m}),this._do(w),this.default_return_value()},d._get_unset_prop_command=function(c){var d=this.get_pointer_obj();if(!b.isString(c))return void console.error("No name given");var e=new a.UnsetPropCommand({parent:d,name:c});return e},d.unset=function(){var a=this._get_unset_prop_command.apply(this,arguments);return this._do(a),this.default_return_value()},d.inherit=function(b){var c=(this.get_pointer_obj(),this.pointer),d=c.points_at(),e=a.find_or_put_contextual_obj(d,c);e=e.prop(b);var f=new a.InheritPropCommand({cobj:e,name:b});return this._do(f),this.default_return_value()},d._get_rename_prop_command=function(b,c){var d=this.get_pointer_obj(),e=new a.RenamePropCommand({parent:d,from:b,to:c});return e},d.rename=function(){var a=this._get_rename_prop_command.apply(this,arguments);return this._do(a),this.default_return_value()},d.set_copies=function(b){var c=this.get_pointer_obj(),d=new a.SetCopiesCommand({parent:c,value:b});return this._do(d),this.default_return_value()},d._get_move_prop_command=function(b,c){var d=this.get_pointer_obj(),e=new a.MovePropCommand({parent:d,name:b,to:c});return e},d.move=function(){var a=this._get_move_prop_command.apply(this,arguments);return this._do(a),this.default_return_value()},d._get_set_cell_command=function(c,d,e){var f,g,h,i,j,k,l,m,n,o=[];if(1===arguments.length)f=this.get_pointer_obj(),g=c;else if(2===arguments.length)if(j=this.get_pointer_obj(),b.isString(c))if("("===c[0]&&")"===c[c.length-1]){k=c.slice(1,c.length-1),l=j.get_builtins();for(i in l)if(l.hasOwnProperty(i)&&(n=l[i],m=n._get_env_name(),k===m)){f=j[n._get_getter_name()]();break}}else f=j._get_prop(c,this.pointer);else f=c;else{var p;if(j=this.get_pointer_obj(),b.isString(c))if("("===c[0]&&")"===c[c.length-1]){k=c.slice(1,c.length-1),l=j.get_builtins();for(i in l)if(l.hasOwnProperty(i)&&(n=l[i],m=n._get_env_name(),k===m)){p=j[n._get_getter_name()]();break}}else p=j._get_prop(c,this.pointer);else p=c;h=this.find_state(d),g=e,f=new a.Cell({str:"",ignore_inherited_in_first_dict:!0}),o.push(this._get_stateful_prop_set_value_command(p,h,f))}o.push(new a.ChangeCellCommand({cell:f,str:g}));var q;return q=1===o.length?o[0]:new a.CombinedCommand({commands:o})},d.set_cell=function(){var a=this._get_set_cell_command.apply(this,arguments);return this._do(a),this.default_return_value()};d._get_stateful_prop_set_value_command=function(b,c,d){var e=new a.SetStatefulPropValueCommand({stateful_prop:b,state:c,value:d});return e},d._get_stateful_prop_unset_value_command=function(b,c){var d=new a.UnsetStatefulPropValueCommand({stateful_prop:b,state:c});return d},d._get_add_state_command=function(c,d){var e=this.get_current_statechart();b.isNumber(d)&&(d+=1);var f=new a.AddStateCommand({name:c,statechart:e,index:d});return f},d.add_state=function(){var a=this._get_add_state_command.apply(this,arguments);return this._do(a),this.default_return_value()},d._get_remove_state_command=function(b){var c=this.get_current_statechart(),d=new a.RemoveStateCommand({name:b,statechart:c});return d},d.remove_state=function(){var a=this._get_remove_state_command.apply(this,arguments);return this._do(a),this.default_return_value()},d._get_move_state_command=function(c,d){var e=this.get_current_statechart();b.isNumber(d)&&(d+=1);var f=new a.MoveStateCommand({name:c,statechart:e,index:d});return f},d.move_state=function(){var a=this._get_move_state_command.apply(this,arguments);return this._do(a),this.default_return_value()},d._get_rename_state_command=function(b,c){var d=this.get_current_statechart(),e=new a.RenameStateCommand({from:b,to:c,statechart:d});return e},d.rename_state=function(){var a=this._get_rename_state_command.apply(this,arguments);return this._do(a),this.default_return_value()},d._get_add_transition_command=function(c,d,e){var f=this.get_current_statechart(),g=(this.get_pointer_obj(),f.find_state(c)),h=f.find_state(d);b.isString(e)&&(e=new a.ParsedEvent({str:e,inert:!0}));var i=new a.AddTransitionCommand({statechart:f,event:e,from:g,to:h});return i},d.make_concurrent=function(b,c){1===arguments.length&&(c=b,b=!1);var d=b?this.find_state(b):this.get_current_statechart(),e=new a.MakeConcurrentCommand({statechart:d,concurrent:c!==!1});return this._do(e),this.default_return_value()},d.add_transition=function(){var a=this._get_add_transition_command.apply(this,arguments);return this._do(a),this.default_return_value()},d._get_remove_transition_command=function(b){var c,d,e=this.get_current_statechart();b instanceof a.StatechartTransition?d=b:c=b;var f=new a.RemoveTransitionCommand({statechart:e,id:c,transition:d});return f},d.remove_transition=function(){var a=this._get_remove_transition_command.apply(this,arguments);return this._do(a),this.default_return_value()},d._get_set_event_command=function(b,c){var d=this.get_current_statechart(),e=new a.SetTransitionEventCommand({statechart:d,id:b,event:c});return e},d.set_event=function(){var a=this._get_set_event_command.apply(this,arguments);return this._do(a),this.default_return_value()},d.set_from=function(b,c){b=this.find_state(b),c=this.find_state(c);var d=new a.SetTransitionFromCommand({transition:b,statechart:c});return this._do(d),this.default_return_value()},d.set_to=function(b,c){b=this.find_state(b),c=this.find_state(c);var d=new a.SetTransitionToCommand({transition:b,statechart:c});return this._do(d),this.default_return_value()},d.start_at=function(b){var c,d,e,f,g=this.find_state(b);return c=b.indexOf(".")<0?this.get_current_statechart():this.find_state(b.slice(0,b.lastIndexOf("."))),d=c.get_start_state(),e=d.get_outgoing_transition(),f=new a.SetTransitionToCommand({transition:e,statechart:g}),this._do(f),this.default_return_value()},d.on_state=function(c,d,e){var f=this.get_current_statechart();b.isString(d)&&(d=a.get_parsed_val(a.parse(d),{}));var g=new a.StatechartOnCommand({statechart:f,spec:c,listener:d,pcontext:this.pointer,context:e});return this._do(g),this.default_return_value()},d.off_state=function(b,c,d){var e=this.get_current_statechart(),f=new a.StatechartOffCommand({statechart:e,spec:b,listener:c,context:d});return this._do(f),this.default_return_value()},d.print=function(b){return a.print(this.pointer,b)},d.destroy=function(){var b=this.pointer,c=b.root(),d=a.find_or_put_contextual_obj(c);this._command_stack.destroy(),delete this._command_stack,window.dbg=!0,d.destroy(),window.dbg=!1,c.destroy(),delete this.pointer},d._cycle_stringify_destringify=function(){var b=this.get_root(),c=a.stringify(b);b.destroy(),this._command_stack.clear();var d=a.destringify(c);this.pointer=new a.Pointer({stack:[d]})}}(a.Environment)}(interstate),function(a,b){"use strict";var c,d=a.cjs,e=a._,f=window.location.protocol+"//"+window.location.host,g=window.navigator.platform;c="iPhone"===g||"iPod"===g?"phone":"iPad"===g?"tablet":"desktop",b.widget("interstate.dom_output",{options:{root:void 0,show_edit_button:!0,edit_on_open:!1,editor_url:"editor.html",editor_name:uid.get_prefix()+"ist_editor",open_separate_client_window:!0,external_editor:"phone"===c||"tablet"===c,auto_open_external_editor:!1,editor_window_options:function(){return"toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=yes, resizable=yes, width="+window.innerWidth+", height="+2*window.innerHeight/3+", left="+window.screenX+", top="+(window.screenY+window.outerHeight)},client_id:uid.get_prefix(),immediately_create_server_socket:!1},_create:function(){if(this.element.addClass("ist_runtime"),this._command_stack=new a.CommandStack,this.$dirty_program=d(!1),this.$highlighting_objects=d([]),this.$inspecting_hover_object=d(!1),this.$breakpoints=d({}),!this.option("root")){var f=a.load();f||(f=a.get_default_root(),a.saveAndSetCurrent(f)),this.option("root",f)}if(this.option("show_edit_button")){this.button_color="#990000",this.edit_button_css={"float":"right","text-decoration":"none","font-variant":"small-caps",position:"fixed",top:"tablet"===c||"phone"===c?"15px":"0px",right:"0px",color:this.button_color,"background-color":"","font-size":"1.2em","font-family":'"HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif',cursor:"pointer",padding:"5px","border-bottom":""},this.running_button_css={"float":"right",position:"fixed",top:"20px","padding-left":"5px",right:"20px","font-family":'"HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif',color:this.button_color,"-webkit-touch-callout":"none","-webkit-user-select":"none","-khtml-user-select":"none","-moz-user-select":"none","-ms-user-select":"none","user-select":"none"},this.editing_button_css={position:"fixed",top:"40px"},this.editing_button_open_css={top:"60px"},this.hidden_button_css={display:"none"},this.shown_button_css={display:"block"},this.run_edit_active_css={"font-weight":"bold"},this.run_edit_inactive_css={"font-weight":"normal"},this.edit_hover_css={opacity:1,color:"white","background-color":this.button_color,cursor:"pointer","border-bottom":""},this.edit_active_css={opacity:1,color:this.button_color,"background-color":"",cursor:"default","border-bottom":"5px solid "+this.button_color},this.palette_css={"float":"right",position:"fixed",top:"65px",right:"13px","padding-left":"0",margin:"0",display:"none","font-size":"0.95em","list-style-type":"none","font-family":'"HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif',color:this.button_color},this.palette_css_show={display:"block"},this.inspect_css={display:"block",top:"42px",right:"25px"},this.code_view_css={right:"25px"},this.inspect_css_show={display:"none"},this.undo_redo_css={"float":"right",position:"fixed",right:"0px",padding:"5px",top:"0",display:"none"};this.edit_button=b("<a />").text("edit").css(this.edit_button_css).on("mouseover.make_active",e.bind(function(){this.edit_button.hasClass("active")||this.edit_button.addClass("hover").css(this.edit_hover_css)},this)).on("mouseout.make_active",e.bind(function(){this.edit_button.hasClass("active")||this.edit_button.removeClass("hover").css(this.edit_button_css)},this)).on("mousedown.open_editor touchstart.open_editor",e.bind(this.open_editor,this));{window.setInterval(e.bind(function(){this.element.append(this.edit_button)},this))}}this.option("edit_on_open")&&this.open_editor(),b(window).on("keydown.open_editor",e.bind(this.on_key_down,this)).on("beforeunload.do_save onunload.do_save unload.do_save pagehide.do_save",e.bind(function(){this._save(),this.element.dom_output("destroy")},this)),this.option("immediately_create_server_socket")&&(this.server_socket=this._create_server_socket()),this._add_change_listeners(),this._add_highlight_listeners()},_setOption:function(b,c){if("root"===b){this._remove_change_listeners();var d=this.option("root");if(d){a.find_or_put_contextual_obj(d)}}this._super(b,c),"root"===b&&(this._command_stack.clear(),this.server_socket&&this.server_socket.set_root(this.option("root")),c&&this._add_change_listeners(),this.$dirty_program.set(!1))},import_component:function(a,b){for(var c=this.option("root"),d=a,e=1;c._has_direct_prop(a);)a=d+"_"+e,e++;c.set(a,b)},get_server_socket:function(){return this.server_socket},on_key_down:function(a){a.altKey&&a.metaKey&&(69===a.keyCode?this.open_editor():84===a.keyCode&&(this.begin_inspect(),a.preventDefault(),a.stopPropagation()))},_destroy:function(){this._super(),this.close_editor(),b(window).off(".do_save"),this._remove_highlight_listeners(),this.$highlighting_objects.destroy(!0),delete this.$highlighting_objects,this.$inspecting_hover_object.destroy(!0),delete this.$inspecting_hover_object,this.$dirty_program.destroy(!0),delete this.$dirty_program,this.$breakpoints.destroy(!0),delete this.$breakpoints,this._remove_change_listeners(),this.element.removeClass("ist_runtime"),b(window).off("keydown.open_editor"),this.edit_button&&this.edit_button.off("mouseover.make_active").off("mouseout.make_active").off("click.open_editor").remove(),this.server_socket&&(this.server_socket.destroy(),delete this.server_socket),this._command_stack.destroy(),delete this._command_stack,delete this.options},_add_highlight_listeners:function(){var a=[],c=[];this._highlight_fn=d.liven(function(){var d=this.$highlighting_objects.toArray(),f=e.chain(d).map(function(a){return a.is_destroyed()?!1:a.is_template()?a.instances():a}).compact().flatten().map(function(a){return a._destroyed?void 0:a.get_dom_obj()}).flatten().value().concat(this.$inspecting_hover_object.get());f=e.compact(f);var g=e.diff(a,f);e.each(g.added,function(a){var d=a.item;if(b(d).addClass("highlight"),d instanceof SVGElement){var e=d.getBoundingClientRect(),f=d.tagName,g=b("<div />").appendTo(document.body).addClass("highlight svg_follow").css({left:e.left+"px",top:e.top+"px",width:e.width+"px",height:e.height+"px",borderRadius:"CIRCLE"===f.toUpperCase()?e.width/2+"px":"0px"});c.push({following:d,follower:g})}}),e.each(g.removed,function(a){var d=a.from_item;b(d).removeClass("highlight"),d instanceof SVGElement&&e.each(c,function(a,b){a.following===d&&(a.follower.remove(),c.splice(b,1))})}),a=f},{context:this,on_destroy:function(){e.each(a,function(a){b(a).removeClass("highlight"),a instanceof SVGElement&&e.each(c,function(b,d){b.following===a&&(b.follower.remove(),c.splice(d,1))})})},run_on_start:!1}),this._highlight_fn.run()},_remove_highlight_listeners:function(){this._highlight_fn&&this._highlight_fn.destroy()},_add_change_listeners:function(){var b=this.option("root"),c=a.find_or_put_contextual_obj(b);a.__empty_files||(this._dom_tree_fn=d.liven(function(){var a=c.get_attachment_instance("dom"),b=a.get_dom_obj();this.element.children().is(b)?this.element.children().not(b).remove():(this.element.children().remove(),this.element.append(b))},{context:this,pause_while_running:!0,on_destroy:function(){this.element.children().remove()}}))},_remove_change_listeners:function(){this._dom_tree_fn&&(this._dom_tree_fn.destroy(),delete this._dom_tree_fn),this._raphael_fn&&(this._raphael_fn.destroy(),delete this._raphael_fn),this._update_fn&&(this._update_fn.destroy(),delete this._update_fn)},_create_server_socket:function(){var b=this.option("root"),c=new a.ProgramStateServer({root:b,command_stack:this._command_stack,dirty_program:this.$dirty_program}).on("connected",function(){this.edit_button&&this.edit_button.addClass("active").css(this.edit_active_css)},this).on("disconnected",function(){this.cleanup_closed_editor()},this).on("command",function(a){"undo"===a?(this._command_stack._undo(),this.$dirty_program.set(!0)):"redo"===a?(this._command_stack._redo(),this.$dirty_program.set(!0)):(this._command_stack._do(a),this.$dirty_program.set(!0))},this).on("load_program",function(b){var c=a.load(b);this.option("root",c)},this).on("load_file",function(a){this.load_str(a.contents,a.name,a.also_load)},this).on("download_program",function(b,c){this.server_socket.post("component"===c?{type:"stringified_obj",value:a.loadString(b,c),name:b}:{type:"stringified_root",value:a.loadString(b,c),name:b})},this).on("save_component",function(b){var c=b.cobj_id,d=a.find_uid(c);if(d){var e=d.get_object();a.save(e,d.get_name(),"component")}},this).on("save_curr",function(){this._save()},this).on("save_curr_as",function(b){this._save(),a.saveAndSetCurrent(this.option("root"),b.name)},this).on("create_program",function(b){this._save();var c=a.get_default_root();a.saveAndSetCurrent(c,b.name),this.option("root",c)},this).on("copy_component",function(b){var c=b.target_obj_id,d=a.find_uid(c),e=a.load(b.name,"component");d.set(b.name,e)},this).on("rename_program",function(b){var c=b.from_name,d=b.to_name,e=b.storage_type;this._save(),a.rename(c,d,e)},this).on("add_highlight",function(b){var c=b.cobj_id,d=a.find_uid(c);d&&this.$highlighting_objects.push(d)},this).on("remove_highlight",function(b){var c=b.cobj_id,d=a.find_uid(c);if(d){var e=this.$highlighting_objects.indexOf(d);e>=0&&this.$highlighting_objects.splice(e,1)}},this);return c},load_str:function(b,c,d){var e,f=b.replace(/^COMPONENT:/,""),g=f.length!==b.length,h=c.replace(/\.\w*$/,"");if(a.__debug)e=a.destringify(f);else try{e=a.destringify(f)}catch(i){return console.error("Error loading "+c),void console.error(i)}g?interstate.save(e,h,"component"):(this._save(),d?(a.saveAndSetCurrent(e,h),this.option("root",e),this.element.trigger("change_root",e)):a.save(e,h))},open_editor:function(d,g){if(this.editing_button&&this.editing_button.css(this.shown_button_css),this.running_button&&this.running_button.css(this.shown_button_css),this.undo_redo_buttons&&this.undo_redo_buttons.css(this.shown_button_css),d&&(d.preventDefault(),d.stopPropagation()),this.editor_window)this.editor_window.focus();else{var h=function(a){this.server_socket=this.server_socket||this._create_server_socket(g),this.server_socket.set_communication_mechanism(a),this.server_socket.is_connected()&&this.edit_button&&this.edit_button.addClass("active").css(this.edit_active_css),this.element.trigger("editor_open")};this.option("external_editor")?interstate.async_js("/socket.io/socket.io.js",e.bind(function(){var d=new a.SocketCommWrapper(this.option("client_id"),!0);if(this.option("auto_open_external_editor"))b.ajax({url:"auto_open_editor",data:{client_id:this.option("client_id")},type:"GET"});else{var e=f+"/e/"+encodeURIComponent(this.option("client_id")),g=b("<div />"),i="tablet"===c?500:256,j=(new QRCode(g[0],{text:e,width:i,height:i,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H}),b("<div />").addClass("upload_url").appendTo(document.body).append(g,b("<a />").attr({href:e,target:"_blank"}).text(e)));b(window).on("touchstart.close_alert mousedown.close_alert",function(a){b(a.target).parents().is(j)||(b(window).off("touchstart.close_alert mousedown.close_alert"),j.remove())})}h.call(this,d)},this)):this.option("open_separate_client_window")?(this.editor_window=window.open(this.option("editor_url")+"?client_id="+encodeURIComponent(this.option("client_id")),this.option("editor_name"),this.option("editor_window_options")()),h.call(this,new a.InterWindowCommWrapper(this.editor_window,this.option("client_id")))):(this.editor_window=window,h.call(this,new a.SameWindowCommWrapper(this.option("client_id"),0)))}},close_editor:function(){this.editor_window&&(this.editor_window.close(),this.cleanup_closed_editor())},_save:function(){this.$dirty_program.get()&&(this.$dirty_program.set(!1),a.save(this.option("root")))},cleanup_closed_editor:function(){this.$highlighting_objects.setValue([]),this.edit_button&&this.edit_button.removeClass("active").css(this.edit_button_css),delete this.editor_window},begin_inspect:function(){this._inspecting?this.cancel_inspect():(this._inspecting=!0,this._inspecting_target=!1,this._on_mover=e.bind(function(a){var b=this._inspecting_target=a.target;this.$inspecting_hover_object.set(b)},this),this._on_mout=e.bind(function(a){a.target===this._inspecting_target&&(this.$inspecting_hover_object.set(!1),this._inspecting_target=!1)},this),this._on_click=e.bind(function(a){var b=a.target,c=b.__ist_contextual_object__;this.inspect_cobj(c)},this),b(this.element).get(0).addEventListener("mouseover",this._on_mover,!0),b(this.element).get(0).addEventListener("mouseout",this._on_mout,!0),b(this.element).get(0).addEventListener("click",this._on_click,!0),b(window).on("keydown.inspector",e.bind(function(a){if(27===a.keyCode)this.cancel_inspect();
else if(13===a.keyCode&&this._inspecting_target){var b=this._inspecting_target.__ist_contextual_object__;this.inspect_cobj(b)}},this)))},cancel_inspect:function(){this._inspecting&&(this._inspecting=!1,this._inspecting_target=!1,this.$inspecting_hover_object.set(!1),b(this.element).get(0).removeEventListener("mouseover",this._on_mover,!0),b(this.element).get(0).removeEventListener("mouseout",this._on_mout,!0),b(this.element).get(0).removeEventListener("click",this._on_click,!0),b(window).off("keydown.inspector"))},inspect_cobj:function(a){this.editor_window?(this.server_socket.post({type:"inspect",cobj_id:a.id()}),this.editor_window.focus()):this.open_editor(),this.cancel_inspect()}})}(interstate,jQuery),function(a,b){"use strict";var c=a.cjs,d=a._,e=c.createTemplate("<textarea cjs-on-blur=on_edit_blur cjs-on-keydown=on_edit_keydown />");c.registerCustomPartial("editing_text",{createNode:function(a){var c=e({on_edit_blur:function(a){b(c).editing_text("on_edit_blur",a)},on_edit_keydown:function(a){b(c).editing_text("on_edit_keydown",a)}});return b(c).editing_text({init_val:a}),c},onAdd:function(a,c){d.defer(function(){b(a).val(c).select().focus()}),b(a).editing_text("onAdd")},onRemove:function(a){b(a).editing_text("option","helper",!1),b(a).editing_text("onRemove")},destroyNode:function(a){b(a).editing_text("destroy")}}),b.widget("interstate.editing_text",{options:{init_val:"",helper:!1},_create:function(){this._helper_focused=!1,this.element.val(this.option("init_val")),this._confirm=d.bind(this._confirm_edit,this),this._cancel=d.bind(this._cancel_edit,this)},_destroy:function(){this.$textarea_binding&&this.$textarea_binding.destroy(),this.option("helper",!1),this._super()},onAdd:function(){b("#confirm_button").on("mousedown",this._confirm),b("#cancel_button").on("mousedown",this._cancel)},onRemove:function(){b("#confirm_button").off("mousedown",this._confirm),b("#cancel_button").off("mousedown",this._cancel)},_setOption:function(a,b){if("helper"===a){var d=b,e=this.option("helper");this.$textarea_binding&&this.$textarea_binding.destroy(),e&&e.setValue(""),d&&(d.setValue(this.element.val()||" ",1),this.$textarea_binding=c(this.element[0]),this.$textarea_binding.onChange(function(){d.setValue(this.$textarea_binding.get(),1)},this))}this._super(a,b)},on_edit_blur:function(a){var b=this.option("helper"),c=d.bind(this._confirm_edit,this);a.preventDefault(),a.stopPropagation();var e=d.bind(function(){this._helper_focused=!1,d.delay(d.bind(function(){b.isFocused()?this._helper_focused=!0:this.element.is(":focus")?this._helper_focused=!1:c()},this),50),b.off("blur",e),b.off("change",f)},this),f=d.bind(function(){this._helper_focused&&this.element.val(b.getValue())},this);b?d.delay(d.bind(function(){b.isFocused()?(this._helper_focused=!0,b.on("change",f),b.on("blur",e)):c()},this),50):c()},on_edit_keydown:function(a){var b=a.keyCode;27===b?(a.preventDefault(),a.stopPropagation(),this._cancel_edit()):13===b&&(a.shiftKey||a.ctrlKey||a.metaKey||(a.preventDefault(),a.stopPropagation(),this._confirm_edit()))},cancel:function(){return this._cancel_edit()},_confirm_edit:function(){if(!this.__blocked){this.__blocked=!0;var a=new b.Event("confirm_value");a.value=this.element.val().trim(),this.element.trigger(a),d.delay(d.bind(function(){delete this.__blocked},this),50)}},_cancel_edit:function(){if(!this.__blocked){this.__blocked=!0;var a=new b.Event("cancel_value");this.element.trigger(a),d.delay(d.bind(function(){delete this.__blocked},this),50)}}})}(interstate,jQuery),function(a,b){"use strict";function c(a){return function(){return a}}function d(a,b){if(a.fireEvent)a.fireEvent("on"+b);else{var c=document.createEvent("Events");c.initEvent(b,!0,!1),a.dispatchEvent(c)}}function e(a,c){{var e;navigator.userAgent.toLowerCase().indexOf("chrome")>-1}e=b("<a />").attr({href:"data:text/plain;charset=utf-8,"+a,alt:c,download:c}),d(e[0],"click")}var f=a.cjs,g=a._,h=f.createTemplate("<nav class='navbar navbar-default' role='navigation'><div class='undoredo_group btn-group navbar-left'>{{#if undo_desc}}<div type='button' class='btn btn btn-default' data-cjs-on-click='undo'><div class='tooltip'>{{undo_desc}}</div><span class='glyphicon glyphicon-arrow-left'></span> Undo</div>{{#else}}<div disabled type='button' class='btn btn btn-default'><span class='glyphicon glyphicon-arrow-left'></span> Undo</div>{{/if}}{{#if redo_desc}}<div type='button' class='btn btn btn-default' data-cjs-on-click='redo'><div class='tooltip'>{{redo_desc}}</div>Redo <span class='glyphicon glyphicon-arrow-right'></span></div>{{#else}}<div disabled type='button' class='btn btn btn-default'>Redo <span class='glyphicon glyphicon-arrow-right'></span></div>{{/if}}</div><table id='cell_group' class='input-group navbar-left'><tr><td><pre id='ace_ajax_editor'></pre></td><td id='confirm'><span title='Confirm cell' id='confirm_button' class='glyphicon glyphicon-ok-circle'></span></td><td id='cancel'><span title='Cancel' id='cancel_button' class='glyphicon glyphicon-remove-circle'></span></td></tr><tr><td class='resize_bar' data-cjs-on-mousedown='beginResizeAce'></td></tr></table><div class='widget_group navbar-right pull-right'><div type='button' class='btn btn btn-default {{show_components ? \"active\" : \"\"}}' data-cjs-on-click='toggle_show_widgets'>Files <span class='glyphicon {{show_components ? \"glyphicon-chevron-up\" : \"glyphicon-chevron-down\"}}'></span></div></div></nav>{{#fsm loading_state}}{{#state loading}}<div class='loading'>loading editor...</div>{{#state loaded}}{{#if show_components}}{{> widgetList getWidgetListOptions()}}{{/if}}{{> navigator getNavigatorOptions()}}{{> pinned getPinnedOptions()}}{{/fsm}}");b.widget("interstate.editor",{options:{full_window:!0,server_window:window.opener,client_id:uid.get_prefix(),upload_usage:!1,use_socket:!1,pinned_row:!0},_create:function(){this.$pinned_columns=f([]),this.loading_state=f.fsm("loading","loaded").startsAt("loading"),this.$dragging_client=f(!1);var c=this.loading_state.addTransition("loading","loaded"),d=this.loading_state.addTransition("loaded","loading");this.$window_inner_width=f(function(){return window.innerWidth}),this.$window_inner_height=f(function(){return window.innerHeight}),b(window).on("resize.owr",g.bind(function(){this.$window_inner_width.invalidate(),this.$window_inner_height.invalidate()},this)),this.$show_components=f(!1),this.$info_servers=f(!1),this.$undo_client=this.$info_servers.prop("undo_description"),this.$redo_client=this.$info_servers.prop("redo_description"),this.$pinned_height_pct=f(.5);var h=g.bind(function(){return 0===this.$pinned_columns.length()?this.$dragging_client.get()?.3:0:this.$pinned_height_pct.get()},this);this.$obj_nav_y=f(function(){var a=b("#obj_nav",this.element).position();return a?a.top:0},{context:this}),g.delay(g.bind(function(){this.$obj_nav_y.invalidate()},this),500),this.$nav_height=f(function(){var a=this.$obj_nav_y.get();return(this.$window_inner_height.get()-a)*(1-h())},{context:this}),this.$pinned_height=f(function(){var a=this.$obj_nav_y.get();return(this.$window_inner_height.get()-a)*h()},{context:this}),this.$undo_desc=f(function(){var a=this.$undo_client.get();return a?a.get():!1},{context:this}),this.$redo_desc=f(function(){var a=this.$redo_client.get();return a?a.get():!1},{context:this});var i=function(f){this.client_socket=new a.ProgramStateClient({ready_func:this.option("debug_ready"),comm_mechanism:f}).on("loaded",function(a,b){this.root_client=a,this.$info_servers.set(b),c()},this).on("root_changed",function(){d()},this).on("stringified_root",function(a){e(a.value,a.name+".ist")},this).on("stringified_obj",function(a){e("COMPONENT:"+a.value,a.name+".istc")},this).on("inspect",function(a){b("#obj_nav",this.element).navigator("open_cobj",a)},this)};this.option("use_socket")?interstate.async_js("/socket.io/socket.io.js",g.bind(function(){var b=this.option("use_socket"),c=new a.SocketCommWrapper(b.client_id,!1);i.call(this,c)},this)):this.option("server_window")===window?i.call(this,new a.SameWindowCommWrapper(this.option("client_id"),0)):i.call(this,new a.InterWindowCommWrapper(this.option("server_window"),this.option("client_id"))),b(window).on("keydown.editor_undo_redo",g.bind(function(a){90===a.keyCode&&(a.metaKey||a.ctrlKey)&&(a.shiftKey?this._redo():this._undo(),a.stopPropagation(),a.preventDefault())},this)),this.element.on("dragstart.pin",g.bind(function(a){this.$dragging_client.set(!0);var c=b(a.target),d=b(".components",this.element),e=b("#pinned",this.element),f=function(){this.$dragging_client.set(!1),d.add(e).removeClass("drop_indicator").off("dragover.pin drop.pin dragenter.pin dragleave.pin"),c.off("dragcancel.pin dragend.pin")};d.add(e).addClass("drop_indicator").on("drop.pin",g.bind(function(a){var d=c.column("option","client");b(a.target).parents().is(".component_drop")?this.client_socket.post({type:"save_component",cobj_id:d.cobj_id}):(f.call(this),e.pinned("addClient",d))},this)),c.on("dragcancel.pin dragend.pin",g.bind(function(){f.call(this)},this))},this)).on("resize_pinned",g.bind(function(a){var c=b("#obj_nav",this.element).position().top,d=Math.max(200,a.clientY-c),e=Math.max(200,window.innerHeight-d-c);this.$pinned_height_pct.set(e/(e+d))},this)),b(window).on("beforeunload.close_editor",g.bind(function(){this.destroy()},this)),this._addClassBindings(),this._addEventListeners(),this._addContentBindings()},_destroy:function(){this._removeContentBindings(),this._removeEventListeners(),this._removeClassBindings(),this.$show_components.destroy(),this.on_unload(),this._super()},_undo:function(){this.client_socket.post_command("undo")},_redo:function(){this.client_socket.post_command("redo")},_addContentBindings:function(){h({loading_state:this.loading_state,getNavigatorOptions:g.bind(function(){return{root_client:this.root_client,client_socket:this.client_socket,editor:this,height:this.$nav_height}},this),getPinnedOptions:g.bind(function(){return{root_client:this.root_client,client_socket:this.client_socket,editor:this,columns:this.$pinned_columns,height:this.$pinned_height}},this),undo:g.bind(this._undo,this),redo:g.bind(this._redo,this),show_components:this.$show_components,toggle_show_widgets:g.bind(function(){this.$show_components.set(!this.$show_components.get())},this),getWidgetListOptions:g.bind(function(){return{info_servers:this.$info_servers,editor:this}},this),undo_desc:this.$undo_desc,redo_desc:this.$redo_desc,dirty_program:this.$dirty_program,beginResizeAce:g.bind(function(c){if(!b("table#cell_group",this.element).hasClass("disabled")){var d=c.clientY,e=0,f=a.height();b(window).on("mousemove.resize_editor",g.bind(function(b){e=b.clientY-d;var c=f+e;a.height(c),this.editor.resize()},this)).on("mouseup.resize_editor",g.bind(function(){b(window).off(".resize_editor")},this)),c.preventDefault(),c.stopPropagation()}},this),dragging_client:this.$dragging_client},this.element);var a=b("nav #ace_ajax_editor",this.element);a.css("width","100%"),this.editor=ace.edit(a[0]),this.editor.setHighlightActiveLine(!1),this.editor.setShowPrintMargin(!1),this.editor.renderer.setShowGutter(!1),this.editor.getSession().setMode("ace/mode/javascript"),this._cellwidth_binding=f.bindCSS(a,"width",this.$window_inner_width.sub(this.$window_inner_width.le(767).iif(300,300)).add("px")),this.$window_inner_width.onChange(function(){this.editor.resize()},this),this._disable_editor()},_removeContentBindings:function(){this.editor.destroy(),f.destroyTemplate(this.element),b(window).off("resize.owr"),this._cellwidth_binding.destroy(),this.$window_inner_width.destroy()},_addClassBindings:function(){this.option("full_window")&&b("html").addClass("full_window_editor"),this.element.addClass("editor_view")},_removeClassBindings:function(){this.option("full_window")&&b("html").removeClass("full_window_editor"),this.element.removeClass("editor_view")},_disable_editor:function(){b("table#cell_group",this.element).addClass("disabled"),this.editor.setReadOnly(!0)},_enable_editor:function(){b("table#cell_group",this.element).removeClass("disabled"),this.editor.setReadOnly(!1)},on_unload:function(){this.client_socket&&(this.client_socket.destroy(),delete this.client_socket)},_addEventListeners:function(){this.element.on("command.editor",g.bind(this.on_command,this)).on("export.editor",g.bind(function(a){var b=a.obj;this.client_socket.post({type:"export_component",cobj_id:b?b.cobj_id:!1})},this)).on("remove_storage.editor",g.bind(function(a){this.client_socket.post({type:"remove_storage",name:a.name,storage_type:a.storage_type})},this)).on("save_curr.editor",g.bind(function(){this.client_socket.post({type:"save_curr"})},this)).on("save_curr_as.editor",g.bind(function(a){this.client_socket.post({type:"save_curr_as",name:a.name})},this)).on("create_program.editor",g.bind(function(a){this.client_socket.post({type:"create_program",name:a.name})},this)).on("rename_storage.editor",g.bind(function(a){this.client_socket.post({type:"rename_program",from_name:a.from_name,to_name:a.to_name,storage_type:a.storage_type})},this)).on("download_program.editor",g.bind(function(a){this.client_socket.post({type:"download_program",name:a.name,storage_type:a.storage_type})},this)).on("load_program.editor",g.bind(function(a){this.client_socket.post({type:"load_program",name:a.name,storage_type:a.storage_type})},this)).on("load_saved_file.editor",g.bind(function(a){this.client_socket.post({type:"load_file",contents:a.filecontents,name:a.filename,also_load:a.also_load})},this)).on("copy_component.editor",g.bind(function(a){this.client_socket.post({type:"copy_component",name:a.name,target_obj_id:a.target_obj_id,above_below:a.above_below})},this)).on("begin_editing_cell",g.bind(function(a){this.editor.setValue(a.initial_val,1),this._enable_editor(),b(a.textarea).editing_text("option","helper",this.editor)},this)).on("done_editing_cell",g.bind(function(){this.editor.setValue(""),this._disable_editor()},this)).on("add_highlight",g.bind(function(a){var b=a.client,c=b.type?b.type():!1;("stateful"===c||"dict"===c)&&this.client_socket.post({type:"add_highlight",cobj_id:b.cobj_id})},this)).on("remove_highlight",g.bind(function(a){var b=a.client,c=b.type?b.type():!1;("stateful"===c||"dict"===c)&&this.client_socket&&this.client_socket.post({type:"remove_highlight",cobj_id:b.cobj_id})},this))},_removeEventListeners:function(){this.element.off(".editor")},getDraggingClientConstraint:function(){return this.$dragging_client},on_command:function(b){var d,e,f,h,i,j,k,l,m,n=b.command_type;if("add_property"===n){d=b.client;var o=b.prop_type;"stateful"===o?(f=new a.StatefulObj(void 0,!0),f.initialize({direct_protos:new a.StatefulProp({can_inherit:!1,statechart_parent:f})})):"stateful_prop"===o&&(f="dict"===d.type()?new a.Cell({str:""}):new a.StatefulProp),h=new a.SetPropCommand({in_effect:!0,parent:{id:c(d.obj_id)},value:f,index:0,name:b.prop_name}),m=this.client_socket.post_command(h,function(){h.destroy(),h=null,f.destroy(),f=null})}else if("rename"===n)d=b.client,h=new a.RenamePropCommand({in_effect:!0,parent:{id:c(d.obj_id)},from:b.from_name,to:b.to_name}),m=this.client_socket.post_command(h,function(){h.destroy(),h=null});else if("inherit"===n){d=b.client;var p=b.name;h=new a.InheritPropCommand({in_effect:!0,cobj:{id:c(d.cobj_id)},name:p}),m=this.client_socket.post_command(h,function(){h.destroy(),h=null})}else if("unset"===n)d=b.client,h=new a.UnsetPropCommand({in_effect:!0,parent:{id:c(d.obj_id)},name:b.name}),m=this.client_socket.post_command(h,function(){h.destroy(),h=null});else if("set_stateful_prop_for_state"===n)d=b.prop,i=b.state,f=new a.Cell({str:b.text||"",substantiated:!1}),h=new a.SetStatefulPropValueCommand({in_effect:!0,stateful_prop:{id:c(d.obj_id)},state:{id:c(i.cobj_id)},value:f}),m=this.client_socket.post_command(h,function(){h.destroy(),h=null,f.destroy(),f=null});else if("unset_stateful_prop_for_state"===n)d=b.prop,i=b.state,h=new a.UnsetStatefulPropValueCommand({in_effect:!0,stateful_prop:{id:c(d.obj_id)},state:{id:c(i.cobj_id)}}),m=this.client_socket.post_command(h,function(){h.destroy(),h=null});else if("set_str"===n)d=b.client,f=b.str,h=new a.ChangeCellCommand({in_effect:!0,cell:{id:c(d.cobj_id||d.obj_id)},str:f}),m=this.client_socket.post_command(h,function(){h.destroy(),h=null});else if("add_state"===n){i=b.state,k=i.puppet_master_id||i.id();var q,r,s=i.get_substates(),t=g.size(s);if(0===t)q="init",r=!0;else{var u="state_"+t;q=u;for(var v=1;g.has(s,q);)q=u+"_"+v;r=!1}h=new a.AddStateCommand({in_effect:!0,statechart:{id:c(k)},name:q,make_start:r}),m=this.client_socket.post_command(h,function(){h.destroy(),h=null})}else if("remove_state"===n)i=b.state,e=i.get_name("parent"),l=i.parent().puppet_master_id||i.parent().id(),h=new a.RemoveStateCommand({in_effect:!0,statechart:{id:c(l)},name:e}),m=this.client_socket.post_command(h,function(){h.destroy(),h=null});else if("remove_transition"===n){j=b.transition;var w=j.root();h=new a.RemoveTransitionCommand({in_effect:!0,transition:{id:c(j.puppet_master_id||j.id())},statechart:{id:c(w.puppet_master_id||j.id())}}),m=this.client_socket.post_command(h,function(){h.destroy(),h=null})}else if("set_type"===n){var x=b.type_name;e=b.prop_name,d=b.client,"stateful"===x?(f=new a.StatefulObj(void 0,!0),f.initialize({direct_protos:new a.StatefulProp({can_inherit:!1,statechart_parent:f})})):"stateful_prop"===x?f=new a.StatefulProp:"cell"===x&&(f=new a.Cell),h=new a.SetPropCommand({in_effect:!0,parent:{id:c(d.obj_id)},value:f,name:e}),m=this.client_socket.post_command(h,function(){h.destroy(),h=null,f.destroy(),f=null})}else if("add_transition"===n){var y=b.from,z=b.to;i=y.root(),k=i.puppet_master_id||i.id();var A=y.puppet_master_id||y.id(),B=z.puppet_master_id||z.id();b=new a.ParsedEvent({str:"false",inert:!0}),h=new a.AddTransitionCommand({in_effect:!0,from:{id:c(A)},to:{id:c(B)},event:b,statechart:{id:c(k)}}),m=this.client_socket.post_command(h,function(){h.destroy(),h=null,b.destroy(),b=null})}else if("set_transition_to"===n)j=b.transition,i=b.to,k=i.puppet_master_id||i.id(),h=new a.SetTransitionToCommand({in_effect:!0,transition:{id:c(j.puppet_master_id||j.id())},statechart:{id:c(k)}}),m=this.client_socket.post_command(h,function(){h.destroy(),h=null});else if("set_transition_from"===n)j=b.transition,i=b.from,k=i.puppet_master_id||i.id(),h=new a.SetTransitionFromCommand({in_effect:!0,transition:{id:c(j.puppet_master_id||j.id())},statechart:{id:c(k)}}),m=this.client_socket.post_command(h,function(){h.destroy(),h=null});else if("rename_state"===n){i=b.state;var C=b.new_name,D=i.get_name("parent");l=i.parent().puppet_master_id||i.parent().id(),h=new a.RenameStateCommand({in_effect:!0,statechart:{id:c(l)},from:D,to:C}),m=this.client_socket.post_command(h,function(){h.destroy(),h=null})}else if("set_transition_str"===n){j=b.transition;var E=b.str,F=j.puppet_master_id||j.id();h=new a.SetTransitionEventCommand({in_effect:!0,transition:{id:c(F)},event:E}),m=this.client_socket.post_command(h,function(){h.destroy(),h=null})}else if("set_copies"===n)f=b.str,d=b.client,h=new a.SetCopiesCommand({in_effect:!0,parent:{id:c(d.obj_id)},value:f}),m=this.client_socket.post_command(h,function(){h.destroy(),h=null});else if("reset"===n)d=b.client,h=new a.ResetCommand({in_effect:!0,parent:{id:c(d.cobj_id)}}),m=this.client_socket.post_command(h,function(){h.destroy(),h=null});else if("make_concurrent"===n){i=b.state;var G=i.puppet_master_id||i.id();h=new a.MakeConcurrentCommand({in_effect:!0,statechart:{id:c(G)},concurrent:b.concurrent}),m=this.client_socket.post_command(h,function(){h.destroy(),h=null})}else if("move_prop"===n){var H=b.from_obj,I=b.from_name,J=b.target_obj,K=b.target_name,L=b.above_below;h=new a.MovePropAboveBelowCommand({in_effect:!0,from_obj:{id:c(H.obj_id)},from_name:I,target_obj:{id:c(J.obj_id)},target_name:K,above_below:L}),m=this.client_socket.post_command(h,function(){h.destroy(),h=null})}else console.log("Unhandled type "+n);this.option("upload_usage")&&this.upload_event({type:"command",value:m})}}),a.create_key_val_map=function(b,c){var d=f.map({}),e=[],h=[],i=f.liven(function(){var f=b.get()||[],i=c.get()||[],j=a.get_map_diff(e,f,h,i);g.each(j.key_change,function(a){d.rename(a.from,a.to)}),g.each(j.set,function(a){d.put(a.key,a.value)}),g.each(j.unset,function(a){d.remove(a.key)}),g.each(j.value_change,function(a){d.put(a.key,a.to)}),e=f,h=i}),j=d.destroy;return d.destroy=function(){j.apply(this,arguments),i.destroy()},d}}(interstate,jQuery),function(a,b){"use strict";var c=a.cjs,d=a._;c.registerCustomPartial("widgetList",{createNode:function(a){return b("<div />").component_list(a)},destroyNode:function(a){b(a).component_list("destroy")}});var e=c.createTemplate("<div class='header'><h3>my programs</h3><p>whole files</p></div><div class='programs'>{{#each programs}}{{>widgetItem getWidgetItemOptions(this, '')}}{{#else}}{{#if !new_program}}<div class='none'>no programs</div>{{/if}}{{/each}}</div>{{#if new_program}}<div class='new_prog'>{{>editing_text getDefaultSketchName()}}<button type='button' class='btn btn-success btn-xs'>OK</button><button cjs-on-mousedown='cancel_newprog' type='button' class='btn btn-danger btn-xs'>Cancel</button></div>{{/if}}<div class='btn-group'><button disabled={{new_program}} class='new_sketch btn btn-sm btn-default' data-cjs-on-click='createNewSketch'><span class='glyphicon glyphicon-file'></span> New</button><button disabled={{disable_save_btn}} class='save_sketch btn btn-sm btn-default' data-cjs-on-click='saveSketch'>{{#if dirty_program}}<span class='glyphicon glyphicon-floppy-disk'></span> Save{{#else}}<span class='glyphicon glyphicon-floppy-saved'></span> Saved{{/if}}</button><button disabled={{new_program}} class='saveas_sketch btn btn-sm btn-default' data-cjs-on-click='saveSketchAs'><span class='glyphicon glyphicon-floppy-save'></span> Save as...</button><div disabled={{new_program}} style='position:relative' id='import_btn' class='btn btn-sm btn-default'><span class='glyphicon glyphicon-cloud-upload'></span> Import<input multiple data-cjs-on-change='onImport' style='width:100%;position:absolute;top:0px;left:-3px;height:30px;opacity:0' title='Import' type='file'/></div></div><div class='header components_header'><h3>my components</h3><p>reusable parts</p></div><div class='components component_drop' data-cjs-on-dragover=dragoverComponent data-cjs-on-dragout=dragoutComponent data-cjs-on-dragenter=dragEnterComponent data-cjs-on-dragleave=dragLeaveComponent>{{#each components}}{{>widgetItem getWidgetItemOptions(this, 'component')}}{{#else}}<div class='none component_drop'>(drop objects here)</div>{{/each}}</div><div class='toolbar'><div disabled={{new_program}} style='position:relative' id='import_btn' class='btn btn-sm btn-default'><span class='glyphicon glyphicon-cloud-upload'></span> Import<input multiple data-cjs-on-change='onImport' style='width:100%;position:absolute;top:0px;left:-3px;height:30px;opacity:0' title='Import' type='file'/></div></div>");b.widget("interstate.component_list",{options:{info_servers:!1,editor:!1},_create:function(){var a=this.option("info_servers").get();this.$program_names=c(function(){return a.programs.get()}),this.$component_names=c(function(){return a.components.get()}),this.$loaded_program=c(function(){return a.loaded_program.get()}),this.$dirty_program=c(function(){return a.dirty_program.get()}),this.$dirty_program=c(function(){return a.dirty_program.get()}),this.$new_program=c(!1),this.$dragging=this.option("editor").getDraggingClientConstraint(),this._addContentBindings(),this._addClassBindings()},_destroy:function(){this._removeContentBindings(),this._removeClassBindings(),this._super()},_addClassBindings:function(){this.element.addClass("component_list")},_removeClassBindings:function(){},_addContentBindings:function(){this.element.on("confirm_value",d.bind(function(a){var c;if("create"===this.__next_action)c="create_program";else{if("saveAs"!==this.__next_action)return;c="save_curr_as"}var d=new b.Event(c);d.name=a.value,this.element.trigger(d),this.$new_program.set(!1),delete this.__next_action},this)).on("cancel_value",d.bind(function(){this.$new_program.set(!1)},this)),e({programs:this.$program_names,components:this.$component_names,cancel_newprog:d.bind(function(a){return b(".new_prog > textarea",this.element).editing_text("cancel"),a.preventDefault(),a.stopPropagation(),this.$new_program.set(!1),!1},this),new_program:this.$new_program,dirty_program:this.$dirty_program,disable_save_btn:this.$dirty_program.not().or(this.$new_program),createNewSketch:d.bind(function(){this.__next_action="create",this.$new_program.set(!0)},this),saveSketch:d.bind(function(){var a=new b.Event("save_curr");this.element.trigger(a)},this),saveSketchAs:d.bind(function(){this.__next_action="saveAs",this.$new_program.set(!0)},this),getWidgetItemOptions:d.bind(function(a,b){return{name:a,selected:this.$loaded_program.eqStrict(a),storage_type:b,hover_tip:"component"===b?"drag & drop in":"",editor:this.option("editor")}},this),getDefaultSketchName:d.bind(function(){for(var a=this.$program_names.get(),b="sketch_"+(a.length+1),c=1,d=b;a.indexOf(d)>=0;)d=b+"_"+c,c++;return d},this),onImport:d.bind(function(a){var c=a.target.files||a.dataTransfer.files;if(c&&c.length>0){var e=c.length-1;d.each(c,function(a,c){var f=new FileReader;f.onload=d.bind(function(){var g=f.result,h=a.name;d.defer(d.bind(function(){var a=new b.Event("load_saved_file");a.filecontents=g,a.filename=h,a.also_load=e===c,this.element.trigger(a)},this)),delete f.onload,f=null},this),f.readAsText(a)},this)}},this),dragoverComponent:d.bind(function(a){return a.preventDefault(),a.stopPropagation(),!1},this),dragoutComponent:d.bind(function(a){return a.preventDefault(),a.stopPropagation(),!1},this),dragEnterComponent:d.bind(function(a){return a.preventDefault(),a.stopPropagation(),!1},this),dragLeaveComponent:d.bind(function(a){return a.preventDefault(),a.stopPropagation(),!1},this)},this.element)},_removeContentBindings:function(){c.destroyTemplate(this.element)},save_curr:function(a){var c=b("<input type='text'>").insertBefore(a.target).focus();c.on("blur",function(){c.remove()}).on("keydown",d.bind(function(a){if(13===a.keyCode){var d=c.val();if(d.length>0){var e=new b.Event("save_curr");e.name=d,e.storage_type="",this.element.trigger(e)}c.remove()}else 27===a.keyCode&&c.remove()},this))},show_drag_over:function(){b(this.element).addClass("drop_target"),this.hasOwnProperty("overlay")||(this.overlay=b("<div />").addClass("overlay").css({"background-color":"#555",opacity:"0.8",position:"absolute",width:"100%",height:"100%","pointer-events":"none",border:"10px dashed #DDD","box-sizing":"border-box"}).prependTo(this.element))},hide_drag_over:function(){b(this.element).removeClass("drop_target"),this.overlay.remove(),delete this.overlay}}),c.registerCustomPartial("widgetItem",{createNode:function(a){return b("<div />").component_item(a)},destroyNode:function(a){b(a).component_item("destroy")}});var f=c.createTemplate("<div data-name='{{name}}' data-cjs-on-click='load_program'>{{#fsm name_edit_state}}{{#state idle}}{{name}}<span class='hover_tip'>{{hover_tip}}</span>{{#state editing}}{{>editing_text name 'input'}}{{/fsm}}</div>{{#if show_menu}}<ul class='menu'><li class='menu-item' data-action='export'>Export</li><li class='menu-item' data-action='delete'>Delete</li><li class='menu-item' data-action='rename'>Rename</li></ul>{{/if}}");b.widget("interstate.component_item",{options:{name:"",selected:!1,storage_type:"",hover_tip:"",editor:!1},_create:function(){this.$name=this.option("name"),this.$selected=this.option("selected"),this.$dragging=this.option("editor").getDraggingClientConstraint();var a=this.element;this.name_edit_state=c.fsm("idle","editing").startsAt("idle").addTransition("editing","idle",function(b){a.on("confirm_value",b)}).addTransition("editing","idle",function(b){a.on("cancel_value",b)}).on("editing->idle",function(a){"confirm_value"===a.type&&this._emit_new_name(a.value)},this),"component"===this.option("storage_type")&&this.element.attr("draggable",!0).on("dragstart.ondragstart",d.bind(this.on_drag_start,this)),this._addMenu(),this._addContentBindings(),this._addClassBindings()},_destroy:function(){this._removeContentBindings(),this._removeClassBindings(),this._removeMenu(),this._super()},_addMenu:function(){this.$show_menu=c(!1),this.menu_state=c.fsm("hidden","holding","on_release","on_click").addTransition("hidden","holding",c.on("contextmenu",this.element[0])).addTransition("holding","on_click",c.on("mouseup")).addTransition("holding","on_release",c.on("timeout",500)).addTransition("holding","hidden",c.on("keydown").guard("keyCode",27)).addTransition("on_click","hidden",c.on("keydown").guard("keyCode",27)).addTransition("on_release","hidden",c.on("keydown").guard("keyCode",27)).startsAt("hidden");var a=this.menu_state.addTransition("holding","hidden"),e=this.menu_state.addTransition("on_release","hidden"),f=this.menu_state.addTransition("on_click","hidden");this.menu_state.on("hidden->holding",function(a){this.$show_menu.set(!0),a.stopPropagation(),a.preventDefault();this.element.position();return!1},this);var g=function(){b(window).add("ul.menu > li",this.element).off(".menu_item"),b("ul.menu > li",this.element).on("click.menu_item",d.bind(function(a){this.on_menu_action(a.target.getAttribute("data-action")),f(a),a.stopPropagation(),a.preventDefault()},this)),b(window).on("mousedown.menu_item",function(a){b(a.target).parents().is(b("ul.menu",this.element))||(f(a),a.stopPropagation(),a.preventDefault())})},h=function(){b("ul.menu > li",this.element).on("mouseup.menu_item",d.bind(function(b){this.on_menu_action(b.target.getAttribute("data-action")),a(b),e(b),b.stopPropagation(),b.preventDefault()},this)),b(window).on("mouseup.menu_item",function(c){b(c.target).parents().is(b("ul.menu",this.element))||(a(c),e(c),c.stopPropagation(),c.preventDefault())})},i=function(){this.menu_state.off("on_click",g,this).off("holding",h,this).off("hidden",i,this),this.$show_menu.set(!1),b(window).add("ul.menu > li",this.element).off(".menu_item")};this.menu_state.on("on_click",g,this),this.menu_state.on("holding",h,this),this.menu_state.on("hidden",i,this)},_removeMenu:function(){b("ul.menu > li",this.element).off(".menu_item"),b(window).off(".menu_item"),this.menu_state.destroy(),this.$show_menu.destroy()},_emit_new_name:function(a){if(a.length>0){var d=new b.Event("rename_storage");d.from_name=c.get(this.$name),d.to_name=a,d.storage_type=this.option("storage_type"),this.element.trigger(d)}},_addContentBindings:function(){f({name:this.$name,selected:this.$selected,show_menu:this.$show_menu,load_program:d.bind(function(a){if(!this.option("type")){var c=new b.Event("load_program");c.storage_type=this.option("storage_type"),c.name=b(a.target).attr("data-name"),this.element.trigger(c)}},this),hover_tip:this.option("hover_tip"),name_edit_state:this.name_edit_state},this.element)},begin_rename:function(){this.name_edit_state._setState("editing")},_removeContentBindings:function(){c.destroyTemplate(this.element)},_addClassBindings:function(){this._cssBinding=c.bindClass(this.element,"program","entry",this.$selected.iif("selected",""),this.$show_menu.iif("menuized",""))},_removeClassBindings:function(){this._cssBinding.destroy()},on_menu_action:function(a){var d;"delete"===a?(d=new b.Event("remove_storage"),d.name=c.get(this.$name),d.storage_type=this.option("storage_type"),this.element.trigger(d)):"rename"===a?this.begin_rename():"export"===a&&(d=new b.Event("download_program"),d.name=c.get(this.$name),d.storage_type=this.option("storage_type"),this.element.trigger(d))},on_drag_start:function(a){this.element.addClass("dragging");var c=this.option("name");this.$dragging.set(c),a.preventDefault(),a.stopPropagation();var e=!1,f=!1,g=function(a){f=2*a.offsetY>e.height()?"below":"above",e.addClass("above"===f?"dragtop":"dragbottom"),e.removeClass("above"===f?"dragbottom":"dragtop")},h=function(){e=b(this),e.addClass("dragtop"),e.on("mousemove",g)},i=function(){e&&(e.removeClass("dragtop dragbottom"),e.off("mousemove",g),e=!1)
},j=d.bind(function(){if(this.$dragging.set(!1),k.off("mouseover",h),k.off("mouseout",i),b(window).off("mouseup",j),this.element.removeClass("dragging"),e){{var a,d;this.option("obj"),this.option("name")}e.is("tr.no_children")?(d=e.parents(".col").column("option","client"),a=!1):(d=e.prop("option","obj"),a=e.prop("option","name")),e.removeClass("dragtop dragbottom"),e.off("mousemove",g),e=!1;var l=new b.Event("copy_component");l.name=c,l.target_obj_id=d.obj_id,l.above_below=f,this.element.trigger(l)}},this),k=b("tr.child").not(".inherited").add("tr.no_children");k.on("mouseover",h),k.on("mouseout",i),b(window).on("mouseup",j)}})}(interstate,jQuery),function(a,b){"use strict";var c=a.cjs,d=a._,e=c.createTemplate("{{#each columns}}{{> col getColumnOptions(this, @index) }}{{/each}}");c.registerCustomPartial("navigator",{createNode:function(a){return b("<div />").navigator(a)},destroyNode:function(a){b(a).navigator("destroy")},onAdd:function(a,c){b(a).data("interstate-navigator")||b(a).navigator(c)},onRemove:function(a){b(a).navigator("destroy")}}),b.widget("interstate.navigator",{options:{root_client:!1,single_col:!1,client_socket:!1,editor:!1,height:!1},_create:function(){var a=this.option("root_client");a.signal_interest(),this.$columns=c([a]),this.$selected_column=this.$columns.itemConstraint(c(d.bind(this.$columns.length,this.$columns)).sub(1)),this.element.on("child_select.nav",d.bind(this.on_child_select,this)).on("header_click.nav",d.bind(this.on_header_click,this)).on("open_cobj.nav",d.bind(this.open_cobj,this)),this._add_content_bindings(),this._add_class_bindings(),this._add_destroy_check()},_destroy:function(){var a=this.option("root_client");this.element.off(".nav"),this._remove_class_bindings(),this._remove_content_bindings(),this._remove_destroy_check(),a.signal_destroy(),this._super()},_setOption:function(a,b){this._super(a,b)},_add_content_bindings:function(){var a=this.option("client_socket");e({columns:this.$columns,getColumnOptions:d.bind(function(b,c){return{client:b,client_socket:a,is_curr_col:this.$selected_column.eqStrict(b),columns:this.$columns,column_index:c,editor:this.option("editor")}},this)},this.element)},_remove_content_bindings:function(){c.destroyTemplate(this.element)},_add_class_bindings:function(){this.element.attr("id","obj_nav"),this._height_binding=c.bindCSS(this.element,"height",this.option("height").add("px"))},_remove_class_bindings:function(){this.element.attr("id",""),this._height_binding.destroy()},_add_destroy_check:function(){var a=[],b=d.bind(function(a){var b=this.$columns.indexOf(a);this.$columns.splice(b,this.$columns.length()-b)},this);this._destroy_check_fn=c.liven(function(){d.each(a,function(a){a.off("begin_destroy",b)},this);var c=this.$columns.toArray();d.each(c,function(a){a.on("begin_destroy",b)},this),a=c},{context:this})},_remove_destroy_check:function(){this._destroy_check_fn.destroy()},on_child_select:function(c,d){if(d instanceof a.WrapperClient&&("dict"===d.type()||"stateful"===d.type())){var e=this.$columns.indexOf(d);if(e>=0)this.$columns.splice(e,this.$columns.length()-e);else{var f=b(c.target).column("option","client");e=this.$columns.indexOf(f),this.$columns.splice(e+1,this.$columns.length()-e-1,d)}}else this.on_header_click(c,b(c.target).column("option","client"))},on_header_click:function(a,b){var c=this.$columns.indexOf(b);c>=0&&this.$columns.splice(c+1,this.$columns.length()-c-1)},open_cobj:function(a){var b=this.option("client_socket"),c=a.cobj_id;b.once("get_ptr_response",function(a){if(a.cobj_id===c){var e=a.cobjs,f=d.map(e,function(a){return b.get_wrapper_client(a)});this.$columns.setValue(f)}},this),b.post({type:"get_ptr",cobj_id:c})}})}(interstate,jQuery),function(a,b){"use strict";var c=a.cjs,d=a._,e=c.createTemplate("{{#if show_instructions}}<div class='instructions'>Drop here to pin</div>{{#else}}{{#if columns.length()>0}}<div class='resize_bar' data-cjs-on-mousedown=beginResize />{{/if}}<div class='pinned_cols'>{{#each columns}}{{> col getColumnOptions(this, @index) }}{{/each}}</div>{{/if}}");c.registerCustomPartial("pinned",{createNode:function(a){return b("<div />").pinned(a)},destroyNode:function(a){b(a).pinned("destroy")},onAdd:function(a,c){b(a).data("interstate-pinned")||b(a).pinned(c)},onRemove:function(a){b(a).pinned("destroy")}}),b.widget("interstate.pinned",{options:{single_col:!1,client_socket:!1,editor:!1,root_client:!1,columns:!1},_create:function(){this.$columns=this.option("columns"),this.$dragging=this.option("editor").getDraggingClientConstraint(),this.$show_instructions=c(function(){return 0===this.$columns.length()?this.$dragging.get():!1},{context:this}),this.element.on("child_select.nav",d.bind(this.on_child_select,this)).on("close_column.nav",d.bind(this.on_close_col,this)).on("prev_column.nav",d.bind(this.on_prev_col,this)).on("open_cobj.nav",d.bind(this.open_cobj,this)),this._add_content_bindings(),this._add_class_bindings(),this._add_destroy_check(),this.element.on("dragover",d.bind(this.dragoverComponent,this)).on("dragout",d.bind(this.dragoutComponent,this)).on("dragenter",d.bind(this.dragEnterComponent,this)).on("dragleave",d.bind(this.dragLeaveComponent,this))},_destroy:function(){this.element.off(".nav"),this._remove_class_bindings(),this._remove_content_bindings(),this._remove_destroy_check(),this._super()},_setOption:function(a,b){this._super(a,b)},_add_content_bindings:function(){var a=this.option("client_socket");e({columns:this.$columns,getColumnOptions:d.bind(function(b){return{client:b,client_socket:a,is_curr_col:c(!0),editor:this.option("editor"),pinned:!0}},this),show_instructions:this.$show_instructions,beginResize:d.bind(function(a){a.clientY;b(window).on("mousemove.resize_pinned",d.bind(function(a){var c=new b.Event("resize_pinned");c.clientY=a.clientY,this.element.trigger(c)},this)).on("mouseup.resize_pinned",d.bind(function(){b(window).off(".resize_pinned")},this)),a.preventDefault(),a.stopPropagation()},this)},this.element)},_remove_content_bindings:function(){c.destroyTemplate(this.element)},_add_class_bindings:function(){this.element.attr("id","pinned"),this._height_binding=c.bindCSS(this.element,"height",this.option("height").add("px"))},_remove_class_bindings:function(){this._height_binding.destroy(),this.element.attr("id","")},_add_destroy_check:function(){var a=[],b=d.bind(function(a){var b=this.$columns.indexOf(a);this.$columns.splice(b,this.$columns.length()-b)},this);this._destroy_check_fn=c.liven(function(){d.each(a,function(a){a.off("begin_destroy",b)},this);var c=this.$columns.toArray();d.each(c,function(a){a.on("begin_destroy",b)},this),a=c},{context:this})},_remove_destroy_check:function(){this._destroy_check_fn.destroy()},on_child_select:function(c,d){if(d instanceof a.WrapperClient&&("dict"===d.type()||"stateful"===d.type())){var e=b(c.target).index();e>=0&&this.$columns.splice(e,1,d)}},on_close_col:function(a){var c=b(a.target).index();c>=0&&this.$columns.splice(c,1)},on_prev_col:function(a){var c=b(a.target).column("option","client"),d=b(a.target).index();if(d>=0){var e=this.option("client_socket"),f=c.cobj_id;e.once("get_ptr_response",function(a){if(a.cobj_id===f){var b=a.cobjs;if(b.length>1){var c=e.get_wrapper_client(b[b.length-2]);this.$columns.splice(d,1,c)}}},this),e.post({type:"get_ptr",cobj_id:f})}},addClient:function(a){this.$columns.unshift(a)},open_cobj:function(a){var c=b(a.target).parents(".col").index();if(c>=0){var d=this.option("client_socket"),e=a.cobj_id;d.once("get_ptr_response",function(a){if(a.cobj_id===e){var b=a.cobjs,f=d.get_wrapper_client(b[b.length-1]);this.$columns.splice(c,1,f)}},this),d.post({type:"get_ptr",cobj_id:e})}},dragoverComponent:d.bind(function(a){return a.preventDefault(),a.stopPropagation(),!1},this),dragoutComponent:d.bind(function(a){return a.preventDefault(),a.stopPropagation(),!1},this),dragEnterComponent:d.bind(function(a){return a.preventDefault(),a.stopPropagation(),!1},this),dragLeaveComponent:d.bind(function(a){return a.preventDefault(),a.stopPropagation(),!1},this)})}(interstate,jQuery),function(a,b){"use strict";var c=a.cjs,d=a._;c.registerCustomPartial("col",{createNode:function(a){return b("<table />").column(a)},destroyNode:function(a){b(a).column("destroy")}});var e=c.createTemplate("<tbody><tr class='header'><th colspan={{num_curr_values+1}} class='obj_name'>{{#if pinned && !is_root}}<span title='Previous' data-cjs-on-click='prev_col' class='prev_btn glyphicon glyphicon-chevron-left'/>{{/if}}<h2 data-cjs-on-mouseover='headerMOver' data-cjs-on-mouseout='headerMOut' data-cjs-on-click='headerClicked'>{{ci}}{{name}}{{#if is_template}}[{{curr_copy_index}}]{{/if}}</h2>{{#if pinned}}<span title='Close' data-cjs-on-click='close_col' class='close_btn glyphicon glyphicon-remove'/>{{/if}}</th>{{#if stateful}}<th rowspan='{{is_template ? 4 : 3}}' class='statechart_cell'>{{#if is_curr_col}}{{statechart_view}}{{/if}}</th>{{#else}}<th rowspan='2'></th>{{/if}}</tr>{{#if is_curr_col}}{{#if stateful}}<tr class='copies_spec'><td colspan='{{num_curr_values+1}}' class='copies_spec'><span class='copies_label'>Copies: </span>{{> propCell getCopiesCellOptions() }}</td></tr>{{/if}}<tr class='add_prop'><td colspan='{{num_curr_values+1}}' class='add_prop'><div class='add_prop' data-cjs-on-click=addProperty>Add Field</div></td></tr>{{#if is_template}}<tr class='switch_copy'><td></td>{{#if show_prev_value}}<td class='prev_copy' data-cjs-on-mouseover='prevMOver' data-cjs-on-mouseout='prevMOut' data-cjs-on-click='selectPrevClient'><span class='glyphicon glyphicon-chevron-left'></span></td>{{/if}}<td class='curr_copy' data-cjs-on-mouseover='currMOver' data-cjs-on-mouseout='currMOut'>copy {{curr_copy_index+1}} of {{num_instances}}</td>{{#if show_next_value}}<td class='next_copy' data-cjs-on-mouseover='nextMOver' data-cjs-on-mouseout='nextMOut' data-cjs-on-click='selectNextClient'><span class='glyphicon glyphicon-chevron-right'></span></td>{{/if}}</tr>{{/if}}{{/if}}{{#each builtins}}{{>prop getPropertyViewOptions(this, true)}}{{/each}}{{#if adding_field&&is_curr_col}}<tr class='new_field'><td class='name'><input placeholder='Field name' class='name' /></td><td class='type'><select class='type'><option value='stateful'>Object</option><option value='stateful_prop'>Property</option></select></td><td class='confirm_field'><a href='javascript:void(0)'>OK</a></td></tr>{{/if}}{{#each children}}{{>prop getPropertyViewOptions(this)}}{{#else}}{{#if !adding_field && builtins.length===0}}<tr class='no_children'><td colspan='{{num_curr_values+2}}'>No fields</td></tr>{{/if}}{{/each}}</tbody>");b.widget("interstate.column",{options:{client:!1,prev_col:!1,show_prev:!1,is_curr_col:!1,show_source:!0,curr_copy_client:!1,client_socket:!1,selected_prop_name:!1,curr_copy_index:!1,close_button:!1,columns:!1,column_index:-1,editor:!1,pinned:!1},_create:function(){var e=this.option("client");e.signal_interest(),this.element.attr("draggable",!0),this.$dragging=this.option("editor").getDraggingClientConstraint();var f=this.option("editor").root_client;if(this.is_root=e===f,this.$adding_field=c(!1),this.$selected_prop=this.option("pinned")?c(!1):this.option("columns").itemConstraint(this.option("column_index")+1),this.$is_curr_col=this.option("is_curr_col"),this.$name=e.get_$("get_name"),this.$copies_obj=e.get_$("copies_obj"),this.$is_template=e.get_$("is_template"),this.$instances=e.get_$("instances"),this.$num_instances=this.$instances.prop("length"),this.$curr_copy_index=c(0),this.$curr_copy_client=c(function(){if(this.$is_template.get()){var a=this.$instances.get(),b=this.$curr_copy_index.get();return a[b]?a[b]:!1}return e},{context:this}),this.$prev_copy_client=c(function(){if(this.$is_template.get()){var a=this.$instances.get(),b=this.$curr_copy_index.get()-1;if(a[b])return a[b]}return!1},{context:this}),this.$next_copy_client=c(function(){if(this.$is_template.get()){var a=this.$instances.get(),b=this.$curr_copy_index.get()+1;if(a[b])return a[b]}return!1},{context:this}),this.$show_prev_value=c(this.$prev_copy_client),this.$show_next_value=c(this.$next_copy_client),this.$num_curr_values=this.$is_template.iif(this.$prev_copy_client.iif(2,1).add(this.$next_copy_client.iif(1,0)),1),this.$column_info=a.indirectClient(this.$curr_copy_client,["children",!0],"builtin_children"),this.$children=this.$column_info.itemConstraint("children"),this.$builtins=this.$column_info.itemConstraint("builtin_children"),"stateful"===e.type()){this.$statecharts=a.indirectClient(this.$curr_copy_client,"get_statecharts");var g=[],h=[],i=[];this.statechart_view=b("<div />").statechart({statecharts:g,client:this.$curr_copy_client}),this.layout_manager=this.statechart_view.statechart("get_layout_manager"),this.sc_live_fn=c.liven(function(){var b=i;i=this.$statecharts.get()||[];var c=d.diff(b,i,function(a,b){return a.object_summary.id===b.object_summary.id});d.forEach(c.removed,function(a){{var b=a.from,c=(a.from_item,h[b]);g[b]}c.signal_destroy(),h.splice(b,1),g.splice(b,1)},this),d.forEach(c.added,function(b){var c=b.to,d=b.item,e=d,f=a.create_remote_statechart(e);h.splice(c,0,e),e.signal_interest(),g.splice(c,0,f)},this),d.forEach(c.moved,function(a){var b=a.from,c=a.to,d=(a.item,g[b]);g.splice(b,1),g.splice(c,0,d)},this),(c.added.length>0||c.removed.length>0||c.moved.length>0)&&this.statechart_view.statechart("option","statecharts",g)},{context:this,on_destroy:function(){d.each(h,function(a){a.signal_destroy()})}})}this._add_content_bindings(),this._add_class_bindings(),this.element.on("expand.on_child_select",d.bind(this.on_child_select,this))},_destroy:function(){var a=this.option("client");this._remove_class_bindings(),this._remove_content_bindings(),this.$statecharts&&(this.statechart_view.statechart("destroy"),this.sc_live_fn.destroy(),this.$statecharts.destroy()),this.$curr_copy_client.destroy(),this.$prev_copy_client.destroy(),this.$next_copy_client.destroy(),this.$is_template.signal_destroy(),this.$is_curr_col.destroy(),this.$name.signal_destroy(),this.$instances.signal_destroy(),this.$copies_obj.signal_destroy(),this.$children.destroy(),this.$builtins.destroy(),this.$column_info.destroy(),a.signal_destroy(),this._super()},_add_content_bindings:function(){var a=this.option("client");e({name:this.$name,children:this.$children,builtins:this.$builtins,stateful:"stateful"===a.type(),is_template:this.$is_template,getPropertyViewOptions:d.bind(function(a){return{client:a.value,name:a.name,inherited:a.inherited,builtin:a.builtin,layout_manager:this.layout_manager,show_src:this.$is_curr_col,obj:this.option("client"),client_socket:this.option("client_socket"),statechart_view:this.statechart_view,selected:this.$selected_prop.eqStrict(a.value),prev:this.$prev_copy_client,next:this.$next_copy_client,editor:this.option("editor")}},this),statechart_view:this.statechart_view,is_curr_col:this.$is_curr_col,headerClicked:d.bind(this.on_header_click,this),close_col:d.bind(this.close_col,this),prev_col:d.bind(this.prev_col,this),addProperty:d.bind(this._add_property,this),adding_field:this.$adding_field,getCopiesCellOptions:d.bind(function(){return{client:c.constraint(this.$copies_obj)}},this),num_curr_values:this.$num_curr_values,curr_copy_index:this.$curr_copy_index,show_prev_value:this.$show_prev_value,show_next_value:this.$show_next_value,selectPrevClient:d.bind(function(){this.$curr_copy_index.set(this.$curr_copy_index.get()-1)},this),selectNextClient:d.bind(function(){this.$curr_copy_index.set(this.$curr_copy_index.get()+1)},this),num_instances:this.$num_instances,pinned:this.option("pinned"),is_root:this.is_root,headerMOver:d.bind(function(){var a=this.$curr_copy_client.get(),c=new b.Event("add_highlight");c.client=a,this.element.trigger(c)},this),headerMOut:d.bind(function(){var a=this.$curr_copy_client.get(),c=new b.Event("remove_highlight");c.client=a,this.element.trigger(c)},this),prevMOver:d.bind(function(){var a=this.$prev_copy_client.get(),c=new b.Event("add_highlight");c.client=a,this.element.trigger(c)},this),prevMOut:d.bind(function(){var a=this.$prev_copy_client.get(),c=new b.Event("remove_highlight");c.client=a,this.element.trigger(c)},this),nextMOver:d.bind(function(){var a=this.$next_copy_client.get(),c=new b.Event("add_highlight");c.client=a,this.element.trigger(c)},this),nextMOut:d.bind(function(){var a=this.$next_copy_client.get(),c=new b.Event("remove_highlight");c.client=a,this.element.trigger(c)},this),currMOver:d.bind(function(){var a=this.$curr_copy_client.get(),c=new b.Event("add_highlight");c.client=a,this.element.trigger(c)},this),currMOut:d.bind(function(){var a=this.$curr_copy_client.get(),c=new b.Event("remove_highlight");c.client=a,this.element.trigger(c)},this)},this.element),this._select_just_added_name=c.liven(function(){var a=this.$children.get();if(this._just_added_prop_name)for(var b,c=0;c<a.length;c++)if(b=a[c],b.name===this._just_added_prop_name)return this._trigger_child_select(b.value),void delete this._just_added_prop_name},{context:this})},_remove_content_bindings:function(){c.destroyTemplate(this.element)},_add_class_bindings:function(){this._class_binding=c.bindClass(this.element,"col",this.$is_curr_col.iif("curr_col"),this.$is_template.iif("template"))},_remove_class_bindings:function(){this._class_binding.destroy()},_setOption:function(a,b){this._super(a,b),"is_curr_col"===a&&this.$is_curr_col.set(b)},close_col:function(a){a.stopPropagation(),a.preventDefault();var c=new b.Event("close_column");this.element.trigger(c)},prev_col:function(a){a.stopPropagation(),a.preventDefault();var c=new b.Event("prev_column");this.element.trigger(c)},on_header_click:function(a){this.element.trigger("header_click",this.option("client")),a.stopPropagation(),a.preventDefault()},on_child_select:function(a){if(a&&b(a.target).hasClass("selected"))this.on_header_click(a);else{var c=b(a.target),d=c.data("interstate-prop")?c.prop("option","client"):!1;this._trigger_child_select(d)}},_trigger_child_select:function(a){this.element.trigger("child_select",a)},_add_property:function(){for(var a=d.pluck(this.$children.get(),"name"),c="field_"+(a.length+1),e=c,f=1,g=this.option("client");a.indexOf(e)>=0;)e=c+"_"+f,f++;this.$adding_field.set(!0),b("select.type",this.element).val("stateful"===g.type()?"stateful_prop":"stateful"),b(".new_field input.name",this.element).val(e).select().focus();var h,i=d.bind(function(){b("select.type,input",this.element).off(".addfield"),clearTimeout(h);var a=new b.Event("command");a.command_type="add_property",a.client=this.option("client"),this._just_added_prop_name=a.prop_name=b(".new_field input.name",this.element).val(),window.setTimeout(d.bind(function(){delete this._just_added_prop_name},this),200),a.prop_type=b("select.type",this.element).val(),this.element.trigger(a),this.$adding_field.set(!1)},this),j=d.bind(function(){b("select.type,input",this.element).off(".addfield"),this.$adding_field.set(!1)},this);b("select.type,input",this.element).on("blur.addfield",function(a){a.preventDefault(),a.stopPropagation(),h=setTimeout(function(){i()},50)}).on("focus.addfield",function(){clearTimeout(h)}).on("keydown.addfield",function(a){13===a.keyCode?i():27===a.keyCode&&j()})}})}(interstate,jQuery),function(a,b){"use strict";var c=a.cjs,d=a._;c.registerCustomPartial("prop",{createNode:function(a){return b("<tr />").prop(a)},destroyNode:function(a){b(a).prop("destroy")}});var e=c.createTemplate("<td data-cjs-on-mouseover='propMOver' data-cjs-on-mouseout='propMOut' class='name'>{{#fsm name_edit_state}}{{#state idle}}<span>{{ prop_name }}</span>{{#state editing}}{{>editing_text prop_name 'input'}}{{/fsm}}{{#if show_menu}}<ul class='menu'><li class='menu-item' data-action='change_type'>Change to {{ (type === 'stateful_prop' || type==='cell') ? 'object' : 'property'}}</li><li class='menu-item' data-action='delete'>Delete</li><li class='menu-item' data-action='rename'>Rename</li></ul>{{/if}}</td>{{#if show_prev_value}}{{> valueSummary getPrevValueSummaryOptions() }}{{/if}}{{> valueSummary getValueSummaryOptions() }}{{#if show_next_value}}{{> valueSummary getNextValueSummaryOptions() }}{{/if}}{{#if show_src}}{{#if type==='stateful_prop'}}<td class='stateful_prop src'>{{#each propValues}}{{> propCell getPropCellOptions(@key) }}{{/each}}</td>{{#elif type==='cell'}}<td class='src'>{{> propCell getPurePropCellOptions() }}</td>{{#else}}<td class='cannot_modify src' />{{/if}}{{/if}}");b.widget("interstate.prop",{options:{name:"",client:!1,inherited:!1,builtin:!1,layout_manager:!1,show_src:!1,obj:!1,client_socket:!1,selected:!1,prev:!1,next:!1},_create:function(){var b=this.option("client");this.$dragging=this.option("editor").getDraggingClientConstraint(),this.$prop_name=c(this.option("name")),this.$inherited=c(this.option("inherited")),this.$show_src=this.option("show_src"),this.$selected=this.option("selected"),this.$prev_dict_client=this.option("prev"),this.$next_dict_client=this.option("next"),this.$show_prev_value=c(this.$prev_dict_client),this.$show_next_value=c(this.$next_dict_client),this.prev_value=a.indirectClient(this.$prev_dict_client,["prop_val",this.option("name")]),this.next_value=a.indirectClient(this.$next_dict_client,["prop_val",this.option("name")]),this.$type=c(function(){return b instanceof a.WrapperClient?b.type():""});var e=this.element;this.name_edit_state=c.fsm("idle","editing").startsAt("idle").addTransition("editing","idle",function(a){e.on("confirm_value.prop",a)}).addTransition("editing","idle",function(a){e.on("cancel_value.prop",a)}).on("editing->idle",function(a){"confirm_value"===a.type&&this._emit_new_name(a.value)},this),this.element.on("click.expand",d.bind(this._trigger_expand,this)),this._add_menu(),this._create_state_map(),this._add_content_bindings(),this._add_class_bindings(),this._add_tooltip(),this.option("inherited")?this.element.on("mousedown.inherit",d.bind(this.inherit,this)):this.element.attr("draggable",!0).on("dragstart.ondragstart",d.bind(this.on_drag_start,this)),b instanceof a.WrapperClient&&b.signal_interest()},_destroy:function(){var b=this.option("client");this.element.off(".prop").off(".inherit .ondragstart .menu_item"),this._remove_tooltip(),this._remove_content_bindings(),this._remove_class_bindings(),this._destroy_state_map(),this._destroy_menu(),b instanceof a.WrapperClient&&b.signal_destroy(),this.$prop_name.destroy(),this.$inherited.destroy(),this.$show_menu.destroy(),this.$type.destroy(),this.name_edit_state.destroy(),this._super()},_add_menu:function(){this.$show_menu=c(!1),this.menu_state=c.fsm("hidden","holding","on_release","on_click"),this.option("builtin")?this.element.on("contextmenu",function(a){a.preventDefault(),a.stopPropagation()}):this.menu_state.addTransition("hidden","holding",c.on("contextmenu",this.element[0])),this.menu_state.addTransition("holding","on_click",c.on("mouseup")).addTransition("holding","on_release",c.on("timeout",500)).addTransition("holding","hidden",c.on("keydown").guard("keyCode",27)).addTransition("on_click","hidden",c.on("keydown").guard("keyCode",27)).addTransition("on_release","hidden",c.on("keydown").guard("keyCode",27)).startsAt("hidden");var a=this.menu_state.addTransition("holding","hidden"),e=this.menu_state.addTransition("on_release","hidden"),f=this.menu_state.addTransition("on_click","hidden");this.menu_state.on("hidden->holding",function(a){this.$show_menu.set(!0),a.stopPropagation(),a.preventDefault();this.element.position();return!1},this);var g=function(){b(window).add("ul.menu > li",this.element).off(".menu_item"),b("ul.menu > li",this.element).on("click.menu_item",d.bind(function(a){this.on_menu_action(a.target.getAttribute("data-action")),f(a),a.stopPropagation(),a.preventDefault()},this)),b(window).on("mousedown.menu_item",function(a){b(a.target).parents().is(b("ul.menu",this.element))||(f(a),a.stopPropagation(),a.preventDefault())})},h=function(){b("ul.menu > li",this.element).on("mouseup.menu_item",d.bind(function(b){this.on_menu_action(b.target.getAttribute("data-action")),a(b),e(b),b.stopPropagation(),b.preventDefault()},this)),b(window).on("mouseup.menu_item",function(c){b(c.target).parents().is(b("ul.menu",this.element))||(a(c),e(c),c.stopPropagation(),c.preventDefault())})},i=function(){this.menu_state.off("on_click",g,this).off("holding",h,this).off("hidden",i,this),this.$show_menu.set(!1),b(window).add("ul.menu > li",this.element).off(".menu_item")};this.menu_state.on("on_click",g,this),this.menu_state.on("holding",h,this),this.menu_state.on("hidden",i,this)},_destroy_menu:function(){b(window).add("ul.menu > li",this.element).off(".menu_item").remove(),this.menu_state.destroy(),this.$show_menu.destroy()},on_menu_action:function(a){d.defer(d.bind(function(){if("delete"===a){var c=new b.Event("command");c.command_type="unset",c.name=this.$prop_name.get(),c.client=this.option("obj"),this.element.trigger(c)}else if("rename"===a)this.begin_rename();else if("change_type"===a){var d=this.option("client"),e=d.type(),f=this.option("obj"),g=f.type(),h="cell"===e||"stateful_prop"===e?"stateful":"stateful"===g?"stateful_prop":"cell";this._change_type(h)}},this))},begin_rename:function(){this.name_edit_state._setState("editing")},_add_tooltip:function(){var b=this.option("client");b instanceof a.WrapperClient&&"stateful_prop"===b.type()&&(this.$runtime_errors=b.get_$("get_runtime_errors"),this.element.tooltip({position:{my:"center bottom-1",at:"center top"},show:!1,hide:!1,content:""}),this._tooltip_live_fn=c.liven(function(){var a=this.$runtime_errors.get();if(a&&a.length>0){var b=a[0];this.element.addClass("error").attr("title",b).tooltip("option",{tooltipClass:"error",content:b})}else this.element.removeClass("error").attr("title","").tooltip("option",{tooltipClass:"",content:""})},{context:this,on_destroy:function(){this.element.tooltip("destroy")}}))},_remove_tooltip:function(){this._tooltip_live_fn&&(this._tooltip_live_fn.destroy(),delete this._tooltip_live_fn)},_create_state_map:function(){var b=this.option("client");b instanceof a.WrapperClient&&"stateful_prop"===b.type()&&(this.$states=b.get_$("get_states"),this.$values=b.get_$("get_values"),this.$active_value=b.get_$("active_value"),this.$full_values=c(function(){var a=this.$values.get()||[],b=this.$states.get()||[],c=[];return d.each(b,function(a,b){c[b]=void 0}),d.each(a,function(a){var d=b.indexOf(a.state);c[d]=a.value}),c},{context:this}),this.$prop_values=a.create_key_val_map(this.$states,this.$full_values))},_destroy_state_map:function(){this.$states&&(this.$states.signal_destroy(),this.$values.signal_destroy(),this.$active_value.signal_destroy(),this.$full_values.destroy(),this.$prop_values.destroy())},_add_content_bindings:function(){var a=this.option("layout_manager");e({prop_name:this.$prop_name,name_edit_state:this.name_edit_state,getPrevValueSummaryOptions:d.bind(function(){return{is_primary:!1,client:this.prev_value,itemClass:"prev"}},this),getValueSummaryOptions:d.bind(function(){return{is_primary:!0,client:this.option("client"),itemClass:"primary"}},this),getNextValueSummaryOptions:d.bind(function(){return{is_primary:!1,client:this.next_value,itemClass:"next"}},this),getPurePropCellOptions:d.bind(function(){return{client:c.constraint(this.option("client")),prop:!1}},this),getPropCellOptions:d.bind(function(b){var c=this.$prop_values.itemConstraint(b),d=function(){return a.get_x(b)},e=function(){return c.get()?a.get_width(b):7};return{prop:this.option("client"),state:b,client:c,left:d,width:e,active_value:this.$active_value}},this),show_prev_value:this.$show_prev_value,show_next_value:this.$show_next_value,show_src:this.$show_src,value:this.option("client"),type:this.$type,propValues:this.$prop_values,show_menu:this.$show_menu,propMOver:d.bind(function(){var a=this.option("client"),c=new b.Event("add_highlight");c.client=a,this.element.trigger(c)},this),propMOut:d.bind(function(){var a=this.option("client"),c=new b.Event("remove_highlight");c.client=a,this.element.trigger(c)},this)},this.element)},_remove_content_bindings:function(){c.destroyTemplate(this.element)},_add_class_bindings:function(){this._class_binding=c.bindClass(this.element,"child",this.option("builtin")?"builtin":"",this.$selected.iif("selected",""),this.$inherited.iif("inherited",""),this.$show_menu.iif("menuized",""))},_remove_class_bindings:function(){this._class_binding.destroy()},_setOption:function(a,b){this._super(a,b),"name"===a?this.$prop_name.set(b):"inherited"===a?this.$inherited.set(b):"show_src"===a&&this.$show_src.set(b)},_trigger_expand:function(a){a.stopPropagation(),a.preventDefault(),this.element.not(".selected")&&this.element.trigger("expand")},inherit:function(a){a&&(a.preventDefault(),a.stopPropagation());var c=new b.Event("command");c.command_type="inherit",c.name=this.option("name"),c.client=this.option("client"),this.element.trigger(c)},_emit_new_name:function(c){if(a.is_valid_prop_name(c)){var d=!1,e=this;if(b("span.prop_name",this.element.parent()).each(function(){var a=b(this).parents(".child");a!==e&&a.data("interstate-prop")&&a.prop("option","name")===c&&(d=!0,e.name_span.editable_text("option","text",old_name),window.alert("Property with name '"+c+"' already exists"))}),d)return;var f=new b.Event("command");f.command_type="rename",f.from_name=this.$prop_name.get(),f.to_name=c,f.client=this.option("obj"),f.from_name!==f.to_name&&this.element.trigger(f)}},_change_type:function(a){var c=new b.Event("command");c.command_type="set_type",c.client=this.option("obj"),c.prop_name=this.$prop_name.get(),c.type_name=a,this.element.trigger(c)},on_drag_start:function(a){if(a.preventDefault(),a.stopPropagation(),!this.element.is(".inherited")&&!this.element.is(".builtin")){this.$dragging.set(this.option("client")),this.element.addClass("dragging");var c=!1,e=!1,f=function(a){e=2*a.offsetY>c.height()?"below":"above",c.addClass("above"===e?"dragtop":"dragbottom"),c.removeClass("above"===e?"dragbottom":"dragtop")},g=function(){c=b(this),c.addClass("dragtop"),c.on("mousemove",f)},h=function(){c&&(c.removeClass("dragtop dragbottom"),c.off("mousemove",f),c=!1)},i=d.bind(function(){if(this.$dragging.set(!1),j.off("mouseover",g),j.off("mouseout",h),b(window).off("mouseup",i),this.element.removeClass("dragging"),c){var a,d,k=this.option("obj"),l=this.option("name");c.is("tr.no_children")?(d=c.parents(".col").column("option","client"),a=!1):(d=c.prop("option","obj"),a=c.prop("option","name")),c.removeClass("dragtop dragbottom"),c.off("mousemove",f),c=!1;var m=new b.Event("command");m.command_type="move_prop",m.from_obj=k,m.from_name=l,m.target_obj=d,m.target_name=a,m.above_below=e,this.element.trigger(m)}},this),j=b("tr.child").not(".inherited").add("tr.no_children");j.on("mouseover",g),j.on("mouseout",h),b(window).on("mouseup",i)}}})}(interstate,jQuery),function(a,b){"use strict";var c=a.cjs,d=a._;c.registerCustomPartial("propCell",{createNode:function(a){return b("<span />").prop_cell(a)},destroyNode:function(a){b(a).prop_cell("destroy")}});var e=c.createTemplate("{{#fsm client_state}}{{#state initialedit}}{{>editing_text ''}}{{#state set}}{{#fsm edit_state}}{{#state idle}}{{#if str===''}}<span class='empty'>(empty)</span>{{#else}}{{str}}{{/if}}{{#state editing}}{{>editing_text str}}{{/fsm}}{{/fsm}}");b.widget("interstate.prop_cell",{options:{client:!1,left:void 0,width:0,edit_width:150,unset_radius:7,active:!1,parent:!1,state:!1,prop:!1,default_max_width:90,char_limit:200},_create:function(){var b=this.option("client"),e=this.element;this.client_state=c.fsm("unset","initialedit","set").addTransition("unset","initialedit",c.on("click",this.element)).addTransition("initialedit","set",function(a){e.on("confirm_value.cell",a)}).addTransition("initialedit","unset",function(a){e.on("cancel_value.cell",a)}).on("initialedit->set",function(a){this._set_value_for_state(a.value)},this).on("unset->initialedit",this._emit_begin_editing,this).on("initialedit->*",this._emit_done_editing,this),this.client_state._setState(b.get()?"set":"unset"),b.onChange(function(){this.client_state._setState(b.get()?"set":"unset")},this),this.$cell_info=a.indirectClient(this.option("client"),"get_str","get_syntax_errors"),this.$str=this.$cell_info.itemConstraint("get_str"),this.$syntax_errors=this.$cell_info.itemConstraint("get_syntax_errors"),this.edit_state=c.fsm("idle","editing").startsAt("idle").addTransition("idle","editing",c.on("click",this.element).guard(d.bind(function(){return!!b.get()
},this))).addTransition("editing","idle",function(a){e.on("confirm_value.cell",a)}).addTransition("editing","idle",function(a){e.on("cancel_value.cell",a)}).on("editing->idle",function(a){"confirm_value"===a.type&&this._emit_new_value(a.value)},this),this.$active=c(function(){var a=this.option("active_value"),b=c.get(a),d=b?b.value:!1;return d&&d===c.get(this.option("client"))},{context:this}),this.$left=c(this.option("left")),this.$pure=c(!this.option("prop")),this.$visible=this.$pure.or(this.$left.neq(void 0)),this.do_edit=this.edit_state.addTransition("idle","editing"),this._add_content_bindings(),this._add_tooltip(),this._add_class_bindings(),this._add_position_bindings()},_destroy:function(){var a=this.option("client");this.element.off("confirm_value.cell cancel_value.cell").children().remove(),this._remove_position_bindings(),this._remove_class_bindings(),this._remove_tooltip(),this._remove_content_bindings(),this.$str.destroy(),this.$syntax_errors.destroy(),this.$cell_info.destroy(),this.$active.destroy(),this.$left.destroy(),this.client_state.destroy(),this.$pure.destroy(),this.$visible.destroy(),this.edit_state.destroy(),a.destroy(),this._super()},_emit_new_value:function(a){var d;this.option("prop")&&""===a?(d=new b.Event("command"),d.command_type="unset_stateful_prop_for_state",d.prop=this.option("prop"),d.state=this.option("state"),this.element.trigger(d)):(d=new b.Event("command"),d.command_type="set_str",d.str=a,d.client=c.get(this.option("client")),this.element.trigger(d))},_setOption:function(a,b){this._super(a,b),"left"===a?this.$left.set(b):"width"===a?this.$specified_width.set(b):"active"===a&&this.$active.set(b)},_add_content_bindings:function(){this.edit_state.addTransition("editing","idle"),this.edit_state.addTransition("editing","idle"),e({edit_state:this.edit_state,str:this.$str,client_state:this.client_state},this.element)},_remove_content_bindings:function(){this.element.off("click.start_edit"),c.destroyTemplate(this.element)},_add_class_bindings:function(){this.element.addClass("cell"),this._class_binding=c.bindClass(this.element,this.$active.iif("active",""),this.$pure.iif("pure_cell",""),c.inFSM(this.client_state,{unset:"unset",set:"",initialedit:"editing"}),this.edit_state.state)},_remove_class_bindings:function(){this._class_binding.destroy(),this.element.removeClass("cell")},_add_position_bindings:function(){this.$specified_width=c(this.option("width")),this.$width=c.inFSM(this.edit_state,{idle:c.inFSM(this.client_state,{unset:2*this.option("unset_radius"),set:this.$specified_width,initialedit:this.option("edit_width")}),editing:this.option("edit_width")}),this.$edit_width=c(this.option("edit_width")),this.$z_index=c.inFSM(this.edit_state,{idle:c.inFSM(this.client_state,{unset:0,set:0,initialedit:99}),editing:99}),this.element.css("min-width",this.option("width")),this.position_binding=c.bindCSS(this.element,{left:this.$left.sub(this.$width.div(2)).add("px"),"z-index":this.$z_index,visibility:this.$visible.iif("visible","hidden"),"max-width":c.inFSM(this.edit_state,{idle:c.inFSM(this.client_state,{unset:2*this.option("unset_radius"),set:this.option("default_max_width")+"px",initialedit:"none"}),editing:"none"})})},_remove_position_bindings:function(){d.each([this.$specified_width,this.$width,this.$left,this.$edit_width,this.$z_index,this.$active,this.position_binding],function(a){a.destroy(!0)})},_add_tooltip:function(){this.element.tooltip({position:{my:"center bottom-1",at:"center top"},show:!1,hide:!1,content:""});var a=d.bind(function(){this.element.tooltip("enable")},this),b=d.bind(function(){this.element.tooltip("disable")},this);this._tooltip_live_fn=c.liven(function(){var a=this.$syntax_errors.get();if(a&&a.length>0){var b=a[0];this.element.addClass("error").attr("title",b).tooltip("option",{tooltipClass:"error",content:b})}else{var c=this.$str.get()||"";c.length>this.option("char_limit")&&(c=c.slice(0,this.option("char_limit")-3)+"..."),this.element.removeClass("error").attr("title",c).tooltip("option",{tooltipClass:"cell_text",content:c})}},{context:this,on_destroy:function(){this.element.tooltip("destroy"),this.edit_state.off("idle->editing",b).off("editing->idle",a)}}),this.edit_state.on("idle->editing",b).on("idle->editing",this._emit_begin_editing,this).on("editing->idle",a).on("editing->idle",this._emit_done_editing,this)},_remove_tooltip:function(){this._tooltip_live_fn.destroy(),delete this._tooltip_live_fn},_set_value_for_state:function(a){var c=new b.Event("command");c.command_type="set_stateful_prop_for_state",c.prop=this.option("prop"),c.state=this.option("state"),c.text=a||"",this.element.trigger(c)},_emit_begin_editing:function(){var a=new b.Event("begin_editing_cell");a.initial_val=this.$str.get(),a.textarea=b("textarea",this.element)[0],this.element.trigger(a)},_emit_done_editing:function(){var a=new b.Event("done_editing_cell");this.element.trigger(a)}})}(interstate,jQuery),function(a,b){"use strict";var c=a.cjs,d=a._;b.widget("interstate.copy",{options:{curr_copy:!1,out_of:0,client:!1,displayed:!1},_create:function(){var a=this.option("client");a.signal_interest(),this.left_brace=b("<span />").text(" [").addClass("brace"),this.content=b("<span />"),this.right_brace=b("<span />").text("]").addClass("brace"),this.curr_copy_text=b("<span />").addClass("copy_num"),this.of_text=b("<span />").addClass("of_text"),this.content.append(this.curr_copy_text,this.of_text),this.element.addClass("copy"),this.option("displayed")&&this.on_displayed(),this.content.on("click.on_click",d.bind(this.on_click,this)),this.add_listener()},_destroy:function(){this.destroy_copy_num_input(),this.content.off("click.on_click"),this._super(),this.remove_listener();var a=this.option("client");a.signal_destroy(),delete this.options.client,delete this.options},on_click:function(){this.copy_num_input=b("<input />").attr({type:"number",min:0,max:this.option("out_of")}).val(this.option("curr_copy")).addClass("copy_input").insertBefore(this.content).focus().select().on("blur.on_blur",d.bind(this.on_blur,this)).on("change.on_change",d.bind(this.on_change,this)).on("keydown.on_keydown",d.bind(this.on_key_down,this)),this.original_copy_num=this.option("curr_copy"),this.content.hide()},destroy_copy_num_input:function(){this.copy_num_input&&(this.copy_num_input.off("blur.on_blur").off("change.on_change").off("keydown.on_keydown").remove(),delete this.copy_num_input)},on_blur:function(){this.destroy_copy_num_input(),this.content.show()},on_change:function(){var a=parseInt(this.copy_num_input.val(),10);this.option("curr_copy",a)},on_key_down:function(a){var b=a.originalEvent;13===b.keyCode?(this.on_change(),this.on_blur()):27===b.keyCode&&(this.on_blur(),this.option("curr_copy",this.original_copy_num))},add_listener:function(){var a=this.option("client"),b=a.get_$("is_template"),e=a.get_$("instances");this.copy_listener=c.liven(function(){var a=b.get();if(a){var c=e.get();if(d.isArray(c)){var f=c.length;this.option({displayed:!0,out_of:f-1,curr_copy:Math.min(this.option("curr_copy"),f)})}else this.option({displayed:!1})}else this.option({displayed:!1})},{context:this,on_destroy:function(){b.signal_destroy(),e.signal_destroy()}})},remove_listener:function(){this.copy_listener&&(this.copy_listener.destroy(),delete this.copy_listener)},update_display:function(){this.option("curr_copy")===!1?(this.curr_copy_text.text(""),this.of_text.text(this.option("out_of"))):(this.curr_copy_text.text(this.option("curr_copy")),this.of_text.text(" , length "+(this.option("out_of")+1)))},on_displayed:function(){this.update_display(),this.element.append(this.left_brace,this.content,this.right_brace)},on_not_displayed:function(){this.element.children().remove()},_setOption:function(a,b){var c;("curr_copy"===a||"out_of"===a)&&(c=this.option(a)),this._super(a,b),"displayed"===a?b?this.on_displayed():this.on_not_displayed():("curr_copy"===a||"out_of"===a)&&c!==b&&("curr_copy"===a&&this.element.trigger("curr_copy_change",b),this.update_display())}})}(interstate,jQuery),function(a,b){"use strict";function c(a){return String(a).replace(/[&<>"'\/]/g,function(a){return k[a]})}var d=a.cjs,e=a._;d.registerCustomPartial("valueSummary",{createNode:function(a){return b("<td />").value_summary(a)},destroyNode:function(a){b(a).value_summary("destroy")}});var f=d.createTemplate("{{#if type ==='dict' || type === 'stateful'}}{{#if is_template}}<span class='copies'>[{{num_instances}}]</span>{{/if}}<span class='expand_arrow'>></span>{{#else}}<span>{{{ summarize_val(value, is_primary) }}}</span>{{/if}}"),g=function(a,b){var c=Math.pow(10,b);return Math.round(a*c)/c},h=0/0,i=function(b,d){return e.isString(b)?"(native function)"===b?b:"'"+c(b)+"'":e.isArray(b)?"["+e.map(b,function(a){return i(a,d)}).join(", ")+"]":b instanceof a.WrapperClient?d?"<span class='cobj_link' data-cobj_id='"+b.cobj_id+"'>"+b.colloquial_name+"</span>":"":j.apply(this,arguments)},j=function(b){return e.isString(b)?"(native function)"===b?b:"'"+b+"'":e.isNumber(b)?g(b,2)+"":void 0===b?"undefined":null===b?"null":b===h?"NaN":e.isFunction(b)?"(func)":e.isArray(b)?"["+e.map(b,j).join(", ")+"]":b instanceof a.WrapperClient?b.colloquial_name:b+""};b.widget("interstate.value_summary",{options:{client:!1,is_primary:!0,itemClass:"",char_limit:200},_create:function(){var c=this.option("client");c instanceof a.WrapperClient?(this.$type=c.type(),this.$value=a.indirectClient(c,"val")):(this.$type=!1,this.$value=c),this.$client_info=a.indirectClient(c,"is_template","instances","val"),this.$is_template=this.$client_info.itemConstraint("is_template"),this.$instances=this.$client_info.itemConstraint("instances"),this.$num_instances=this.$instances.prop("length"),this._add_content_bindings(),this._add_class_bindings(),this._add_tooltip(),this.element.on("click.navigate",e.bind(function(a){var c=b(a.target).attr("data-cobj_id");c&&this.element.parents().is(".col.curr_col")&&(this.open_cobj(c),a.preventDefault(),a.stopPropagation())},this))},_destroy:function(){this._remove_tooltip(),this._remove_content_bindings(),this._remove_class_bindings(),this.$num_instances.destroy(),this.$instances.destroy(),this.$is_template.destroy(),this.$client_info.destroy(),this.$value&&this.$value.destroy&&this.$value.destroy(),this._super()},_add_content_bindings:function(){f({is_dict:this.$is_dict,is_template:this.$is_template,num_instances:this.$num_instances,summarize_val:i,value:this.$value,type:this.$type,is_primary:this.option("is_primary")},this.element)},_remove_content_bindings:function(){d.destroyTemplate(this.element)},_add_class_bindings:function(){this.element.addClass("value_summary "+this.option("itemClass"))},_remove_class_bindings:function(){this.element.removeClass("value_summary")},open_cobj:function(a){var c=new b.Event("open_cobj");c.cobj_id=a,this.element.trigger(c)},_add_tooltip:function(){this.element.tooltip({position:{my:"center bottom-1",at:"center top"},show:!1,hide:!1,content:""});e.bind(function(){this.element.tooltip("enable")},this),e.bind(function(){this.element.tooltip("disable")},this);this._tooltip_live_fn=d.liven(function(){var a=this.$type;if("stateful_prop"===a||"cell"===a){var b=j(d.get(this.$value));b.length>this.option("char_limit")&&(b=b.slice(0,this.option("char_limit")-3)+"..."),this.element.attr("title",b).tooltip("option",{tooltipClass:"val_summary",content:b})}},{context:this,on_destroy:function(){this.element.tooltip("destroy")}})},_remove_tooltip:function(){this._tooltip_live_fn.destroy(),delete this._tooltip_live_fn}});var k={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"}}(interstate,jQuery),function(a,b){"use strict";var c=(a.cjs,a._),d=function(a,b,c){a.style.position="absolute";var d=b.attr("text-anchor");a.style.textAlign="start"===d?"left":"middle"===d?"center":"right",a.style.fontFamily=b.attr("font-family"),a.style.fontWeight=b.attr("font-weight"),a.style.fontStyle=b.attr("font-style"),a.style.fontSize=b.attr("font-size")+"px";var e=b.getBBox();a.style.top=e.y+"px",a.style.outline="none",a.style.border="none",a.style.padding="0px",a.style.margin="0px",a.style.boxSizing="border-box",a.style.background=c.fill,a.style.color=c.color};a.EditableText=function(a,d){able.make_this_listenable(this),able.make_this_optionable(this,{x:0,y:0,text:"",width:100,"text-anchor":"middle",animation_duration:600,"default":"",font:"","font-family":"Courier New, Courier","font-size":14,"font-weight":"normal",color:"#000000",default_color:"#AAAAAA",fill:"white","fill-opacity":.7,textbox_background:"white",textbox_color:"black",edit_on_click:!0},d),this.text=a.text(this.option("x"),this.option("y"),this.get_text()).attr({font:this.option("font"),"font-family":this.option("font-family"),"font-size":this.option("font-size"),"font-weight":this.option("font-weight"),"text-anchor":this.option("text-anchor")}),this.show_default()?this.text.attr("fill",this.option("default_color")):this.text.attr("fill",this.option("color"));var e=this.getBBox();this.label_background=a.rect(e.x,e.y,e.width,e.height).insertBefore(this.text),this.label_background.attr({fill:this.option("fill"),"fill-opacity":this.option("fill-opacity"),stroke:"none"}),this.$text=b(this.text[0]).tooltip(),this.$text.on("click.onclick",c.bind(this.onClick,this)),this.paper=a},function(a){var e=a.prototype;able.make_proto_listenable(e),able.make_proto_optionable(e),e.destroy=function(){this.$text.off("click.onclick"),this.$text.tooltip("destroy").remove(),delete this.$text,delete this.text,this.textbox&&(b(this.textbox).off("keydown.onkeydown").off("blur.onblur").remove(),delete this.textbox),able.destroy_this_listenable(this),able.destroy_this_optionable(this)},e.get_raphael_object=function(){return this.text},e.toFront=function(){this.label_background.toFront(),this.text.toFront()},e.show_default=function(){return""===this.option("text")},e.get_text=function(){return this.option(this.show_default()?"default":"text")},e.onClick=function(){this.option("edit_on_click")!==!1&&this.edit()},e.edit=function(){this.textbox=window.document.createElement("input"),this.textbox.type="text",this.textbox.style.zIndex=2;var a=this.getBBox(),e=Math.max(a.width,this.option("width")),f=this.text.attr("text-anchor");return this.textbox.style.left="start"===f?this.option("x")+"px":"middle"===f?this.option("x")-e/2+"px":this.option("x")-e+"px",this.textbox.style.width=e+"px",d(this.textbox,this.text,{color:this.option("textbox_color"),fill:this.option("textbox_background")}),this.paper.canvas.parentNode.insertBefore(this.textbox,this.paper.canvas),this.textbox.value=this.option("text"),this.text.hide(),this.textbox.focus(),this.textbox.select(),b(this.textbox).on("keydown.onkeydown",c.bind(this.onKeydown,this)).on("blur.onblur",c.bind(this.onBlur,this)),this},e.getBBox=function(){return this.text.getBBox()},e.update_label_background=function(){var a=this.getBBox();a&&this.label_background.attr({x:a.x-1,y:a.y-1,width:a.width+2,height:a.height+2,fill:this.option("fill")})},e.onKeydown=function(a){27===a.keyCode?(this.onCancel(),this.showText()):13===a.keyCode&&(this.onTextChange(this.textbox.value),this.showText())},e.onCancel=function(){this._emit("cancel")},e.onTextChange=function(a){this.option("text",a),this.text.attr("text",this.get_text()),this.show_default()?this.text.attr("fill",this.option("default_color")):this.text.attr("fill",this.option("color")),this.update_label_background(),this._emit("change",{value:a,target:this})},e.onBlur=function(){this.onTextChange(this.textbox.value),this.showText()},e.showText=function(){this.text.show(),b(this.textbox).off("keydown.onkeydown").off("blur.onblur").remove(),delete this.textbox},e._on_options_set=function(a,b){c.isNumber(b)?this.text.animate({fill:this.option(this.show_default()?"default_color":"color")},b):(this.text.attr({x:this.option("x"),y:this.option("y"),width:this.option("width"),font:this.option("font"),"font-family":this.option("font-family"),"font-size":this.option("font-size"),"font-weight":this.option("font-weight"),"text-anchor":this.option("text-anchor"),fill:this.option(this.show_default()?"default_color":"color"),text:this.option("text")}),this.update_label_background())},e.remove=function(){this.label_background.remove(),this.text.remove()},e.hide=function(){return this.label_background.hide(),this.text.hide(),this},e.show=function(){return this.label_background.show(),this.text.show(),this},e.focus=function(){return this.textbox.focus(),this},e.select=function(){return this.textbox.select(),this}}(a.EditableText)}(interstate,jQuery),function(a){"use strict";var b=a.cjs,c=a._,d=a.__debug_statecharts,e={hash:function(){return"null"},get_incoming_transitions:function(){return[]},id:function(){return"FAKE"},parent_is_concurrent:function(){return!1},is_initialized:function(){return!0},basis:function(){return!1}};a.RootStatechartLayoutEngine=function(a){able.make_this_optionable(this,{theta_degrees:45,transition_height:18,transition_margin:1,state_name_width:90,state_name_height:function(){return this.option("transition_height")},state_padding_y:function(){return this.option("transition_margin")},state_padding_x:8,add_state_width:50,start_state_width:function(){return this.option("state_name_width")},start_state_radius:5,theta_radians:function(){return this.option("theta_degrees")*Math.PI/180},tan_theta:function(){return Math.tan(this.option("theta_radians"))},transition_width:function(){return this.option("transition_height")/this.option("tan_theta")},state_line_padding_factor:.5,padding_top:0,statecharts_with_add_state_button:[],statecharts:[]},a),this.$layout=b(c.bind(this._compute_layout,this))},function(b){var f=b.prototype;able.make_proto_optionable(f),f.destroy=function(){able.destroy_this_optionable(this),this.$layout.destroy(),delete this.$layout},f.invalidate=function(){this.$layout.invalidate()},f.get_statechart_tree=function(){var b=function(e,f){var g=e.statechart;if(g instanceof a.Statechart&&g.is_initialized()){var h=g.get_substates();(c.size(h)>0||f||d)&&((!g.is_concurrent()||d)&&e.children.push({statechart:g.get_start_state(),children:[]}),e.children.push.apply(e.children,c.map(h,function(a){var c={statechart:a,children:[]};return b(c),c})))}},f={statechart:e,children:c.chain(this.option("statecharts")).map(function(a){if(a.destroyed)return!1;var c={statechart:a,children:[]};return b(c,!0),c},this).compact().value()};return f},f.get_x=function(a){var b=this.get_layout();if(!a)return b.width;var d=a.cobj_id,e=b.locations,f=c.map(e.keys(),function(a){return a.puppet_master_id||a.id()||-1}),g=e.values(),h=c.indexOf(f,d),i=g[h];if(i){if("statechart"===a.type())return i.center.x;if("transition"===a.type())return i.from.x;if("start_state"===a.type())return i.center.x}},f.total_width=function(){var a=this.get_layout();return a.width},f.get_width=function(a){return"statechart"===a.type()?this.option("state_name_width"):"transition"===a.type()?this.option("transition_width"):"start_state"===a.type()?this.option("start_state_width"):0},f.get_layout=function(){return this.$layout.get()},f._compute_layout=function(){var b,d,f=(this.option("theta_degrees"),this.option("transition_height")),g=this.option("transition_margin"),h=this.option("state_name_width"),i=(this.option("state_name_height"),this.option("state_padding_y"),this.option("state_padding_x")),j=this.option("add_state_width"),k=this.option("start_state_width"),l=(this.option("theta_radians"),this.option("tan_theta")),m=(this.option("transition_width"),this.option("state_line_padding_factor")),n=(this.option("start_state_radius"),this.option("padding_top")),o=(this.option("statecharts_with_add_state_button"),this.get_statechart_tree()),p=[],q=[],r=new RedMap({hash:"hash"}),s=function(d,e){var f,g,h=d.statechart,i=d.children,j=i.length,k=q.length;if(h instanceof a.StartState)q.push({state:h,lr:"c",depth:e+1}),r.put(h,{c:k}),f=g=k;else{f=k,q.push({state:h,lr:"l",depth:e}),c.each(i.slice(0,j),function(a){s(a,e+1)});{q.length}q.push({state:h,lr:"c",depth:e}),c.each(i.slice(j),function(a){s(a,e+1)}),g=q.length,q.push({state:h,lr:"r",depth:e}),r.put(h,{l:f,r:g})}var l;for(p[e]?l=p[e]:p[e]=l=[],b=f;g>=b;b+=1)l[b]=h};s(o,0);var t=[],u=function(b){var d,e,f=b.statechart,g=r.get(f);if(f instanceof a.StartState?d=e=g.c:(d=g.l,e=g.r),f.is_initialized()){var h;h=f.parent_is_concurrent()&&!a.__debug_statecharts?[]:f.get_incoming_transitions(),c.each(h,function(b){if(b.is_initialized()){var g=b.from();if(g===f)f instanceof a.StartState||t.push({min_x:e,max_x:e,type:"self",transition:b});else{if(g.parent_is_concurrent()&&!a.__debug_statecharts)return;var h,i,j,k=r.get(g);f.order(g)<0?(h=c.has(k,"r")?k.r:k.c,i=d,j="right"):(h=e,i=c.has(k,"l")?k.l:k.c,j="left"),t.push({min_x:h,max_x:i,type:j,transition:b})}}})}c.each(b.children,u)};u(o),c.each(t,function(a){var c,e,f=a.min_x,g=a.max_x,h=!1;for(b=0;b<p.length;b+=1){c=!0;var i=p[b];for(d=f;g>=d;d+=1)if(i[d]){c=!1;break}if(c){h=p[b],e=b;break}}h||(h=[],e=p.length,p.push(h));var j=a.transition;for(b=f;g>=b;b+=1)h[b]=j});var v,w,x,y,z,A,B,C,D=new RedMap({hash:"hash"}),E=n,F=p.length,G=f+2*g,H=G/2,I=H/l,J=I,K=function(){return{}};for(b=0;b<q.length;b+=1){var L=q[b],M=L.state;if("l"===L.lr||"r"===L.lr)if(C=c.pluck(p,b),"l"===L.lr){J+=i/2,E=n+G*(F-C.length+1)+G/2;var N=!1;for(x=C.length-1;x>=L.depth;x-=1){if(z=C[x],z===M){N||(A=J-I*m,B=E-H*m);break}if(z instanceof a.StatechartTransition&&(v=z.from()===M,w=z.to()===M,v||w)){var O=!1;N||(N=!0,A=J-I*m,B=E-H*m,O=!0),y=D.get_or_put(z,K),v&&w?y.from=y.to={x:J,y:E}:v?y.from={x:J,y:E}:y.to={x:J,y:E}}N&&(J+=2*I),E+=G}y={},y.left_wing_start={x:A,y:B},y.left_wing_end={x:J,y:E},D.put(M,y)}else{E=n+G*(F-L.depth)+G/2,A=J,B=E;var P=J+I*m,Q=E-H*m,R=-1;for(x=C.length-1;x>=L.depth;x-=1)if(z=C[x],z instanceof a.StatechartTransition&&(z.from()===M||z.to()===M)){R=x;break}for(x=L.depth;x<C.length;x+=1)z=C[x],z===M?(A=J,B=E):z instanceof a.StatechartTransition&&(v=z.from()===M,w=z.to()===M,(v||w)&&(P=J+I*m,Q=E-H*m,y=D.get_or_put(z,K),v&&w?y.from=y.to={x:J,y:E}:v?y.from={x:J,y:E}:y.to={x:J,y:E})),R>=x&&(J+=2*I),E-=G;y=D.get(M),y.right_wing_start={x:A,y:B},y.right_wing_end={x:P,y:Q},J+=i/2,c.indexOf(this.option("statecharts_with_add_state_button"),M)>=0&&(J+=j/2,y.add_state_button_x=J,J+=j/2,y.right_wing_end.x+=j,y.right_wing_start.x+=j)}else if(M===e)J+=i;else if(c.indexOf(this.option("statecharts"),M)>=0)E=n+G*(F-L.depth)+G/2,y=D.get(M),y.center={x:J,y:E};else if(M instanceof a.StartState){for(J+=k/2,E=n+G*(F-L.depth)+G/2,D.put(M,{center:{x:J,y:E}}),C=c.pluck(p,b),x=C.length-1;x>=L.depth;x-=1)z=C[x],z instanceof a.StatechartTransition&&(z.from()===M||z.to()===M)&&(v=z.from()===M,w=z.to()===M,y=D.get_or_put(z,K),v&&w?y.from=y.to={x:J,y:E}:v?y.from={x:J,y:E}:y.to={x:J,y:E});J+=k/2}else J+=h/2,E=n+G*(F-L.depth)+G/2,y=D.get(M),y.center={x:J,y:E},J+=h/2}var S=J,T=n+(F-1)*G;return{width:S,height:T,locations:D}}}(a.RootStatechartLayoutEngine)}(interstate),function(a,b){"use strict";var c=a.cjs,d=(a._,a.__debug_statecharts);a.StartStateView=function(b){able.make_this_optionable(this,{state:null,paper:null,c:{x:0,y:0},radius:6,fill_color:"black",padding_top:0,paper_height:9999,vline_color:"#CCC",vline_dasharray:". ",active_fill:a.__debug_statecharts?"red":"black",running_stroke:"#99E",stroke:"none",running_stroke_width:3,stroke_width:0},b);var c=this.option("state");c.is_initialized()?this.initialize():c.once("initialized",this.initialize,this)},function(a){var e=a.prototype;able.make_proto_optionable(e),e.initialize=function(){var a=this.option("paper"),e=this.option("c"),f=this.option("state");this.active_fn=c.liven(function(){f.is_initialized()&&f.is_active()?this.circle&&this.circle.attr({fill:this.option("active_fill")}):this.circle&&this.circle.attr({fill:this.option("fill_color")})},{context:this}),d&&(this.running_fn=c.liven(function(){var a=this.option("state");a.is_initialized()&&a.get_$running()?this.circle&&this.circle.attr({stroke:this.option("running_stroke"),"stroke-width":this.option("running_stroke_width")}):this.circle&&this.circle.attr({stroke:this.option("stroke"),"stroke-width":this.option("stroke_width")})},{context:this})),this.vline=a.path("M"+e.x+","+e.y+"V"+this.option("paper_height")).attr({stroke:this.option("vline_color"),"stroke-dasharray":this.option("vline_dasharray")}),this.circle=a.circle(e.x,e.y+this.option("padding_top"),this.option("radius")),this.circle.attr({fill:this.option(f.is_active()?"active_fill":"fill_color"),stroke:"none"}),b(this.circle[0]).on("contextmenu.cm")},e.toFront=function(){this.vline&&this.vline.toFront(),this.circle&&this.circle.toFront()},e._on_options_set=function(){var a=(this.option("paper"),this.option("c")),b=this.option("paper_height");this.circle&&this.circle.attr({cx:a.x,cy:a.y+this.option("padding_top"),r:this.option("radius")}),this.vline&&this.vline.attr({path:"M"+a.x+","+a.y+"V"+b}).toBack()},e.on_context_menu=function(a){a.preventDefault(),a.stopPropagation();var b=this.option("parent"),c=this.option("state").get_outgoing_transition(),d=b.get_view(c);d&&d.show_menu()},e.begin_editing=function(){},e.done_editing=function(){},e.remove=function(){this.circle&&this.circle.remove(),this.vline&&this.vline.remove()},e.destroy=function(){this.circle&&b(this.circle[0]).off("contextmenu.cm"),able.destroy_this_optionable(this),this.active_fn&&(this.active_fn.destroy(),delete this.active_fn),this.running_fn&&(this.running_fn.destroy(),delete this.running_fn)}}(a.StartStateView)}(interstate,jQuery),function(a,b){"use strict";var c=a.cjs,d=a._,e=a.__debug_statecharts;a.StateView=function(b){able.make_this_listenable(this),able.make_this_optionable(this,{state:null,paper:null,lws:{x:0,y:0},lwe:{x:0,y:0},rws:{x:0,y:0},rwe:{x:0,y:0},c:{x:0,y:0},default_stroke:"black",default_fill:"white",active_fill:"green",active_text_foreground:"#008000",active_stroke:"green",selectable_fill:"#AAA",text_foreground:"black",text_background:"white",font_family:"Source Sans Pro",font_size:12,padding_top:0,paper_height:9999,vline_color:"#CCC",vline_dasharray:". ",stroke_width:1,running_width:3},b),this.active_fn=c.liven(function(){var a=this.option("state");a.is_initialized()&&a.is_active()?this.path&&(this.path.animate({fill:this.option("active_fill"),stroke:this.option("active_stroke")},300,"ease-out"),this.label.option("color",this.option("active_text_foreground"),300)):this.path&&(this.path.animate({fill:this.option("default_fill"),stroke:this.option("default_stroke")},300,"ease-out"),this.label.option("color",this.option("text_foreground"),300))},{context:this}),e&&(this.running_fn=c.liven(function(){var a=this.option("state");a.is_initialized()&&a.get_$running()?this.path&&this.path.attr("stroke-width",this.option("running_width")):this.path&&this.path.attr("stroke-width",this.option("stroke_width"))},{context:this}));var d=this.option("state"),f=this.option("paper");this.path=f.path("M0,0").toBack(),this.vline=f.path("M0,0").attr({stroke:this.option("vline_color"),"stroke-dasharray":this.option("vline_dasharray")}).toBack(),this.label=new a.EditableText(f,{x:-100,y:-100,text:"",fill:this.option("text_background"),color:this.option("text_foreground")}),d.is_initialized()?this.initialize():d.once("initialized",this.initialize,this)},function(c){var e=c.prototype;able.make_proto_listenable(e),able.make_proto_optionable(e),e.initialize=function(){var a=this.option("state");this.path.attr({path:this.get_path_str(),stroke:this.option(a.is_active()?"active_stroke":"default_stroke"),fill:this.option(a.is_active()?"active_fill":"default_fill")});var c=this.option("c");this.label.on("cancel",this.on_cancel_rename,this).on("change",this.on_confirm_rename,this),this.label.option({"font-size":this.option("font_size"),"font-family":this.option("font_family"),x:c.x,y:c.y,text:this.get_name()}),this.label.on("change",this.forward_event,this),this.$clickable=b([this.path[0],this.label.text[0]]),this.$clickable.on("contextmenu.show",d.bind(this.show_menu,this)),this.path.attr(a.parent_is_concurrent()?{"stroke-dasharray":"- "}:{"stroke-dasharray":""})},e.toFront=function(){this.path.toFront(),this.vline.toFront(),this.label.toFront()},e.get_name=function(){var a=this.option("state"),b=a.get_name("parent");return b},e._on_options_set=function(){if(this.path){var a=this.option("state"),b=this.get_path_str();this.path.attr({path:b}),this.path.attr(a.parent_is_concurrent()?{"stroke-dasharray":"- "}:{"stroke-dasharray":""});var c=this.option("paper_height"),d=this.option("c"),e=a.get_name("parent");this.label.option({x:d.x,y:d.y,text:e}),this.update_menu_position(),this.vline.attr({path:"M"+d.x+","+d.y+"V"+c})}},e.show_menu=function(a){a&&(a.preventDefault(),a.stopPropagation()),this.add_transition=b("<div />").addClass("menu_item").text("Add transition").on("click.menu_item",d.bind(this.on_add_transition_item_pressed,this)),this.rename_item=b("<div />").addClass("menu_item").text("Rename").on("click.menu_item",d.bind(this.on_rename_item_pressed,this)),this.remove_item=b("<div />").addClass("menu_item").text("Delete").on("click.menu_item",d.bind(this.on_remove_item_pressed,this)),this.add_substate_item=b("<div />").addClass("menu_item").text("Add substate").on("click.menu_item",d.bind(this.on_add_substate_item_pressed,this));var c=this.option("state").is_concurrent(),e=c?"&#x2612;":"&#x2610;";this.toggle_concurrency_item=b("<div />").addClass("menu_item").html("Concurrent "+e).on("click.menu_item",d.bind(this.on_toggle_concurrency_item_pressed,this)),this.toggle_breakpoint_item=b("<div />").addClass("menu_item").text("Add breakpoint").on("click.menu_item",d.bind(this.on_toggle_breakpoint_item_pressed,this));var f=this.option("lwe"),g=this.option("rws"),h=1,i=10,j=g.x-f.x-2*h,k=f.x+h,l=f.y-i/2,m=this.option("paper"),n=m.canvas.parentNode;this.edit_dropdown=b("<div />").append(this.add_transition,this.add_substate_item,this.toggle_concurrency_item,this.toggle_breakpoint_item,this.rename_item,this.remove_item).addClass("dropdown").css({position:"absolute",left:k+"px",top:l+"px",width:j+"px"}).appendTo(n);this.option("state");b(window).on("mousedown.expanded_mousedown",d.bind(this.on_window_click_while_expanded,this)),b(window).on("keydown.expanded_keydown",d.bind(this.on_window_keydown_while_expanded,this))},e.add_transition_to_state=function(a){this._emit("add_transition",{from:this.option("state"),to:a})},e.on_add_transition_item_pressed=function(c){c.preventDefault(),c.stopPropagation(),this.remove_edit_dropdown();var e=this.option("state"),f=e.root(),g=f.flatten_substates(),h=g.splice(0,g.length-1);this._emit("awaiting_state_selection",{states:h,on_select:d.bind(function(){this.add_transition_to_state.apply(this,arguments),b(window).off("mousemove.update_display_arrow"),n.remove(),n.destroy()},this),on_cancel:d.bind(function(){b(window).off("mousemove.update_display_arrow"),n.remove(),n.destroy()},this)});var i=this.option("paper"),j=this.option("lwe"),k=this.option("rwe"),l=(j.x+k.x)/2,m=(this.option("padding_top")+j.y)/2,n=new a.ArrowView({paper:i,from:{x:l,y:m},to:{x:l,y:m}});b(n.arrow_path[0]).css("pointer-events","none"),b(window).on("mousemove.update_display_arrow",function(a){var c=b(i.canvas).offset();n.option("to",{x:a.clientX-c.left,y:a.clientY-c.top})})},e.on_add_substate_item_pressed=function(){this.remove_edit_dropdown(),this._emit("add_state",{parent:this.option("state")})},e.on_rename_item_pressed=function(){this.remove_edit_dropdown(),this.begin_rename()},e.on_remove_item_pressed=function(){this.remove_edit_dropdown(),this._emit("remove_state",{state:this.option("state")})},e.on_toggle_concurrency_item_pressed=function(){var a=this.option("state");this.remove_edit_dropdown(),this._emit("make_concurrent",{state:a,concurrent:!a.is_concurrent()})},e.on_toggle_breakpoint_item_pressed=function(){var a=this.option("state");this.remove_edit_dropdown(),this._has_breakpoint=!0,this._emit("toggle_breakpoint",{state:a}),"Add breakpoint"===this.togglebreakpoint.text()?(this.togglebreakpoint.text("Remove breakpoint"),this._emit("toggle_breakpoint",{transition:my_transition})):(this.togglebreakpoint.text("Add breakpoint"),this._emit("toggle_breakpoint",{transition:my_transition}))
},e.on_window_click_while_expanded=function(a){b(a.target).parents().is(this.edit_dropdown)||this.remove_edit_dropdown()},e.on_window_keydown_while_expanded=function(a){27===a.keyCode&&this.remove_edit_dropdown()},e.update_menu_position=function(){if(this.edit_dropdown){{var a=this.option("lwe"),b=this.option("rws"),c=1,d=10,e=b.x-a.x-2*c,f=a.x+c,g=a.y-d/2;this.option("state"),this.get_name()}this.edit_dropdown.css({left:f+"px",top:g+"px",width:e+"px"})}},e.remove_edit_dropdown=function(){this.edit_dropdown&&(this.add_transition.off("click.menu_item").remove(),this.rename_item.off("click.menu_item").remove(),this.remove_item.off("click.menu_item").remove(),this.add_substate_item.off("click.menu_item").remove(),this.toggle_concurrency_item.off("click.menu_item").remove(),this.toggle_breakpoint_item.off("click.menu_item").remove(),this.edit_dropdown.remove(),delete this.edit_dropdown),b(window).off("mousedown.expanded_mousedown"),b(window).off("keydown.expanded_keydown")},e.begin_rename=function(){this.label.edit()},e.on_cancel_rename=function(){},e.on_confirm_rename=function(a){var b=a.value;this._emit("rename",{name:b,state:this.option("state")})},e.get_path_str=function(){var a=[this.option("lws"),this.option("lwe"),this.option("rws"),this.option("rwe")],b=this.option("padding_top"),c=a[0].x,e=(a[0].y,"M"+c+","+b+"L"+d.map(a,function(a){return a.x+","+a.y}).join("L")+"V"+b+"Z");return e},e.remove=function(){this.path.remove(),this.label.remove(),this.vline.remove(),this.edit_dropdown&&(this.edit_dropdown.remove(),delete this.edit_dropdown)},e.destroy=function(){this.unmake_selectable(),this.$clickable.off("contextmenu.show"),delete this.$clickable,this.remove_edit_dropdown(),this.active_fn.destroy(),delete this.active_fn,this.edit_dropdown&&this.edit_dropdown.dropdown("destroy"),this.running_fn&&(this.running_fn.destroy(),delete this.running_fn),this.label.destroy(),delete this.label,able.destroy_this_listenable(this),able.destroy_this_optionable(this)},e.make_selectable=function(a){this.path.attr({fill:this.option("selectable_fill"),cursor:"pointer"}),this._selectable_callback&&this.path.unclick(this._selectable_callback),this._selectable_callback=a,this.path.click(this._selectable_callback);var b=!1,c=500;this.change_color_interval=window.setInterval(d.bind(function(){b?this.path.animate({fill:this.option("selectable_fill")},c):this.path.animate({fill:"#888"},c),b=!b},this),c)},e.unmake_selectable=function(){this.change_color_interval&&(this.path.stop(),window.clearInterval(this.change_color_interval),delete this.change_color_interval),this._selectable_callback&&(this.path.unclick(this._selectable_callback),delete this._selectable_callback);var a=this.option("state");this.path.attr({fill:this.option(a.is_active()?"active_fill":"default_fill"),cursor:""})}}(a.StateView)}(interstate,jQuery),function(a,b){"use strict";var c=a.cjs,d=a._,e=a.__debug_statecharts,f=function(a,b,c,e,f,g){var h,i,j,k,l,m,n,o=a.x,p=a.y,q=b.x,r=b.y,s=q-o,t=r-p;if(Math.pow(s,2)+Math.pow(t,2)<=Math.pow(e+f,2)){var u=2*e*e+f+2;m=c*Math.PI/180,n=m-90*Math.PI/180,i=o+e*Math.cos(m),j=p+e*Math.sin(m),k=o+(e+f)*Math.cos(m),l=p-(e+f)*Math.sin(m),h="M"+i+","+j+"C"+(o+u*Math.cos(m))+","+(p+u*Math.sin(m))+","+(o+(u+f)*Math.cos(m))+","+(p-(u+f)*Math.sin(m))+","+k+","+l,q+=e*Math.cos(m),r-=e*Math.sin(m)}else m=n=Math.atan2(t,s),i=o+Math.cos(m)*e,j=p+Math.sin(m)*e,k=q-Math.cos(m)*f,l=r-Math.sin(m)*f,h="M"+i+","+j+"L"+k+","+l;var v=f*Math.tan(g),w=[{x:q,y:r},{x:k+v*Math.cos(n-Math.PI/2),y:l+v*Math.sin(n-Math.PI/2)},{x:k+v*Math.cos(n+Math.PI/2),y:l+v*Math.sin(n+Math.PI/2)}],x="M"+d.map(w,function(a){return a.x+","+a.y}).join("L")+"Z";return{line:{path:h},arrow:{path:x},circle:{cx:o,cy:p,r:e}}},g=function(a,b){return{x:(a.x+b.x)/2,y:(a.y+b.y)/2}};a.TransitionView=function(e){able.make_this_listenable(this),able.make_this_optionable(this,{transition:null,paper:null,from:{x:0,y:0},to:{x:0,y:0},color:"black",active_color:"green",text_background:"white",text_foreground:"black",error_background:"#900",error_foreground:"white",font_family:"Sourse Sans Pro",font_size:14,padding_top:0,paper_height:9999,vline_color:"#CCC",vline_dasharray:". "},e);var f=this.option("paper");this.arrow=new a.ArrowView({paper:f,color:this.option("color"),active_color:this.option("active_color"),transition:this.option("transition"),from:this.option("from"),to:this.option("to")});var h=this.option("transition"),i=h.event(),j="";i instanceof a.ParsedEvent&&(j=i.get_str());var k=g(this.option("from"),this.option("to"));this.label=new a.EditableText(f,{x:k.x,y:k.y+8,text:j,fill:this.option("text_background"),color:this.option("text_foreground")}),this.label.option({"font-size":this.option("font_size"),"font-family":this.option("font_family")}),this.label.on("cancel",this.on_cancel_rename,this).on("change",this.on_confirm_rename,this).on("change",this.forward_event,this),h.on("fire",this.flash,this);this.option("from");i instanceof a.ParsedEvent?(i.on("setString",function(a){if(this.label){var b=a.to;this.label.option("text",b)}},this),j=i.get_str(),this.errors_fn=c.liven(function(){var a=i.get_errors();if(a&&a.length>0){this.label.option({fill:this.option("error_background"),color:this.option("error_foreground")});var c=a[0];b(this.label.text[0]).attr("title",c).tooltip("option",{content:c})}else this.label.option({fill:this.option("text_background"),color:this.option("text_foreground")}),b(this.label.text[0]).attr("title","").tooltip("option",{tooltipClass:"error",content:""})},{context:this,destroy:function(){}})):j="",this.label.option("text",j),this.vline=f.path("M0,0").attr({stroke:this.option("vline_color"),"stroke-dasharray":this.option("vline_dasharray")}).toBack(),this.$clickable=b([this.label.text[0],this.label.label_background[0],this.arrow.line_path[0],this.arrow.circle[0],this.arrow.arrow_path[0]]),this.$clickable.on("contextmenu.cm",d.bind(this.show_menu,this)),b(this.label.text[0]).tooltip({tooltipClass:"error"})},function(c){var e=c.prototype;able.make_proto_listenable(e),able.make_proto_optionable(e),e._on_options_set=function(a){this.arrow.option(a);var b=this.option("transition"),c=(this.option("paper_height"),b.event(),this.option("from")),d=g(c,this.option("to"));this.label.option({x:d.x,y:d.y+8}),this.update_menu_position()},e.toFront=function(){this.arrow.toFront(),this.vline.toFront(),this.label.toFront()},e.get_str=function(){var b=this.option("transition"),c=b.event(),d="";return d=c instanceof a.ParsedEvent?c.get_str():"(start)"},e.flash=function(){this.arrow.flash()},e.show_menu=function(c){c&&(c.preventDefault(),c.stopPropagation());var e=this.option("paper"),f=this.option("transition"),g=e.canvas.parentNode;this.edit_event=b("<div />").addClass("menu_item").text("Change event").on("click.menu_item",d.bind(this.on_edit_event_pressed,this)),this.change_from=b("<div />").addClass("menu_item").text("Change from").on("click.menu_item",d.bind(this.on_change_from_pressed,this)),this.change_to=b("<div />").addClass("menu_item").text("Change to").on("click.menu_item",d.bind(this.on_change_to_pressed,this)),this.remove_item=b("<div />").addClass("menu_item").text("Delete").on("click.menu_item",d.bind(this.on_remove_item_pressed,this)),this.togglebreakpoint=b("<div />").addClass("menu_item").text("Add breakpoint").on("click.menu_item",d.bind(this.on_toggle_breakpoint,this));var h=this.option("from"),i=this.option("to"),j=Math.min(h.x,i.x),k=Math.max(h.x,i.x),l=1,m=Math.max(k-j-2*l,100),n=(k+j)/2,o=n-m/2,p=h.y;this.edit_dropdown=b("<div />").addClass("transition dropdown").appendTo(g).css({position:"absolute",left:o+"px",top:p+"px",width:m+"px"});f.from()instanceof a.StartState?this.edit_dropdown.append(this.change_to):this.edit_dropdown.append(this.edit_event,this.change_from,this.change_to,this.remove_item,this.togglebreakpoint),b(window).on("mousedown.close_menu",d.bind(this.on_window_click_while_expanded,this)),b(window).on("keydown.close_menu",d.bind(this.on_window_keydown_while_expanded,this))},e.on_edit_event_pressed=function(){this.remove_edit_dropdown(),this.begin_rename()},e.emit_set_from=function(a){this._emit("set_from",{transition:this.option("transition"),from:a})},e.on_change_from_pressed=function(){this.remove_edit_dropdown();var a=this.option("transition").root(),b=a.flatten_substates();b=b.splice(0,b.length-1),this._emit("awaiting_state_selection",{states:b,on_select:d.bind(this.emit_set_from,this)})},e.emit_set_to=function(a){this._emit("set_to",{transition:this.option("transition"),to:a})},e.on_change_to_pressed=function(){this.remove_edit_dropdown();var a=this.option("transition").root(),b=a.flatten_substates();b=b.splice(0,b.length-1),this._emit("awaiting_state_selection",{states:b,on_select:d.bind(this.emit_set_to,this)})},e.on_remove_item_pressed=function(){this.remove_edit_dropdown(),this._emit("remove_transition",{transition:this.option("transition")})},e.on_toggle_breakpoint=function(){this.remove_edit_dropdown();var a=this.option("transition");this._has_breakpoint=!0,"Add breakpoint"===this.togglebreakpoint.text()?(this.togglebreakpoint.text("Remove breakpoint"),this._emit("toggle_breakpoint",{transition:a})):(this.togglebreakpoint.text("Add breakpoint"),this._emit("toggle_breakpoint",{transition:a}))},e.on_window_click_while_expanded=function(a){b(a.target).parents().is(this.edit_dropdown)||this.remove_edit_dropdown()},e.on_window_keydown_while_expanded=function(a){27===a.keyCode&&this.remove_edit_dropdown()},e.update_menu_position=function(){if(this.edit_dropdown){var a=this.option("from"),b=this.option("to"),c=Math.min(a.x,b.x),d=Math.max(a.x,b.x),e=1,f=Math.max(d-c-2*e,100),g=(d+c)/2,h=g-f/2,i=a.y;this.edit_dropdown.css({left:h+"px",top:i+"px",width:f+"px"})}},e.begin_rename=function(){this.label.edit()},e.on_cancel_rename=function(){this.end_rename()},e.on_confirm_rename=function(a){var b=a.value;this.end_rename(),this._emit("set_str",{str:b,transition:this.option("transition")})},e.end_rename=function(){},e.remove_edit_dropdown=function(){b(window).off("mousedown.close_menu"),b(window).off("keydown.close_menu"),this.edit_dropdown&&(this.edit_event.off("click.menu_item").remove(),this.change_from.off("click.menu_item").remove(),this.change_to.off("click.menu_item").remove(),this.remove_item.off("click.menu_item").remove(),this.togglebreakpoint.off("click.menu_item").remove(),this.edit_dropdown.remove(),delete this.edit_dropdown)},e.remove=function(){this.arrow.remove(),this.vline.remove(),this.label.remove(),this.edit_dropdown&&(this.edit_dropdown.remove(),delete this.edit_dropdown)},e.destroy=function(){this.arrow.destroy(),this.$clickable.off("contextmenu.cm"),delete this.$clickable,this.label.off("cancel",this.on_cancel_rename,this).off("change",this.on_confirm_rename,this),this.label.destroy(),delete this.label;var a=this.option("transition");a.destroyed||a.off("fire",this.flash,this),this.edit_dropdown&&this.edit_dropdown.dropdown("destroy"),this.enabled_fn&&this.enabled_fn.destroy(),able.destroy_this_listenable(this),able.destroy_this_optionable(this)}}(a.TransitionView),a.ArrowView=function(a){able.make_this_listenable(this),able.make_this_optionable(this,{paper:null,from:{x:0,y:0},to:{x:0,y:0},arrowLength:8,radius:1,arrowAngle:20,self_pointing_theta:40,color:"black",active_color:"green",enabled_dasharray:"",disabled_dasharray:". "},a);var b=this.option("paper"),d=this.get_paths();this.line_path=b.path(d.line.path),this.line_path.attr({stroke:this.option("color")}),this.arrow_path=b.path(d.arrow.path),this.arrow_path.attr({fill:this.option("color"),stroke:"none"}),this.circle=b.circle(d.circle.cx,d.circle.cy,d.circle.r),this.circle.attr({fill:this.option("color"),stroke:"none"}),e&&(this.enabled_fn=c.liven(function(){var a=this.option("transition");a&&a.is_initialized()&&a.get_$enabled()?this.line_path&&this.line_path.attr("stroke-dasharray",this.option("enabled_dasharray")):this.line_path&&this.line_path.attr("stroke-dasharray",this.option("disabled_dasharray"))},{context:this}))},function(a){var b=a.prototype;able.make_proto_listenable(b),able.make_proto_optionable(b),b.get_paths=function(){var a=this.option("from"),b=this.option("to"),c=this.option("self_pointing_theta"),d=this.option("radius"),e=this.option("arrowLength"),g=this.option("arrowAngle")*Math.PI/180;return f(a,b,c,d,e,g)},b._on_options_set=function(){var a=this.get_paths();this.line_path.attr("path",a.line.path),this.arrow_path.attr("path",a.arrow.path);this.option("from");this.circle.attr({cx:a.circle.cx,cy:a.circle.cy,r:a.circle.r})},b.toFront=function(){this.line_path.toFront(),this.circle.toFront(),this.arrow_path.toFront()};var c=400;b.flash=function(){var a=this.option("paper"),b=this.option("color"),d=this.option("active_color"),e=this.line_path,f=this.arrow_path,g=e.getTotalLength();this.circle.attr({r:4*this.option("radius"),fill:d}),this.circle.animate({fill:b,r:this.option("radius")},c);var h=a.path(e.getSubpath(0,0));h.attr({stroke:d,"stroke-width":3,guide:e,along:[0,0]});var i=Raphael.animation({path:e.getSubpath(4*g/4.1,g)},c/2,"ease-out",function(){h.remove()}),j=Raphael.animation({fill:b},c/2,"ease_out"),k=Raphael.animation({path:e.getSubpath(0,g)},c/2,"ease-in",function(){if(null!==a.height){if(null===f[0])return void h.remove();f.attr({fill:d}),h.animate(i),f.animate(j)}});h.animate(k)},b.remove=function(){this.circle.remove(),this.line_path.remove(),this.arrow_path.remove()},b.destroy=function(){this.enabled_fn&&this.enabled_fn.destroy(),able.destroy_this_listenable(this),able.destroy_this_optionable(this)}}(a.ArrowView)}(interstate,jQuery),function(a,b){"use strict";var c=a.cjs,d=a._;c.registerPartial("statechartView",function(a,c){return c||(c=b("<div />")[0]),b(c).statechart(a),c}),b.widget("interstate.statechart",{options:{transition_font_family:"Source Sans Pro",transition_font_size:12,transition_arrow_color:"#000",transition_text_background_color:"#FFF",transition_text_color:"#000",active_transition_color:"#007000",state_font_family:"Source Sans Pro",state_font_size:13,state_text_background_color:"#FFF",state_text_color:"#000",state_fill:"#EEE",state_stroke:"#999",active_state_fill:"#FFF",active_state_stroke:"#007000",active_state_text_color:"#007000",start_state_color:"#000",start_state_radius:6,add_state_width:50,statecharts:[],hrange_y:5,hrange_height:14,client:!1,padding_top:function(){return this.option("hrange_y")+this.option("hrange_height")}},_create:function(){this.element.addClass("statechart"),this.paper=new Raphael(this.element[0],0,0);var b=this.option("statecharts");this.layout_manager=new a.RootStatechartLayoutEngine({statecharts:b,statecharts_with_add_state_button:[b[0]],start_state_radius:this.option("start_state_radius"),padding_top:this.option("padding_top").call(this),add_state_width:this.option("add_state_width")}),this.statechart_view=new a.RootStatechartView(b,this.layout_manager,this.paper,this.options),this.statechart_view.on("add_state",this.add_state,this),this.statechart_view.on("remove_state",this.remove_state,this),this.statechart_view.on("remove_transition",this.remove_transition,this),this.statechart_view.on("add_transition",this.add_transition,this),this.statechart_view.on("set_to",this.set_transition_to,this),this.statechart_view.on("set_from",this.set_transition_from,this),this.statechart_view.on("rename",this.rename_state,this),this.statechart_view.on("set_str",this.set_transition_str,this),this.statechart_view.on("make_concurrent",this.make_concurrent,this),this.statechart_view.on("reset",this.reset,this)},_destroy:function(){this._super(),this.statechart_view.off("add_state",this.add_state,this),this.statechart_view.off("remove_state",this.remove_state,this),this.statechart_view.off("remove_transition",this.remove_transition,this),this.statechart_view.off("add_transition",this.add_transition,this),this.statechart_view.off("set_to",this.set_transition_to,this),this.statechart_view.off("set_from",this.set_transition_from,this),this.statechart_view.off("rename",this.rename_state,this),this.statechart_view.off("set_str",this.set_transition_str,this),this.statechart_view.off("make_concurrent",this.make_concurrent,this),this.statechart_view.off("reset",this.reset,this),this.statechart_view.destroy(),delete this.statechart_view,this.paper.remove(),this.element.removeClass("statechart"),delete this.options.statecharts,delete this.options,this.layout_manager.destroy(),delete this.layout_manager},get_layout_manager:function(){return this.layout_manager},_setOption:function(a,b){this._super(a,b),"statecharts"===a&&(this.layout_manager.option("statecharts_with_add_state_button",[b[0]]),this.layout_manager.invalidate())},add_state:function(a){var c=new b.Event("command");c.command_type="add_state",c.state=a.parent,this.element.trigger(c)},remove_state:function(a){var c=new b.Event("command");c.command_type="remove_state",c.state=a.state,this.element.trigger(c)},remove_transition:function(a){var c=new b.Event("command");c.command_type="remove_transition",c.transition=a.transition,this.element.trigger(c)},add_transition:function(a){var c=new b.Event("command");c.command_type="add_transition",c.from=a.from,c.to=a.to,this.element.trigger(c)},set_transition_to:function(a){var c=new b.Event("command");c.command_type="set_transition_to",c.transition=a.transition,c.to=a.to,this.element.trigger(c)},set_transition_from:function(a){var c=new b.Event("command");c.command_type="set_transition_from",c.transition=a.transition,c.from=a.from,this.element.trigger(c)},set_transition_event:function(a){var c=new b.Event("command");c.command_type="set_transition_event",c.transition=a.transition,c.from=a.from,this.element.trigger(c)},rename_state:function(a){var c=new b.Event("command");c.command_type="rename_state",c.state=a.state,c.new_name=a.name,this.element.trigger(c)},set_transition_str:function(a){var c=new b.Event("command");c.command_type="set_transition_str",c.transition=a.transition,c.str=a.str,this.element.trigger(c)},make_concurrent:function(a){var c=new b.Event("command");c.command_type="make_concurrent",c.state=a.state,c.concurrent=a.concurrent,this.element.trigger(c)},reset:function(){var a=new b.Event("command");a.command_type="reset",a.client=c.get(this.option("client")),a.client&&this.element.trigger(a)}}),a.RootStatechartView=function(b,e,f,g){able.make_this_listenable(this),able.make_this_optionable(this,{},g),this.statecharts=b,this.layout_engine=e,this.object_views=new RedMap({hash:"hash"}),this.hranges=new RedMap({hash:"hash"}),this.paper=f,this.add_state_shape=this.paper.path("M0,0").hide(),this.add_state_button=this.paper.text(0,0,"+").hide(),this.add_state_shape.attr({fill:this.option("state_fill"),stroke:this.option("state_stroke"),opacity:.5,cursor:"pointer"}).click(d.bind(this.on_add_state_click,this)),this.add_state_button.attr({"font-size":"42px",fill:this.option("state_stroke"),opacity:.5,cursor:"pointer"}).click(d.bind(this.on_add_state_click,this));var h=[];this.live_layout=c.liven(function(){var b=this.layout_engine.get_layout(),c=b.width,e=b.height,f=b.locations;this.paper.setSize(c,e);var g=[];f.each(function(b,c){var f;if(c instanceof a.State){if(d.indexOf(this.statecharts,c)>=0){if(b.add_state_button_x){this.add_state_button.attr({x:b.add_state_button_x,y:e/2}).show();var h=this.layout_engine.option("state_name_height"),i=b.right_wing_end.x-b.right_wing_start.x,j=this.option("padding_top"),k=b.add_state_button_x,l=this.option("add_state_width");this.add_state_shape.attr({path:"M"+(k-l/2)+","+j+"H"+(k+l/2)+"V"+(b.right_wing_end.y-h)+"L"+b.right_wing_start.x+","+(b.right_wing_start.y-h)+"H"+(k-l/2+i)+"L"+(k-l/2)+","+(b.right_wing_end.y-h)+"Z"}).show()}var m,n="inherited";return this.statecharts[0]===c&&(n="own"),void(this.hranges.has(c)?(m=this.hranges.get(c),m.option({from_x:b.left_wing_start.x,to_x:b.right_wing_end.x})):(m=this.get_hrange(c,n,b),m.on("add_state",this.forward_event,this),m.on("make_concurrent",this.forward_event,this),m.on("reset",this.forward_event,this)))}this.object_views.has(c)?(f=this.get_view(c,b),f.option(c instanceof a.StartState?{c:b.center}:{lws:b.left_wing_start,lwe:b.left_wing_end,rws:b.right_wing_start,rwe:b.right_wing_end,c:b.center}),g.push(f)):(f=this.get_view(c,b),g.push(f)),f.toFront()}else c instanceof a.StatechartTransition&&(this.object_views.has(c)?(f=this.get_view(c,b),f.option({from:b.from,to:b.to}),g.push(f)):(f=this.get_view(c,b),g.push(f)))},this);var i;d.each(h,function(b){g.indexOf(b)<0&&(i=b.option(b instanceof a.TransitionView?"transition":"state"),this.object_views.remove(i),b.remove(),b.destroy())},this),d.each(g,function(b){b instanceof a.TransitionView&&b.toFront()}),h=g},{context:this}),this.editing=!1},function(c){var e=c.prototype;able.make_proto_listenable(e),able.make_proto_optionable(e),e.get_hrange=function(b,c,d){return this.hranges.get_or_put(b,function(){return new a.HorizontalRangeDisplay({from_x:d.left_wing_start.x,to_x:d.right_wing_end.x,paper:this.paper,text:c,line_color:"#AAA",color:"#999",background:"#EEE",y:this.option("hrange_y"),height:this.option("hrange_height"),state:b})},this)},e.on_add_state_click=function(){this._emit("add_state",{parent:this.statecharts[0]})},e.get_view=function(b,c){return this.object_views.get_or_put(b,function(){var d;return b instanceof a.StatechartTransition?(d=new a.TransitionView({paper:this.paper,transition:b,from:c.from,to:c.to,active_color:this.option("active_transition_color"),color:this.option("transition_arrow_color"),text_background:this.option("transition_text_background_color"),text_foreground:this.option("transition_text_color"),font_family:this.option("transition_font_family"),font_size:this.option("transition_font_size"),parent:this}),d.on("change",function(a){var c=a.value;""===c?this._emit("remove_transition",{transition:b}):this._emit("change_transition_event",{transition:b,str:c})},this),d.on("remove_transition",this.forward_event,this),d.on("awaiting_state_selection",this.on_awaiting_state_selection,this),d.on("set_to",this.forward_event,this),d.on("set_from",this.forward_event,this),d.on("set_str",this.forward_event,this)):b instanceof a.StartState?d=new a.StartStateView({state:b,paper:this.paper,c:c.center,fill_color:this.option("start_state_color"),radius:this.option("start_state_radius"),parent:this}):(d=new a.StateView({state:b,paper:this.paper,lws:c.left_wing_start,lwe:c.left_wing_end,rws:c.right_wing_start,rwe:c.right_wing_end,c:c.center,font_family:this.option("state_font_family"),font_size:this.option("state_font_size"),default_stroke:this.option("state_stroke"),default_fill:this.option("state_fill"),active_stroke:this.option("active_state_stroke"),active_fill:this.option("active_state_fill"),text_foreground:this.option("state_text_color"),active_text_fireground:this.option("active_state_text_color"),text_background:this.option("state_text_background_color"),padding_top:this.option("padding_top"),parent:this}),d.on("remove_state",this.forward_event,this),d.on("add_transition",this.forward_event,this),d.on("add_state",this.forward_event,this),d.on("make_concurrent",this.forward_event,this),d.on("rename",this.forward_event,this),d.on("awaiting_state_selection",this.on_awaiting_state_selection,this)),d},this)},e.pause=function(){this.live_layout.pause()},e.resume=function(){this.live_layout.resume(),this.live_layout.run()},e.on_awaiting_state_selection=function(a){this._awaiting_state_selection&&this._awaiting_state_selection();var c=a.states,e=a.on_select,f=a.on_cancel,g=this.paper.text(this.paper.width/2,10,"(click a destination state)").attr({"font-size":16,fill:"#777","font-family":"Source Sans Pro"}),h=g.getBBox(),i=this.paper.rect(h.x-3,h.y-3,h.width+6,h.height+6).attr({stroke:"none",fill:"white",opacity:.7});g.toFront();var j=function(a){27===a.keyCode&&(f(),l())};b(window).on("keydown.awaiting_state_selection",j);var k=d.map(c,this.get_view,this),l=this._awaiting_state_selection=d.bind(function(){g.remove(),i.remove(),b(window).off("keydown.awaiting_state_selection mousedown.cancel_state_selection"),d.each(k,function(a){a.unmake_selectable()}),e=k=c=null,delete this._awaiting_state_selection},this);d.each(c,function(a,b){k[b].make_selectable(function(){e(c[b]),l()})});var m=b(this.paper.canvas.parentNode);b(window).on("mousedown.cancel_state_selection",function(a){return 0===m.has(a.target).length?(f(),l(),a.preventDefault(),a.stopPropagation(),!1):void 0})},e.remove=function(){},e.destroy=function(){b(window).off("keydown.awaiting_state_selection"),delete this.statecharts,this.live_layout.destroy(),delete this.live_layout,delete this.layout_engine,this.object_views.each(function(a){a.destroy()}),this.object_views.destroy(),delete this.object_views,this.hranges.each(function(a){a.destroy()}),this.hranges.destroy(),delete this.hranges,able.destroy_this_listenable(this),able.destroy_this_optionable(this),this.add_state_shape.remove(),delete this.add_state_shape,this.add_state_button.remove(),delete this.add_state_button}}(a.RootStatechartView)}(interstate,jQuery),function(a,b){"use strict";var c=(a.cjs,a._);a.HorizontalRangeDisplay=function(a){able.make_this_optionable(this,{font_family:"Source Sans Pro",font_size:"12px",line_color:"black",color:"black",background:"white",height:10,y:1,from_x:0,to_x:0,paper:!1,text:"",state:null},a),able.make_this_listenable(this);var d=this.option("paper");this.left_vline=d.path("M0,0"),this.right_vline=d.path("M0,0"),this.hline=d.path("M0,0"),this.text_background=d.rect(0,0,0,0),this.text_foreground=d.text(0,0,this.option("text")),this.left_vline.attr({stroke:this.option("line_color")}),this.right_vline.attr({stroke:this.option("line_color")}),this.hline.attr({stroke:this.option("line_color")}),this.text_background.attr({stroke:"none",fill:this.option("background"),"fill-opacity":.5}),this.text_foreground.attr({fill:this.option("color"),"font-family":this.option("font_family"),"font-size":this.option("font_size")}),this.update(),b(this.hline[0]).add(this.text_foreground[0]).on("contextmenu.showmenu",c.bind(function(a){a.preventDefault(),a.stopPropagation(),this.show_menu()},this))},function(a){var d=a.prototype;able.make_proto_optionable(d),able.make_proto_listenable(d),d.destroy=function(){b(this.hline[0]).add(this.text_foreground[0]).off("contextmenu.showmenu"),this.remove_edit_dropdown(),able.destroy_this_optionable(this),able.destroy_this_listenable(this)},d.update=function(){var a=this.option("from_x"),b=this.option("to_x"),c=(this.option("text"),this.option("y")),d=this.option("height");this.left_vline.attr({path:"M"+a+","+c+"V"+(c+d)}),this.right_vline.attr({path:"M"+b+","+c+"V"+(c+d)}),this.hline.attr({path:"M"+a+","+(c+d/2)+"H"+b}),this.text_foreground.attr({x:(a+b)/2,y:c+d/2});var e=this.text_foreground.getBBox();this.text_background.attr({x:e.x,y:e.y,height:e.height,width:e.width})},d._on_options_set=function(){this.update()},d.show_menu=function(){var a=this.option("state");this.add_substate_item=b("<div />").addClass("menu_item").text("Add substate").on("click",c.bind(function(){this.remove_edit_dropdown(),this._emit("add_state",{parent:a})},this));var d=this.option("state").is_concurrent(),e=d?"&#x2612;":"&#x2610;";this.toggle_concurrency_item=b("<div />").addClass("menu_item").html("Concurrent "+e).on("click",c.bind(function(){this.remove_edit_dropdown(),this._emit("make_concurrent",{state:a,concurrent:!a.is_concurrent()})},this)),this.reset_item=b("<div />").addClass("menu_item").text("Reset").on("click",c.bind(function(){this.remove_edit_dropdown(),this._emit("reset",{parent:a})},this));var f=this.option("from_x"),g=this.option("y"),h=this.option("to_x")-f,i=this.option("paper"),j=i.canvas.parentNode;this.edit_dropdown=b("<div />").append(this.add_substate_item,this.toggle_concurrency_item,this.reset_item).addClass("dropdown").css({position:"absolute",left:f+"px",top:g+"px",width:h+"px"}).appendTo(j),b(window).on("mousedown.collapse",c.bind(this.on_window_click_while_expanded,this)),b(window).on("keydown.collapse",c.bind(this.on_window_keydown_while_expanded,this))},d.on_window_click_while_expanded=function(a){b(a.target).parents().is(this.edit_dropdown)||this.remove_edit_dropdown()},d.on_window_keydown_while_expanded=function(a){27===a.keyCode&&this.remove_edit_dropdown()},d.remove_edit_dropdown=function(){this.edit_dropdown&&(this.edit_dropdown.remove(),delete this.edit_dropdown),b(window).off("mousedown.collapse"),b(window).off("keydown.collapse")}}(a.HorizontalRangeDisplay)}(interstate,jQuery);
//# sourceMappingURL=interstate.min.js.map