<!DOCTYPE html>
<html lang="en">
  <head>
    <title>red</title>
  </head>
  <body>
		<div class="content">
		</div>
	  <div>
			<%- red_include(red_inc.main) %>
			<script type="text/javascript">
				var env, the_div, root;
				window.save = function(name) {
					return red.save(root, name);
				};
				window.load = function(name) {
					root = red.load(name);
					if(the_div.data("dom_output")) {
						the_div.dom_output("destroy")
					}
					if(env) {
						env.destroy();
					}
					env = red.create("environment", {root: root});
					env.print_on_return = true;
					the_div.dom_output({
						root: root,
						//edit_on_open: true
					});
					return root;
				};
				window.ls = red.ls;

				$(function() {
					the_div = $("<div />").appendTo(document.body);
					try {
						root = load();
					} catch(e) {
						console.log("Creating a new project");
						env = red.create("environment");
						env	.cd("child_nodes")
						/*
							.set("button", "<stateful>")
							.cd("button")
								.rename_state("INIT", "idle")
								.add_state("selected")
								.add_transition("idle", "selected", "on('mousedown', this)")
								.add_transition("selected", "idle", "on('mousedown', find(buttons).not(this))")
								.set("color")
								.set("color", "idle", "'black'")
								.set("color", "selected", "'yellow'")
								.set("text")
								.set("text", "idle", "'Confirm'")


								.set("(prototypes)", "idle", "dom")
								.up()
							.up()
							/*
						.set("draggable", "<stateful>")
						.cd("draggable")
							.add_state("drag")
							.add_transition("drag", "INIT", "on('mouseup')")
							.add_transition("INIT", "drag", "on('mousedown', this)")
							.add_transition("drag", "drag", "on('mousemove')")
							.set("x")
							.set("x", "drag->drag", "event.clientX")
							.set("y", "drag->drag", "event.clientY")
							.set("x", "drag->INIT", "x")
							.set("y", "drag->INIT", "y")
								/*
								.add_state("hover")
								.add_transition("INIT", "hover", "on('mouseover', this)")
								.add_transition("hover", "INIT", "on('mouseout', this)")
								.set("text", "hover", "'goodbye cruel world'")
								.up()
								*/

						root = env.get_root();

						the_div.dom_output({
							root: root
				//			edit_on_open: true
						});
						env.print_on_return = true;
					}
				});
				$(window).on("beforeunload", function() {
					if(window.nosave !== true) {
						save();
					}
				});
				window.nuke = function() {
					nosave = true;
					red.nuke();
				};
				//nosave = true;
			</script>
	  </div>
  </body>
</html>
