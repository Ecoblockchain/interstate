<!DOCTYPE html>
<html lang="en">
  <head>
    <title>red</title>
	<link rel="stylesheet" type="text/css" href="src/view/css/styles.css"></link>
	<link rel="stylesheet" type="text/css" href="src/_vendor/bootstrap/css/bootstrap.css"></link>
  </head>
  <body>
	  <!--<h1>red</h1>-->

		<div class="content">
		</div>

	  <div>
			<%- red_include(red_inc.main) %>
			<script type="text/javascript" src="src/_vendor/bootstrap/js/bootstrap.js"></script>
			<script type="text/javascript" src="album_data.js"></script>

			<script type="text/javascript">
				var root, env, cjs, _, root_view;
				$(function() {
					cjs = red.cjs;
					_ = red._;

					red.__debug = false;


					var thediv = document.getElementById("mydiv");

					env = red.create("environment");
					root = env.get_pointer();
					env.set("elem", thediv);
					env.set("a", "stateful");
					env.cd("a");
					env.add_state("hover");
					env.add_transition("INIT", "hover", "mouseover(elem)");
					console.log(env.print());
					/*
					env.cd("children");
					var children = env.get_pointer();
					env.set("obj", "dict");
					env.cd("obj");
					var obj = env.get_pointer();
					env.set("(protos)", "dom");
					env.set("(manifestations)", "20");
					env.set("tag");
					//env.set("text", "'hi'");
					env.set("tag", "'div'");
					//env.set("text", "'hi'+basis");
					env.set("children", "dict");
					env.cd("children");
					env.set("0", "dict");
					env.cd("0");
					env.set("(protos)", "dom");
					env.set("tag", "'span'");
					env.set("text", "'yo'");
					env.up();
					env.set("1", "dict");
					env.cd("1");
					env.set("(protos)", "dom");
					env.set("tag", "'span'");
					env.set("text", "basis");
					//obj.set("tag", "div");
					//obj.set("text", "hi");

					/*
					var context = red.create("context", {stack: [root, children, obj]});
					var mobjs = obj.get_manifestation_objs(context);
					var mcontexts = _.map(mobjs, function(mobj) {
						return context.push(mobj);
					});
					*/

					/*
					var stopwatch = new Stopwatch().start();
					_.each(mcontexts, function(context) {
						var dom_attachment = obj.get_attachment_instance("dom", context);
					//	var protos = obj._get_direct_protos(context);
					});
					console.log(stopwatch.stop());
					*/
					
					/*
					output_view = $("<div />").dom_output({
						root: env.get_root()
						, context: env.get_root_context()
					}).appendTo(document.body);


					console.log(env.print());
					*/
					/*
					var thediv = document.getElementById("mydiv");
					var dict = red.create("dict").set("div", thediv);
					var context = red.create("context", {stack: [dict]});

					var sc = red.create("statechart");
					var shadow = sc.create_shadow(context);

					sc	.add_state("INIT")
					//	.starts_at("INIT")
					//	.add_state("hover")
					//	.add_transition("INIT", "hover", red.create_event("parsed", {str: "mouseover(div)", inert_super_event: true}))
						.run();

					//shadow.run();
					//console.log(red.serialize(sc));
					//console.log(red.stringify(sc));
					console.log(sc.stringify());
					//console.log(shadow.stringify());
					window.sc = sc;
					window.shadow = shadow;
					/*
					*/

					var storage_prefix = "_";
					window.save = function(name) {
						if(!_.isString(name)) {
							name = "default";
						}
						name = storage_prefix+name;
						localStorage[name] = red.stringify(root);
						return ls();
					};
					window.open = window.load = function(name) {
						if(!_.isString(name)) {
							name = "default";
						}
						name = storage_prefix+name;
						root_view.environment("destroy");
						root.destroy();
						root = red.destringify(localStorage[name]);
						env = red.create("environment", {root: root});
						root_view.environment({controller: env});
						console.log(env.print());
					};
					window.ls = function() {
						return _.chain(localStorage)
								.keys()
								.filter(function(key) {
									return key.substr(0, storage_prefix.length) === storage_prefix
								})
								.map(function(key) {
										return key.slice(storage_prefix.length);
								})
								.value();
					};
					window.rm = function(name) {
						if(!_.isString(name)) {
							name = "default";
						}
						name = storage_prefix+name;
						delete localStorage[name];
						return ls();
					};
					window.print = function() {
						console.log(env.print());
					};
				});
			</script>
	  </div>
	  <div id="mydiv" style="width:150px;height:150px;background-color:red;"></div>
  </body>
</html>
