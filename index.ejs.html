<!DOCTYPE html>
<html lang="en">
  <head>
    <title>red</title>
	<link rel="stylesheet" type="text/css" href="src/view/css/styles.css"></link>
	<link rel="stylesheet" type="text/css" href="src/_vendor/bootstrap/css/bootstrap.css"></link>
  </head>
  <body>
	  <!--<h1>red</h1>-->

		<div class="content">
		</div>

	  <div>
			<%- red_include(red_inc.main) %>
			<script type="text/javascript" src="src/_vendor/bootstrap/js/bootstrap.js"></script>
			<script type="text/javascript" src="album_data.js"></script>

			<script type="text/javascript">
				var root, env, cjs, _, root_view;
				$(function() {
					cjs = red.cjs;
					_ = red._;

					red.__debug = false;

					env = red	.create("environment")
								.cd("children")
								.set("obj", "stateful")
								.cd("obj")
								.add_state("hover")
								.add_transition("INIT", "hover", "mouseover(this)")
								.add_transition("hover", "INIT", "mouseout(this)")
								.set("(manifestations)", "10")
								.set("(protos)", "INIT", "dom")
								.set("tag")
								.set("tag", "INIT", "'div'")
								.set("text")
								.set("text", "INIT", "'hello world'")
								.set("text", "hover", "'hover'")
					/**/
								;
					var obj = env.get_pointer();

					output_view = $("<div />").dom_output({
						root: env.get_root()
						, context: env.get_root_context()
					}).appendTo(document.body);
					env.print_on_return = true;
					console.log(env.print());
					

					//console.log(obj);
					//console.log(manifestations);
					/**/
					/*

					var m = cjs.map({value: {a: 1}});
					/*
					var obj = red.create("dict");
					var context = red.create("context");
					var cell = red.create("cell");
					obj.set_manifestations(cell);
					*/
					/*

					cjs.liven(function() {
						console.log(m.get_or_put("a"));
					}, {
						context: this
						, pause_while_running: true
					});
					cjs.wait();
					m.clear().get_or_put("a", function() { return 4; });
					cjs.signal();
					cjs.wait();
					m.clear().get_or_put("a", function() { return 5; });
					cjs.signal();
					/*
					cell.set_str("2");
					cell.set_str("3");
					cell.set_str("4");
					/*
					d.set_manifestations(3);
					d.set_manifestations(5);
					/**/

					var storage_prefix = "_";
					window.save = function(name) {
						if(!_.isString(name)) {
							name = "default";
						}
						name = storage_prefix+name;
						localStorage[name] = red.stringify(root);
						return ls();
					};
					window.open = window.load = function(name) {
						if(!_.isString(name)) {
							name = "default";
						}
						name = storage_prefix+name;
						root_view.environment("destroy");
						root.destroy();
						root = red.destringify(localStorage[name]);
						env = red.create("environment", {root: root});
						root_view.environment({controller: env});
						console.log(env.print());
					};
					window.ls = function() {
						return _.chain(localStorage)
								.keys()
								.filter(function(key) {
									return key.substr(0, storage_prefix.length) === storage_prefix
								})
								.map(function(key) {
										return key.slice(storage_prefix.length);
								})
								.value();
					};
					window.rm = function(name) {
						if(!_.isString(name)) {
							name = "default";
						}
						name = storage_prefix+name;
						delete localStorage[name];
						return ls();
					};
					window.print = function() {
						console.log(env.print());
					};
				});
			</script>
	  </div>
  </body>
</html>
