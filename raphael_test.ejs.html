<!DOCTYPE html>
<html lang="en">
  <head>
    <title>red</title>
	<link rel="stylesheet" type="text/css" href="src/view/css/styles.css"></link>
	<link rel="stylesheet" type="text/css" href="src/_vendor/bootstrap/css/bootstrap.css"></link>
  </head>
  <body>
	  <!--<h1>red</h1>-->

		<div class="content">
		</div>

	  <div>
			<%- red_include(red_inc.main) %>
			<script type="text/javascript" src="src/_vendor/bootstrap/js/bootstrap.js"></script>
			<script type="text/javascript">
				var _ = red._;
				var Antenna = function(paper, options) {
					this.options = _.extend({
						radius: 5
						, height: 40
						, top: 5
						, left: 10
						, animation_duration: 600
					}, options);

					this.expanded = true;

					this.ellipse = paper.ellipse(this.options.left
												, this.options.top + this.options.radius
												, this.options.radius
												, this.options.radius);
					this.line = paper.path("M"+this.options.left+","+(this.options.top+2*this.options.radius)+
											"L"+this.options.left+","+(this.options.top + this.options.height));
				};

				Antenna.prototype.collapse = function() {
					this.line.animate({
						path: "M" + this.options.left + "," + (this.options.top+this.options.height)
					}, this.options.animation_duration);
					this.ellipse.animate({
						cy: this.options.top + this.options.height
						, ry: 0
						, rx: 0
					}, this.options.animation_duration);
					this.expanded = false;
				};
				Antenna.prototype.expand = function() {
					this.expanded = true;
					this.line.animate({
						path: "M"+this.options.left+","+(this.options.top+2*this.options.radius)+
										"L"+this.options.left+","+(this.options.top + this.options.height)
					}, this.options.animation_duration);
					this.ellipse.animate({
						cy: this.options.top + this.options.radius
						, ry: this.options.radius
						, rx: this.options.radius
					}, this.options.animation_duration);
				};
				Antenna.prototype.option = function(key, value, animated) {
					if(arguments.length <= 1) {
						return this.options[key];
					} else {
						this.options[key] = value;
						var animation_duration = animated ? this.animation_duration : 0;
						if(this.expanded) {
							this.ellipse.animate({
								cy: this.options.top + this.options.radius
								, ry: this.options.radius
								, rx: this.options.radius
							}, animation_duration);
							this.line.animate({
								path: "M"+this.options.left+","+(this.options.top+2*this.options.radius)+
												"L"+this.options.left+","+(this.options.top + this.options.height)
							}, animation_duration);
						} else {
							if(key === "left") {
								this.line.animate({
									path: "M"+this.options.left+","+(this.options.top+2*this.options.radius)+
													"L"+this.options.left+","+(this.options.top + this.options.height)
								}, animation_duration);
								this.ellipse.animate({
									cy: this.options.top + this.options.radius
									, ry: this.options.radius
									, rx: this.options.radius
								}, 0);
							}
						}
						return this;
					}
				};

				var Arrow = function(paper, options) {
					this.options = _.extend({
						arrowLength: 7
						, fromX: 10
						, toX: 80
						, fromY: 20
						, toY: 20
						, radius: 3
						, arrowAngle: 20
						, bottom: 45
						, animation_duration: 600
					});

					this.expanded = true;
					var lineStart = this.getLineStart();
					var lineEnd = this.getLineEnd();
					this.ellipse = paper.ellipse(this.options.fromX
												, this.options.fromY
												, this.options.radius
												, this.options.radius);
					this.line = paper.path("M"+lineStart.x+","+lineStart.y+
											"L"+lineEnd.x+","+lineEnd.y);
					this.triangle = paper.path(this.getTrianglePath());
				};
				Arrow.prototype.getTheta = function() {
					var dy = this.options.toY - this.options.fromY;
					var dx = this.options.toX - this.options.fromX;
					return Math.atan2(dy, dx);
				};
				Arrow.prototype.getLineStart = function() {
					var theta = this.getTheta();
					return {
						x: this.options.fromX + Math.cos(theta) * this.options.radius
						, y: this.options.fromY + Math.sin(theta) * this.options.radius
					};
				};
				Arrow.prototype.getLineEnd = function() {
					var theta = this.getTheta();
					return {
						x: this.options.toX - Math.cos(theta) * this.options.arrowLength
						, y: this.options.toY - Math.sin(theta) * this.options.arrowLength
					};
				};
				Arrow.prototype.getTrianglePath = function() {
					var theta = this.getTheta();
					var arrowAngleRadians = this.options.arrowAngle * Math.PI/180;

					var line_end = this.getLineEnd();
					var off_line = this.options.arrowLength * Math.tan(arrowAngleRadians);
					
					var path = [
						{x: this.options.toX, y:this.options.toY}
						, {x: line_end.x + off_line * Math.cos(theta - Math.PI/2)
							, y: line_end.y + off_line * Math.sin(theta - Math.PI/2)
						}
						, {x: line_end.x + off_line * Math.cos(theta + Math.PI/2)
							, y: line_end.y + off_line * Math.sin(theta + Math.PI/2)
						}
					];
					return "M" + _.map(path, function(point) {
									return point.x+","+point.y;
								}).join("L") + "Z";
				};
				Arrow.prototype.collapse = function() {
					this.ellipse.animate({
						cx: this.options.fromX
						, cy: this.options.bottom
						, rx: 0
						, ry: 0
					}, this.options.animation_duration);
					this.line.animate({
						path: "M"+this.options.fromX+","+this.options.bottom
					}, this.options.animation_duration);
					this.triangle.animate({
						path: "M"+this.options.fromX+","+this.options.bottom
					}, this.options.animation_duration);
					this.expanded = false;
				};
				Arrow.prototype.expand = function() {
					this.expanded = true;
					var lineStart = this.getLineStart();
					var lineEnd = this.getLineEnd();
					this.ellipse.animate({
						cx: this.options.fromX
						, cy: this.options.fromY
						, rx: this.options.radius
						, ry: this.options.radius
					}, this.options.animation_duration);
					this.line.animate({
						path: "M"+lineStart.x+","+lineStart.y+
											"L"+lineEnd.x+","+lineEnd.y
					}, this.options.animation_duration);
					this.triangle.animate({
						path: this.getTrianglePath()
					}, this.options.animation_duration);
				};

				var StatechartView = function(statechart, paper, options) {
					this.statechart = statechart;
					this.paper = paper;
					this.options = _.extend({
										root: false
										, parent: null
										, left: 0
										, width: 100
									}, options);


					if(!this.options.root) {
						this.antenna = new Antenna(this.paper, { left: this.options.left + (this.options.width / 2) });
					}

					this.$substates = this.statechart.$substates;
					this.$onSet = _.bind(this.onSet, this);
					this.$onUnset = _.bind(this.onUnset, this);
					this.$onIndexChange = _.bind(this.onIndexChange, this);
					this.$onMove = _.bind(this.onMove, this);
					this.$onValueChange = _.bind(this.onValueChange, this);

					this.$substates.each(this.$onSet);

					this.$substates.onSet(this.$onSet);
					this.$substates.onUnset(this.$onUnset);
					this.$substates.onIndexChange(this.$onIndexChange);
					this.$substates.onKeyChange(this.$onKeyChange);
					this.$substates.onMove(this.$onMove);
					this.$substates.onValueChange(this.$onValueChange)
				};

				(function(my) {
					var proto = my.prototype;
					proto.onSet = function(state, state_name, index) {
						var state_view = new StatechartView(state, this.paper, {
							parent: this
							, left: this.options.left + 50*index
							, width: this.options.width
						});
					};
					proto.onUnset = function() {
					};
					proto.onIndexChange = function() {
					};
					proto.onKeyChange = function() {
					};
					proto.onMove = function() {
					};
					proto.onValueChange = function() {
					};
					proto.option = function(key, value, animated) {
						if(arguments.length <= 1) {
							return this.options[key];
						} else {
							this.options[key] = value;
							return this;
						}
					};
				}(StatechartView));


				var root, env, cjs, _, root_view;
				$(function() {
					var statechart = window.statechart = red.create("statechart")
										.add_state("stateA")
										.starts_at("stateA")
										.run();
					/*
										.add_state("superstateA")
										.add_state("superstateA.substate1")
										.add_state("superstateA.substate2")
										.add_state("stateB")
										.add_state("superstateC")
										.add_state("superstateC.substate1")
										.add_state("superstateC.substate2")
										.add_state("stateD");
					*/



					var paper = Raphael(0, 0, 600, 200);

					var statechart_view = new StatechartView(statechart, paper, {root: true});
					
					statechart.add_state("stateB");


					/*
					var a1 = new Antenna(paper, { });
					var arrow1 = new Arrow(paper, { });
					var a2 = new Antenna(paper, { left: 80 });

					window.setInterval(function() {
						a1.collapse();
						a2.collapse();
						arrow1.collapse();
						window.setTimeout(function() {
							a1.expand();
							a2.expand();
							arrow1.expand();
						}, 1000);
					}, 2000);

					/*
					// Creates circle at x = 50, y = 40, with radius 10
					var circle = paper.circle(50, 40, 10);
					// Sets the fill attribute of the circle to red (#f00)
					circle.attr("fill", "#f00");

					var line = paper.path("M50,40L50,80");

					// Sets the stroke attribute of the circle to white
					circle.attr("stroke", "#fff");
					*/
				});
			</script>
	  </div>
  </body>
</html>
