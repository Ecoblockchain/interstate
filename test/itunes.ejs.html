<!DOCTYPE html>
<html lang="en">
  <head>
    <title>red</title>
	<style type="text/css">
		div.player {
			margin: auto;
			border: 1px solid black;
			width: 620px;
			margin-top: 10px;
		}
		div.header {
			background-image: -webkit-linear-gradient(top, rgb(246,246,246), rgb(167,167,167));
			padding-top: 10px;
			padding-bottom: 10px;
			padding-left: 10px;
			border-top-left-radius: 5px;
			border-top-right-radius: 5px;
		}
		div.header > img {
			margin-left: 1px;
			margin-right: 1px;
		}
		div.songs {
			max-height: 300px;
			overflow-y: scroll;
			border-bottom: rgb(237, 237, 237);
		}
		div.songs > div.song:nth-child(odd) {
			background-color: rgb(250, 250, 250);
		}
		div.songs > div.song:nth-child(even) {
			background-color: rgb(241, 244, 247);
		}
		
		div.song {
			padding-left: 4px;
			cursor: default;
		}
		div.songs > div.selected.song {
			background-color: rgb(139, 167, 198);
			color: rgb(255, 255, 255);
		}
		.selected {
			background-color: rgb(139, 167, 198);
			color: rgb(255, 255, 255);
		}
		div.song span.name {
			display: inline-block;
			width: 190px;
			font-weight: bold;
		}
		div.song span.artist {
			display: inline-block;
			width: 125px;
		}
		div.song span.duration {
			display: inline-block;
			width: 75px;
			text-align: right;
		}
	</style>
  </head>
  <body>
	  <!--<h1>red</h1>-->

		<div class="content">
		</div>

	  <div>
			<%- red_include(red_inc.main) %>
			<script type="text/javascript" src="album_data.js"></script>

			<script type="text/javascript">
				var format_duration = function(time) {
					var minutes = Math.floor(time);
					var seconds = Math.round((time - minutes) * 60);
					if(seconds < 10) seconds = "0"+seconds;
					else seconds = ""+seconds;
					return minutes+":"+seconds;
				};
				var root, env, cjs, _, root_view;
				$(function() {
					cjs = red.cjs;
					_ = red._;

					red.__debug = false;

					env = red	.create("environment");
					
					window.songs = cjs.$(function() {
						return _.chain(albums)
								.map(function(x) {
									return x.songs;
								})
								.flatten(true)
								.map(function(x) {
									var duration_str
									return {
										artist: x.album.artist,
										duration: format_duration(x.duration),
										name: x.title
									};
								})
								.value()
					});

					var get_songs = function(plist) {
							var rv = songs.get();
							if(!plist) {
								return songs;
							}
							var z = parseInt(uid.strip_prefix(plist.id()))%4+2;
							console.log(z);
							rv = _.filter(rv, function(s, i) {
								if(i%z == 0) {
										return true;
								}
								return false;
							});
							return rv;
					};

env			
.set("button", "<stateful>")
.cd("button")
	.rename_state("INIT", "idle")
	.add_state("hover")
	.add_state("active")
	.add_state("active_out")
	.add_transition("idle", "hover", "on('mouseover', this)")
	.add_transition("hover", "idle", "on('mouseout', this)")
	.add_transition("hover", "active", "on('mousedown', this)")
	.add_transition("active", "hover", "on('mouseup')")
	.add_transition("active", "active_out", "on('mouseout', this)")
	.add_transition("active_out", "active", "on('mouseover', this)")
	.add_transition("active_out", "idle", "on('mouseup')")
	.set("(prototypes)", "idle", "[dom]")
	.top()
.set("attr", "<dict>")
.cd("attr")
	.set("class", "'player'")
	.up()
.cd("child_nodes")
	.set("playlists", "<stateful>")
	.cd("playlists")
		.set("(prototypes)", "INIT", "[dom]")
		.set("tag")
		.set("tag", "INIT", "'div'")
		.set("css", "<dict>")
		.cd("css")
			.set("float", "'left'")
			.set("width", "'120px'")
			.set("height", "'362px'")
			.up()
		.set("child_nodes", "<dict>")
		.cd("child_nodes")
			.set("ptext", "<stateful>")
			.cd("ptext")
				.set("(prototypes)", "INIT", "[dom]")
				.set("tag")
				.set("tag", "INIT", "'div'")
				.set("text", "'Playlists:'")
				.set("css", "<dict>")
				.cd("css")
					.set("padding-top", "'60px'")
					.set("font-weight", "'bold'")
					.up()
				.up()
			.set("plist", "<stateful>")
			.cd("plist")
				.rename_state("INIT", "not_selected")
				.add_state("selected")
				.add_transition("not_selected", "selected", "selection_info.selected_plist === this")
				.add_transition("selected", "not_selected", "selection_info.selected_plist !== this")
				.set("(prototypes)", "not_selected", "[dom]")
				.set("(copies)", "['80s Music', 'Rock', 'Workout']")
				.set("tag")
				.set("tag", "not_selected", "'div'")
				.set("text", "my_copy")
				.set("css", "<dict>")
				.cd("css")
					.up()
				.set("attr", "<dict>")
				.cd("attr")
					.set("class", "<stateful_prop>")
					.set("class", "not_selected", "'song'")
					.set("class", "selected", "'selected song'")
					.up()
				.up()
			.up()
		.up()
	.set("header", "<stateful>")
	.cd("header")
		.set("(prototypes)", "INIT", "[dom]")
		.set("tag")
		.set("tag", "INIT", "'div'")
		.set("attr", "<dict>")
		.cd("attr")
			.set("class", "<stateful_prop>")
			.set("class", "INIT", "'header'")
			.up()
		.set("child_nodes", "<dict>")
		.cd("child_nodes")
			.set("prev_button", "<stateful>")
			.cd("prev_button")
				.set("(prototypes)", "INIT", "[button]")
				.set("tag")
				.set("tag", "INIT", "'img'")
				.set("attr", "<dict>")
				.cd("attr")
					.set("src", "<stateful_prop>")
					.set("src", "idle", "'buttons/prev.png'")
					.set("src", "hover", "'buttons/prev.png'")
					.set("src", "active", "'buttons/prev_active.png'")
					.set("src", "active_out", "'buttons/prev.png'")
					.up()
				.up()
			.set("play_button", "<stateful>")
			.cd("play_button")
				.set("(prototypes)", "INIT", "[button]")
				.set("tag")
				.set("tag", "INIT", "'img'")
				.set("attr", "<dict>")
				.cd("attr")
					.set("src", "<stateful_prop>")
					.set("src", "idle", "'buttons/play.png'")
					.set("src", "hover", "'buttons/play.png'")
					.set("src", "active", "'buttons/play_active.png'")
					.set("src", "active_out", "'buttons/play.png'")
					.up()
				.up()
			.set("next_button", "<stateful>")
			.cd("next_button")
				.set("(prototypes)", "INIT", "[button]")
				.set("tag")
				.set("tag", "INIT", "'img'")
				.set("attr", "<dict>")
				.cd("attr")
					.set("src", "<stateful_prop>")
					.set("src", "idle", "'buttons/next.png'")
					.set("src", "hover", "'buttons/next.png'")
					.set("src", "active", "'buttons/next_active.png'")
					.set("src", "active_out", "'buttons/next.png'")
					.up()
				.up()
			.up()
		.up()
	.set("albums", "<stateful>")
	.cd("albums")
		.up()
	.set("songs", "<stateful>")
	.cd("songs")
		.set("(prototypes)", "INIT", "[dom]")
		.set("tag")
		.set("tag", "INIT", "'div'")
		.set("attr", "<dict>")
		.cd("attr")
			.set("class", "<stateful_prop>")
			.set("class", "INIT", "'songs'")
			.up()
		.set("child_nodes", "<dict>")
		.cd("child_nodes")
			.set("song_view", "<stateful>")
			.cd("song_view")
				.rename_state("INIT", "not_selected")
				.add_state("selected")
				.add_transition("not_selected", "selected", "selection_info.selected_song === this")
				.add_transition("selected", "not_selected", "selection_info.selected_song !== this")
				.set("(prototypes)", "not_selected", "[dom]")
				.set("(copies)", "get_songs(selection_info.selected_plist)")
				.set("attr", "<dict>")
				.cd("attr")
					.set("class", "<stateful_prop>")
					.set("class", "not_selected", "'song'")
					.set("class", "selected", "'selected song'")
					.up()
				.set("tag")
				.set("tag", "not_selected", "'div'")
				.set("child_nodes", "<dict>")
				.cd("child_nodes")
					.set("song_name", "<dict>")
					.cd("song_name")
						.set("(prototypes)", "[dom]")
						.set("tag", "'span'")
						.set("text", "my_copy.name")
						.set("attr", "<dict>")
						.cd("attr")
							.set("class", "'name'")
							.up()
						.up()
					.set("artist", "<dict>")
					.cd("artist")
						.set("(prototypes)", "[dom]")
						.set("tag", "'span'")
						.set("text", "my_copy.artist")
						.set("attr", "<dict>")
						.cd("attr")
							.set("class", "'artist'")
						.up()
					.up()
				.set("duration", "<dict>")
				.cd("duration")
					.set("(prototypes)", "[dom]")
					.set("tag", "'span'")
					.set("text", "my_copy.duration")
					.set("attr", "<dict>")
					.cd("attr")
						.set("class", "'duration'")
						.up()
					.up()
				.top()
	.set("selection_info", "<stateful>")
	.cd("selection_info")
		.add_transition("INIT", "INIT", "on('mousedown', root.child_nodes.songs.child_nodes.song_view)")
		.set("selected_song")
		.set("selected_song", "INIT -0> INIT", "event.red_target")
		.add_transition("INIT", "INIT", "on('mousedown', root.child_nodes.playlists.child_nodes.plist)")
		.set("selected_plist")
		.set("selected_plist", "INIT -1> INIT", "event.red_target")
		.top()
	.set("get_songs", get_songs)
;
					output_view = $("<div />").dom_output({
						root: env.get_root()
					}).appendTo(document.body);

					env.print_on_return = true;
					console.log(env.print());
				});
			</script>
	  </div>
  </body>
</html>
