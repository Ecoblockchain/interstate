<!DOCTYPE html>
<html lang="en">
  <head>
    <title>red</title>
  </head>
  <body>
		<div class="output"></div>
		<div id="editor"></div>
		<canvas width="600" height="400" id="canvas"></canvas>
	  <div>
			<%- red_include(red_inc.main) %>
			<script type="text/javascript">
				var env = red.create("environment");
				var root = env.get_root();

				env
				.set("my_world", "<stateful>")
				.cd("my_world")
					.set("(prototypes)", "(start)", "box2d")
					.set("gy", "(start)", "0")
					.set("gx", "(start)", "0")
					.up()
				.set("my_block", "<stateful>")
				.cd("my_block")
					.set("(prototypes)", "(start)", "my_world.fixture")
					.set("r", "(start)", "50")
					.set("x", "(start)", "50")
					.set("y", "(start)", "50")
				var rc = red.find_or_put_contextual_obj(root);
				var my_world = rc.prop_val("my_world");
				var box2d = my_world.get_attachment_instance("box2d");

				var world = box2d.get_world();
				var fixDef = new Box2D.Dynamics.b2FixtureDef();
				fixDef.density = 1.0;
				fixDef.friction = 0.5;
				fixDef.restitution = 0.2;

				var bodyDef = new Box2D.Dynamics.b2BodyDef();
				bodyDef.type = Box2D.Dynamics.b2Body.b2_dynamicBody;
				document.getElementById("canvas").addEventListener("click", function(event) {
					fixDef.shape = new Box2D.Collision.Shapes.b2CircleShape(50/30);
					bodyDef.position.x = event.layerX/30;
					bodyDef.position.y = event.layerY/30;
					window.x = world.CreateBody(bodyDef).CreateFixture(fixDef);
				});
				
				//setup debug draw
				var debugDraw = new Box2D.Dynamics.b2DebugDraw();
				debugDraw.SetSprite(document.getElementById("canvas").getContext("2d"));
				debugDraw.SetDrawScale(30.0);
				debugDraw.SetFillAlpha(0.5);
				debugDraw.SetLineThickness(1.0);
				debugDraw.SetFlags(Box2D.Dynamics.b2DebugDraw.e_shapeBit | Box2D.Dynamics.b2DebugDraw.e_jointBit);
				world.SetDebugDraw(debugDraw);

				window.setInterval(update, 1000 / 60);
			
				function update() {
					world.Step(1 / 60, 10, 10);
					world.DrawDebugData();
					world.ClearForces();
				};

				$("div#editor").editor({
					debug_env: true,
					server_window: window
				});
				$("div.output").dom_output({
					root: root,
					open_separate_client_window: false,
					edit_on_open: true
				});
			</script>
	  </div>
  </body>
</html>
