<!DOCTYPE html>
<html lang="en">
  <head>
    <title>red</title>
  </head>
  <body>
		<div class="output"></div>
		<div id="editor"></div>
		<canvas width="600" height="400" id="canvas"></canvas>
	  <div>
			<%- red_include(red_inc.main) %>
			<script type="text/javascript">
				var env = red.create("environment");
				var root = env.get_root();

				env
				.set("my_world", "<stateful>")
				.cd("my_world")
					.set("(prototypes)", "(start)", "box2d")
					.set("gy", "(start)", "0")
					.set("gx", "(start)", "0")
					.up()
				.set("my_block", "<stateful>")
				.cd("my_block")
					.set("(prototypes)", "(start)", "my_world.fixture")
					.set("r", "(start)", "50")
					.set("x", "(start)", "100")
					.set("y", "(start)", "100")
					.set("x_val", "(start)", "this.get_x()")
					.set("y_val", "(start)", "this.get_y()")
					.set("fixed", "(start)", "true")
				var rc = red.find_or_put_contextual_obj(root);
				var my_world = rc.prop_val("my_world");
				var my_block = rc.prop_val("my_block");
				var box2d = my_world.get_attachment_instance("box2d");
				var b2dfixture = my_block.get_attachment_instance("box2d_fixture");

				var world = box2d.get_world();
				var fixture = b2dfixture.get_fixture();
				
				//setup debug draw
				var debugDraw = new Box2D.Dynamics.b2DebugDraw();
				debugDraw.SetSprite(document.getElementById("canvas").getContext("2d"));
				debugDraw.SetDrawScale(30.0);
				debugDraw.SetFillAlpha(0.5);
				debugDraw.SetLineThickness(1.0);
				debugDraw.SetFlags(Box2D.Dynamics.b2DebugDraw.e_shapeBit | Box2D.Dynamics.b2DebugDraw.e_jointBit);
				world.SetDebugDraw(debugDraw);

				window.setInterval(update, 1000 / 60);
			
				function update() {
					world.Step(1 / 60, 10, 10);
					world.DrawDebugData();
					world.ClearForces();
				};

				$("div#editor").editor({
					debug_env: true,
					server_window: window
				});
				$("div.output").dom_output({
					root: root,
					open_separate_client_window: false,
					edit_on_open: true
				});
			</script>
	  </div>
  </body>
</html>
