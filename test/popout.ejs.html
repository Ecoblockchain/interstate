<!DOCTYPE html>
<html lang="en">
  <head>
    <title>red</title>
	<style type="text/css">
	</style>
  </head>
  <body>
	  <a href="javascript:void(0)" id="open">Open it</a>

	  <div>
			<%- red_include(red_inc.main) %>

			<script type="text/javascript">
				var port;
				var post = function(str) {
					port.postMessage(str);
				};
				var on_message = function(data) {
					console.log("Meccage received", data);
				};
				$(function() {
					$("a#open").on("click", function() {
						var editorWindow = window.open("../src/view/editor.ejs.html", "red_editor", "toolbar=yes, location=yes, directories=yes, status=yes, menubar=yes, scrollbars=yes, resizable=yes, width=800, height=600"); 
						var initializePort = function() {
							var channel = new MessageChannel();
							port = channel.port2;
							channel.port1.onmessage = function (event) {
								on_message(event.data);
							};
							editorWindow.postMessage("port", "http://localhost:8000", [channel.port2]);
							window.addEventListener("unload", function() {
								editorWindow.close();
							});
						};


						$(editorWindow.document).ready(function() {
								console.log("READY");
								initializePort();
								/*
							if(editorWindow.document.readyState === "complete") {
							} else {
								editorWindow.addEventListener("load", initializePort);
							}
								*/
						});
					});
				});
			</script>
	  </div>
  </body>
</html>
